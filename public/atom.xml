<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Shit Gary Says]]></title>
  <link href="http://glarizza.github.com/atom.xml" rel="self"/>
  <link href="http://glarizza.github.com/"/>
  <updated>2013-01-16T15:19:27-08:00</updated>
  <id>http://glarizza.github.com/</id>
  <author>
    <name><![CDATA[Gary larizza]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[JAMF NetSUS Appliance]]></title>
    <link href="http://glarizza.github.com/blog/2012/02/06/jamf-netsus-appliance/"/>
    <updated>2012-02-06T11:22:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2012/02/06/jamf-netsus-appliance</id>
    <content type="html"><![CDATA[<h2>JAMF&#8217;s NetSUS Appliance - Netboot in a Box</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">Today, JAMF released a new appliance VM</a> based on Ubuntu 10.04 LTS (Lucid) that, for once, provides an &#8216;out of the box&#8217; implementation of Netboot and Software Update Service WITHOUT requiring OS X hardware (based on <a href="http://github.com/wdas/reposado">Reposado</a>) and <a href="http://twitpic.com/8glygw">other open-source technologies.</a></p>

<p>For those people who are relatively new to Linux, I thought I&#8217;d provide an easy walkthrough of how to get started using this VM on your Laptop.  I&#8217;m going to demo this using VMware Fusion instead of VirtualBox mainly because I prefer how Fusion handles Networking.  I&#8217;ve used many VMs, and Fusion always tends to be much more solid and stable for me.  If you don&#8217;t have Fusion or don&#8217;t WANT to use Fusion, feel free to use VirtualBox.</p>

<h2>Download and Convert the OVA File</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">The appliance can be downloaded directly from JAMF</a> and comes as a VirtualBox OVA file.  <a href="http://derflounder.wordpress.com/2012/02/06/converting-jamfs-netbootsus-appliance-to-vmware/">Rich Trouton has provided a great walkthrough</a> on converting the OVA file to a VMX file, so I&#8217;ll link you to that post (since he did it so well).</p>

<h2>Start up the VM</h2>

<p>Once you have your VMX file, you can open it up with Fusion and import it into your Virtual Machine Library.  There is one change we&#8217;ll want to make, so click on the VM and open its Settings panel (this is different from Fusion 3.0 and 4.0 - I&#8217;ll be describing the 4.0 method).  In the Settings panel, you&#8217;ll want to select the Network Adapter icon and make sure the radio button next to &#8220;Share the Mac&#8217;s network connection (NAT)&#8221; is selected.  This will create a local IP address so we can contact it directly from our Laptop.  Once you&#8217;ve done that, start the VM and get to the login screen (you&#8217;ll need to click the Ok button through the message about logging into the NetSUS instance).  Feel free to login with the username &#8216;shelluser&#8217; and the password &#8216;shelluser&#8217;.  You should see a Message of the Day splash with one of the sections being &#8220;IP address for eth0:&#8221;.  Note the IP address, we&#8217;ll need it in the next section (if you don&#8217;t see this, just run <code>ifconfig</code> from the command line and look for the IP address for the eth0 adapter - it should be in the format of 192.168.x.x).</p>

<h2>Prepare to Break Free!</h2>

<p>It really sucks to work with VMs from WITHIN the VM window for various reasons (lack of Copy/Paste, loss of mouse, etcâ€¦), so we&#8217;re going to setup a host entry on your local laptop so we can SSH into the VM as we need.  I&#8217;m going to give my VM a hostname of &#8216;netsus.puppetlabs.vm&#8217; but you can name it whatever you want.  Let&#8217;s first edit the /etc/hosts file on your laptop (NOT within the VM, this is ON your laptop) by running the following from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/hosts</span></code></pre></td></tr></table></div></figure>


<p>Feel free to use pico/nano to edit /etc/hosts in case you don&#8217;t have any experience with vim.  We want to add the following line in the /etc/hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.217.154 netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE</strong> SUBSTITUTE 192.168.217.154 WITH THE IP ADDRESS YOU GOT FROM THE PREVIOUS STEP!  That&#8217;s the IP address that was assigned on MY laptop, and it will definitely be different from the IP address you got on YOUR computer.  Also, you don&#8217;t HAVE to use &#8216;netsus.puppetlabs.vm&#8217; - you can assign it any name you want.  Save and close /etc/hosts and then let&#8217;s test connectivity from the command line by doing a ping:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ping 192.168.217.154</span></code></pre></td></tr></table></div></figure>


<p>As long as we have connection, we&#8217;re fine (remember, substitute your IP Address for mine).  If you DON&#8217;T have connectivity, make sure your VM is running and review your /etc/hosts file to make sure the changes were saved (also, check the IP address on your VM again).</p>

<h2>Snapshot Time</h2>

<p>The beauty of Fusion is that you can take snapshots and revert to them should you mess things up.  Let&#8217;s take a snapshot now in case we screw things up in the following steps.  I&#8217;m using VMware Fusion 4.0, so I take a snapshot by clicking on the VM window, clicking on the Virtual Machine menu at the top, and then down to Snapshots.  From there, you can click the &#8216;Take Snapshot&#8217; button and let it do its thing.  When it&#8217;s done, hit the close button and return to the VM</p>

<h2>Enable SSH and Login</h2>

<p>By default, the VM doesn&#8217;t have the SSHD process running, so we can&#8217;t yet SSH in from our laptop.  Enable this by doing the following from within the VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install openssh-server</span></code></pre></td></tr></table></div></figure>


<p>Hit &#8220;Y&#8221; when it asks if it should download and install.  When it completes, switch back to your LAPTOP (i.e. NOT inside the VM), open up Terminal, and do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh shelluser@netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Type yes to add the SSH key to your known_hosts file and use the password &#8216;shelluser&#8217; to login.  Tada! Now you can work directly from Terminal and enable copy/pasting directly from your Terminal window.  You can always type <code>exit</code> to close the ssh connection when you&#8217;re done.</p>

<h2>Install Puppet</h2>

<p>So, it wouldn&#8217;t be one of my write-ups if I DIDN&#8217;T get Puppet installed.  Actually, if you&#8217;ve only managed Macs, then you might not have seen the benefit of Puppet before.  Now that we&#8217;re on Linux, you&#8217;ll definitely see the benefit of Puppet (especially if you&#8217;re not familiar with the service/package manipulation commands).  Puppet can help abstract that for you, so we&#8217;re going to enable it.</p>

<p>The version of Puppet that&#8217;s in the main package repository is quite old (0.25 as opposed to the current 2.7.10 version we support).  Let&#8217;s add Puppet Labs&#8217; Apt Repository to the list of repositories queried so we can get a recent version of Puppet.  Do that by opening up the /etc/apt/sources.list file for editing with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/apt/sources.list</span></code></pre></td></tr></table></div></figure>


<p>If it prompts you for your password, go ahead and enter it.  Also, if you&#8217;re not familiar with vi or vim, I&#8217;ll try and help you with the basics.  Arrow down to the line JUST above the line that begins with &#8220;deb http://&#8221; and press the i button on your keyboard to insert the following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://apt.puppetlabs.com/ubuntu lucid main
</span><span class='line'>deb-src http://apt.puppetlabs.com/ubuntu lucid main</span></code></pre></td></tr></table></div></figure>


<p>When you&#8217;re done, hit the escape key and press ZZ (hold shift and hit Z twice, you want two capital-Z&#8217;s) to save and close the file.  This will add Puppet Labs&#8217; repository to the list of repos queried.</p>

<p>Next, we&#8217;ll need to add Puppet Labs&#8217; GPG key to the system so we can validate the packages that are downloaded.  From the terminal, execute the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>The first time you run it, it will bother you about needing to create the keyserver file and won&#8217;t run correctly.  Let&#8217;s execute it correctly to receive the key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>Great, we should have the key, now we want to load it.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg -a --export 4BD6EC30 | sudo apt-key add -</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s update apt so that it knows about the repository.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get update</span></code></pre></td></tr></table></div></figure>


<p>When it finishes running, you can finally install Puppet with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install puppet</span></code></pre></td></tr></table></div></figure>


<p>Type &#8220;Y&#8221; when it asks you if it should download and install all the dependencies.  That&#8217;s it!  Puppet should be installed!  Run the following to see what version we&#8217;ve installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet --version</span></code></pre></td></tr></table></div></figure>


<p>As of this writing, 2.7.10 is the current version.  As long as you don&#8217;t have version 0.25 you should be good!</p>

<h2>Snapshots away</h2>

<p>It would be wise to take another snapshot at this point.  Don&#8217;t worry, I&#8217;ll wait.</p>

<h2>Inspect the System</h2>

<p>Puppet lets us see what&#8217;s been installed on the VM.  Take a look at all the packages on the system by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource package</span></code></pre></td></tr></table></div></figure>


<p>Type your password when prompted and Puppet will return you with a list of all packages on the system and the versions that are running.  Similarly, you can see what services are running with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource service</span></code></pre></td></tr></table></div></figure>


<p>Notice that sshd is running and other services like netatalk (that enables AFP on Linux) should also be running.  Sweet.  We&#8217;ll come back to Puppet later.</p>

<h2>Login to the Web GUI</h2>

<p>If your VM is running, you should be able to open a web browser on your Laptop and navigate to the following address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Note the httpS as we&#8217;ll need to use SSL to get into the Web GUI.  When it asks if you want to accept the self-signed cert, make sure to choose Yes.  You can login with the user &#8216;webadmin&#8217; and the password &#8216;webadmin&#8217;</p>

<p>Once you&#8217;re logged in, <a href="https://s3.amazonaws.com/jamfsoftware-content/downloads/NetBootSUS+Appliance_v1.0.pdf">feel free to read through JAMF&#8217;s instructions for enabling their services.</a>  They do a much better job than I about walking you through that.</p>

<h2>Access to the Raw Files</h2>

<p>Back in the Terminal window, you can access all the PHP/Shell magic that comprises the Web GUI in the /var/www/webadmin directory.  You can poke around through all the files (and use sudo to open some of the key bits) at your leisure.</p>

<p>Note that /etc/dhcpd.conf is the main configuration file for the DHCPD service and it&#8217;s got some special bits to accommodate Apple Hardware.</p>

<p>Also, /var/appliance has some magic (and the /var/appliance/configurefornetboot script has some sed statements for fixing a stock dhcpd.conf file and enabling those Apple Hardware bits).</p>

<h2>More Later?</h2>

<p>That&#8217;s it for now - I just wanted to get something online to show people how to setup and poke around in the VM.  Later I can show you how to manipulate and manage the VM with Puppet, which is pretty fun.  Your VM should get you started and let you play around locally, but if you want to test out Netboot and the like then you&#8217;ll need an externally-accessible IP address (as apposed to the 192.168.x.x IP, which is only accessible from your Laptop).  You can change the settings in VMware Fusion to enable that (like we did in step 2).</p>

<p>Hope this helped you out!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Run Stages with Puppet]]></title>
    <link href="http://glarizza.github.com/blog/2011/03/11/using-run-stages-with-puppet/"/>
    <updated>2011-03-11T11:34:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2011/03/11/using-run-stages-with-puppet</id>
    <content type="html"><![CDATA[<p>As of version 2.6, Puppet introduced a feature called &#8220;Run Stages&#8221; that will allow you to better control the order that Puppet configures your system.  The problem with Run Stages (as of right now) is that there&#8217;s not that much good Documentation out there.  Hopefully this document helps someone else out there who wants to setup Run Stages in their own environment.</p>

<h2>A NOTE ON SYNTAX!!!</h2>

<p>One of THE MOST DIFFICULT concepts to understand for puppet newbies is that these two things are identical:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">foo</span>
</span><span class='line'><span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of these lines INVOKE the &#8216;foo&#8217; class for use on a particular node.  The problem is that the second method (the parameterized class method) looks nearly IDENTICAL to the method you would use to DECLARE the foo class in foo.pp.  The only difference is that the class name is now INSIDE the curly braces (versus being OUTSIDE the braces when you DECLARE the class in your foo.pp file).  It is VERY important that you distinguish the difference between DECLARING a class and using a parameterized class to INCLUDE the class in your site.pp file.  I will point this out later too&#8230;</p>

<h2>A Linux Example - Repositories</h2>

<p>I would bet that the resource with the most &#8220;require&#8221; and &#8220;before&#8221; dependencies in the Linux world (Well, in the RHEL world anyways) would be the yumrepo.  I&#8217;m sure most of us have many declared yumrepo resources in our manifests that each have their own tangled web of dependencies.  My goal was to create a &#8220;repo&#8221; class that would have all of my repositories and use a Run Stage to ensure that my repo class was installed prior to any other package installs.  Let&#8217;s look at some code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::repo</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">yumrepo</span> <span class="p">{</span> <span class="s1">&#39;huronrepo&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">descr</span>    <span class="p">=&gt;</span> <span class="s1">&#39;Huron Repository&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">enabled</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">gpgcheck</span> <span class="p">=&gt;</span>  <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">baseurl</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;http://10.13.0.6/huronrepo&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This is my repo subclass based on my general base class.  I have a single repository, but could easily have another 5 or 10 as need arises (I&#8217;m keeping things simple for demo purposes).  Let&#8217;s look at another class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::centos</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">general::repo</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;mcollective&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">name</span>    <span class="p">=&gt;</span> <span class="s2">&quot;mcollective&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">&#39;stomp&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s a centos subclass off of the general base class.  We&#8217;re including our repo class and declaring a single package that requires our &#8220;huronrepo&#8221; yumrepo.  If we only needed to install a single package, we could use the &#8220;require&#8221; parameter; but if you assume that we will eventually need to install MULTIPLE packages, then this logic doesn&#8217;t scale. Just to keep things consistent, here&#8217;s my general base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">case</span> <span class="nv">$::operatingsystem</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;CentOS&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="kn">include</span> <span class="nc">general::centos</span> <span class="err">}</span>
</span><span class='line'>    <span class="err">&#39;Darwin&#39;</span><span class="nc">:</span> <span class="p">{</span> <span class="ss">include</span> <span class="ss">general</span><span class="p">::</span><span class="ss">osx</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>You can see that we include the general::centos class as long as Puppet is running on a CentOS box.  There&#8217;s one final piece to this puzzle - it&#8217;s the actual declaration and assignment of the Run Stages.  I&#8217;m doing this in my site.pp file.  Here&#8217;s a snippit of what&#8217;s in my site.pp file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline"># /etc/puppet/manifests/site.pp</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Exec</span> <span class="p">{</span> <span class="ss">path</span> <span class="err">=&amp;</span><span class="ss">gt</span><span class="err">;</span> <span class="s2">&quot;/usr/bin:/usr/sbin:/bin:/sbin&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Run Stages</span>
</span><span class='line'><span class="ss">stage</span> <span class="p">{</span> <span class="s1">&#39;pre&#39;</span><span class="err">:</span>
</span><span class='line'>  <span class="ss">before</span> <span class="p">=&gt;</span> <span class="nc">Stage</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Node Declaration</span>
</span><span class='line'><span class="ss">node</span> <span class="s1">&#39;server.whomever.com&#39;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">class</span> <span class="p">{</span> <span class="s1">&#39;general::repos&#39;</span><span class="err">:</span>
</span><span class='line'>    <span class="ss">stage</span> <span class="p">=&gt;</span> <span class="s1">&#39;pre&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s where we&#8217;ve declared a &#8220;pre&#8221; stage that needs to run before the &#8220;main&#8221; stage.  We don&#8217;t have to declare the &#8220;main&#8221; stage because Puppet uses that stage by default.  Next, we&#8217;re including the general::repos class inside our &#8216;server.whomever.com&#8217; node declaration and assigning it to the &#8220;pre&#8221; stage (which means that everything in that class will get configured prior to our &#8220;main&#8221; stage).  Remember that you can declare as many stages as you need and chain them all to setup the order that you want, but that can become very unmanageable very quickly.  I find it ideal to setup a &#8216;pre&#8217; stage for repo setup, and then setting up dependencies within class files.</p>

<h2>The World is Your Stage</h2>

<p>This might not be the &#8220;best&#8221; way to use Run Stages, but it works for me.  Hopefully this little writeup cements the concept for you too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting Started with The Luggage]]></title>
    <link href="http://glarizza.github.com/blog/2010/12/21/getting-started-with-the-luggage/"/>
    <updated>2010-12-21T09:47:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2010/12/21/getting-started-with-the-luggage</id>
    <content type="html"><![CDATA[<p>With the current movement in the Mac Community toward modular imaging strategies, there&#8217;s a spike in the need for properly formed package installers. Apple&#8217;s package format is well documented for its benefits and flaws and there are a string of applications that will help you create your perfect package (from Apple&#8217;s Packagemaker to the many third-party applications).  While all the various package creation applications will ultimately create a desirable package in the end, very few of them have the triple-threat of easy code-review, replication, and portability.  This is where The Luggage comes in.</p>

<p><a href="http://github.com/unixorn/luggage">The Luggage</a> is a packaging system based on GNU&#8217;s make command that is found on most every *nix-based operating system (OS X included).  Joe Block, the author, open-sourced the project based on an internal Google tool for creating packages with Makefiles.  By using Makefiles, every member of your team can quickly glance at the file and see exactly what is being inserted into a package.  Changes can be made and committed quickly, errors can be squashed without tearing apart .pkg files, and you can reproduce packages quickly and efficiently without wading through many GUI windows.</p>

<h2>Why do I need to Package?</h2>

<p>Many vendors already ship properly formatted package installers for their software - and for that we thank them.  There are still a couple of major software vendors that choose to use unique third-party package &#8220;wrappers&#8221; to install their software.  While this is fine if you only ever need to install that software on one machine, it makes software deployment&#8230;difficult.  Because of this, systems administrators need to re-package this software into a proper package installer that will deploy and install silently.</p>

<p>If you&#8217;re a fan of open-source software, you will find that many projects do not offer their software in Apple-friendly packages.  The Luggage will help you wrap their source files into a package format that can be distributed to your machines.</p>

<p>Finally, you may have a whole bevy of scripts that you use for configuration/customization of your clients.  These scripts can easily be deployed via ARD or wrapped into a payload-free package with a single postinstall script.  The Luggage will help you keep track of all your scripts and package them for distribution.</p>

<p>As I&#8217;ve said before, there are other third-party applications out there that will create a package to your needs.  Many will use snapshotting (or fseventsd monitoring) to create a package based on what&#8217;s changed on your system.  While this is lightning fast (in most cases), you will need to redo this whole process if something needs to be changed in the resultant package.</p>

<h2>How do we use The Luggage?</h2>

<p>As we said before, The Luggage is just a giant Makefile.  Make has its own unique language, so you need to obey its syntax and formatting standards.  I&#8217;ve linked to the <a href="http://www.gnu.org/software/make/manual/make.html">GNU make manual here</a> so you can get a quick overview of how it works (WARNING, it&#8217;s quite large), but this guide will cover all the basics you need to know to get started.</p>

<p>Note that while it is <strong>NOT NECESSARY TO COMPLETELY UNDERSTAND MAKE TO BEGIN USING THE LUGGAGE</strong>, it will help you out tremendously as you start to create complicated packages if you DO understand make&#8217;s nuances. This article may be long, but that&#8217;s only to make sure that the reader understands what is going on in the background.</p>

<h2>The luggage.make File</h2>

<p>The base of everything you will do with The Luggage is a file called luggage.make.  It is by no means definitive, and you&#8217;re encouraged to add to it should you encounter a situation where a recipe doesn&#8217;t exist for a directory into which you want to install files (Don&#8217;t worry, we&#8217;ll get into this later), but it does serve as the basis for all packages you&#8217;re going to be creating.</p>

<p>At the top of the file are all the variable declarations.  Anything that begins with SOMETHING=somethingelse is setting a variable that we will encounter later.  Many of these variables (such as PACKAGEMAKER, WORK_D, CP, INSTALL, and so on) are paths to various commands that we will need in our rules (setting absolute paths to common commands saves typing later and helps us avoid errors with things like PATH environment variables).  Dereferencing these variables in a Makefile is done with a syntax that looks like this -> ${CP} (this outputs the value of the CP variable, which is actually <strong>/bin/cp</strong>).  Note that you DO NOT use quotes when you set a variable (i.e. if you want to set the path to CP you do it with CP=/bin/cp and NOT by doing CP=&#8221;/bin/cp&#8221;) - if you DO use quotes, they will be included in the value of that variable (which will cause you all kinds of problems).</p>

<p>Next, we have the target stanzas.  A target (or a rule - I will use the word rule throughout the article) is setup to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        o-something: l_usr_bin
</span><span class='line'>        @-echo <span class="s2">&quot;Commands are entered here&quot;</span>
</span><span class='line'>        @-echo <span class="s2">&quot;Everything below our rule is executed&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, the <strong>target</strong>, or <strong>rule</strong>, is called <strong>do-something</strong> and has dependencies based on ANOTHER rule that&#8217;s called <strong>l_usr_bin</strong>.  Below this line is called our <strong>recipe</strong>, and right now there are two echo commands.  If the above code was in a blank text file called Makefile we could execute the two echo commands by running the following command from the command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    make <span class="k">do</span>-something
</span></code></pre></td></tr></table></div></figure>


<p>This would in turn echo the two lines of text below the do-something rule (This is not totally true - since we haven&#8217;t defined a rule for l_usr_bin it would probably error out, but I&#8217;ve kept that dependency in the above example to show you how a rule works.).  Looking specifically at luggage.make, the target stanzas define the behavior for The Luggage&#8217;s various behaviors (make pkg, make dmg, make zip, and so on).  Note that since many of these rules have dependencies on OTHER rules, a simple command of <strong>make pkg</strong> will trigger.</p>

<p>Next, you will encounter the Target directory rules.  This is the part of the luggage.make file that you may need to edit.  Joe has done a great job of defining the most popular directories into which you will install files/applications/etc. but it would be impossible for him to define EVERY location that you could possibly need.  Here is the structure of creating a Directory Rule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        l_etc_puppet: l_etc
</span><span class='line'>        @sudo mkdir -p <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chown -R root:wheel <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span></code></pre></td></tr></table></div></figure>


<p>This rule will create an /etc/puppet directory in Luggage&#8217;s working directory (The variable WORK_D will be used frequently - it&#8217;s the temporary directory that The Luggage creates to simulate the target volume onto which it&#8217;s installing files.  Everything following ${WORK_D} will be the <strong>EXACT PATH</strong> into which files will be installed on the machine that runs your package.)  These Directory Rules become very important when we create custom Makefiles because they serve as dependencies which create the directories in The Luggage&#8217;s Working Directory. In a nutshell, if you&#8217;re installing files into a directory with The Luggage, you need to have a Directory Rule that creates this directory first.  Bottom Line: if you don&#8217;t FIND a Directory Rule for a directory where you will be installing files, then you&#8217;ll need to create one.</p>

<p>Finally are the File Packaging Rules.  These are handy shortcut rules that will keep your makefiles very short and readable.  In a nutshell, Joe has defined some of the most common directories to which files are installed and created one-line commands that will install specific files into those directories.  For example, say you were creating a custom Makefile in a directory that also had a launchd plist called <strong>com.foo.bar.plist</strong> in it.  If ALL you needed to do was create a package that installed that launchd plist into the /Library/LaunchDaemons directory you could setup your Makefile like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>install_foo_launchd_plist
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.foo
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>pack-Library-LaunchDaemons-com.foo.bar.plist
</span></code></pre></td></tr></table></div></figure>


<p>The PAYLOAD variable tells The Luggage which rules to execute.  In this case, it&#8217;s executing the File Packaging Rule for launchd plists (pack-Library-LaunchDaemons-%) that creates the ${WORK_D}/Library/LaunchDaemons directory, installs the com.foo.bar.plist file into it, sets the correct permissions, and then executes the Packagemaker command line tool to create your package installer. Congratulations, you created a package in 5 lines of code!</p>

<h2>Preparing for using The Luggage</h2>

<p>The Luggage is fairly self contained, but it DOES use Apple&#8217;s Packagemaker command line tool - and the way to install THAT is to download and install the Developer Tools for your computer&#8217;s OS version (There are different Developer Tools packages for 10.6, 10.5, and so on).  The Developer Tools can be downloaded from <a href="http://developer.apple.com">Apple&#8217;s Developer Site</a>, but you must create a (free) developer account first.  If you&#8217;re a Mac sysadmin, you should already have all of this.</p>

<p>Once the Developer Tools have been installed you will then need to install The Luggage.  You can use The Luggage to create an installer package for The Luggage (Weird, yes) by first <a href="http://github.com/unixorn/luggage">downloading the source code from Github.</a>  Just click on the big Downloads button in the upper right corner of the screen and download a zip version of the files.  From there, double-click on the downloaded zip file to open it, open up Terminal and change to the folder that was created which contains The Luggage&#8217;s source code, and execute the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo make pkg
</span></code></pre></td></tr></table></div></figure>


<p>This will create an installer package which can be run.  This package installs The Luggage into the /usr/local/share/luggage directory (Don&#8217;t believe me? Check the Makefile for your self!).  You&#8217;re now ready to use The Luggage!</p>

<p>Before we get into the package creation examples, we need to talk about directory structure and version control systems (svn, hg, git, etc&#8230;).  When you create new packages with The Luggage, it&#8217;s necessary to create a new Makefile in a new directory.  I like to use the /usr/local/share/luggage/examples directory to create my packages.  The easiest way to begin a new package is to copy a directory that contains a working Makefile and simply tailor it to your needs.  Unless your job is SOLELY packaging (or you&#8217;re a unix graybeard), you&#8217;re NOT going to remember all the syntax and nuances of make.  Don&#8217;t re-create the wheel - just copy and edit.</p>

<p>Next, you&#8217;re going to want to backup your files and/or have a versioning system.  Version control systems (like Subversion, Mercurial, Git, and the like) are becoming increasingly popular <a href="http://www.agileweboperations.com/the-state-of-devops">with the current DevOps movement</a>, so it might be a good idea to start playing with one NOW while you&#8217;re learning a new skill!  If you&#8217;re TOTALLY new to this concept, <a href="http://help.github.com/mac-git-installation/">I recommend using git</a>, but it&#8217;s entirely up to you.  <a href="http://github.com/huronschools/luggage">I maintain a git repository of my Luggage fork</a> that&#8217;s open to anyone to review and borrow.  If you decide to use something like Git, well then GOOD ON YA, MAN!  If not, make sure you have a backup of your Makefiles.  They&#8217;re small files; make two backups :)</p>

<h2>Package Creation Examples</h2>

<p>Now that we&#8217;ve described how make works, how luggage.make works, given a quick example of how to create a package in 5 lines, and had the installation/backup talk let&#8217;s walk you through some basic package creation examples. We&#8217;ll create packages that install an application, create a package that installs printers and executes a postinstall script, create a package that installs source code in many directories, and finally create a complex Makefile that uses variables and bash commands.</p>

<h2>An Application Package</h2>

<p>The most common packages will simply install an application file into the /Applications folder on your computer.  Since .app files are actually bundles (a directory that contains subdirectories of executable code), we will need to use tar to wrap these bundles into a single file.  From there we can have The Luggage untar the application into the correct folder. <a href="https://github.com/unixorn/luggage/blob/master/examples/firefox/Makefile">Joe&#8217;s Firefox example</a> does this, but he also has an added step of curling the tarred/bzipped application from a web server.  I&#8217;m going to skip that step (for now) so you understand how the basic process works, but it&#8217;s a best practice to use the curl method so you can keep your applications up-to-date on your fileserver without having to copy the new files to your luggage directory every time.</p>

<p>Let&#8217;s first create the /usr/local/share/luggage/examples/calculator directory and then make a copy of /Applications/Calculator.app into the /usr/local/share/luggage/examples/calculator directory.  Next, lets open Terminal and change to our /usr/local/share/luggage/examples/calculator directory.  Finally, run the following command to tar.bz2 our Calculator.app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    tar cvfj Calculator.app.tar.bz2 Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>If you did it correctly, it should create the Calculator.app.tar.bz2 file that we need for The Luggage.  Make sure this file is in the SAME directory (and level - so don&#8217;t create subfolders) as the Makefile we&#8217;re going to create.  You can actually delete the Calculator.app copy that we created - we won&#8217;t need it.  From there, our Makefile is simple - it should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>Calculator_Install
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.yourdomain
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>unbz2-applications-Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it!  The PAYLOAD variable is the magic variable here - it contains the rule(s) that are to be executed in creating our package.  The unbz2-applications-% File Packaging Rule is defined in our luggage.make file (which we&#8217;ve included at the top of our Makefile), so we don&#8217;t NEED anything else in our Makefile.  <strong>MAKE SURE</strong> that the capitalization and spelling of Calculator.app in &#8220;unbz2-applications-Calculator.app&#8221; and your &#8220;Calculator.app.tar.bz2&#8221; files are IDENTICAL or this package will NOT be created (make relies on this).</p>

<h2>UPDATED: An easier Application Package</h2>

<p>Joe has actually created a Ruby script that will perform all of the actions outlined in the previous example for you.  It&#8217;s called app2luggage.rb and it can save you a few steps if you know how to use it.  Let&#8217;s take a look and see what we need to use it.</p>

<p>The first thing you will need to do is install the trollop rubygem as that&#8217;s what app2luggage.rb uses to parse its options.  You can do this with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo gem install trollop
</span></code></pre></td></tr></table></div></figure>


<p>Next, make sure the app2luggage.rb script exists in your /usr/local/share/luggage directory.  Finally, let&#8217;s run the command with the following arguments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo /usr/local/share/luggage/app2luggage.rb -a /Applications/Calculator.app -i /usr/local/share/luggage/examples/Calculator_Application/ -l /usr/local/share/luggage/luggage.make -r com.huronhs -p Calculator_Application
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s what each argument means:</p>

<ol>
<li>-a is the path to the Application we want to tar up and install with The Luggage - we&#8217;re using the path to Calculator.app for now</li>
<li>-i is the path to the folder that app2luggage.rb will create that contains our Makefile and tarred up application.  This folder SHOULD NOT EXIST or app2luggage.rb will exit (so as not to overwrite your data).</li>
<li>-l is the path to our luggage.make file</li>
<li>-r is the reverse domain for our organization</li>
<li>-p is the package id for the Makefile</li>
</ol>


<p>There are other arguments available, simply run app2luggage.rb with the &#8211;help argument to see them all.  Once app2luggage.rb runs successfully, it will create the directory you specified in the -i argument and populate it with a Makefile and the tarred up application.  The only thing left to do is to make your pkg, zip, or dmg.</p>

<h2>Installing a printer with a preinstall script</h2>

<p>One of the most popular solutions I offer with using The Luggage is to create a package that will install a printer and then install a pre-configured PPD file that sets all the initial settings for the printer.  I do this with Puppet currently, and I know it&#8217;s popular in Munki too.  You can also optionally install a specific driver (if the drivers for your printer aren&#8217;t already on your machines).  For those people who like to skip ahead, <a href="https://github.com/huronschools/luggage/tree/master/examples/hhs_printers/Printserver%20Managed/Office_9050">I have this example on my luggage repo</a>.</p>

<p>This Makefile demonstrates the use of a preinstall/preflight script (which isn&#8217;t actually installed into the payload of the package).  The Luggage has a special packaging rule for this called pack-script-% that works so long as the name of your script corresponds exactly with what you write in the PAYLOAD variable.  This file also demonstrates the use of multiple rules in the PAYLOAD variable by using the \ character.  While this isn&#8217;t difficult to understand, it is a necessary syntax.</p>

<p><a href="https://github.com/huronschools/luggage/blob/master/examples/hhs_printers/Printserver%20Managed/Office_9050/preflight">My preflight script is right here</a> for those who are interested.  It&#8217;s copied into the directory we create that contains our makefile and I name it preflight.  Note that it contains variables that need to be changed (all of which are at the top of the script) before you deploy this package.</p>

<p>Next, we need to get a .ppd file that contains all the configuration data for our printer.  The easiest way to do this is to install your printer on a demo machine using the EXACT SAME SETTINGS that will be configured in your script (protip: actually RUN the script on your computer first), configure it how you want (number of trays, memory settings, type of finisher, etc&#8230;), and then open the /etc/cups/ppd directory on your model computer.  Inside should be a .ppd file for your printer containing all the settings you&#8217;ve just configured.  Copy this .ppd file into the folder that contains your Makefile and preflight script.  Mine (in this example) will be called psm_HHS_Office_9050.ppd</p>

<p>Now, let&#8217;s look at our Makefile:</p>

<figure class='code'><figcaption><span>Managed Printer Makefile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>HHS_Main_Office_9050_Managed_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-hp-ppd <span class="se">\</span>
</span><span class='line'>        pack-script-preflight
</span><span class='line'>
</span><span class='line'>    pack-hp-ppd: l_etc_cups_ppd
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./psm_HHS_Office_9050.ppd <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chmod 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chown root:_lp <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The first thing you should notice is that our PAYLOAD variable starts with a \ and has three lines.  The \ signifies that the contents of our variable spans multiple lines.  In reality, the value of PAYLOAD is actually &#8220;pack-hp-ppd pack-script-preflight&#8221; but it&#8217;s formatted so it&#8217;s easier to read.  Next, notice that the pack-script-preflight rule contains the word &#8220;preflight&#8221; after pack-script-.  This means that our script must be named preflight (EXACTLY - case is sensitive here).  Finally, we&#8217;ve also specified a pack-hp-ppd rule.  Since luggage.make DOES NOT define this rule, we&#8217;ve defined it in our Makefile.</p>

<p>The pack-hp-ppd rule has a dependency on the l_etc_cups_ppd rule.  This rule IS defined in luggage.make (well, it is for me - I can&#8217;t remember if I created it or not.  If it isn&#8217;t there for you, then you&#8217;ll need to create it using the other folder creation rules as a guide) - and it creates the /etc/cups/ppd folder structure that we need in our package.  Lets look at the three lines which are called our <strong>recipe</strong>*:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="err">@sudo</span> <span class="err">${CP}</span> <span class="err">./psm_HHS_Office_9050.ppd</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="err">@sudo</span> <span class="err">chmod</span> <span class="err">644</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="nf">@sudo chown root</span><span class="o">:</span><span class="m">_lp ${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line references the CP variable (if you remember - its value is /bin/cp) to copy the psm_HHS_Office_9050.ppd file from the directory that contains our Makefile into Luggage&#8217;s working directory/etc/cups/ppd.  The second line sets its mode to 644 (to match the mode for all .ppd files in that directory), and the third line sets the owner to root and the group to _lp (note that this group is ONLY available in 10.5 and 10.6 machines - so you&#8217;ll need another package for 10.4 clients or below).</p>

<p>That&#8217;s it!  The resultant package will run the preflight script and then install the correct .ppd file after the script is run.  This package will successfully install and configure your printer in one fell swoop.</p>

<h2>Installing files into multiple directories</h2>

<p>So far our Makefiles have been pretty easy.  In fact, most of them have been a couple of lines.  Lets look at a package that installs files into multiple locations.  There&#8217;s a cool open source tool called <a href="http://github.com/ripienaar/angelia">Angelia that was created by R.I Pienaar</a>.  I use it to send alerts to my iPhone and to also process Nagios Alerts.  The problem is that it&#8217;s only packaged for Linux machines.  Since I manage Mac machines, I thought I&#8217;d lend R.I. a hand and create a package installer for it.  <a href="https://github.com/huronschools/luggage/tree/master/examples/angelia">This package is also on my luggage repo</a> if you want to work ahead.  Let&#8217;s look at the Makefile:</p>

<figure class='code'><figcaption><span>Angelia Recipe  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Angelia Package Creation:</span>
</span><span class='line'>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>Angelia_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-angelia-etc <span class="se">\</span>
</span><span class='line'>        pack-angelia-binaries <span class="se">\</span>
</span><span class='line'>        pack-angelia-lib <span class="se">\</span>
</span><span class='line'>        pack-angelia-spool <span class="se">\</span>
</span><span class='line'>        pack-angelia-log <span class="se">\</span>
</span><span class='line'>        pack-angelia-launchd
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    pack-angelia-launchd: l_Library_LaunchDaemons
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> net.devco.angelia.plist <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>      @sudo chmod -R 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>
</span><span class='line'>    pack-angelia-binaries: l_usr_sbin
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-send
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-spoold.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-spoold
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-nagios-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-nagios-send
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin
</span><span class='line'>
</span><span class='line'>    pack-angelia-lib: l_Library_Ruby_Site_1_8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./angelia <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>
</span><span class='line'>    pack-angelia-etc: l_etc_angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./templates <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.cfg <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./COPYING <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./README.markdown <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>
</span><span class='line'>    pack-angelia-log: l_var_log_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>    pack-angelia-spool: l_var_spool_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s definitely longer, but I don&#8217;t think it&#8217;s any more complex than the examples we&#8217;ve seen before.  The PAYLOAD variable spans multiple lines using the \ character and I&#8217;ve defined all the custom rules.  All of the rules depend on <a href="https://github.com/huronschools/luggage/blob/master/luggage.make">folder rules in my luggage.make file</a> (which were created if they didn&#8217;t exist before), and the recipes inside those rules are extremely simple to navigate (mainly copying files and changing permissions).  Creating a script that makes this package would be QUITE A BIT longer than this Makefile, and the Makefile itself took less than 3 minutes to create.  The only caveat is that we need to make sure all the files/directories we&#8217;re copying into Luggage&#8217;s WORK_D directory are in the folder that contains the Makefile.  Because of this, anytime Angelia is updated I will need to copy over new files.</p>

<p>It would be much easier to create a Makefile that downloaded the current version of all of these files before it copied them into our package&#8230;</p>

<h2>Creating a more complex Makefile</h2>

<p>The basis of this example was my thought that it would be MUCH easier for me to have a Makefile that downloaded the newest versions of the files that I need before it copies them into the package.  Make supports this through its support of shell commands and variables - it only requires you to code it up.  Let&#8217;s look at a package I created for Marionette-Collective.</p>

<p><a href="http://github.com/puppetlabs/marionette-collective">Marionette-Collective is awesome software</a> (also created by R.I Pienaar and now owned by Puppet Labs) that allows you to communicate with multiple nodes at once.  They DID have a script that created their packages, but I wanted to create a Makefile that would create a package of ANY version of their software.  Let&#8217;s look at the Makefile first and I&#8217;ll break it down:</p>

<figure class='code'><figcaption><span>MCollective Recipe  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Example:  A dynamic installer for Marionette-Collective</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Author:  Gary Larizza</span>
</span><span class='line'><span class="c">    #  Created: 12/17/2010</span>
</span><span class='line'><span class="c">    #  Last Modified: 12/18/2010</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Description:  This Makefile will download the version of MCollective specified</span>
</span><span class='line'><span class="c">    #    in the PACKAGE_VERSION variable from the Puppet Labs website, untar it,</span>
</span><span class='line'><span class="c">    #    and then install the source files into their Mac-specific locations.  </span>
</span><span class='line'><span class="c">    #    The MAJOR and MINOR versions must be specified for the Info.plist file</span>
</span><span class='line'><span class="c">    #    that Packagemaker requires, but I use awk on the PACKAGE_VERSION to </span>
</span><span class='line'><span class="c">    #    get these.  See inline comments.</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">    # Luggage Variables:</span>
</span><span class='line'><span class="c">    #    If the TYPE variable isn&#39;t specified via the CLI, we will install everything</span>
</span><span class='line'><span class="c">    #    into the resultant package</span>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Full
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.puppetlabs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>        pack-mc-libexec <span class="se">\</span>
</span><span class='line'>        pack-mc-binaries <span class="se">\</span>
</span><span class='line'>        pack-mc-lib <span class="se">\</span>
</span><span class='line'>        pack-mc-config <span class="se">\</span>
</span><span class='line'>        pack-mc-config-server <span class="se">\</span>
</span><span class='line'>        pack-mc-config-client <span class="se">\</span>
</span><span class='line'>        pack-mc-launchd <span class="se">\</span>
</span><span class='line'>        pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>        pack-mc-preflight-all
</span><span class='line'>
</span><span class='line'><span class="c">    # Variable Declarations:  </span>
</span><span class='line'><span class="c">    #    Any variable can be set from the command line by doing this:</span>
</span><span class='line'><span class="c">    #    &quot;make pkg PACKAGE_VERSION=1.0.0&quot;</span>
</span><span class='line'>    <span class="nv">PACKAGE_VERSION</span><span class="o">=</span>1.0.0
</span><span class='line'>    <span class="nv">PACKAGE_MAJOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$1}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">PACKAGE_MINOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$2$$3}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">MCFILE</span><span class="o">=</span>mcollective-<span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="nv">MCURL</span><span class="o">=</span>http://puppetlabs.com/downloads/mcollective/<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # Package Creation Limiters:</span>
</span><span class='line'><span class="c">    #    These if-statements will check for one of three values for the TYPE variable:</span>
</span><span class='line'><span class="c">    #    &quot;COMMON, CLIENT, or BASE&quot;  If either of these values are present (CASE SENSITIVE)</span>
</span><span class='line'><span class="c">    #    the PAYLOAD variable will be changed to limit what is installed into the package.</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # COMMON Package:</span>
</span><span class='line'><span class="c">    #    This package includes the Ruby libraries and MCollective plugins with nothing else.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},COMMON)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-libexec <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-common
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Common
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # CLIENT Package:</span>
</span><span class='line'><span class="c">    #    This package includes the MCollective Binaries and the configuration file for</span>
</span><span class='line'><span class="c">    #    MCollective&#39;s client binaries.  </span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},CLIENT)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-binaries <span class="se">\</span>
</span><span class='line'>          pack-mc-config-client <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-client
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Client
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # BASE Package:</span>
</span><span class='line'><span class="c">    #    This package includes the mcollectived daemon, Ruby Libraries, a launchd plist</span>
</span><span class='line'><span class="c">    #    to call mcollectived, and the configuration files for the MCollective server.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},BASE)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-config-server <span class="se">\</span>
</span><span class='line'>          pack-mc-launchd <span class="se">\</span>
</span><span class='line'>          pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-base
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Base
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will curl the selected version of MCollective and untar it into the directory</span>
</span><span class='line'><span class="c">    #    in which the Makefile resides.</span>
</span><span class='line'>    unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>:
</span><span class='line'>      curl <span class="k">${</span><span class="nv">MCURL</span><span class="k">}</span> -o <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">TAR</span><span class="k">}</span> xzf <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will install MCollective&#39;s plugin files to /usr/libexec/mcollective</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
