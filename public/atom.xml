<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Shit Gary Says]]></title>
  <link href="http://garylarizza.com/atom.xml" rel="self"/>
  <link href="http://garylarizza.com/"/>
  <updated>2014-02-18T08:56:26-08:00</updated>
  <id>http://garylarizza.com/</id>
  <author>
    <name><![CDATA[Gary larizza]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building a Functional Puppet Workflow Part 2: Roles and Profiles]]></title>
    <link href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-2/"/>
    <updated>2014-02-17T14:01:37-08:00</updated>
    <id>http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-2</id>
    <content type="html"><![CDATA[<p>In my <a href="http://www.garylarizza.com/blog/2014/02/17/puppet-workflow-part-1/">first post</a>, I talked about writing functional component
modules. Well, I didn&rsquo;t really do much detailing other than pointing out
key bits of information that tend to cause problems. In this post, I&rsquo;ll
describe the next layer to the functional Puppet module workflow.</p>

<p>People usually stop once they have a library of component modules (whether
hand-written, taken from Github, or pulled from <a href="http://forge.puppetlabs.com">The Forge</a>). The idea
is that you can classify all of your nodes in <code>site.pp</code>, the Puppet
Enterprise Console, The Foreman, or with some other ENC, so why not just
declare all your classes for every node when you need them?</p>

<p>Because that&rsquo;s a lot of extra work and opportunities for fuckups.</p>

<p>People recognized this, so in the EARLY days of Puppet they would create node
blocks in <code>site.pp</code> and use inheritance to inherit from those blocks. This was
the right IDEA, but probably not the best PLACE for it. Eventually, &lsquo;Profiles&rsquo;
were born.</p>

<p>The idea of &lsquo;Roles and Profiles&rsquo; originally came from a piece that
<a href="http://www.craigdunn.org/2012/05/239/">Craig Dunn wrote</a> while he worked for the BBC, and then
<a href="http://sysadvent.blogspot.com/2012/12/day-13-configuration-management-as-legos.html">Adrien Thebo also wrote a piece</a> that documents the same sort of pattern.
So why am I writing about it a THIRD time? Well, because I feel it&rsquo;s only a PIECE
of an overall puzzle. The introduction of Hiera and other awesome tools (like R10k,
which we will get to on the next post) still make Roles and Profiles VIABLE, but
they also extend upon them.</p>

<p>One final note before we move on &ndash; the terms &lsquo;Roles&rsquo; and &lsquo;Profiles&rsquo; are ENTIRELY
ARBITRARY. They&rsquo;re not magic reserve words in Puppet, and you can call them
whatever the hell you want. It&rsquo;s also been pointed out that Craig MIGHT have
misnamed them (a ROLE should be a model for an individual piece of tech, and a
PROFILE should probably be a group of roles), but, like all good Puppet Labs
employees &ndash; we suck at naming things.</p>

<h2>Profiles: technology-specific wrapper classes</h2>

<p>A profile is simply a wrapper class that groups Hiera lookups and class
declarations into one functional unit. For example, if you wanted Wordpress
installed on a machine, you&rsquo;d probably need to declare the apache class to
get Apache setup, declare an <code>apache::vhost</code> for the Wordpress directory,
setup a MySQL database with the appropriate classes, and so on. There are
a lot of components that go together when you setup a piece of technology,
it&rsquo;s not just a single class.</p>

<p>Because of this, a profile exists to give you a single class you can include
that will setup all the necessary bits for that piece of technology (be it
Wordpress, or Tomcat, or whatever).</p>

<p>Let&rsquo;s look at a simple profile for Wordpress:</p>

<figure class='code'><figcaption><span>profiles/manifests/wordpress.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">profiles::wordpress</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Hiera lookups</span>
</span><span class='line'>  <span class="nv">$site_name</span>               <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::site_name&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_user_password</span> <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_user_password&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$mysql_root_password</span>     <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::mysql_root_password&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_host</span>       <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_host&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_name</span>       <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_name&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_password</span>   <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_password&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_user</span>          <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_user&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_group</span>         <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_group&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_docroot</span>       <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_docroot&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_port</span>          <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_port&#39;</span><span class="p">)</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Create user</span>
</span><span class='line'>  <span class="nc">group</span> <span class="p">{</span> <span class="s1">&#39;wordpress&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">name</span>   <span class="p">=&gt;</span> <span class="nv">$wordpress_group</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nc">user</span> <span class="p">{</span> <span class="s1">&#39;wordpress&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>   <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">gid</span>      <span class="p">=&gt;</span> <span class="nv">$wordpress_group</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">password</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_user_password</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">name</span>     <span class="p">=&gt;</span> <span class="nv">$wordpress_group</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">home</span>     <span class="p">=&gt;</span> <span class="nv">$wordpress_docroot</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Configure mysql</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;mysql::server&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">root_password</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_root_password</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;mysql::bindings&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">php_enable</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Configure apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache::mod::php</span>
</span><span class='line'>  <span class="nc">apache::vhost</span> <span class="p">{</span> <span class="nv">$::fqdn</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">port</span>    <span class="p">=&gt;</span> <span class="nv">$wordpress_port</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">docroot</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_docroot</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Configure wordpress</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;::wordpress&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">install_dir</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_docroot</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">db_name</span>     <span class="p">=&gt;</span> <span class="nv">$wordpress_db_name</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">db_host</span>     <span class="p">=&gt;</span> <span class="nv">$wordpress_db_host</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">db_password</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_db_password</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Name your profiles according to the technology they setup</h3>

<p>Profiles are technology-specific, so you&rsquo;ll have one to setup wordpress, and
tomcat, and jenkins, and&hellip;well, you get the picture. You can also namespace
your profiles so that you have <code>profiles::ssh::server</code> and
<code>profiles::ssh::client</code> if you want. You can even have
<code>profiles::jenkins::tomcat</code> and <code>profiles::jenkins::jboss</code> or however you need
to namespace according to the TECHNOLOGIES you use. You don&rsquo;t need to include
your environment in the profile name (a la <code>profiles::dev::tomcat</code>) as the bits
of data that make the dev environment different from production should come
from <strong>HIERA</strong>, and thus aren&rsquo;t going to be different on a per-profile basis.
You CAN setup profiles according to your business unit if multiple units use
Puppet and have different setups (a la <code>security::profiles::tomcat</code> versus
<code>ops::profiles::tomcat</code>), but the GOAL of Puppet is to have one main set of
modules that every group uses (and the Hiera data being different for every
group). That&rsquo;s the GOAL, but I&rsquo;m pragmatic enough to understand that not
everywhere is a shiny, happy &lsquo;DevOps Garden.&rsquo;</p>

<h3>Do all Hiera lookups in the profile</h3>

<p>You&rsquo;ll see that I declared variables and set their values with Hiera lookups.
The profile is the place for these lookups because the profile collects all
external data and declares all the classes you&rsquo;ll need. In reality, you&rsquo;ll
<strong>USUALLY</strong> only see profiles looking up parameters and declaring classes
(i.e. declaring users and groups like I did above will USUALLY be left to
component classes).</p>

<p>I do the Hiera lookups first to make it easy to debug from where those values
came. I don&rsquo;t rely on <a href="http://docs.puppetlabs.com/hiera/1/puppet.html#automatic-parameter-lookup">&lsquo;Automatic Parameter Lookup&rsquo;</a> in Puppet
3.x.x because it can be &lsquo;magic&rsquo; for people who aren&rsquo;t aware of it (for people
new to Puppet, it&rsquo;s much easier to see a function call and trace back what it
does rather than experience Puppet doing something unseen and wondering what
the hell happened).</p>

<p>Finally, you&rsquo;ll notice that my Hiera lookups have <strong>NO DEFAULT VALUES</strong> &ndash; this
is <strong>BY DESIGN!</strong>  For most people, their Hiera data is <strong>PROBABLY</strong> located in
a separate repository as their Puppet module data. Imagine making a change to
your profile to have it lookup a bit of data from Hiera, and then imagine you
FORGOT to put that data into Hiera. What happens if you provide a default value
to Hiera? The catalog compiles, that default value gets passed down to the
component module, and gets enforced on disk. If you have good tests, you MIGHT
see that the component you configured has a bit of data that&rsquo;s not correct, but
what if you don&rsquo;t have a great post-Puppet testing workflow? Puppet will
correctly set this default value, according to Puppet everything is green and
worked just fine, but now your component is setup incorrectly. That&rsquo;s one of
the WORST failures &ndash; the ones that you don&rsquo;t catch.  Now, imagine you DON&rsquo;T
provide a default value. In THIS case, Puppet will raise a compilation error
because a Hiera lookup didn&rsquo;t return a value. You&rsquo;ll catch your error before
anything gets pushed to Production and you can catch the screwup. This is
a MUCH better solution.</p>

<h3>Use parameterized class declarations and explicitly pass values you care about</h3>

<p>The parameterized class declaration syntax can be dangerous. The difference
between the <code>include</code> function and the parameterized class syntax is that
the <code>include</code> function is idempotent. You can do the following in a Puppet
manifest, and Puppet doesn&rsquo;t raise an error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include apache
</span><span class='line'>include apache
</span><span class='line'>include apache</span></code></pre></td></tr></table></div></figure>


<p>This is because the <code>include</code> function checks to see if the class is in the
catalog. If it ISN&rsquo;T, then it adds it. If it IS, then it exits cleanly. The
<code>include</code> function is your pal.</p>

<p>Consider THIS manifest:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class { 'apache': }
</span><span class='line'>include apache
</span><span class='line'>include apache</span></code></pre></td></tr></table></div></figure>


<p>Does this work?  Yep.  The parameterized class syntax adds the class to the
catalog, the include function detects this and exits cleanly twice.  What
about THIS manifest:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include apache
</span><span class='line'>class { 'apache': }
</span><span class='line'>include apache</span></code></pre></td></tr></table></div></figure>


<p>Does THIS work?  Nope!  Puppet raises a compilation error because a class was
declared more than once in a catalog.  Why?  Well, consider that Puppet is
&lsquo;declarative&rsquo;&hellip;all the way up until it isn&rsquo;t.  Puppet&rsquo;s PARSER reads from the
top of the file to the bottom of the file, and we have a single-pass parser
when it comes to things like setting variables and declaring classes. When
the parser hits the first include function, it adds the class to the catalog.
The parameterized class syntax, however, is a honey badger: it doesn&rsquo;t give
a shit. It adds a class to the catalog regardless of whether it already exists
or not. So why would we EVER use the parameterized class declaration syntax?
We need to use it because the include function doesn&rsquo;t allow you to pass
parameters when you declare a class.</p>

<p>So wait &ndash; why did I spend all this time explaining why the parameterized class
syntax is more dangerous than the include function <strong>ONLY</strong> to recommend its
use in profiles?  For two reasons:</p>

<ul>
<li>We need to use it to pass parameters to classes</li>
<li>We&rsquo;re wrapping its use in a class that we can <strong>IN TURN</strong> declare with the <code>include</code> function</li>
</ul>


<p>Yes, we can get the best of BOTH worlds, the ability to pass parameters and
the use of our pal the <code>include</code> function, with this wrapper class. We&rsquo;ll see
the latter usage when we come to roles, but for now let&rsquo;s focus on passing
parameter values.</p>

<p>In the first section, we set variables with Hiera lookups, now we can pass
those variables to classes we&rsquo;re declaring with the parameterized class syntax.
This allows the declaration of the class to be static, but the parameters we
pass to that class to change according to the Hiera hierarchy. We&rsquo;ve explicitly
called the <code>hiera</code> function, so it makes it easier to debug, and we&rsquo;re explicitly
passing parameter values so we know definitively which parameters are being
passed (and thus are overriding default values) to the component module. Finally,
since our component modules do NOT use Hiera at all, we can be sure that if we&rsquo;re
not passing a parameter that it&rsquo;s getting its value from the default set in the
module&rsquo;s <code>::params</code> class.</p>

<p>Everything we do here is meant to make things easier to debug when it&rsquo;s 3am and
things aren&rsquo;t working. Any asshole can do crazy shit in Puppet, but a seasoned
sysadmin writes their code for ease of debugging during 3am pages.</p>

<h3>An annoying Puppet bug &ndash; top-level class declarations and profiles</h3>

<p><a href="http://projects.puppetlabs.com/issues/2053">Oh, ticket 2053</a>, how terrible are you? This is one of those bug numbers
that I can remember by heart (like <a href="http://projects.puppetlabs.com/issues/8040">8040</a> and <a href="http://projects.puppetlabs.com/issues/86">86</a>). Puppet has
the ability to do &lsquo;relative namespacing&rsquo;, which allows you to declare a variable
called <code>$port</code> in a class called <code>$apache</code> and refer to it as <code>$port</code> instead
of fully-namespacing the variable, and thus having to call it <code>$apache::port</code>
inside the <code>apache</code> class. It&rsquo;s a shortcut &ndash; you can STILL refer to the variable
as <code>$apache::port</code> in the class &ndash; but it comes in handy. The PROBLEM occurs when
you create a profile, as we did above, called <code>profiles::wordpress</code> and you try
to declare a class called <code>wordpress</code>.  If you do the following inside the
<code>profiles::wordpress</code> class, what class is being declared:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include wordpress</span></code></pre></td></tr></table></div></figure>


<p>If you think you&rsquo;re declaring a wordpress class from within a wordpress module
in your Puppet modulepath, you would be wrong.  Puppet ACTUALLY thinks you&rsquo;re
trying to declare <code>profiles::wordpress</code> because you&rsquo;re INSIDE the <code>profiles::wordpress</code>
class and it&rsquo;s doing relative namespacing (i.e. in the same way you refer to <code>$port</code>
and ACTUALLY mean <code>$apache::port</code> it thinks you&rsquo;re referring to <code>wordpress</code> and
ACTUALLY mean <code>profiles::wordpress</code>.</p>

<p>Needless to say, this causes LOTS of confusion.</p>

<p>The solution here is to declare a class called <code>::wordpress</code> which tells Puppet
to go to the top-level namespace and look for a module called <code>wordpress</code> which
has a top-level class called <code>wordpress</code>. It&rsquo;s the same reason that we refer to
Facter Fact values as <code>$::osfamily</code> instead of <code>$osfamily</code> in class definitions
(because you can declare a local variable called <code>$osfamily</code> in your class).
This is why in the profile above you see this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class { '::wordpress':
</span><span class='line'>  install_dir =&gt; $wordpress_docroot,
</span><span class='line'>  db_name     =&gt; $wordpress_db_name,
</span><span class='line'>  db_host     =&gt; $wordpress_db_host,
</span><span class='line'>  db_password =&gt; $wordpress_db_password,
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>When you use profiles and roles, you&rsquo;ll need to do this namespacing trick when
declaring classes because you&rsquo;re frequently going to have a <code>profile::&lt;sometech&gt;</code>
that will declare the <code>&lt;sometech&gt;</code> top-level class.</p>

<h2>Roles: business-specific wrapper classes</h2>

<p>How do you refer to your machines? When I ask you about that cluster over
there, do you say &ldquo;Oh, you mean the machines with java 1.6, apache, mysql,
etc&hellip;&rdquo;?  I didn&rsquo;t think so. You usually have names for them, like the
&ldquo;internal compute cluster&rdquo; or &ldquo;app builder nodes&rdquo; or &ldquo;DMZ repo machines&rdquo; or
whatever. These names are your Roles. Roles are just the mapping of your
machine&rsquo;s names to the technology that should be ON them. In the past we had
descriptive hostnames that afforded us a code for what the machine &lsquo;did&rsquo; &ndash;
roles are just that mapping for Puppet.</p>

<p>Roles are namespaced just like profiles, but now it&rsquo;s up to your organization
to fill in the blanks. Some people immediately want to put environments into
the roles (a la <code>roles::uat::compute_cluster</code>), but that&rsquo;s usually not necessary
(as MOST LIKELY the compute cluster nodes have the SAME technology on them
when they&rsquo;re in dev versus when they&rsquo;re in prod, it&rsquo;s just the DATA &ndash; like
database names, VIP locations, usernames/passwords, etc &ndash; that&rsquo;s different.
Again, these data differences will come from Hiera, so there should be no reason
to put the environment name in your role). You still CAN put the environment
name in the role if it makes you feel better, but it&rsquo;ll probably be useless.</p>

<h3>Roles ONLY include profiles</h3>

<p>So what exactly is in the role wrapper class? That depends on what technology
is on the node that defines that role. What I can tell you for CERTAIN is that
roles should ONLY use the <code>include</code> function and should ONLY include profiles.
What does this give us? This gives us our pal the <code>include</code> function back! You
can include the same profile 100 times if you want, and Puppet only puts it in
the catalog once.</p>

<h3>Every node is classified with one role. Period.</h3>

<p>The beautiful thing about roles and profiles is that the GOAL is that you
should be able to classify a node with a SINGLE role and THAT&rsquo;S IT. This makes
classification simple and static &ndash; the node gets its role, the role includes
profiles, profiles call out to Hiera for data, that data is passed to component
modules, and away we go. Also, since classification is static, you can use
version control to see what changes were introduced to the role (i.e. what
profiles were added or removed).  In my opinion, if you need to apply more
than one role to a node, you&rsquo;ve introduced a new role (see below).</p>

<h3>Roles CAN use inheritance&hellip;if you like</h3>

<p>I&rsquo;ve seen people implement roles a couple of different ways, and one of them
is to use inheritance to build a catalog.  For example, you can define a base
<code>roles</code> class that includes something like a base security profile (i.e.
something that EVERY node in your infrastructure should have). Moving down the
line, you COULD namespace according to function like <code>roles::app</code> for your
application server machines. The <code>roles::app</code> class could inherit from the <code>roles</code>
class (which gets the base security profile), and could then include the profiles
necessary to setup an application server. Next, you could subclass down to
<code>roles::app::site_foo</code> for an application server that supports some site in
your organization.  That class inherits from the <code>roles::app</code> class, and then
adds profiles that are specific to that site (maybe they use Jboss instead of
Tomcat, and thus that&rsquo;s where the differentiation occurs). This is great
because you don&rsquo;t have a lot of repeated use of the <code>include</code> function, but
it also makes it hard to definitively look at a specific role to see exactly
what&rsquo;s being declared (i.e. all the profiles). You have to weigh what you
value more: less typing or greater visibility. I will err on the side of
greater visibility (just due to that whole 3am outage thing), but it&rsquo;s up
to you to decide what to optimize for.</p>

<h3>A role similar, yet different, from another role is: a new role</h3>

<p>EVERYBODY says to me &ldquo;Gary, I have this machine that&rsquo;s an AWFUL LOT like
this role over here, but&hellip;it&rsquo;s different.&rdquo; My answer to them is: &ldquo;Great,
that&rsquo;s another role.&rdquo;  If the thing that&rsquo;s different is data (i.e. which
database to connect to, or what IP address to route traffic through),
then that difference should be put in HIERA and the classification should
remain the same. If that difference is technology-specific (i.e. this server
uses JBoss instead of Tomcat) then first look and see if you can isolate
how you know this machine is different (maybe it&rsquo;s on a different subnet,
maybe it&rsquo;s at a different location, something like that). If you can figure
that out and write a Fact for it (or use similar conditional logic to determine
this logically), then you can just drop that conditional logic in your role
and let it do the heavy lifting. If, in the end, this bit of data is totally
arbitrary, then you&rsquo;ll need to create another role (perhaps a subclass using
the above namespacing) and assign it to your node.</p>

<p>The hardest thing about this setup is naming your roles. Why? Every site is
different.  It&rsquo;s hard for me to account for differences in your setup because
your workplace is dysfunctional (seriously).</p>

<h2>Review: what does this get you?</h2>

<p>Let&rsquo;s walk through every level of this setup from the top to the bottom and see
what it gets you. Every node is classified to a single role, and, for the most
part, that classification isn&rsquo;t going to change. Now you can take all the extra
work off your classifier tool and put it back into the manifests (that are
subject to version control, so you can <code>git blame</code> to your heart&rsquo;s content and
see who last changed the role/profile). Each role is going to include one or
more profile, which gives us the added idempotent protection of the include
function (of course, if profiles have collisions with classes you&rsquo;ll have to
resolve those. Say one or more profiles tries to include an apache class &ndash;
simply break that component out into a separate profile, extract the parameters
from Hiera, and include that profile at a higher level). Each profile is going
to do Hiera lookups which should give you the ability to provide different data
for different host types (i.e. different data on a per-environment level, or
however you lay out your Hiera hierarchy), and that data will be passed
directly to class that is declared. Finally, each component module will
accept parameters as variables internal to that module, default
parameters/variables to sane values in the <code>::params</code> class, and use those
variables when declaring each resource throughtout its classes.</p>

<ul>
<li>Roles abstract profiles</li>
<li>Profiles abstract component modules</li>
<li>Hiera abstracts configuration data</li>
<li>Component modules abstract resources</li>
<li>Resources abstract the underlying OS implementation</li>
</ul>


<h2>Choose your level of comfortability</h2>

<p>The roles and profiles pattern also buys you something else &ndash; the ability for
less-skilled and more-skilled Puppet users to work with the same codebase.
Let&rsquo;s say you use some GUI classifier (like the Puppet Enterprise Console),
someone who&rsquo;s less skilled at Puppet looks and sees that a node is classified
with a certain role, so they open the role file and see something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include profiles::wordpress
</span><span class='line'>include profiles::tomcat
</span><span class='line'>include profiles::git::repo_server</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s pretty legible, right? Someone who doesn&rsquo;t regularly use Puppet can
probably make a good guess as to what&rsquo;s on the machine. Need more information?
Open one of the profiles and look specifically at the classes that are being
declared. Need to know the data being passed? Jump into Hiera. Need to know
more information? Dig into each component module and see what&rsquo;s going on there.</p>

<p>When you have everything abstracted correctly, you can have developers
providing data (like build versions) to Hiera, junior admins grouping nodes for
classification, more senior folk updating profiles, and your best Puppet people
creating/updating component modules and building plugins like custom
facts/functions/whatever.</p>

<h2>Great! Now go and refactor&hellip;</h2>

<p>If you&rsquo;ve used Puppet for more than a month, you&rsquo;re probably familiar with the
&ldquo;Oh shit, I should have done it THAT way&hellip;let me refactor this&rdquo; game. I know,
it sucks, and we at Puppet Labs haven&rsquo;t been shy of incorporating something that
we feel will help people out (but will also require some refactoring). This
pattern, though, has been in use by the Professional Services team at Puppet Labs
for over a year without modification. I&rsquo;ve used this on sites GREAT and small,
and every site with which I&rsquo;ve consulted and implemented this pattern has been
able to both understand its power and derive real value within a week. If you&rsquo;re
contemplating a refactor, you can&rsquo;t go wrong with Roles and Profiles (or
whatever names you decide to use).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building a Functional Puppet Workflow Part 1: Module Structure]]></title>
    <link href="http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-1/"/>
    <updated>2014-02-17T14:01:37-08:00</updated>
    <id>http://garylarizza.com/blog/2014/02/17/puppet-workflow-part-1</id>
    <content type="html"><![CDATA[<p>Working as a professional services engineer for <a href="http://www.puppetlabs.com">Puppet Labs</a>,
my life consists almost entirely of either correcting some of the worst code
atrocities you&rsquo;ve seen in your life, or helping people get started with Puppet
so that they don&rsquo;t need to call us again due to: A.) Said code atrocities or
B.) Refactor the work we JUST helped them start.  It wasn&rsquo;t ALWAYS like this &ndash;
I can remember some of my earliest gigs, and I almost feel like I should go
revisit them if only to correct some of the previous &lsquo;best practices&rsquo; that
didn&rsquo;t quite pan out.</p>

<p>This would be exactly why I&rsquo;m wary of &lsquo;Best Practices&rsquo; &ndash; because one person&rsquo;s
&lsquo;Best Practice&rsquo; is another person&rsquo;s &lsquo;What the fuck did you just do?!&rsquo;</p>

<p>Having said that, I&rsquo;m finding myself repeating a story over and over again when
I train/consult, and that&rsquo;s the story of &lsquo;The Usable Puppet Workflow.&rsquo;  Everybody
wants to know &lsquo;The Right Wayâ„¢&rsquo;, and I feel like we finally have a way that survives
a reasonable test of time. I&rsquo;ve been promoting this workflow for over a year (which
is a HELL of a long time in Startup time), and I&rsquo;ve yet to really see an edge case
it couldn&rsquo;t handle.</p>

<p>(If you&rsquo;re already savvy: yes, this is the Roles and Profiles talk)</p>

<p>I&rsquo;ll be breaking this workflow down into separate blog posts for every component,
and, as always, your comments are welcome&hellip;</p>

<h2>It all starts with the component module</h2>

<p>The first piece of a functional Puppet deployment starts with what we call
&lsquo;component modules&rsquo;.  Component modules are the lowest level in your
deployment, and are modules that configure specific pieces of technology (like
apache, ntp, mysql, and etc&hellip;).  Component modules are well-encapsulated, have
a reasonable API, and focus on doing small, specific things really well (i.e.
the *nix way).</p>

<p>I don&rsquo;t want to write thousands of words on building component modules because
I feel like others have done this better than I. As examples, check out
<a href="http://www.devco.net/archives/2012/12/13/simple-puppet-module-structure-redux.php">RI&rsquo;s Post on a simple module structure</a>,
<a href="http://docs.puppetlabs.com/guides/module_guides/bgtm.html">Puppet Labs&#8217; very own docs on the subject</a>,
<a href="http://www.confreaks.com/videos/1651-puppetconf2012-puppet-modules-for-fun-and-profit">and even Alessandro&rsquo;s Puppetconf 2012 session.</a> Instead, I&rsquo;d like to
provide some pointers on what I feel makes a good component module, and some
&lsquo;gotchas&rsquo; we&rsquo;ve noticed.</p>

<h3>Parameters are your API</h3>

<p>In the current world of Puppet, you MUST define the parameters your module will
accept in the Puppet DSL. Also, every parameter MUST ultimately have a value
when Puppet compiles the catalog (whether by explicitly passing this parameter
value when declaring the class, or by assuming a default value). Yes, it&rsquo;s
funny that, when writing a Puppet class, if you typo a VARIABLE Puppet will
not alert you to this (in a NON <code>use strict</code>-ian sort of approach) and will
happily accept a variable in an undefined state, but the second you don&rsquo;t pass
a value to your class parameter you&rsquo;re in for a rude compilation error.
This is the way of Puppet classes at the time of this writing, so you&rsquo;re going
to see Puppet classes with LINES of defined parameters. I expect this to change
in the future (please let this change in the near future), but for now, it&rsquo;s
a necessary evil.</p>

<p>The parameters you expose to your top-level class (i.e. given class names like
<code>apache</code> and <code>apache::install</code>, I&rsquo;m talking specifically about <code>apache</code>) should
be treated as an API to your module. IDEALLY, they&rsquo;re the ONLY THING that
a user needs to modify when using your module. Also, whenever possible, it
should be the case that a user need ONLY interact with the top-level class when
using your module (of course, defined resource types like <code>apache::vhost</code> are
used on an ad-hoc basis, and thus are the exception here).</p>

<h3>Inherit the <code>::params</code> class</h3>

<p>We&rsquo;re starting to make enemies at this point. It&rsquo;s been a convention for modules
to use a <code>::params</code> class to assign values to all variables that are going to
be used for all classes inside the module. The idea is that the <code>::params</code> class
is the one-stop-shop to see where a variable is set. Also, to get access to a
variable that&rsquo;s set in a Puppet class, you have to declare the class (i.e. use
the <code>include()</code> function or inherit from that class). When you declare a class
that has both variables AND resources, those resources get put into the catalog,
which means that Puppet ENFORCES THE STATE of those resources. What if you only
needed a variable&rsquo;s value and didn&rsquo;t want to enforce the rest of the resources
in that class? There&rsquo;s no good way in Puppet to do that. Finally, when you inherit
from a class in Puppet that has assigned variable values, you ALSO get access
to those variables in the parameter definition section of your class (i.e. the
following section of the class:</p>

<pre><code>class apache (
  $port = $apache::params::port,
  $user = $apache::params::user,
) inherits apache::params {
</code></pre>

<p>See how I set the default value of <code>$apache::port</code> to <code>$apache::params::port</code>?
I could only access the value of the variable <code>$apache::params::port</code> in that
section by inheriting from the <code>apache::params</code> class.  I couldn&rsquo;t insert
<code>include apache::params</code> below that section and be allowed access to the variable
up in the parameter defaults section (due to the way that Puppet parses classes).</p>

<p><strong>FOR THIS REASON, THIS IS THE </strong><em>ONLY</em><strong> RECOMMENDED USAGE OF INHERITANCE IN
PUPPET!</strong></p>

<p>We do NOT recommend using inheritance anywhere else in Puppet and for any other
reason because there are better ways to achieve what you want to do INSTEAD of
using inheritance.  Inheritance is a holdover from a scarier, more lawless time.</p>

<p><strong>NOTE: Data in Modules</strong> &ndash; There&rsquo;s a &lsquo;Data in Modules&rsquo; pattern out there that
attempts to eliminate the <code>::params</code> class.  <a href="http://garylarizza.com/blog/2013/12/08/when-to-hiera/">I wrote about it in a previous post</a>,
and I recommend you read that post for more info (it&rsquo;s near the bottom).</p>

<h3>Do <strong>NOT</strong> do Hiera lookups in your component modules!</h3>

<p>This is something that&rsquo;s really only RECENTLY been pushed. When Hiera was
released, we quickly recognized that it would be the answer to quite a few
problems in Puppet. In the rush to adopt Hiera, many people started adding
Hiera calls to their modules, and suddenly you had &lsquo;Hiera-compatible&rsquo; modules
out there. This caused all kinds of compatibility problems, and it was largely
because there wasn&rsquo;t a better module structure and workflow by which to integrate
Hiera. The pattern that I&rsquo;ll be pushing DOES INDEED use Hiera, <strong>BUT</strong> it
confines all Hiera calls to a higher-level wrapper class we call a &lsquo;profile&rsquo;.
The reasons for NOT using Hiera in your module are:</p>

<ul>
<li>By doing Hiera calls at a higher level, you have a greater visibility on
exactly what parameters were set by Hiera and which were set explicitly or by
default values.</li>
<li>By doing Hiera calls elsewhere, your module is backwards-compatible for
those folks who are NOT using Hiera</li>
</ul>


<p>Remember &ndash; your module should just accept a value and use it somewhere. Don&rsquo;t
get <strong>TOO</strong> smart with your component module &ndash; leave the logic for other
places.</p>

<h3>Keep your component modules generic</h3>

<p>We always get asked &ldquo;How do I know if I&rsquo;m writing a good module?&rdquo; We USED to
say &ldquo;Well, does it work?&rdquo; (and trust me, that was a BIG hurdle). Now, with
data separation models out there like Hiera, I have a couple of other questions
that I ask (you know, BEYOND asking if it compiles and actually installs the
thing it&rsquo;s supposed to install). The best way I&rsquo;ve found to determine if your
module is &lsquo;generic enough&rsquo; is if I asked you TODAY to give me your module,
would you give it to me, or would you be worried that there was some
company-specific data locked in there? If you have company-specific data in
your module, then you need to refactor the module, store the data in Hiera, and
make your module more generic/reusable. Also, does your module focus on installing
one piece of technology, or are you declaring packages for shared libraries
or other components (like gcc, apache, or other common components)? You&rsquo;re
not going to win any prizes for having the biggest, most monolithic module
out there. Rather, if your module is that large and that complex, you&rsquo;re
going to have a hell of a time debugging it. Err on the side of making your
modules smaller and more task-specific. So what if you end up needing to
declare 4 classes where you previously declared 1? In the roles and profiles
pattern we will show you in the next blog post, you can abstract that away
ANYHOW.</p>

<h3>Don&rsquo;t play the &ldquo;what if&rdquo; game</h3>

<p>I&rsquo;ve had more than a couple of gigs where the customer says something along the
lines of &ldquo;What if we need to introduce FreeBSD/Solaris/etc&hellip; nodes into our
organization, shouldn&rsquo;t I account for them now?&rdquo; This leads more than a few
people down a path of entirely too-complex modules that become bulky and
unwieldy. Yes, your modules should be formatted so that you can simply add
another case in your <code>::params</code> class for another OS&rsquo;s parameters, and yes,
your module should be formatted so that your <code>::install</code> or <code>::config</code>
class can handle another OS, but if you currently only manage Redhat, and
you&rsquo;ve only EVER managed Redhat, then don&rsquo;t start adding Debian parameters
RIGHT NOW just because you&rsquo;re afraid you might inherit Ubuntu machines. The
goal of Puppet is to automate the tasks that eat up the MAJORITY of your time
so you can focus on the edge cases that really demand your time. If you can
eventually automate those edge cases, then AWESOME! Until then, don&rsquo;t spend
the majority of your time trying to automate the edge cases only to drown
under the weight of deadlines from simple work that you COULD have already
automated (but didn&rsquo;t, because you were so worried about the exceptions)!</p>

<h3>Store your modules in version control</h3>

<p>This should go without saying, but your modules should be stored in version
control (a la git, svn, hg, whatever). We tend to prefer git due to its lightweight
branching and merging (most of our tooling and solutions will use git because
we&rsquo;re big git users), but you&rsquo;re free to use whatever you want. The bigger
question is HOW to store your modules in version control. There are usually
two schools of thought:</p>

<ul>
<li>One repository per module</li>
<li>All modules in a single repository</li>
</ul>


<p>Each model has its pros and cons, but we tend to recommend one module per
repository for the following reasons:</p>

<ul>
<li>Individual repos mean individual module development histories</li>
<li>Most VCS solutions don&rsquo;t have per-folder ACLs for a single repositories;
having multiple repos allows per-module security settings.</li>
<li>With the one-repository-per-module solution, modules you pull down from the
Forge (or Github) must be committed to your repo. Having multiple
repositories for each module allow you to keep everything separate</li>
</ul>


<p><strong>NOTE:</strong> This becomes important in the third blog post in the series when we
talk about moving changes to each Puppet Environment, but it&rsquo;s important to
introduce it NOW as a &lsquo;best practice&rsquo;. If you use our recommended module/environment
solution, then one-module-per-repo is the best practice. If you DON&rsquo;T use our
solution, then the single repository per for all modules will STILL work,
but you&rsquo;ll have to manage the above issues. Also note that even if you currently
have every module in a single repository, you can STILL use our solution in
part 3 of the series (you&rsquo;ll just need to perform a couple of steps to conform).</p>

<h2>Best practices are shit</h2>

<p>In general, &lsquo;best practices&rsquo; are only recommended if they fit into your organizational
workflow. The best and worst part of Puppet is that it&rsquo;s infinitely customizable,
so &lsquo;best practices&rsquo; will invariably be left wanting for a certain subset of the
community. As always, take what I say under consideration; it&rsquo;s quite possible
that I could be entirely full of shit.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Seriously, What Is This Provider Doing?]]></title>
    <link href="http://garylarizza.com/blog/2013/12/15/seriously-what-is-this-provider-doing/"/>
    <updated>2013-12-15T08:44:17-08:00</updated>
    <id>http://garylarizza.com/blog/2013/12/15/seriously-what-is-this-provider-doing</id>
    <content type="html"><![CDATA[<p>Clarke&rsquo;s third law states: &ldquo;Any sufficiently advanced technology is
indistinguishable from magic.&rdquo; In the case of Ruby and Puppet provider
interaction, I&rsquo;m inclined to believe it. If you want proof, take a look at some
of the native Puppet types &ndash; no amount of &lsquo;Expecto Patronum&rsquo; will free you from
the Ruby metaprogramming dementors that hover around
<code>lib/puppet/provider/exec</code>-land.</p>

<p>In my <a href="http://garylarizza.com/blog/2013/11/25/fun-with-providers/">first post tackling Puppet types and providers</a>, I introduced
the concept of Puppet types and the utility they provide. <a href="http://garylarizza.com/blog/2013/11/26/fun-with-providers-part-2/">In the second post,</a>
I brought you to the great plain of Puppet providers and introduced the core
methods necessary for creating a very basic Puppet provider with a single property
(HINT: if you&rsquo;ve not read either of those posts, or you&rsquo;ve never dealt with basic
types and providers, you might want to stop here and read up a bit on the topics).
The problems with a provider like the one created in that post were:</p>

<ul>
<li><code>puppet resource</code> support wasn&rsquo;t implemented, so you couldn&rsquo;t query for existing instances of the type on the system (and their corresponding values)</li>
<li>The getter method would be called for EVERY instance of the type on the system, which would mean shelling-out multiple times during a run</li>
<li>Ditto for the setter method (if changes to multiple instances of the type were necessary)</li>
<li>That type was VERY basic (i.e. ensurable with a single property)</li>
</ul>


<p>Unfortunately, when most of us have the need of a Puppet type and provider, we
usually require multiple properties and reasonably complex system interaction. When
it comes to creating both a getter and a setter method for every property (including
the potential performance hit that could come from shelling-out many times during
a Puppet run), ain&rsquo;t nobody got time for that. And finally, <code>puppet resource</code> is a
REALLY handy tool for querying the current state of your resources on a system.
These problems all have solutions, but up until recently there was just one more
problem:</p>

<p><strong>Good luck finding documentation for those solutions.</strong></p>

<p>NOTE: The <a href="http://www.amazon.com/Puppet-Types-Providers-Dan-Bode/dp/1449339328/ref=sr_1_1?ie=UTF8&amp;qid=1387136838&amp;sr=8-1&amp;keywords=types+and+providers+puppet+book">Puppet Types and Providers book written by Nan and Dan</a>
is a great resource that provides a bit of a deeper dive than I&rsquo;ll be doing in this
post &ndash; DO check it out if you want to know more</p>

<h2>Something, something, <code>puppet resource</code></h2>

<p>The <code>puppet resource</code> command (or <code>ralsh</code>, as it used to be known), is a very
handy command for querying a system and returning the current state of resources
for a specific Puppet type.  Try it out if you never have (note that the following
is being run on CentOS 6.4):</p>

<pre><code>[root@linux ~]# puppet resource user
user { 'abrt':
  ensure           =&gt; 'present',
  gid              =&gt; '173',
  home             =&gt; '/etc/abrt',
  password         =&gt; '!!',
  password_max_age =&gt; '-1',
  password_min_age =&gt; '-1',
  shell            =&gt; '/sbin/nologin',
  uid              =&gt; '173',
}
user { 'adm':
  ensure           =&gt; 'present',
  comment          =&gt; 'adm',
  gid              =&gt; '4',
  groups           =&gt; ['sys', 'adm'],
  home             =&gt; '/var/adm',
  password         =&gt; '*',
  password_max_age =&gt; '99999',
  password_min_age =&gt; '0',
  shell            =&gt; '/sbin/nologin',
  uid              =&gt; '3',
}
&lt; ... and more users below ... &gt;
</code></pre>

<p>The <code>puppet resource</code> command returns a list of all users on the system
and their current property values (note you can only see the password
hash if you&rsquo;re running Puppet with sufficient privileges). You can even
query <code>puppet resource</code> for the values of a specific resource:</p>

<pre><code>[root@gary ~]# puppet resource user glarizza
user { 'glarizza':
  ensure           =&gt; 'present',
  gid              =&gt; '502',
  home             =&gt; '/home/glarizza',
  password         =&gt; '$1$hsUuCygh$kgLKG5epuRaXHMX5KmxrL1',
  password_max_age =&gt; '99999',
  password_min_age =&gt; '0',
  shell            =&gt; '/bin/bash',
  uid              =&gt; '502',
}
</code></pre>

<p><code>puppet resource</code> seems magical, and you might think that if you create a
custom type and sync it to your machine then <code>puppet resource</code> will automatically
work for you.</p>

<p><strong>And you would be wrong.</strong></p>

<p><code>puppet resource</code> will only work if you&rsquo;ve implemented a special method in your
provider called <code>self.instances</code>.</p>

<h2><code>self.instances</code></h2>

<p>The <code>self.instances</code> method is pretty sparsely documented, so let&rsquo;s go straight
to the source&hellip;code, that is:</p>

<figure class='code'><figcaption><span>lib/puppet/provider.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Returns a list of system resources (entities) this provider may/can manage.</span>
</span><span class='line'>  <span class="c1"># This is a query mechanism that lists entities that the provider may manage on a given system. It is</span>
</span><span class='line'>  <span class="c1"># is directly used in query services, but is also the foundation for other services; prefetching, and</span>
</span><span class='line'>  <span class="c1"># purging.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># As an example, a package provider lists all installed packages. (In contrast, the File provider does</span>
</span><span class='line'>  <span class="c1"># not list all files on the file-system as that would make execution incredibly slow). An implementation</span>
</span><span class='line'>  <span class="c1"># of this method should be made if it is possible to quickly (with a single system call) provide all</span>
</span><span class='line'>  <span class="c1"># instances.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># An implementation of this method should only cache the values of properties</span>
</span><span class='line'>  <span class="c1"># if they are discovered as part of the process for finding existing resources.</span>
</span><span class='line'>  <span class="c1"># Resource properties that require additional commands (than those used to determine existence/identity)</span>
</span><span class='line'>  <span class="c1"># should be implemented in their respective getter method. (This is important from a performance perspective;</span>
</span><span class='line'>  <span class="c1"># it may be expensive to compute, as well as wasteful as all discovered resources may perhaps not be managed).</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># An implementation may return an empty list (naturally with the effect that it is not possible to query</span>
</span><span class='line'>  <span class="c1"># for manageable entities).</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># By implementing this method, it is possible to use the `resourcesÂ´ resource type to specify purging</span>
</span><span class='line'>  <span class="c1"># of all non managed entities.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># @note The returned instances are instance of some subclass of Provider, not resources.</span>
</span><span class='line'>  <span class="c1"># @return [Array&lt;Puppet::Provider&gt;] a list of providers referencing the system entities</span>
</span><span class='line'>  <span class="c1"># @abstract this method must be implemented by a subclass and this super method should never be called as it raises an exception.</span>
</span><span class='line'>  <span class="c1"># @raise [Puppet::DevError] Error indicating that the method should have been implemented by subclass.</span>
</span><span class='line'>  <span class="c1"># @see prefetch</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:DevError</span><span class="p">,</span> <span class="s2">&quot;Provider </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has not defined the &#39;instances&#39; class method&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll find that method around lines 348 &ndash; 377 of the <code>lib/puppet/provider.rb</code>
file in Puppet&rsquo;s source code (as of this writing, which is a Friday&hellip;
on a flight from DC to Seattle). To summarize, implementing <code>self.instances</code>
in your provider means that you need to return an array of provider instances
that have been discovered on the current system and all the current property
values (we call these values the &lsquo;is&rsquo; values for the properties, since each
value IS the current value of the property on the system). It&rsquo;s recommended to only
implement <code>self.instances</code> if you can gather all resource property values in a reasonably
&lsquo;cheap&rsquo; manner (i.e. a single system call, read from a single file, or some
similar low-IO means). Implementing <code>self.instances</code> not only gives you the
ability to run <code>puppet resource</code> (which also affords you a quick-and-dirty
way of testing your provider without creating unit tests by simply running
<code>puppet resource</code> in debug mode and checking the output), but it also allows
the <a href="http://docs.puppetlabs.com/references/latest/type.html#resources">&lsquo;resources&rsquo; resource</a> to work its magic (If you&rsquo;ve
never heard of the &lsquo;resources&rsquo; resource, <a href="http://docs.puppetlabs.com/references/latest/type.html#resources">check this link</a>
for more information on this terribly/awesomely named resource type).</p>

<h3>An important note about scope and <code>self.instances</code></h3>

<p>The <code>self.instances</code> method is a method of the PROVIDER, which is why it is
prefixed with <code>self.</code>  Even though it may be located in the provider file
itself, and even though it sits among other methods like <code>create</code>, <code>exists?</code>,
and <code>destroy</code> (which are methods of the INSTANCE of the provider), it does
NOT have the ability to directly access or call those methods. It DOES have
the ability to access other methods of the provider directly (i.e. other
methods prefixed with <code>self.</code>).  This means that if you were to define a
method like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">proxy_type</span>
</span><span class='line'>  <span class="s1">&#39;web&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You could access that directly from <code>self.instances</code> by simply calling it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">type_of_proxy</span> <span class="o">=</span> <span class="n">proxy_type</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say you had a method of the INSTANCE of the provider, like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">system_type</span>
</span><span class='line'>  <span class="s1">&#39;OS X&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You COULD NOT access this method from <code>self.instances</code> directly (there are
always hacky ways around EVERYTHING in Ruby, sure, but there is no easy/straightforward
way to access this method).</p>

<p><strong>And here&rsquo;s where it gets confusing&hellip;</strong></p>

<p>Methods of the INSTANCE of the provider CAN access provider methods directly.
Given our previous example, what if the <code>system_type</code> method wanted to access
<code>self.proxy_type</code> for some reason?  It could be done like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">system_type</span>
</span><span class='line'>  <span class="n">type_of_proxy</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">proxy_type</span><span class="p">()</span>
</span><span class='line'>  <span class="s1">&#39;OS X&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A method of the instance of the provider can access provider methods by simply
calling the <code>class</code> method on itself (which returns the provider object). This
is a one-way street for method creation that needs to be heeded when designing
your provider.</p>

<h2>Building a provider that uses <code>self.instances</code> (or: more Mac problems)</h2>

<p>In the previous two posts on types/providers, I created a type and provider
for managing bypass domains for network proxies on OS X. For this post, let&rsquo;s
create a provider for actually MANAGING the proxy settings for a given
network interface.  Here&rsquo;s a quick type for managing a web proxy on a network
interface on OS X:</p>

<figure class='code'><figcaption><span>puppet-mac_proxy/lib/puppet/type/mac_web_proxy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">newtype</span><span class="p">(</span><span class="ss">:mac_web_proxy</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Puppet type that models a network interface on OS X&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ensurable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:namevar</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Interface name - currently must be &#39;friendly&#39; name (e.g. Ethernet)&quot;</span>
</span><span class='line'>    <span class="n">munge</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>      <span class="n">value</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">insync?</span><span class="p">(</span><span class="n">is</span><span class="p">)</span>
</span><span class='line'>      <span class="n">is</span><span class="o">.</span><span class="n">downcase</span> <span class="o">==</span> <span class="n">should</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_server</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:authenticated_username</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Username for proxy authentication&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:authenticated_password</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Password for proxy authentication&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_authenticated</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="ss">:true</span><span class="p">,</span> <span class="ss">:false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_port</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This type has three properties, is ensurable, and a namevar called &lsquo;name&rsquo;. As
for the provider, let&rsquo;s start with <code>self.instances</code> and get the web proxy
values for all interfaces.  To do that we&rsquo;re going to need to know how to get
a list of all network interfaces, and also how to get the current proxy state
for every interface. Fortunately, both of those tasks are accomplished with the
<code>networksetup</code> binary:</p>

<pre><code>â–· networksetup -listallnetworkservices
An asterisk (*) denotes that a network service is disabled.
Bluetooth DUN
Display Ethernet
Ethernet
FireWire
Wi-Fi
iPhone USB
Bluetooth PAN

â–· networksetup -getwebproxy Ethernet
Enabled: No
Server: proxy.corp.net
Port: 1234
Authenticated Proxy Enabled: 0
</code></pre>

<p>Cool, so one binary will do both tasks and they&rsquo;re REASONABLY low-cost to run.</p>

<h3>Helper methods</h3>

<p>To keep things separated and easier to test, let&rsquo;s create separate helper methods
for each task. Since these methods are going to be called by <code>self.instances</code>,
they will be provider methods.</p>

<p>The first method will simply return an array of network interfaces:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_list_of_interfaces</span>
</span><span class='line'>  <span class="n">interfaces</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="s1">&#39;-listallnetworkservices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">interfaces</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'>  <span class="n">interfaces</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember from above that the <code>networksetup -listallnetworkservices</code> command
returns an info line before each interface, so this code strips that line
off and returns a sorted list of interfaces based on a one-line-per-interface
assumption.</p>

<p>The next method we need will accept a network interface name as an argument,
will run the <code>networksetup -getwebproxy (interface)</code> command, and will use
its output to return all the current property values (including the ensure
value) for every instance of the type on the system (i.e. every interface&rsquo;s
proxy settings and whether the proxy is enabled, which means the resource
is ensured as &lsquo;present&rsquo;, or disabled, which means the resource is ensured
as &lsquo;absent&rsquo;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>  <span class="n">interface_properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-getwebproxy&#39;</span><span class="p">,</span> <span class="n">int</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;#mac_web_proxy tried to run `networksetup -getwebproxy </span><span class="si">#{</span><span class="n">int</span><span class="si">}</span><span class="s2">` and the command returned non-zero. Failing here...&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output_array</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">output_array</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>    <span class="n">line_values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">line_values</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;Enabled&#39;</span>
</span><span class='line'>      <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span> <span class="p">?</span> <span class="ss">:absent</span> <span class="p">:</span> <span class="ss">:present</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;Server&#39;</span>
</span><span class='line'>      <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;Port&#39;</span>
</span><span class='line'>      <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;Authenticated Proxy Enabled&#39;</span>
</span><span class='line'>      <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_authenticated</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:ruby</span>
</span><span class='line'>  <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>     <span class="o">=</span> <span class="n">int</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>  <span class="n">interface_properties</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A couple of notes on the method itself &ndash; first, the <code>networksetup</code> command must
exit zero on success or non-zero on failure (which it does). If ever the <code>networksetup</code>
command were to return non-zero, we&rsquo;re raising our own Puppet::Error, documenting what
happened, and bailing out.</p>

<p>This method is going to return a hash of properties and values that is going
to be used by <code>self.instances</code> &ndash; so the case statement needs to account for that.
HOWEVER you populate that hash is up to you (in my case, I&rsquo;m checking for specific
output that <code>networksetup</code> returns), but make sure that the hash has a value for
the <code>:ensure</code> key at the VERY least.</p>

<h3>Assembling <code>self.instances</code></h3>

<p>Once the helper provider methods have been defined, <code>self.instances</code> becomes
reasonably simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>  <span class="n">get_list_of_interfaces</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">int</span><span class="o">|</span>
</span><span class='line'>    <span class="n">proxy_properties</span> <span class="o">=</span> <span class="n">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span><span class="p">(</span><span class="n">proxy_properties</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember that <code>self.instances</code> must return an array of provider instances,
and each one of these instances must include the <code>namevar</code> and ensure value
at the very least. Since <code>self.get_proxy_properties</code> returns a hash containing
all the property &lsquo;is&rsquo; values for a resource, declaring a new provider instance
is as easy as calling the <code>new()</code> method on the return value of
<code>self.get_proxy_properties</code> for every network interface. In the end, the
return value of the <code>collect</code> method on <code>get_list_of_interfaces</code> will be an
array of provider instances.</p>

<h2>Existance, <code>@property_hash</code>, and more magical methods</h2>

<p>Even though we have assembled a functional <code>self.instances</code> method, we don&rsquo;t have
complete implementation that will work with <code>puppet resource</code>.  The problem is
that Puppet can&rsquo;t yet determine the existance of a resource (even though the
resource&rsquo;s <code>ensure</code> value has been set by <code>self.instances</code>). If you were to
execute the code with <code>puppet resource mac_web_proxy</code>, you would get the error:</p>

<pre><code>Error: Could not run: No ability to determine if mac_web_proxy exists
</code></pre>

<p>To satisfy Puppet, we need to implement an <code>exists?()</code> method for the instance
of the provider. Fortunately, we don&rsquo;t need to re-implement any existing logic
and can instead use <code>@property_hash</code></p>

<h3>A <code>@property_hash</code> is born&hellip;</h3>

<p>I&rsquo;ve omitted one last thing that is borne out of <code>self.instances</code>, and that&rsquo;s
the <code>@property_hash</code> instance variable. <code>@property_hash</code> is populated by
<code>self.instances</code> as an instance variable that&rsquo;s available to methods of the
INSTANCE of the provider (i.e. methods that ARE NOT prefixed with <code>self.</code>)
containing all the &lsquo;is&rsquo; values for a resource. Do you need to get the &lsquo;is&rsquo;
value for a property?  Just use <code>@property_hash[:property_name]</code>. Since the
<code>exists?</code> method is a method of the instance of the provider, and it&rsquo;s
essentially the same thing as the <code>ensure</code> value for a resource, let&rsquo;s implement
<code>exists?</code> by doing a check on the ensure value from the <code>@property_hash</code>
variable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>  <span class="vi">@property_hash</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:present</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect, now <code>exists?</code> will return true or false accordingly and Puppet will be
satisfied.</p>

<h3>Getter methods &ndash; the slow way</h3>

<p>Puppet may be happy that you have an <code>exists?</code> method, but <code>puppet resource</code>
won&rsquo;t successfully run until you have a method that returns an &lsquo;is&rsquo; value for
every property of the type (i.e. the <code>proxy_server</code>, <code>proxy_authenticated</code>,
and <code>proxy_port</code> attributes for the mac_web_proxy type). These &lsquo;is value methods&rsquo; are
called &lsquo;getter&rsquo; methods: they&rsquo;re methods of the instance of the provider, and
are named exactly the same as the properties they represent.</p>

<p>You SHOULD be thinking: &ldquo;Hey, we already have <code>@property_hash</code>, why can&rsquo;t we
just use it again? We can, and you COULD implement all the getter methods
like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">proxy_server</span>
</span><span class='line'>  <span class="vi">@property_hash</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you did that, you would be TECHNICALLY correct, but it would seem to be a
waste of lines in a provider (especially if you have many properties).</p>

<h3>Getter methods &ndash; the quicker &lsquo;method&rsquo;</h3>

<p>Because uncle Luke hated excess lines of code, he made available a method called
<code>mk_resource_methods</code> which works very similarly to Ruby&rsquo;s <code>attr_accessor</code>
method. Adding <code>mk_resource_methods</code> to your provider will AUTOMATICALLY
create getter methods that pull values out of <code>@property_hash</code> in the similar
way that I just demonstrated (it will also create SETTER methods too, but we&rsquo;ll
look at those later). Long story short &ndash; don&rsquo;t make getter/setter methods if
you&rsquo;re using self.instances &ndash; just implement <code>mk_resource_methods</code>.</p>

<h2>JUST enough for <code>puppet resource</code></h2>

<p>Putting everything that we&rsquo;ve learned up until now, we should have a provider
that looks like this:</p>

<figure class='code'><figcaption><span>lib/puppet/provider/mac_web_proxy/ruby.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:mac_web_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">commands</span> <span class="ss">:networksetup</span> <span class="o">=&gt;</span> <span class="s1">&#39;networksetup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mk_resource_methods</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_list_of_interfaces</span>
</span><span class='line'>    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="s1">&#39;-listallnetworkservices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">interfaces</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'>    <span class="n">interfaces</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>    <span class="n">interface_properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-getwebproxy&#39;</span><span class="p">,</span> <span class="n">int</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;#get_proxy_properties had an error -&gt; </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">output_array</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">output_array</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>      <span class="n">line_values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">line_values</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Enabled&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span> <span class="p">?</span> <span class="ss">:absent</span> <span class="p">:</span> <span class="ss">:present</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Server&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Port&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Authenticated Proxy Enabled&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_authenticated</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:ruby</span>
</span><span class='line'>    <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>     <span class="o">=</span> <span class="n">int</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Interface properties: </span><span class="si">#{</span><span class="n">interface_properties</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">interface_properties</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>    <span class="n">get_list_of_interfaces</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">int</span><span class="o">|</span>
</span><span class='line'>      <span class="n">proxy_properties</span> <span class="o">=</span> <span class="n">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>      <span class="kp">new</span><span class="p">(</span><span class="n">proxy_properties</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>    <span class="vi">@property_hash</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:present</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s a tree of the module I&rsquo;ve assembled on my machine:</p>

<pre><code>â””(~/src/puppet-mac_web_proxy)â–· tree .
.
â””â”€â”€ lib
Â Â  â””â”€â”€ puppet
Â Â      â”œâ”€â”€ provider
Â Â      â”‚Â Â  â””â”€â”€ mac_web_proxy
Â Â      â”‚Â Â      â””â”€â”€ ruby.rb
Â Â      â””â”€â”€ type
Â Â          â””â”€â”€ mac_web_proxy.rb
</code></pre>

<p>To test out <code>puppet resource</code>, we need to make Puppet aware of our new custom
module. To do that, let&rsquo;s set the <code>$RUBYLIB</code> environmental variable. <code>$RUBYLIB</code>
is queried by Puppet and is added to its load path when looking for additional
Puppet plugins.  You will need to set <code>$RUBYLIB</code> to the path of the <code>lib</code> directory
in the custom module that you&rsquo;ve assembled.  Because my custom module is located
in <code>~/src/puppet-mac_web_proxy</code>, I&rsquo;m going to set <code>$RUBYLIB</code> like so:</p>

<pre><code>export RUBYLIB=~/src/puppet-mac_web_proxy/lib
</code></pre>

<p>You can execute that command from the command line, or set it in your
<code>~/.{bash,zsh}rc</code> and <code>source</code> that file.</p>

<p>Finally, with all the files in place and <code>$RUBYLIB</code> set, it&rsquo;s time to officially
run <code>puppet resource</code> (I&rsquo;m going to do it in <code>--debug</code> mode to see the debug output
that I&rsquo;ve written into the code):</p>

<pre><code>â””(~/src/blogtests)â–· envpuppet puppet resource mac_web_proxy --debug
Debug: Executing '/usr/sbin/networksetup -listallnetworkservices'
Debug: Executing '/usr/sbin/networksetup -getwebproxy Bluetooth DUN'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;nil, :proxy_port=&gt;nil, :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"bluetooth dun"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy Bluetooth PAN'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;nil, :proxy_port=&gt;nil, :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"bluetooth pan"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy Display Ethernet'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;"foo.bar.baz", :proxy_port=&gt;"80", :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"display ethernet"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy Ethernet'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;"proxy.corp.net", :proxy_port=&gt;"1234", :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"ethernet"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy FireWire'
Debug: Interface properties: {:ensure=&gt;:present, :proxy_server=&gt;"stuff.bar.blat", :proxy_port=&gt;"8190", :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"firewire"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy Wi-Fi'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;nil, :proxy_port=&gt;nil, :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"wi-fi"}
Debug: Executing '/usr/sbin/networksetup -getwebproxy iPhone USB'
Debug: Interface properties: {:ensure=&gt;:absent, :proxy_server=&gt;nil, :proxy_port=&gt;nil, :proxy_authenticated=&gt;nil, :provider=&gt;:ruby, :name=&gt;"iphone usb"}
mac_web_proxy { 'bluetooth dun':
  ensure =&gt; 'absent',
}
mac_web_proxy { 'bluetooth pan':
  ensure =&gt; 'absent',
}
mac_web_proxy { 'display ethernet':
  ensure =&gt; 'absent',
}
mac_web_proxy { 'ethernet':
  ensure =&gt; 'absent',
}
mac_web_proxy { 'firewire':
  ensure       =&gt; 'present',
  proxy_port   =&gt; '8190',
  proxy_server =&gt; 'stuff.bar.blat',
}
mac_web_proxy { 'iphone usb':
  ensure =&gt; 'absent',
}
mac_web_proxy { 'wi-fi':
  ensure =&gt; 'absent',
}
</code></pre>

<p>Note that you will only see &lsquo;is&rsquo; values if you have a proxy set on any of your
network interfaces (obviously, if you&rsquo;ve not setup a proxy, then it will show
as &lsquo;absent&rsquo; on every interface. You can setup a proxy by opening System
Preferences, clicking on the Network icon, choosing an interface from the list
on the left, clicking the Advanced button in the lower right corner of the
window, clicking the &lsquo;Proxies&#8221; tab at the top of the window, clicking the
checkbox next to the &ldquo;Web Proxy (HTTP)&rdquo; choice, and entering a proxy URL and
port. NOW do you get why we automate this bullshit?).  Also, your list of
network interfaces may not match mine if you have more or less interfaces than
I do.</p>

<p>TADA! <code>puppet resource</code> WORKS! ISN&rsquo;T THAT AWESOME?! WHY AM I TYPING IN CAPS?!</p>

<h2>Prefetching, flushing, caching, and other hard shit</h2>

<p>Okay, so up until now we&rsquo;ve implemented one half of the equation &ndash; we can query
&lsquo;is&rsquo; values and <code>puppet resource</code> works. What about using this &lsquo;more efficient&rsquo;
method of getting values for a type on the OTHER end of the spectrum? What if
instead of calling setter methods one-by-one to set values for all resources
of a type in a catalog we had a way to do it all at once? Well, such a way
exists, and it&rsquo;s called the <code>flush</code> method&hellip;but we&rsquo;re getting slightly ahead
of ourselves. Before we get to flushing, we need to point out that <code>self.instances</code>
is ONLY used by <code>puppet resource</code> &ndash; THAT&rsquo;S IT (and it&rsquo;s only used by <code>self.instances</code>
when you GET values from the system, not when you SET values on the system&hellip;and if
you never knew that <code>puppet resource</code> could actually SET values on the system, well,
I guess you got another surprise today). If we want <code>puppet agent</code> or
<code>puppet apply</code> to use the behavior that <code>self.instances</code> implements, we need
to create another method: <code>self.prefetch</code></p>

<h3><code>self.prefetch</code></h3>

<p>If you thought <code>self.instances</code> didn&rsquo;t have much documentation, wait until
you see <code>self.prefetch</code>.  After wading the waters of <code>self.prefetch</code>, I&rsquo;m
PRETTY SURE its implementation might have come to uncle Luke after a long
night in Reed&rsquo;s chem lab where he might have accidently synthesized mescaline.</p>

<p>Let&rsquo;s look at the codebase:</p>

<figure class='code'><figcaption><span>lib/puppet/provider.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># @comment Document prefetch here as it does not exist anywhere else (called from transaction if implemented)</span>
</span><span class='line'><span class="c1"># @!method self.prefetch(resource_hash)</span>
</span><span class='line'><span class="c1"># @abstract A subclass may implement this - it is not implemented in the Provider class</span>
</span><span class='line'><span class="c1"># This method may be implemented by a provider in order to pre-fetch resource properties.</span>
</span><span class='line'><span class="c1"># If implemented it should set the provider instance of the managed resources to a provider with the</span>
</span><span class='line'><span class="c1"># fetched state (i.e. what is returned from the {instances} method).</span>
</span><span class='line'><span class="c1"># @param resources_hash [Hash&lt;{String =&gt; Puppet::Resource}&gt;] map from name to resource of resources to prefetch</span>
</span><span class='line'><span class="c1"># @return [void]</span>
</span><span class='line'><span class="c1"># @api public</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s right, documentation for <code>self.prefetch</code> in the Puppet codebase is
9 lines of comments in <code>lib/puppet/provider.rb</code>, which is awesome. So when
is <code>self.prefetch</code> used to provide information to Puppet and when is <code>self.instances</code> used?</p>

<table>
<thead>
<tr>
<th></th>
<th align="center">Puppet Subcommand        </th>
<th align="center"> Provider Method       </th>
<th align="center"> Execution Mode  </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="center"> puppet resource         </td>
<td align="center"> self.instances        </td>
<td align="center"> getting values</td>
</tr>
<tr>
<td></td>
<td align="center"> puppet resource         </td>
<td align="center"> self.prefetch         </td>
<td align="center"> setting values</td>
</tr>
<tr>
<td></td>
<td align="center"> puppet agent            </td>
<td align="center"> self.prefetch         </td>
<td align="center"> getting values</td>
</tr>
<tr>
<td></td>
<td align="center"> puppet agent            </td>
<td align="center"> self.prefetch         </td>
<td align="center"> setting values</td>
</tr>
<tr>
<td></td>
<td align="center"> puppet apply            </td>
<td align="center"> self.prefetch         </td>
<td align="center"> getting values</td>
</tr>
<tr>
<td></td>
<td align="center"> puppet apply            </td>
<td align="center"> self.prefetch         </td>
<td align="center"> setting values  </td>
</tr>
</tbody>
</table>


<p>.</p>

<p>This doesn&rsquo;t mean that <code>self.instances</code> is really only handy for <code>puppet
resource</code> &ndash; that&rsquo;s definitely not the case.  In fact, frequently you will find
that <code>self.instances</code> is used by <code>self.prefetch</code> to do some of the heavy
lifting.  Even though <code>self.prefetch</code> works VERY SIMILARLY to the way that
<code>self.instances</code> works for <code>puppet resource</code> (and by that I mean that it&rsquo;s
going to gather a list of instances of a type on the system, and it&rsquo;s also
going to populate <code>@property_hash</code> for <code>puppet apply</code>, <code>puppet agent</code>, and when
when <code>puppet resource</code> is setting values), it&rsquo;s not an exact one-for-one match
with <code>self.instances</code>.  The <code>self.prefetch</code> method for a type is called once
per run when Puppet encounters a resource of that type in the catalog. The
argument to <code>self.prefetch</code> is a hash of all managed resources of that type
that are encountered in a compiled catalog for that node (the hash&rsquo;s key will
be the <code>namevar</code> of the resource, and the value will be an instance of
<code>Puppet::Type</code> &ndash; in this case, <code>Puppet::Type::Mac_web_proxy</code>).  Your task is to
implement a <code>self.prefetch</code> method that gets an array of instances of the
provider that are discovered on the system, iterates through the hash passed to
<code>self.prefetch</code> (containing all the resources of the type that were discovered
in the catalog), and passes the correct instance of the provider that was
discovered on the system to the <code>provider=</code> method of the correct instance of
the type that was discovered in the catalog.</p>

<p><strong>What the actual fuck?!</strong></p>

<p>Okay, let&rsquo;s break that apart to try and discover exactly what&rsquo;s going on here.
Assume that I&rsquo;ve setup a proxy for the &lsquo;FireWire&rsquo; interface on my laptop, and
I want to try and manage that resource with <code>puppet apply</code> (i.e. something that
uses <code>self.prefetch</code>). The resource in the manifest used to manage the proxy
will look something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">mac_web_proxy</span> <span class="p">{</span> <span class="s1">&#39;firewire&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>       <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">proxy_port</span>   <span class="p">=&gt;</span> <span class="s1">&#39;8080&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">proxy_server</span> <span class="p">=&gt;</span> <span class="s1">&#39;proxy.server.org&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When <code>self.prefetch</code> is called by Puppet, it&rsquo;s going to be passed a hash looking
something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span> <span class="s2">&quot;firewire&quot;</span> <span class="o">=&gt;</span> <span class="no">Mac_web_proxy</span><span class="o">[</span><span class="n">firewire</span><span class="o">]</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because only one resource is encountered in the catalog, only one key/value
pair shows up in the hash that&rsquo;s passed as the argument to <code>self.prefetch</code>.</p>

<p>The job of <code>self.prefetch</code> is to find the current state of <code>Mac_web_proxy['firewire']</code>
on the system, create a new instance of the <code>mac_web_proxy</code> provider that contains
the &lsquo;is&rsquo; values for the <code>Mac_web_proxy['firewire']</code> resource, and assign this provider instance as the value
of the <code>provider=</code> method to the instance of the mac_web_proxy TYPE that is the
VALUE of the &lsquo;firewire&rsquo; key of the hash that&rsquo;s passed to <code>self.prefetch</code>.</p>

<p><strong>No, really, that&rsquo;s what it&rsquo;s supposed to do. I&rsquo;m not even sure what&rsquo;s real anymore</strong></p>

<p>You&rsquo;ll remember that <code>self.instances</code> gives us an array of resources that were
discovered on the system, so we have THAT part of the implementation written. We also have the
hash of resources that were encountered in the catalog &ndash; so we have THAT
part done too. Our only job is to connect the dots (la la la la), programmatically
speaking.  This should just about do it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">prefetch</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
</span><span class='line'>  <span class="n">instances</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prov</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="o">[</span><span class="n">prov</span><span class="o">.</span><span class="n">name</span><span class="o">]</span>
</span><span class='line'>      <span class="n">resource</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">prov</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I want to make a confession right now &ndash; I&rsquo;ve only ever copied and pasted this
code into every provider I&rsquo;ve ever written that needed <code>self.prefetch</code> implemented.
It wasn&rsquo;t until someone actually asked me what it DID that I had to walk the path
of figuring out EXACTLY what it did. Based on the last couple of paragraphs &ndash; can
you blame me?</p>

<p>This code iterates through the array of resources returned by <code>self.instances</code>,
tries to assign a variable <code>resource</code> based on referencing a key in the
<code>resources</code> hash using the name of the resource (remember, <code>resources</code> is
a hash containing all resources in the catalog), and, if this assignment works
(i.e. it isn&rsquo;t <code>nil</code>, which is what happens when you reference a key in a Ruby
hash that doesn&rsquo;t exist), then we&rsquo;re calling the <code>provider=</code> method on the
instance of the type that was referenced in the <code>resources</code> hash, and passing
it the resource that was discovered on the system by <code>self.instances</code>.</p>

<p>Wow.</p>

<p>Why <strong>DID</strong> we do all of that?  We did it all for the <code>@provider_hash</code>. Doing
this will populate <code>@provider_hash</code> in all methods of the instance of the
provider (i.e. <code>exists?</code>, <code>create</code>, <code>destroy</code>, etc..) just like <code>self.instances</code>
did for <code>puppet resource</code>.</p>

<h2>Flush it; Ship it</h2>

<p>As I alluded to above, the opposite side of the coin to prefetching (which
is a way to query the state for all resources at once) is flushing (or
specifically the <code>flush</code> method). The <code>flush</code> method is called once per
resource whenever the &lsquo;is&rsquo; and &lsquo;should&rsquo; values for a property differ (and
synchronization needs to occur). The <code>flush</code> method <strong>does not take the place
of property setter methods</strong>, but, rather, is used in conjunction with them
to determine how to synchronize resource property values. In this vein, it&rsquo;s
a single trigger that can be used to set all property values for an individual
resource simultaneously.</p>

<p>There are a couple of strategies for implementing <code>flush</code>, but one of the more
popular ones in use is to create an instance variable that will hold values to
be synchronized, and then determine inside <code>flush</code> how best to make
as-few-as-possible calls to the system to synchronize all the property values
for an individual resource.</p>

<p>Our resource type is unique because the <code>networksetup</code> binary that we&rsquo;ll be
using to synchronize values allows us to set most every property value with
a single command. Because of this, we really only need that instance variable
for one property &ndash; the ensure value.  But let&rsquo;s start with the initialization
of that instance variable for the <code>flush</code> method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>  <span class="k">super</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@property_flush</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>initialize</code> method is magic to Ruby &ndash; it&rsquo;s invoked when you instantiate
a new object. In our case, we want to create a new instance variable &ndash;
<code>@property_flush</code> &ndash; that will be available to all methods of the instance of
the provider. This instance variable will be a hash and will contain all the
&lsquo;should&rsquo; values that will need to be synchronized for a resource. The <code>super</code>
method in Ruby sends a message to the parent of the current object, asking it
to invoke a method of the same name (e.g. <code>intialize</code>).  Basically, the
<code>initialize</code> method is doing the exact same thing as it has always done with
one exception &ndash; making the instance variable available to all methods of the
instance of the provider.</p>

<h3>The only &lsquo;setter&rsquo; method you need</h3>

<p>This provider is going to be unique not only because the <code>networksetup</code>
binary will set values for ALL properties, but because to change/set ANY
property values you have to change/set ALL the property values at the same
time. Typically, you&rsquo;ll see providers that will need to pass arguments to
a binary in order to set individual values.  For example, if you had a
binary <code>fooset</code> that took arguments of <code>--bar</code> and <code>--baz</code> to set values
respectively for <code>bar</code> and <code>baz</code> properties of a resource, you might see the following
setter and flush methods for <code>bar</code> and <code>baz</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">bar</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">baz</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:baz</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">flush</span>
</span><span class='line'>  <span class="n">array_arguments</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@property_flush</span>
</span><span class='line'>    <span class="n">array_arguments</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;--bar&#39;</span> <span class="o">&lt;&lt;</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span> <span class="k">if</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span>
</span><span class='line'>    <span class="n">array_arguments</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;--baz&#39;</span> <span class="o">&lt;&lt;</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:baz</span><span class="o">]</span> <span class="k">if</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:baz</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span> <span class="n">array_arguments</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">fooset</span><span class="p">(</span><span class="n">array_arguments</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s not the case for <code>networksetup</code> &ndash; in fact, one of the ONLY places in our code
where we&rsquo;re going to throw a value inside <code>@property_flush</code> is going to be in
the <code>destroy</code> method. If our intention is to ensure a proxy absent (or, in
this case, disable the proxy for a network interface), then we can short-circuit
the method we&rsquo;re going to create to set proxy values by simply checking for
a value in <code>@property_flush[:ensure]</code>. Here&rsquo;s what the <code>destroy</code> method looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>  <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:absent</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need a method that will set values for our proxy. This method will
handle all interaction to <code>networksetup</code>.  So, how do you set proxy values
with <code>networksetup</code>?</p>

<pre><code>networksetup -setwebproxy &lt;networkservice&gt; &lt;domain&gt; &lt;port number&gt; &lt;authenticated&gt; &lt;username&gt; &lt;password&gt;
</code></pre>

<p>The three properties to our <code>mac_web_proxy</code> type are <code>proxy_port</code>, <code>proxy_server</code>,
and <code>proxy_authenticated</code> which map to the &lsquo;&lt;port number>&rsquo;, &lsquo;&lt;domain>&rsquo;,
and &lsquo;&lt;authenticated>&rsquo; values in this command. To change any of these values
means we have to pass ALL of these values (again, which is why our <code>flush</code>
implementation may be unique from other <code>flush</code> implementations). Here&rsquo;s what
the <code>set_proxy</code> method looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">set_proxy</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:absent</span>
</span><span class='line'>      <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setwebproxystate&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">].</span><span class="n">nil?</span> <span class="ow">or</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">].</span><span class="n">nil?</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Proxy types other than &#39;auto&#39; require both a proxy_server and proxy_port setting&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_authenticated</span><span class="o">]</span> <span class="o">!=</span> <span class="ss">:true</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span>
</span><span class='line'>      <span class="o">[</span>
</span><span class='line'>        <span class="s1">&#39;-setwebproxy&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span>
</span><span class='line'>      <span class="o">[</span>
</span><span class='line'>        <span class="s1">&#39;-setwebproxy&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;on&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:authenticated_username</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">[</span><span class="ss">:authenticated_password</span><span class="o">]</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setwebproxystate&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This helper method does all the validation checks for required properties,
executes the correct command, and enables the proxy. Now, let&rsquo;s implement
<code>flush</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">flush</span>
</span><span class='line'>  <span class="n">set_proxy</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Collect the resources again once they&#39;ve been changed (that way `puppet</span>
</span><span class='line'>  <span class="c1"># resource` will show the correct values after changes have been made).</span>
</span><span class='line'>  <span class="vi">@property_hash</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">get_proxy_properties</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last line re-populates <code>@property_hash</code> with the current resource values,
and is necessary for <code>puppet resource</code> to return correct values after it
makes a change to a resource during a run.</p>

<h3>The final method</h3>

<p>We&rsquo;ve implemented logic to query the state of all resources, to prefetch those
states, to make changes to all properties at once, and to destroy a resource
if it exists, but we&rsquo;ve yet to implement logic to CREATE a resource if it
doesn&rsquo;t exist and it should.  Well, this is a bit of a lie &ndash; the logic is in
the code, but we don&rsquo;t have a <code>create</code> method, so Puppet&rsquo;s going to complain:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:present</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Technically, this method doesn&rsquo;t have to do a DAMN thing. Why? Remember how the
<code>flush</code> method is triggered when a resource&rsquo;s &lsquo;is&rsquo; values differ from its
&lsquo;should&rsquo; values? Also, remember how the <code>flush</code> method only calls the <code>set_proxy</code>
method? And, finally, remember how <code>set_proxy</code> only checks if
<code>@property_flush[:ensure] == :absent</code> (and if it doesn&rsquo;t, then it goes about
its merry way running <code>networksetup</code>)?  Right, well add these things up and
you&rsquo;ll realize that the <code>create</code> method is essentially meaningless based on our
implementation (but if you OMIT <code>create</code>, then Puppet&rsquo;s going to throw a shit-fit
in the shape of of a <code>Puppet::Error</code> exception):</p>

<pre><code>Error: /Mac_web_proxy[firewire]/ensure: change from absent to present failed: Could not set 'present' on ensure: undefined method `create' for Mac_web_proxy[firewire]:Puppet::Type::Mac_web_proxy
</code></pre>

<p>So make Puppet happy and write the goddamn <code>create</code> method, okay?</p>

<h2>The complete provider:</h2>

<p>Wow, that was a wild ride, huh?  If you&rsquo;ve been coding along, you should have
created a file that looks something like this:</p>

<figure class='code'><figcaption><span>lib/puppet/provider/mac_web_proxy/ruby.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:mac_web_proxy</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">commands</span> <span class="ss">:networksetup</span> <span class="o">=&gt;</span> <span class="s1">&#39;networksetup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mk_resource_methods</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>    <span class="k">super</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@property_flush</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_list_of_interfaces</span>
</span><span class='line'>    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="s1">&#39;-listallnetworkservices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">interfaces</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'>    <span class="n">interfaces</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>    <span class="n">interface_properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-getwebproxy&#39;</span><span class="p">,</span> <span class="n">int</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;#get_proxy_properties had an error -&gt; </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">output_array</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">output_array</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>      <span class="n">line_values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">line_values</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Enabled&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span> <span class="p">?</span> <span class="ss">:absent</span> <span class="p">:</span> <span class="ss">:present</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Server&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Port&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">when</span> <span class="s1">&#39;Authenticated Proxy Enabled&#39;</span>
</span><span class='line'>        <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:proxy_authenticated</span><span class="o">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">line_values</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:ruby</span>
</span><span class='line'>    <span class="n">interface_properties</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>     <span class="o">=</span> <span class="n">int</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Interface properties: </span><span class="si">#{</span><span class="n">interface_properties</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">interface_properties</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>    <span class="n">get_list_of_interfaces</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">int</span><span class="o">|</span>
</span><span class='line'>      <span class="n">proxy_properties</span> <span class="o">=</span> <span class="n">get_proxy_properties</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>      <span class="kp">new</span><span class="p">(</span><span class="n">proxy_properties</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:present</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>    <span class="vi">@property_hash</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:present</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:absent</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">prefetch</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
</span><span class='line'>    <span class="n">instances</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prov</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="o">[</span><span class="n">prov</span><span class="o">.</span><span class="n">name</span><span class="o">]</span>
</span><span class='line'>        <span class="n">resource</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">prov</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_proxy</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@property_flush</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:absent</span>
</span><span class='line'>        <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setwebproxystate&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">].</span><span class="n">nil?</span> <span class="ow">or</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">].</span><span class="n">nil?</span><span class="p">)</span>
</span><span class='line'>      <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Both the proxy_server and proxy_port parameters require a value.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_authenticated</span><span class="o">]</span> <span class="o">!=</span> <span class="ss">:true</span>
</span><span class='line'>      <span class="n">networksetup</span><span class="p">(</span>
</span><span class='line'>        <span class="o">[</span>
</span><span class='line'>          <span class="s1">&#39;-setwebproxy&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">networksetup</span><span class="p">(</span>
</span><span class='line'>        <span class="o">[</span>
</span><span class='line'>          <span class="s1">&#39;-setwebproxy&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_server</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:proxy_port</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;on&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:authenticated_username</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">[</span><span class="ss">:authenticated_password</span><span class="o">]</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setwebproxystate&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">flush</span>
</span><span class='line'>    <span class="n">set_proxy</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Collect the resources again once they&#39;ve been changed (that way `puppet</span>
</span><span class='line'>    <span class="c1"># resource` will show the correct values after changes have been made).</span>
</span><span class='line'>    <span class="vi">@property_hash</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">get_proxy_properties</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Undoubtedly there are better ways to write this Ruby code, no? Also, I&rsquo;m SURE
I have some errors/bugs in that code. It&rsquo;s those things that keep me in a job&hellip;</p>

<h2>Final Thoughts</h2>

<p>So, I write these posts not to belittle or mock anyone who works on Puppet
or wrote any of its implementation (except the amazing/terrifying bastard who
came up with <code>self.prefetch</code>). Anybody who contributes to open source and who
builds a tool to save some time for a bunch of sysadmins is fucking awesome
in my book.</p>

<p>No, I write these posts so that you can understand the <strong>&lsquo;WHY&rsquo;</strong> piece of the
puzzle. If you fuck up the <strong>&lsquo;HOW&rsquo;</strong> of the code, you can spend some time in
Google and IRB to figure it out, but if you don&rsquo;t understand the <strong>&lsquo;WHY&rsquo;</strong>
then you&rsquo;re probably not going to even bother.</p>

<p>Also, selfishly, I move from project to project so quickly that it&rsquo;s REALLY
easy to forget both why AND how I did what I did. Posts like these give me
someplace to point people when they ask me &ldquo;What&rsquo;s <code>self.prefetch</code>?&rdquo; that
ISN&rsquo;T just the source code or a liquor store.</p>

<p>This isn&rsquo;t the last post in the series, by the way. I haven&rsquo;t even TOUCHED
on writing unit tests for this code, so that&rsquo;s going to be a WHOLE other
piece altogether. Also, while this provider manages a <strong>WEB</strong> proxy for
a network interface, understand that there are MANY MORE kinds of proxies
for OS X network interfaces (including socks and gopher!). A future post
will show you how to refactor the above into a parent provider that can
be inherited to allow for code re-use among all the proxy providers that I
need to create.</p>

<p>As always, you&rsquo;re more than welcome to comment, ask questions, or simply bitch
at me both on this blog as well as <a href="http://www.twitter.com/glarizza">on Twitter: @glarizza</a>. Hopefully
this post helped you out and you learned a little bit more about how Puppet
providers do their dirty work&hellip;</p>

<p>Namaste, bitches.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[When to Hiera (Aka: How Do I Module?)]]></title>
    <link href="http://garylarizza.com/blog/2013/12/08/when-to-hiera/"/>
    <updated>2013-12-08T15:31:54-08:00</updated>
    <id>http://garylarizza.com/blog/2013/12/08/when-to-hiera</id>
    <content type="html"><![CDATA[<p>I&rsquo;m convinced that writing Puppet modules is the ultimate exercise in bikeshedding:
if it works, someone&rsquo;s probably going to tell you that you could have done it better,
if you&rsquo;re using the methods suggested today, they&rsquo;re probably going to be out-of-date
in about 6 months, and good luck writing something that someone else can use cleanly
without needing to change it.</p>

<p>I can help you with the last two.</p>

<h2>Data and Code Separation == bliss?</h2>

<p><a href="http://bit.ly/puppetdata">I wrote a blog post about 2 years ago</a> detailing why separating
your data from your Puppet code was a good idea. The idea is still valid, which means
it&rsquo;s probably one of the better ideas I&rsquo;ve ever stolen (Does anyone want any HD-DVDs?).
Hunter Haugen and I <a href="http://bit.ly/hierablog">put together a quick blog post on using Hiera</a>
to solve the data/code problem because there wasn&rsquo;t a great bit of documentation on Hiera
at that point in time. Since then, Hiera&rsquo;s been widely accepted as &ldquo;a good idea&rdquo; and is
in use in production Puppet environments around the world. In most every environment,
usage of Hiera by more than just one person eventually gives birth to the question
that inspired this post:</p>

<h4>&ldquo;What the hell does and does NOT belong in Hiera?&rdquo;</h4>

<h2>Puppet data models</h2>

<h3>The params class pattern</h3>

<p>Many Puppet modules out there since Puppet 2.6 have begun using this pattern:</p>

<figure class='code'><figcaption><span>puppetlabs-mysql/manifests/server.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">mysql::server</span> <span class="p">(</span>
</span><span class='line'>  <span class="nv">$config_file</span>             <span class="p">=</span> <span class="nv">$mysql::params::config_file</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$manage_config_file</span>      <span class="p">=</span> <span class="nv">$mysql::params::manage_config_file</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$old_root_password</span>       <span class="p">=</span> <span class="nv">$mysql::params::old_root_password</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$override_options</span>        <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'>  <span class="nv">$package_ensure</span>          <span class="p">=</span> <span class="nv">$mysql::params::server_package_ensure</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$package_name</span>            <span class="p">=</span> <span class="nv">$mysql::params::server_package_name</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$purge_conf_dir</span>          <span class="p">=</span> <span class="nv">$mysql::params::purge_conf_dir</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$remove_default_accounts</span> <span class="p">=</span> <span class="ss">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$restart</span>                 <span class="p">=</span> <span class="nv">$mysql::params::restart</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$root_group</span>              <span class="p">=</span> <span class="nv">$mysql::params::root_group</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$root_password</span>           <span class="p">=</span> <span class="nv">$mysql::params::root_password</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$service_enabled</span>         <span class="p">=</span> <span class="nv">$mysql::params::server_service_enabled</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$service_manage</span>          <span class="p">=</span> <span class="nv">$mysql::params::server_service_manage</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$service_name</span>            <span class="p">=</span> <span class="nv">$mysql::params::server_service_name</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$service_provider</span>        <span class="p">=</span> <span class="nv">$mysql::params::server_service_provider</span><span class="p">,</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  # Deprecated parameters</span>
</span><span class='line'>  <span class="nv">$enabled</span>                 <span class="p">=</span> <span class="ss">undef</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$manage_service</span>          <span class="p">=</span> <span class="ss">undef</span>
</span><span class='line'><span class="p">)</span> <span class="kd">inherits</span> <span class="nc">mysql::params</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Puppet goodness goes here</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re not familiar, this is a Puppet class definition for <code>mysql::server</code> that has several parameters
defined and defaulted to values that come out of the <code>mysql::params</code> class.  The
<code>mysql::params</code> class looks a bit like this:</p>

<figure class='code'><figcaption><span>puppetlabs-mysql/manifests/params.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">mysql::params</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">case</span> <span class="nv">$::osfamily</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;RedHat&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">if</span> <span class="nv">$::operatingsystem</span> <span class="o">==</span> <span class="s1">&#39;Fedora&#39;</span> <span class="o">and</span> <span class="p">(</span><span class="ss">is_integer</span><span class="p">(</span><span class="nv">$::operatingsystemrelease</span><span class="p">)</span> <span class="o">and</span> <span class="nv">$::operatingsystemrelease</span> <span class="o">&gt;=</span> <span class="ss">19</span> <span class="o">or</span> <span class="nv">$::operatingsystemrelease</span> <span class="o">==</span> <span class="s2">&quot;Rawhide&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$client_package_name</span> <span class="o">=</span> <span class="s1">&#39;mariadb&#39;</span>
</span><span class='line'>        <span class="nv">$server_package_name</span> <span class="o">=</span> <span class="s1">&#39;mariadb-server&#39;</span>
</span><span class='line'>      } <span class="kr">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$client_package_name</span> <span class="o">=</span> <span class="s1">&#39;mysql&#39;</span>
</span><span class='line'>        <span class="nv">$server_package_name</span> <span class="o">=</span> <span class="s1">&#39;mysql-server&#39;</span>
</span><span class='line'>      }
</span><span class='line'>      <span class="nv">$basedir</span>             <span class="o">=</span> <span class="s1">&#39;/usr&#39;</span>
</span><span class='line'>      <span class="nv">$config_file</span>         <span class="o">=</span> <span class="s1">&#39;/etc/my.cnf&#39;</span>
</span><span class='line'>      <span class="nv">$datadir</span>             <span class="o">=</span> <span class="s1">&#39;/var/lib/mysql&#39;</span>
</span><span class='line'>      <span class="nv">$log_error</span>           <span class="o">=</span> <span class="s1">&#39;/var/log/mysqld.log&#39;</span>
</span><span class='line'>      <span class="nv">$pidfile</span>             <span class="o">=</span> <span class="s1">&#39;/var/run/mysqld/mysqld.pid&#39;</span>
</span><span class='line'>      <span class="nv">$root_group</span>          <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    <span class="s1">&#39;Debian&#39;</span><span class="p">:</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">      ## More parameters defined here</span>
</span><span class='line'>    }
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This pattern puts all conditional logic for all the variables/parameters used
in the module inside one class &ndash; the <code>mysql::params</code> class.  It&rsquo;s called the
&lsquo;params class pattern&rsquo; because we suck at naming things.</p>

<h4>Pros:</h4>

<ul>
<li>All conditional logic is in a single class</li>
<li>You always know which class to seek out if you need to change any of the logic used to determine a variable&rsquo;s value</li>
<li>You can use the include function because parameters for each class will be defaulted to the values that came out of the params class</li>
<li>If you need to override the value of a particular parameter, you can still use the parameterized class declaration syntax to do so</li>
<li>Anyone using Puppet version 2.6 or higher can use it (i.e. anyone who&rsquo;s been using Puppet since about 2010).</li>
</ul>


<h5>Cons:</h5>

<ul>
<li>Conditional logic is repeated in every module</li>
<li>You will need to use inheritance to inherit parameter values in each subclass</li>
<li>It&rsquo;s another place to look if you ALSO use Hiera inside the module</li>
<li>Data is inside the manifest, so business logic is also inside params.pp</li>
</ul>


<h3>Hiera defaults pattern</h3>

<p>When Hiera hit the scene, one of the first things people tried to do was
to incorporate it into existing modules. The logic at that time was that
you could keep all parameter defaults inside Hiera, rid yourself of the
params class, and then just make Hiera calls out for your data. This
pattern looks like this:</p>

<figure class='code'><figcaption><span>puppetlabs-mysql/manifests/server.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">mysql::server</span> <span class="p">(</span>
</span><span class='line'>  <span class="nv">$config_file</span>             <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::config_file&#39;</span><span class="p">,</span> <span class="s1">&#39;default value&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">$manage_config_file</span>      <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::manage_config_file&#39;</span><span class="p">,</span> <span class="s1">&#39;default value&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">$old_root_password</span>       <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::old_root_password&#39;</span><span class="p">,</span> <span class="s1">&#39;default value&#39;</span><span class="p">),</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  ## Repeat the above pattern</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Puppet goodness goes here</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h4>Pros:</h4>

<ul>
<li>All data is locked up in Hiera (and its multiple backends)</li>
<li>Default values can be provided if a Hiera lookup fails</li>
</ul>


<h4>Cons:</h4>

<ul>
<li>You need to have Hiera installed, enabled, and configured to use this pattern</li>
<li>All data, including non-business logic, is in Hiera</li>
<li>If you use the default value, data could either come from Hiera OR the default (multiple places to look when debugging)</li>
</ul>


<h3>Hybrid data model</h3>

<p>This pattern is for those people who want the portability of the params.pp class
combined with the power of Hiera. Because it&rsquo;s a hybrid, there are multiple ways
that people have set it up.  Here&rsquo;s a general example:</p>

<figure class='code'><figcaption><span>puppetlabs-mysql/manifests/server.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">mysql::server</span> <span class="p">(</span>
</span><span class='line'>  <span class="nv">$config_file</span>             <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::config_file&#39;</span><span class="p">,</span> <span class="nv">$mysql::params::config_file</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">$manage_config_file</span>      <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::manage_config_file&#39;</span><span class="p">,</span> <span class="nv">$mysql::params::manage_config_file</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">$old_root_password</span>       <span class="p">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;mysql::params::old_root_password&#39;</span><span class="p">,</span> <span class="nv">$mysql::params::old_root_password</span><span class="p">),</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  ## Repeat the above pattern</span>
</span><span class='line'><span class="p">)</span> <span class="kd">inherits</span> <span class="nc">mysql::params</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Pros:</h4>

<ul>
<li>Data is sought from Hiera first and then defaulted back to the params class parameter</li>
<li>Keep non-business logic (i.e. OS specific data) in the params class and business logic in Hiera</li>
<li>Added benefits of both models</li>
</ul>


<h4>Cons:</h4>

<ul>
<li>Where did the variable get set &ndash; Hiera or the params class? Debugging can be hard</li>
<li>Requires Hiera to be setup to use the module</li>
<li>If you fudge a variable name in Hiera, you get the params class default &ndash; see Con #1</li>
</ul>


<h3>Hiera data bindings in Puppet 3.x.x</h3>

<p>In Puppet 3.0.0, there was a concept introduced called Data Bindings. This created
a federated data model automatically incorporating a Hiera lookup. Previously, the
order that Puppet would use to determine the value of a parameter was to first use
a value passed with the parameterized class declaration syntax (i.e. the below:).</p>

<figure class='code'><figcaption><span>parameterized class declaration </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;apache&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">package_name</span> <span class="p">=&gt;</span> <span class="s1">&#39;httpd&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a parameter was not passed with the parameterized class syntax (like the &lsquo;package_name&rsquo;
parameter above&#8217;), Puppet would then look for a default value inside the class definition
(i.e. the below:).</p>

<figure class='code'><figcaption><span>parameter default in a class definition </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">ntp</span> <span class="p">(</span>
</span><span class='line'>  <span class="nv">$ntpserver</span> <span class="p">=</span> <span class="s1">&#39;default.ntpserver.org&#39;</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  # Use $ntpserver in a file declaration...</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>If the value of &lsquo;ntpserver&rsquo; wasn&rsquo;t passed with a parameterized class declaration,
then the value would be set to &lsquo;default.ntpserver.org&rsquo;, since that&rsquo;s the default
set in the above class definition.</p>

<p>Failing both of these conditions, Puppet would throw a parse error and say
that it couldn&rsquo;t determine a value for a class parameter.</p>

<p>As of Puppet 3.0.0, Puppet will now do a Hiera lookup for the fully namespaced
value of a class parameter</p>

<h3>Roles and Profiles</h3>

<p><a href="http://sysadvent.blogspot.com/2012/12/day-13-configuration-management-as-legos.html">The roles and profiles pattern</a> has been written about
a number of times and is ALSO considered to be &lsquo;a best practice&rsquo; when setting
up your Puppet environment. What roles and profiles gets you is a &lsquo;wrapper
class&rsquo; that allows you to declare classes within this wrapper class:</p>

<figure class='code'><figcaption><span>profiles/manifests/wordpress.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">profiles::wordpress</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  # Data Lookups</span>
</span><span class='line'>  <span class="nv">$site_name</span>               <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::site_name&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_user_password</span> <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_user_password&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$mysql_root_password</span>     <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::mysql_root_password&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_host</span>       <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_host&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_name</span>       <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_name&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$wordpress_db_password</span>   <span class="o">=</span> <span class="nf">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::wordpress::wordpress_db_password&#39;</span><span class="p">)</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Create user</span>
</span><span class='line'>  <span class="nc">group</span> <span class="p">{</span> <span class="s1">&#39;wordpress&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nc">user</span> <span class="p">{</span> <span class="s1">&#39;wordpress&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>   <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">gid</span>      <span class="p">=&gt;</span> <span class="s1">&#39;wordpress&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">password</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_user_password</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">home</span>     <span class="p">=&gt;</span> <span class="s1">&#39;/var/www/wordpress&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Configure mysql</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;mysql::server&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">root_password</span> <span class="p">=&gt;</span> <span class="nv">$wordpress_root_password</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;mysql::bindings&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">php_enable</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ## Configure apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache::mod::php</span>
</span><span class='line'>}<span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">## Continue with declarations...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that any variables that might have business specific logic are set with
Hiera lookups. These Hiera lookups do NOT have default values, which means the
<code>hiera()</code> function will throw a parse error if a value is not returned. This
is IDEAL because we WANT TO KNOW if a Hiera lookup fails &ndash; this means we failed
to put the data in Hiera and should be corrected BEFORE a state that might
contain invalid data is enforced with Puppet.</p>

<p>You then have a &lsquo;Role&rsquo; wrapper class that simply includes many of the &lsquo;Profile&rsquo;
wrapper classes:</p>

<figure class='code'><figcaption><span>roles/manifests/frontend.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">roles::frontend</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">profiles::mysql</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">profiles::apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">profiles::java</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">profiles::jboss</span>
</span><span class='line'><span class="c-Singleline">  # include more profiles...</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The idea being that Profiles abstract all the technical bits that need to
declared to setup a piece of technology, and Roles will abstract all the
business logic for what pieces of technology should be installed on a certain
&lsquo;class&rsquo; of machine.  Basically, you can say that &ldquo;all our frontend infrastructure
should have mysql, apache, java, jboss&hellip;&rdquo;.  In this statement, the Role is
&lsquo;frontend infrastructure&rsquo; and the Profiles are &lsquo;mysql, apache, java, jboss&hellip;&rsquo;.</p>

<h4>Pros:</h4>

<ul>
<li>Hiera data lookups are confined to a wrapper class OUTSIDE of the component modules (like mysql, apache, java, etc&hellip;)</li>
<li>Data lookups for parameters containing business logic are done with Hiera</li>
<li>Non-business specific data is pulled from the module (i.e. the params class)</li>
<li>Wrapper modules can be &lsquo;included&rsquo; with the <code>include</code> function, helping to eliminate multiple class declarations using the parameterized class declaration syntax</li>
<li>Component modules are backward-compatible to Puppet 2.6 while wrapper modules still get to use a modern data lookup mechanism (Hiera)</li>
<li>Component modules do NOT contain any business specific logic, which means they&rsquo;re portable</li>
</ul>


<h4>Cons:</h4>

<ul>
<li>Hiera must be setup to use the wrapper modules</li>
<li>Wrapper modules add another debug path for variable data</li>
<li>Wrapper modules add another layer of abstraction</li>
</ul>


<h2>Data in Puppet Modules</h2>

<p>R.I. Pienaar (the original author of MCollective, Hiera, and much more)
<a href="http://www.devco.net/archives/2013/12/08/better-puppet-modules-using-hiera-data.php">published a blog post</a>
recently on implementing a folder for Puppet modules that Hiera can traverse
when it does data lookups. This construct isn&rsquo;t new,
<a href="https://projects.puppetlabs.com/issues/16856">there was a feature request</a>
for this behavior filed in October of 2012 with a
<a href="https://github.com/puppetlabs/puppet/pull/1217">subsequent pull request</a>
that implemented this functionality (they&rsquo;re both worth reads for further
information). The pull request didn&rsquo;t get merged, and so R.I. implemented
the functionality <a href="http://forge.puppetlabs.com/ripienaar/module_data">inside a module on the Puppet Forge</a>.
In a nutshell, it&rsquo;s a hiera.yaml configuration file INSIDE THE MODULE that
implements a module-specific hierarchy, and a &lsquo;data&rsquo; folder (also inside
the module) that allows for individual YAML files that Hiera could read.
This hierarchy is consulted AFTER the site-specific <code>hiera.yaml</code> file
is read (i.e. <code>/etc/puppet/hiera.yaml</code> or <code>/etc/puppetlabs/puppet/hiera.yaml</code>),
and the in-module data files are consulted AFTER the site-specific Hiera
data files are read (normally found in either <code>/etc/puppet/hieradata</code> or
<code>/etc/puppetlabs/puppet/hieradata</code>).</p>

<p>The argument here is that there&rsquo;s a data store for <strong>SITE-SPECIFIC</strong> Hiera
data that should be kept outside of modules, but there&rsquo;s not a <strong>MODULE-SPECIFIC</strong>
data store that Hiera can use. The argument isn&rsquo;t whether data that should be
shared with other people belongs inside a site-specific Hiera datastore
(protip: it doesn&rsquo;t. Data that&rsquo;s not business-specific should be shared
with others and kept inside the module), the argument is that it shouldn&rsquo;t
be locked up inside the DSL where the barrier-to-entry is learning Puppet&rsquo;s
DSL syntax. Whereas <code>/etc/puppet/hiera.yaml</code> or <code>/etc/puppetlabs/puppet/hiera.yaml</code>
sets up the hierarchy for all your site-specific data, there&rsquo;s no per-module
<code>hiera.yaml</code> file for all module-specific data, and there&rsquo;s no place to put
module-specific Hiera data.</p>

<h4>But module-specific data goes inside the params class and business-specific data goes inside Hiera, right?</h4>

<p>Sure, but for some people the Puppet DSL is a barrier. The argument is that
there should be a lower barrier to entry to contribute parameter data
to Puppet that doesn&rsquo;t require you to learn the syntax of if/case/selector
statements in the Puppet DSL. There&rsquo;s also the argument that if you want
to add support for an operatingsystem to your module, you have to modify
the params class file and add another entry to the if/case/selector
statement &ndash; wouldn&rsquo;t it be easier to just add another YAML file into
a data folder that doesn&rsquo;t affect existing datafiles?</p>

<h4>Great, ANOTHER hierarchy to traverse for data &ndash; that&rsquo;s going to get confusing</h4>

<p>Well, think about it right now &ndash; most EVERY params class of EVERY module
(if it supports multiple operatingsystems)
does some sort of conditional logic to determine values for parameters
on a per-OS basis. That&rsquo;s something that you need to traverse. And many
modules use different conditional data to determine what paramters to use. Look
at the mysql params class example above &ndash; it not only splits on
<code>$osfamily</code>, but it also checks specific operatingsystems. That&rsquo;s a
conditional inside a conditional. You&rsquo;re TRAVERSING conditional data
right now to find a value &ndash; the only difference is that this method
doesn&rsquo;t use the DSL, it uses Hiera and YAML.</p>

<h4>Sure, but this is outside of Puppet and you&rsquo;re losing visibility inside Puppet with your data</h4>

<p>You&rsquo;re already doing that if you&rsquo;re using the params class. In this case, visibility is
moved to YAML files instead of separate Puppet classes.</p>

<h3>Setting it up</h3>

<p>You will first need to install R.I.&rsquo;s module from the Puppet Forge. As of
this writing, it&rsquo;s version <code>0.0.1</code>, so ensure you have the most recent
version using the <code>puppet module</code> tool:</p>

<pre><code>[root@linux modules]# puppet module install ripienaar/module_data
Notice: Preparing to install into /etc/puppetlabs/puppet/modules ...
Notice: Downloading from https://forge.puppetlabs.com ...
Notice: Installing -- do not interrupt ...
/etc/puppetlabs/puppet/modules
â””â”€â”€ ripienaar-module_data (v0.0.1)
</code></pre>

<p>Next, you&rsquo;ll need to setup a module to use the data-in-modules pattern. Take
a look at the tree of a sample module:</p>

<pre><code>[root@linux modules]# tree mysql/
mysql/
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ hiera.yaml
â”‚Â Â  â””â”€â”€ RedHat.yaml
â””â”€â”€ manifests
    â””â”€â”€ init.pp
</code></pre>

<p>I created a sample <code>mysql</code> module based on the examples above. All of
the module&rsquo;s Hiera data (including the module-specific hiera.yaml file)
goes in the <code>data</code> folder. This module should be placed in Puppet&rsquo;s
modulepath &ndash; and if you don&rsquo;t know where Puppet&rsquo;s modulepath is set,
run the <code>puppet config</code> face to determine that:</p>

<pre><code>[root@linux modules]# puppet config print modulepath
/etc/puppetlabs/puppet/modules:/opt/puppet/share/puppet/modules
</code></pre>

<p>In my case, I&rsquo;m putting the module in <code>/etc/puppetlabs/puppet/modules</code>
(since I&rsquo;m running Puppet Enterprise). Here&rsquo;s the hiera.yaml file
from the sample mysql module:</p>

<figure class='code'><figcaption><span>mysql/data/hiera.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{::osfamily}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also included a YAML file for the <code>$osfamily</code> of RedHat:</p>

<figure class='code'><figcaption><span>mysql/data/RedHat.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">mysql::config_file</span><span class="p-Indicator">:</span> <span class="s">&#39;/path/from/data_in_modules&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">mysql::manage_config_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'><span class="l-Scalar-Plain">mysql::old_root_password</span><span class="p-Indicator">:</span> <span class="s">&#39;password_from_data_in_modules&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, here&rsquo;s what the mysql class definition looks like from
<code>manifests/init.pp</code>:</p>

<figure class='code'><figcaption><span>mysql/manifests/init.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">mysql</span> <span class="p">(</span>
</span><span class='line'>  <span class="nv">$config_file</span>        <span class="p">=</span> <span class="s1">&#39;module_default&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$manage_config_file</span> <span class="p">=</span> <span class="s1">&#39;module_default&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">$old_root_password</span>  <span class="p">=</span> <span class="s1">&#39;module_default&#39;</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">notify</span> <span class="p">{</span> <span class="s2">&quot;The value of config_file: </span><span class="si">${config_file}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">notify</span> <span class="p">{</span> <span class="s2">&quot;The value of manage_config_file: </span><span class="si">${manage_config_file}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">notify</span> <span class="p">{</span> <span class="s2">&quot;The value of old_root_password: </span><span class="si">${old_root_password}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Everything should be setup to notify the value of a couple of parameters.
Now, to test it out&hellip;</p>

<h3>Testing data-in-modules</h3>

<p>Let&rsquo;s include the mysql class with <code>puppet apply</code> to see where it&rsquo;s looking
for data:</p>

<pre><code>[root@linux modules]# puppet apply -e 'include mysql'
Notice: The value of config_file: /path/from/data_in_modules
Notice: /Stage[main]/Mysql/Notify[The value of config_file: /path/from/data_in_modules]/message: defined 'message' as 'The value of config_file: /path/from/data_in_modules'
Notice: The value of manage_config_file: true
Notice: /Stage[main]/Mysql/Notify[The value of manage_config_file: true]/message: defined 'message' as 'The value of manage_config_file: true'
Notice: The value of old_root_password: password_from_data_in_modules
Notice: /Stage[main]/Mysql/Notify[The value of old_root_password: password_from_data_in_modules]/message: defined 'message' as 'The value of old_root_password: password_from_data_in_modules'
Notice: Finished catalog run in 0.62 seconds
</code></pre>

<p>Since I&rsquo;m running on an operatingsystem whose family is &lsquo;RedHat&rsquo; (i.e. CentOS),
you can see that the values of all the parameters were pulled from the Hiera
data files inside the module.  Let&rsquo;s temporarily change the <code>$osfamily</code> fact
value and see what happens:</p>

<pre><code>[root@linux modules]# FACTER_osfamily=Debian puppet apply -e 'include mysql'
Notice: The value of config_file: module_default
Notice: /Stage[main]/Mysql/Notify[The value of config_file: module_default]/message: defined 'message' as 'The value of config_file: module_default'
Notice: The value of old_root_password: module_default
Notice: /Stage[main]/Mysql/Notify[The value of old_root_password: module_default]/message: defined 'message' as 'The value of old_root_password: module_default'
Notice: The value of manage_config_file: module_default
Notice: /Stage[main]/Mysql/Notify[The value of manage_config_file: module_default]/message: defined 'message' as 'The value of manage_config_file: module_default'
Notice: Finished catalog run in 0.51 seconds
</code></pre>

<p>This time, when I specified a value of <code>Debian</code> for <code>$osfamily</code>, the parameter
values were pulled from the declaration in the mysql class definition (i.e.
from inside <code>mysql/manifests/init.pp</code>).</p>

<h3>Testing outside of Puppet</h3>

<p>One of the big pros of Hiera is that it comes with the <code>hiera</code> binary that can
be run from the command line to test values. This works just fine for site-specific
module data that&rsquo;s defined in the central <code>hiera.yaml</code> file that&rsquo;s usually defined
in <code>/etc/puppet</code> or <code>/etc/puppetlabs/puppet</code>, but the data-in-modules pattern relies
on a Puppet indirector to point to the current module&rsquo;s <code>data</code> folder, and thus
(as of right now) there&rsquo;s not a simple way to run the <code>hiera</code> binary to pull
data out of modules WITHOUT running Puppet. This is not a dealbreaker, and
doesn&rsquo;t stop anybody from hacking up something that WILL look inside modules
for data, but as of right now it doesn&rsquo;t yet exist. It also makes debugging for
values that come out of modules a bit more difficult.</p>

<h3>The scorecard for data-in-modules</h3>

<h4>Pros:</h4>

<ul>
<li>Parameters are defined in YAML and not Puppet DSL (i.e. you only need to know YAML and not the Puppet DSL)</li>
<li>Adding parameters is as simple as adding another YAML file to the module</li>
<li>Module authors provide module data that can be read by Puppet 3.x.x Hiera data bindings</li>
</ul>


<h4>Cons:</h4>

<ul>
<li>Must be using Puppet 3.0.0 or higher</li>
<li>Additional hierarchy and additional Hiera data file to consult when debugging</li>
<li>Not (currently) an easy/straightforward way to use the <code>hiera</code> binary to test values</li>
<li>Currently depends on a Puppet Forge module being installed on your system</li>
</ul>


<h2>What are you trying to say?</h2>

<p>I am ALL ABOUT code portability, re-usability, and not building 500 apache modules.
Ever since people have been building modules, they&rsquo;ve been putting too much data
inside modules (to the point where they can&rsquo;t share them with anyone else). I
can&rsquo;t tell you how many times I&rsquo;ve heard &ldquo;We have a module for that, but I can&rsquo;t
share it because it has all our company-specific data in it.&rdquo;</p>

<p>Conversely, I&rsquo;ve also seen organizations put EVERYTHING in their site-specific
Hiera datastore because &ldquo;that&rsquo;s the place for Puppet data.&rdquo; They usually end up
with 15+ levels in their Hiera hierarchies because they&rsquo;re doing things like
this:</p>

<figure class='code'><figcaption><span>hiera.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{environment}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{osfamily}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{osfamily}/%{operatingsystem}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{osfamily}/%{operatingsystem}/%{os_version_major}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{osfamily}/%{operatingsystem}/%{os_version_minor}&quot;</span>
</span><span class='line'>  <span class="c1"># Repeat until you have 15 levels of WTF</span>
</span></code></pre></td></tr></table></div></figure>


<p>This leads us back again to &ldquo;What does and DOESN&rsquo;T go in Hiera?&rdquo;
I usually say the following:</p>

<h4>Data in site-specific Hiera datastore</h4>

<ul>
<li>Business-specific data (i.e. internal NTP server, VIP address, per-environment java application versions, etc&hellip;)</li>
<li>Sensitive data</li>
<li>Data that you don&rsquo;t want to share with anyone else</li>
</ul>


<h4>Data that does NOT go in the site-specific Hiera datastore</h4>

<ul>
<li>OS-specific data</li>
<li>Data that EVERYONE ELSE who uses this module will need to know (paths to config files, package names, etc&hellip;)</li>
</ul>


<p>Basically, if I ask you if I can publish your module to <a href="http://forge.puppetlabs.com">the Puppet Forge</a>,
and you object because it has business-specific or sensitive data in it, then
you probably need to pull that data out of the module and put it in Hiera.</p>

<p>The recommendations that I give when I go on-site with Puppet users is the following:</p>

<ul>
<li>Use Roles/Profiles to create wrapper-classes for class declaration</li>
<li>Do ALL Hiera lookups for site-specific data inside your &lsquo;Profile&rsquo; wrapper classes</li>
<li>All module-specific data (like paths to config files, names of packages to install, etc&hellip;) should be kept in the module in the params class</li>
<li>All &lsquo;Role&rsquo; wrapper classes should just <strong>include</strong> &lsquo;Profile&rsquo; wrapper classes &ndash; nothing else</li>
</ul>


<h2>But what about Data in Modules?</h2>

<p>I went through all the trouble of writing up the Data in Modules pattern,
but I didn&rsquo;t recommend or even MENTION it in the previous section. The reason
is NOT because I don&rsquo;t believe in it (I actually think the future will be data
outside of the DSL inside a Puppet module), the reason is because it&rsquo;s not <strong>YET</strong>
in Puppet&rsquo;s core and because it&rsquo;s not <strong>YET</strong> been widely tested. If you&rsquo;re an
existing Puppet user that&rsquo;s been looking for a way to split data outside of
the DSL, here is your opportunity. Use the pattern and PLEASE report back on what
you like and don&rsquo;t like about it. The functionality is in a module, so it&rsquo;s
easy to tweak. If you&rsquo;re new to Puppet and are comfortable with the DSL, then
the params class exists and is available to you.</p>

<p>To voice your opinion or to follow the progress of data in modules,
<a href="https://projects.puppetlabs.com/issues/16856">follow or comment on this Puppet ticket.</a></p>

<h2>Update</h2>

<p><a href="http://www.devco.net/archives/2013/12/09/the-problem-with-params-pp.php">R.I. posted another article on the problem with params.pp</a>
that is worth reading. He gives compelling reasons on why he built Hiera, why
params.pp WORKS, but also why he believes it&rsquo;s not the future of Puppet. R.I.
goes even further to explain that it&rsquo;s not necessarily the Puppet DSL that is
the barrier to entry, it&rsquo;s that this sort of data belongs in a file for config
data and not INSIDE THE CODE itself (i.e. inside the Puppet DSL). Providing data
inside modules gives module authors a way to provide this configuration data
in files that AREN&rsquo;T the Puppet DSL (i.e. not inside the code).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Who Abstracted My Ruby?]]></title>
    <link href="http://garylarizza.com/blog/2013/11/26/fun-with-providers-part-2/"/>
    <updated>2013-11-26T16:01:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/11/26/fun-with-providers-part-2</id>
    <content type="html"><![CDATA[<p>Previously, on Lost, I said a lot of words about Puppet Types;
<a href="http://garylarizza.com/blog/2013/11/25/fun-with-providers/">you should totally check it out.</a>
In this second installment, you&rsquo;re going to find out how to actually throw
pure Ruby at Puppet in a way that makes you feel accomplished. And useful. And elitist.
Well, possibly just elitist. Either way, read on &ndash; there&rsquo;s much thought-leadership to be done&hellip;</p>

<p>In the last post, we learned that Types will essentially dictate the attributes
that you&rsquo;ll be passing in your resource declaration using the DSL. In the
simplest and crudest explanation I could muster, types model how your
declaration will look in the manifest. Providers are where the actual
IMPLEMENTATION happens. If you&rsquo;ve ever wondered how this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;httpd&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">installed</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>eventually gets turned into this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install -e 0 -d 0 -y httpd
</span></code></pre></td></tr></table></div></figure>


<p>your answer would be &ldquo;It&rsquo;s in the provider file&rdquo;.</p>

<h2>Dirty black magic</h2>

<p>I&rsquo;ve seen people do the craziest shit imaginable in the Puppet DSL simply because
they&rsquo;re:</p>

<ul>
<li>Unsure how types and providers work</li>
<li>Afraid of Ruby</li>
<li>Confused by error messages</li>
<li>Afraid to ask for help</li>
</ul>


<p>Sometimes you have a problem that can only be solved by interacting with data
that&rsquo;s returned by a binary (using some binary to get a value, and then using
that binary to set a value, and so on&hellip;). I see people writing defined resource
types with a SHIT TON of <code>exec</code> statements and conditional logic to model this
data when a type and provider would not only BETTER model the problem but would
also be shareable and re-useable by other folk. The issue is that while the DSL
is REALLY easy to get started with, types and providers still feel like dirty
black magic.</p>

<p>The reason is because they&rsquo;re dirty black magic.</p>

<p>Hopefully, I can help get you over the hump and onto a working implementation. Let&rsquo;s
take a problem I had last week:</p>

<h2>Do this if that, and then be done</h2>

<p>I was working with a group who wanted to set a list of domains that would
bypass their web proxy for a specific network interface on an OS X workstation.
It sounds so simple, because it was. Due to the amount of time I had on-site,
I wrote a class with some nasty <code>exec</code> statements, a couple of facts, and some
conditional logic because that&rsquo;s what you do when you&rsquo;re in a hurry&hellip;but it
doesn&rsquo;t make it right. When I left, I hacked up a type and provider, and it&rsquo;s
a GREAT example because you probably have a similar problem.  Let&rsquo;s look at the
information we have:</p>

<p>The list of network interfaces:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â””â–· networksetup -listallnetworkservices
</span><span class='line'>An asterisk <span class="o">(</span>*<span class="o">)</span> denotes that a network service is disabled.
</span><span class='line'>Bluetooth DUN
</span><span class='line'>Display Ethernet
</span><span class='line'>Ethernet
</span><span class='line'>FireWire
</span><span class='line'>Wi-Fi
</span><span class='line'>iPhone USB
</span><span class='line'>Bluetooth PAN
</span></code></pre></td></tr></table></div></figure>


<p>Getting the list of bypass domains for an interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â””â–· networksetup -getproxybypassdomains Ethernet
</span><span class='line'>www.garylarizza.com
</span><span class='line'>*.corp.net
</span><span class='line'>10.13.1.3/24
</span></code></pre></td></tr></table></div></figure>


<p>The message displayed when no domains are set for an interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â””â–· networksetup -getproxybypassdomains FireWire
</span><span class='line'>There aren<span class="err">&#39;</span>t any bypass domains <span class="nb">set </span>on FireWire.
</span></code></pre></td></tr></table></div></figure>


<p>Setting the list of bypass domains for an interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â””â–· networksetup -setproxybypassdomains Ethernet <span class="s1">&#39;*.corp.net&#39;</span> <span class="s1">&#39;10.13.1.3/24&#39;</span> <span class="s1">&#39;www.garylarizza.com&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect &ndash; all of that is done with a single binary, and it&rsquo;s pretty straightforward. Let&rsquo;s look at the type I ended up creating for this problem:</p>

<figure class='code'><figcaption><span>lib/puppet/type/mac_proxy_bypassdomains.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">newtype</span><span class="p">(</span><span class="ss">:mac_proxy_bypassdomains</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Puppet type that models bypass domains for a network interface on OS X&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ensurable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:namevar</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Interface name - currently must be &#39;friendly&#39; name (e.g. Ethernet)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:domains</span><span class="p">,</span> <span class="ss">:array_matching</span> <span class="o">=&gt;</span> <span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Domains which should bypass the proxy&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">insync?</span><span class="p">(</span><span class="n">is</span><span class="p">)</span>
</span><span class='line'>      <span class="n">is</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">should</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The type uses a namevar parameter called &lsquo;name&rsquo;, which is the name of the network interface.
This means that we can set one list of bypass domains for every network interface.
There&rsquo;s a single property, &lsquo;domains&rsquo; that accepts an array of domains that should bypass
the proxy for the network interface. I&rsquo;ve overridden the <code>insync?</code> method for the domains
property to sort the array values on both ends &ndash; this means that the ORDER of the domains
doesn&rsquo;t matter, I only care that the domains specified exist on the system. Finally, the
type is ensurable (which means that we can create a list of domains and remove/destroy
the list of domains for a network interface).</p>

<h2>Setup the provider</h2>

<p>Okay, so we&rsquo;ve defined the problem, seen how to interact with the system to get us the
data that we need, setup a type to model the data, and now the last thing left to do
is to wire up the provider to make the binary calls we need and return the data we
want.</p>

<h3>Typos are not your friend.</h3>

<p>The first thing you will encounter is &ldquo;Puppet&rsquo;s predictable naming pattern&rdquo;
that is used by the Puppet autoloader. Typos are not fun, and omitting a single
letter in either the filename or the provider name will render your provider
(emotionally) unavailable to Puppet. Our type is called &lsquo;mac_proxy_bypassdomains&rsquo;,
as types are generally named along the lines of &lsquo;what does this data model?&rsquo; The
provider name is generally the name of the underlying technology that&rsquo;s doing
the modeling. For the package type, the providers are named after the package
management systems (e.g. yum, apt, pacman, zypper, pip), for the file type, the
providers are loosely named for the operatingsystem kernel type on which files
are to be created (e.g. windows, posix). In our example, I simply chose to name
the provider &lsquo;ruby&rsquo; because, as a Puppet Labs employee, <strong>I TOO</strong> suck at naming
things.</p>

<p>Here&rsquo;s a tree of my module to understand how the type and provider files are
to be laid out:</p>

<figure class='code'><figcaption><span>Module tree </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”œâ”€â”€ Modulefile
</span><span class='line'>â”œâ”€â”€ README.markdown
</span><span class='line'>â””â”€â”€ lib
</span><span class='line'>Â Â   â””â”€â”€ puppet
</span><span class='line'>Â Â       â”œâ”€â”€ provider
</span><span class='line'>Â Â       â”‚Â Â  â”œâ”€â”€ mac_proxy_bypassdomains
</span><span class='line'>Â Â       â”‚Â Â  â”‚Â Â  â””â”€â”€ ruby.rb
</span><span class='line'>Â Â       â””â”€â”€ <span class="nb">type</span>
</span><span class='line'>Â Â           â””â”€â”€ mac_proxy_bypassdomains.rb
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from above, the name of both the type and provider must <strong>EXACTLY</strong>
match the filename of their corresponding files. Also, the provider file lives
in a directory named after the type. There are MANY things that can be typoed here
(filenames, foldernames, type/provider names in their files), so be absolutely sure
that you&rsquo;ve named your files correctly.</p>

<p>The reason for all this naming bullshit is because of the way Puppet syncs down
plugin files (coincidentally, with a <a href="http://docs.puppetlabs.com/guides/plugins_in_modules.html">process known as Pluginsync)</a>.
Everything in the <code>lib</code> directory in a Puppet module is going to get synced down
to your nodes inside <a href="http://docs.puppetlabs.com/references/latest/configuration.html#vardir">the <code>vardir</code> directory</a> on
the node itself. The <code>vardir</code> is a known library path to Puppet, and all files
in the <code>vardir</code> are treated as if they had lived in Puppet&rsquo;s source code (in
the same relative paths).  Because the Puppet source code has all type files in
the <code>lib/puppet/type</code> directory, all <strong>CUSTOM</strong> types must go in the module&rsquo;s
<code>lib/puppet/type</code> directory for confirmity.  This is repeated for <strong>EVERY</strong>
custom Puppet/Facter plugin (including custom facts, custom functions, and
etc&hellip;).</p>

<h3>More scaffolding</h3>

<p>Let&rsquo;s layout the shell of our provider, first, to ensure that we haven&rsquo;t typoed
anything. Here&rsquo;s the provider declaration:</p>

<figure class='code'><figcaption><span>lib/puppet/type/mac_proxy_bypassdomains/ruby.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:mac_proxy_bypassdomains</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Provider work goes here</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the name of the type and the name of the provider are symbolized (i.e.
they&rsquo;re prepended with a colon). Like I mentioned above, they must be spelled
EXACT or Puppet will complain very loudly. You may see variants on that
declaration line because there are multiple ways in Ruby to extend a class
object. The method I&rsquo;ve listed above is the &lsquo;generally accepted best-practice&rsquo;, which
is to say it&rsquo;s the way we&rsquo;re doing it this month.</p>

<p>Congrats! You have THE SHELL of a provider that has yet to do a single goddamn thing!
Technically, you&rsquo;re further than about 90% of other Puppet users at this point! Let&rsquo;s
go the additional 20% (since we&rsquo;re basing this on a mangement metric of 110%) by
wiring up the methods and making the damn thing work!</p>

<h3>Are you (en)sure about this?</h3>

<p>We&rsquo;ve explained before that a type is &lsquo;ensurable&rsquo; when you can check for its existance
on a system, create it when it doesn&rsquo;t exist (and it SHOULD exist), and destroy it when
it does exist (and it SHOULDN&rsquo;T exist). The bare minimum amount of methods necessary
to make a type ensurable is three, and they&rsquo;re called <code>exists?</code>, <code>create</code>, and <code>destroy</code>.</p>

<h3>Method: <code>exists?</code></h3>

<p>The <code>exists?</code> method is a predicate method &ndash; that means it should either return
the boolean <code>true</code> or <code>false</code> value based on whether the bypass domain list
exists. Puppet will always call the <code>exists?</code> provider method to determine if
that &lsquo;thing&rsquo; (in this case, &lsquo;thing&rsquo; means &lsquo;a list of domains to bypass for a
specific network interface&rsquo;) exists before calling any other methods. How do we
know if this thing exists? Like I showed before, you need to run the
<code>networksetup -getproxybypassdomains</code> command and pass the interface name.  If
it returns &lsquo;There aren&rsquo;t any bypass domains set on (interface name)&rsquo;, then the
list doesn&rsquo;t exist. Let&rsquo;s do some binary execution&hellip;</p>

<h4>Calling binaries from Puppet</h4>

<p>Puppet provides some helper syntax around basic actions that most providers
perform. MOST providers are going to need to call out to an external binary
(e.g. yum, apt, etc&hellip;) at some point, and so Puppet allows you to create
your own method JUST for a system binary. The <code>commands</code> method abstracts
all the dirtyness of making a method for each system binary you want to call.
The way you use the <code>commands</code> method is like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">commands</span> <span class="ss">:networksetup</span> <span class="o">=&gt;</span> <span class="s1">&#39;networksetup&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>commands</code> method accepts a hash whose key must be a symbolized name. The
CONVENTION is to use a symbolized name that matches the binary name, but it&rsquo;s
not REQUIRED to do so. The value for that symbolized key MUST be the binary
name. Note that I&rsquo;ve not passed a full path to the binary. Why? Well, Puppet
will automatically do a path lookup for that binary and store its full path
for use when the binary is invoked. We don&rsquo;t REQUIRE you to pass the full
path because sometimes the same binary exists in different locations for
different operatingsystems. Instead of creating a provider for each OS you
manage with Puppet, we abstract away the path stuff. You <strong>CAN</strong> still
pass a full path as a value, but if you elect to do that an the binary doesn&rsquo;t
exist at that path, Puppet will disqualify the provider and you&rsquo;ll be quite
upset.</p>

<p>In the event that Puppet <strong>CANNOT</strong> find this binary, it will disqualify the
entire provider, and you&rsquo;ll get a message saying as much in the debug output
of your Puppet run. Because of that, the <code>commands</code> method is a good way to
confine your provider to a specific system or class of system.</p>

<p>When the <code>commands</code> method is successfully invoked, you will get a new provider
method named after the <strong>SYMBOLIZED</strong> key, and not necessarily the binary
name (unless you made them the same). After the above command is evaluated,
Puppet will now have a <code>networksetup()</code> method in our provider. The argument
to the <code>networksetup</code> method should be an array of arguments that are passed
to the binary. It&rsquo;s c-style, so each element is going to be individually
quoted. You can run into issues here if you pass values containing quotes
as part of your argument array. Read that again &ndash; quoting your values is
totally acceptable (e.g. [&lsquo;foo&rsquo;, &lsquo;bar&rsquo;]), but passing a value that contains
quotes can potentially cause problems (e.g. [&ldquo;&lsquo;foo&rsquo;&rdquo;, &ldquo;&lsquo;bar&rsquo;&rdquo;]).</p>

<p>You&rsquo;re probably thinking &ldquo;Why the hell would I go through this trouble when
I can use the <code>%x{}</code> syntax in ruby to execute a shell command?!&rdquo; And to that
I would say &ldquo;Quit yelling at me&rdquo; and also &ldquo;Because: testing.&rdquo; When you write
spec tests for your provider (which will be covered in a later blog post, since
it&rsquo;s its OWN path of WTF), you&rsquo;re going to need to mock out calls to the system
during your tests (i.e. sometimes you may be running the tests on a system that
doesn&rsquo;t have the binary you&rsquo;re meant to be calling in your provider. You don&rsquo;t
want the tests to fail due to the absence of a binary file). The <code>%x{}</code>
construct in Ruby is hard to mock out, but a method of our provider is a relatively
easy thing to mock out. Also &ndash; see the path problem above. We don&rsquo;t STOP you
from doing <code>%x{}</code> in your code (it will still totally work), but we give you
a couple of good reasons to NOT do it.</p>

<h4>Objects are a provider&rsquo;s best friend</h4>

<p>Within your provider, you&rsquo;re going to be doing lots of system calls and data
manipulation. Often we&rsquo;re asked whether you do that ugliness inside the main
methods (i.e. inside the <code>exists?</code> method directly), or if you create a
helper method for some of this data manipulation. The answer I usually give
is that you should probably create a helper method if:</p>

<ul>
<li>The code is going to be called more than once</li>
<li>The code does something that would be tricky to test (like reading from a file)</li>
<li>Complexity would be reduced by creating a helper method</li>
</ul>


<p>The act of getting a list of domains for a specific interface is definitely
going to be utilized in more than one place in our provider (we&rsquo;ll use it
in the <code>exists?</code> method as well as in a &lsquo;getter&rsquo; method for the <code>domains</code>
property). Also, you could argue that it might be tricky to test since it&rsquo;s
going to be a binary call that&rsquo;s going to return some data. Because of this,
let&rsquo;s create a helper method that returns a list of domains for a specific
interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-getproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">int</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#get_proxy_bypass_domains had an error -&gt; </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">domains</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">domains</span><span class="o">.</span><span class="n">first</span> <span class="o">=~</span> <span class="sr">/There aren\&#39;t any bypass domains set/</span>
</span><span class='line'>  <span class="n">domains</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby convention is to use underscores (i.e. versus camelCase or hyphens) in
method names. You want to give your methods very descriptive names based on
what it is that they DO. In this case, <code>get_proxy_bypass_domains</code> seems
adequately descriptive. Also, you should err on the side of readability when
you&rsquo;re writing code. You can get pretty creative with Ruby metaprogramming,
but that can quickly become hard to follow (and then you&rsquo;re just a dick).
Finally, error-handling is a good thing. If you&rsquo;re going to do any error-handling,
though, be very specific about the errors you catch/rescue. When you have a rescue
block, make sure you catch a specific exception class (in the case above, we&rsquo;re
catching a Puppet::ExecutionFailure &ndash; which means the binary is returning a
non-zero exit code).</p>

<p>The code above will return an array containing all the domains, or it will
return <code>nil</code> if domains aren&rsquo;t found or the <code>networksetup</code> binary had an issue.</p>

<p>Using the helper method above, here&rsquo;s what the final <code>exists?</code> method looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>  <span class="n">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span> <span class="o">!=</span> <span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>All provider methods have the ability to access the &lsquo;should&rsquo; values for the resource
(and by that I mean the values that are set in the Puppet maniest on the Puppet master
server, or locally if you&rsquo;re using <code>puppet apply</code>). Those values reside in the <code>resource</code>
method that responds with a hash. In the code above, <code>resource[:name]</code> will return the
network interface name (e.g. Ethernet, FireWire, etc&hellip;) that was specified in the
Puppet manifest. The exists method will return true of a list of domains exists for
an interface, or it will return false if a list of domains does not exist (i.e.
<code>get_proxy_bypass_domains</code> returns <code>nil</code>).</p>

<h3>Method: <code>create</code></h3>

<p>The <code>create</code> method is called when <code>exists?</code> returns false and a resource has an
<code>ensure</code> value set to <code>present</code>. Because of this, you don&rsquo;t need to call the <code>exists?</code>
method explicitly in <code>create</code> &ndash; it&rsquo;s already been evaluated. Remember from above that
the <code>-setproxybypassdomains</code> argument to the <code>networksetup</code> binary will set a domain
list, so the <code>create</code> method is going to be very short-and-sweet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>  <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:domains</span><span class="o">]]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the end, the <code>create</code> method will call the <code>networksetup</code> binary with the <code>-setproxybypassdomains</code>
argument, pass the interface name (from <code>resource[:name]</code>) and pass an array of domain values (which
comes from <code>resource[:domains]</code>). That&rsquo;s it; it&rsquo;s done!</p>

<h3>Method: <code>destroy</code></h3>

<p>The <code>destroy</code> method is easier than the <code>create</code> method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>  <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we&rsquo;re calling <code>networksetup</code> with the <code>-setproxybypassdomains</code> argument
and passing nothing else. This will initialize the list and set it to be empty.</p>

<h2>Synchronizing properties</h2>

<h3>Getter method: <code>domains</code></h3>

<p>At this point our type is ensurable, which means we can create and destroy resources.
What we CAN&rsquo;T do, however, is change the value of any properties that are out-of-sync. A
property is out-of-sync when the value discovered by Puppet on the node differs from the
value in the catalog (i.e. set by the Puppet manifest using the DSL on the Puppet master).
Just like <code>exists?</code> is called to determine if a resource exists, Puppet needs a way to
get the current value for a property on a node. The method that gets this value is
called the &lsquo;getter method&rsquo; for a property, and its name must match the name of the
property. Because we have a property called <code>domains</code>, the provider must have a <code>domains</code>
method that returns a value (in this case, an array of domains to be bypassed by the
proxy). We&rsquo;ve already written a helper method that does this work for us, so the
<code>domains</code> getter method is pretty easy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">domains</span>
</span><span class='line'>  <span class="n">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tada! Just call the helper method and pass the interface name. Boom &ndash; instant array
of values. The getter method will return the &lsquo;is&rsquo; value, because that&rsquo;s what the value
<strong>IS</strong> (currently on the node). Get it? Anyone? The <strong>IS</strong> value is the other side of
the coin to the &lsquo;should&rsquo; value (that comes from the Puppet manifest) because that&rsquo;s
what the value <strong>SHOULD</strong> be set on the node.</p>

<h3>Setter method: <code>domains=</code></h3>

<p>If the getter method (e.g. <code>domains</code>) returns a value that doesn&rsquo;t match the value
in the catalog, then Puppet changes the value on the node and sets it to the value
in the catalog. It does this by calling the &lsquo;setter&rsquo; method for the property, which
is the name of the property and the equals ( = ) sign. In this case, the setter
method for the <code>domains</code> property must be called <code>domains=</code>.  It looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">domains</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="n">value</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setter methods are always passed a single argument &ndash; the &lsquo;should&rsquo; value of the property.
In our example, we&rsquo;re calling the <code>networksetup</code> binary with the <code>-setproxybypassdomains</code>
argument, passing the name of the interface, and then passing the &lsquo;should&rsquo; value &ndash; or
the array of domains. It&rsquo;s easy, it&rsquo;s one line, and I love it when a plan comes together</p>

<h2>Putting the whole damn thing together</h2>

<p>I&rsquo;ve broken down the provider line by line, but here&rsquo;s the entire file:</p>

<figure class='code'><figcaption><span>lib/puppet/provider/mac_proxy_bypassdomains/ruby.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:mac_proxy_bypassdomains</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:ruby</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">commands</span> <span class="ss">:networksetup</span> <span class="o">=&gt;</span> <span class="s1">&#39;networksetup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">int</span><span class="p">)</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">output</span> <span class="o">=</span> <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-getproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">int</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="no">Puppet</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#get_proxy_bypass_domains had an error -&gt; </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">domains</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">domains</span><span class="o">.</span><span class="n">first</span> <span class="o">=~</span> <span class="sr">/There aren\&#39;t any bypass domains set/</span>
</span><span class='line'>    <span class="n">domains</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>    <span class="n">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span> <span class="o">!=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:domains</span><span class="o">]]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">domains</span>
</span><span class='line'>    <span class="n">get_proxy_bypass_domains</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">domains</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="n">networksetup</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;-setproxybypassdomains&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="n">value</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing the type/provider</h2>

<p>And that&rsquo;s it, we&rsquo;re done!  The last thing to do is to test it out.  You can
test out your provider in one of two ways: the first is to add the module to
the modulepath of your Puppet master and include it that way, or test it
locally by setting the <code>$RUBYLIB</code> environmental variable to point to the <code>lib</code>
directory of your module (which is the more preferred method since it won&rsquo;t
serve it out to all of your nodes without it being tested). Because this module
is on my system at <code>/users/glarizza/src/puppet-mac_proxy</code>, here&rsquo;s how my
<code>$RUBYLIB</code> is set:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RUBYLIB</span><span class="o">=</span>/users/glarizza/src/puppet-mac_proxy/lib
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to create a resource declaration to try and set a couple of
bypass domains. I&rsquo;ll create a <code>tests</code> directory and simple test file in
<code>tests/mac_proxy_bypassdomains.pp</code>:</p>

<figure class='code'><figcaption><span>tests/mac_proxy_bypassdomains.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">mac_proxy_bypassdomains</span> <span class="p">{</span> <span class="s1">&#39;Ethernet&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">domains</span> <span class="p">=&gt;</span> <span class="p">[</span><span class="s1">&#39;www.garylarizza.com&#39;</span><span class="p">,</span><span class="s1">&#39;*.puppetlabs.com&#39;</span><span class="p">,</span><span class="s1">&#39;10.13.1.3/24&#39;</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&rsquo;s run Puppet and test it out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>â””â–· puppet apply ~/src/puppet-mac_proxy/tests/mac_proxy_bypassdomains.pp
</span><span class='line'>Notice: Compiled catalog for satori.local in environment production in 0.06 seconds
</span><span class='line'>Notice: /Stage[main]//Mac_proxy_bypassdomains[Ethernet]/domains: domains changed [] to 'www.garylarizza.com *.puppetlabs.com 10.13.1.3/24'
</span><span class='line'>Notice: Finished catalog run in 3.47 seconds</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> If you run this as a local user, you will be prompted by OS X to
enter an administrative password for a change.  Since Puppet will ultimately be
run as root on OS X when we&rsquo;re NOT testing out code, this shouldn&rsquo;t be required
during a normal Puppet run. To test this out (i.e. that you don&rsquo;t always have to
enter an admin password in a pop-up window), you&rsquo;ll need to <code>sudo -s</code> to
change to root, set the <code>$RUBYLIB</code> as the root user, and then run Puppet again.</p>

<p>And that&rsquo;s it &ndash; looks like our code worked! To check and make sure it will notice a
change, open System Preferences, then the Network pane, click on the Ethernet
interface, then the Advanced button, then the Proxies tab, and finally note the
&lsquo;Bypass proxy settings&hellip;&rsquo; text box at the bottom of the screen (now do you see
why we automate this shit?!). Make a change to the entries in there and run
Puppet again &ndash; it should correct it for you</p>

<h2>Wait&hellip;so that was it?  Really?  We&rsquo;re done?</h2>

<p>Yeah, that was a whole type and provider. Granted, it has only one property and it&rsquo;s
not too complicated, but that&rsquo;s the point. We&rsquo;ve still got some latent bugs (the
network interface passed must be capitalized exactly like OS X expects it, we could
do some better error handling, etc&hellip;), and the type doesn&rsquo;t work with <code>puppet resource</code>
(yet), but we&rsquo;ll handle all of these things in the next blog post (or two&hellip;or three).</p>

<p>Until then, take this time to crack open a type and a provider for something that&rsquo;s
been pissing you off and FIX it!  Better yet, push it up to Github, tweet about it,
and post it up <a href="http://forge.puppetlabs.com">on The Forge</a> so the rest of the
community can use it!</p>

<p>Like always, feel free to comment, tweet me (@glarizza), email me (gary <strong>AT</strong> puppetlabs <strong>DOT</strong> com),
or use the social media platform of choice to get a hold of me (Snapchats may or may not
get a response. Maybe.)  Cheers!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fun With Puppet Providers - Part 1 of Whatever]]></title>
    <link href="http://garylarizza.com/blog/2013/11/25/fun-with-providers/"/>
    <updated>2013-11-25T20:47:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/11/25/fun-with-providers</id>
    <content type="html"><![CDATA[<p>I don&rsquo;t know why I write blog posts &ndash; everybody in open-source software knows
that the code <em>IS</em> the documentation. If you&rsquo;ve ever tried to write a Puppet
type/provider, you know this fact better than ANYONE. To this day, when someone
asks me for the definitive source on this activity I usually refer them first
to <a href="http://www.amazon.com/Puppet-Types-Providers-Dan-Bode/dp/1449339328">Nan Liu and Dan Bode&rsquo;s awesome Types and Providers
book</a>
(which REALLY is a fair bit of quality information), and THEN to the source
code for Puppet. Everything else falls in-between those sources (sadly).</p>

<p>As someone who truly came from knowing absolute fuckall about Ruby and only
marginally more than that about Puppet, I&rsquo;ve walked through the valley of the
shadow of self.instances and have survived to tell the tale. That&rsquo;s what this
post is about &ndash; hopefully some GOOD information if you want to start writing
your own Puppet type and provider. I also wrote this because this knowledge
has been passed down from Puppet employee to Puppet employee, and I wanted
to break the priesthood being held on type and provider magic. If you don&rsquo;t
hear from me after tomorrow, well, then you know what happened&hellip;</p>

<h2>Because 20 execs in a defined type&hellip;</h2>

<p>What would drive someone to write a custom type and provider for Puppet anyhow?
Afterall, you can do ANYTHING IMAGINABLE in the Puppet DSL*! After drawing
back my sarcasm a bit, let me explain where the Puppet DSL tends to fall over
and the idea of a custom type and provider starts becoming more than just an
incredibly vivid dream:</p>

<ul>
<li>You have more than a couple of exec statements in a single class/defined type that have multiple conditional
properties like &lsquo;onlyif&rsquo; and/or &lsquo;unless&rsquo;.</li>
<li>You need to use pure Ruby to manipulate data and parse it through a system binary</li>
<li>Your defined type has more conditional logic than your pre-nuptual agreement</li>
<li>Any combination of similar arguments related to the above</li>
</ul>


<p>If the above sounds familiar to you, then you&rsquo;re probably ready to build your own custom Puppet type and provider.
Do note that custom types and providers are written in Ruby and not the Puppet DSL. This can initially feel
very scary, but get over it (there are much scarier things coming).</p>

<p><em>* Just because you can doesn&rsquo;t mean you don&rsquo;t, in fact, suck.</em></p>

<h2>I&rsquo;m not your Type</h2>

<p>This blog post is going to focus on types and type-interaction, while later
posts will focus on providers and ultimately dirty provider tricks to win
friends and influence others.  Type and provider interaction can be totally
daunting for newcomers, let ALONE just naming files correctly due to Puppet&rsquo;s
predictable (note: anytime I write the word &ldquo;predictable&rdquo;, just substitute the
phrase &ldquo;annoying pain in the ass&rdquo;) naming pattern.  Let&rsquo;s break it down a bit
for you &ndash; somebody que Dre&hellip;</p>

<p>(NOTE: I&rsquo;m going to ASSUME you understand the fundamentals of a Puppet run already. If you&rsquo;re pretty hazy
on that concept, checkout <a href="http://docs.puppetlabs.com">docs.puppetlabs.com</a> for more information)</p>

<h2>Types are concerned about your looks</h2>

<p>The type file defines all the <em>properties</em> and <em>parameters</em> that can be used by your new custom resource.
Think of the type file like the opening stanza to a new Puppet class &ndash; we&rsquo;re describing all the tweakable
knobs and buttons to the new thing we&rsquo;re creating. The type file also gives you some added validation
abilities, which is very handy.</p>

<p>It&rsquo;s important to understand that there is a BIG difference between a &lsquo;property&rsquo; and a &lsquo;parameter&rsquo; with regard
to a type (even though they&rsquo;re both assigned values identically in a resource declaration).  Think of it this
way: a property is something that can be inspected and changed by Puppet, while a parameter is just helper data
that Puppet uses to do its job.  A property would be something like a file&rsquo;s mode.  You can inspect a file and
determine its mode, and you can even CHANGE a file&rsquo;s mode on disk. The file resource type also has a parameter
called &lsquo;backup&rsquo;.  Its sole job is to tell Puppet whether to backup the file to the filebucket before making
changes. This data is useful for Puppet during a run, but you can&rsquo;t inspect a file on disk and know definitively
whether Puppet is going to back it up or not (and it goes without saying that if you can&rsquo;t determine this aspect
about a file on disk just by inspecting it, than you also can&rsquo;t CHANGE this aspect about a file on disk either).
You&rsquo;ll see later where the property/parameter distinction becomes very important.</p>

<p>Recently I built a type modeling the setting of proxy data for network interfaces on OS X, so we&rsquo;ll use that as
a demonstration of a type.  It looks like the following:</p>

<figure class='code'><figcaption><span>lib/puppet/type/mac_web_proxy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">newtype</span><span class="p">(</span><span class="ss">:mac_web_proxy</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Puppet type that models a network interface on OS X&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ensurable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:namevar</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Interface name - currently must be &#39;friendly&#39; name (e.g. Ethernet)&quot;</span>
</span><span class='line'>    <span class="n">munge</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>      <span class="n">value</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">insync?</span><span class="p">(</span><span class="n">is</span><span class="p">)</span>
</span><span class='line'>      <span class="n">is</span><span class="o">.</span><span class="n">downcase</span> <span class="o">==</span> <span class="n">should</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_server</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:authenticated_username</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Username for proxy authentication&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newparam</span><span class="p">(</span><span class="ss">:authenticated_password</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Password for proxy authentication&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_authenticated</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="ss">:true</span><span class="p">,</span> <span class="ss">:false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_port</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>First note the type file&rsquo;s path in the grey titlebar of the graphic: <code>lib/puppet/type/mac_web_proxy.rb</code>
This path is relative to the module that you&rsquo;re building, and it&rsquo;s VERY important that it be named
EXACTLY this way to appease Puppet&rsquo;s predictable naming pattern.  The name of the file directly correllates
to the name of the type listed in the <code>Puppet::Type.newtype()</code> method.</p>

<p>Next, let&rsquo;s look at a sample parameter declaration &ndash; for starters, let&rsquo;s look at the &lsquo;authenticated_password&rsquo;
parameter declaration on line 24 of the above type.  The <code>newparam()</code> method is called and the lone argument
passed is the symbolized name of our parameter (i.e. it&rsquo;s prepended with a colon).  This parameter
provides the password to use when setting up an authenticated web proxy on OS X.
It&rsquo;s a parameter because as far as I know, there&rsquo;s no way for me to query the system for this password
(it&rsquo;s obfuscated in the GUI and I&rsquo;m not entirely certain where it&rsquo;s stored on-disk).
If there were a way for us to query this value from the system, then we could turn it
into a property (since we could both &lsquo;GET&rsquo; as well as &lsquo;SET&rsquo; the value). As of right
now, it exists as helper data for when I need to setup an authenticated proxy.</p>

<p>Having seen a parameter, let&rsquo;s look at the &lsquo;proxy_server&rsquo; property that&rsquo;s declared on
line 16 of the type file above. We&rsquo;re able to both query the system for this value,
as well as change/set the value by using the <code>networksetup</code> binary, so it&rsquo;s able to
be &lsquo;synchronized&rsquo; (according to Puppet). Because of this, it must be a property.</p>

<h2>Just enough validation</h2>

<p>The second major function of the type file is to provide methods to validate property
and parameter data that is being passed. There are two methods to validate this data,
and one method that allows you to massage the data into an acceptable format (which
is called &lsquo;munging&rsquo;).</p>

<h3>validate()</h3>

<p>The first method, named &lsquo;validate&rsquo;, is widely believed to be the only successfully-named
method in the entire Puppet codebase. Validate accepts a block and allows you to perform
free-form validation in any way you prefer.  For example:</p>

<figure class='code'><figcaption><span>lib/puppet/type/user.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">validate</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>  <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;Passwords cannot include &#39;:&#39;&quot;</span> <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example, pulled straight from the Puppet codebase, will raise an error if a
password contains a colon. In this case, we&rsquo;re looking for a specific exception
and are raising errors accordingly.</p>

<h3>newvalues()</h3>

<p>The second method, named &lsquo;newvalues&rsquo;, accepts a regex that property/parameter values
need to match (if you&rsquo;re one of the 8 people in the world that speak regex fluently),
or a list of acceptable values. From the example above:</p>

<figure class='code'><figcaption><span>lib/puppet/type/mac_web_proxy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_authenticated</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="ss">:true</span><span class="p">,</span> <span class="ss">:false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newproperty</span><span class="p">(</span><span class="ss">:proxy_port</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Proxy Server setting for the interface&quot;</span>
</span><span class='line'>    <span class="n">newvalues</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>munge()</h3>

<p>The final method, named &lsquo;munge&rsquo; accepts a block like <code>newvalues</code> but allows you to
convert an unacceptable value into an acceptable value. Again, this is from the example above:</p>

<figure class='code'><figcaption><span>lib/puppet/type/mac_web_proxy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">munge</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>  <span class="n">value</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, we want to ensure that the parameter value is lower case. It&rsquo;s not
necessary to throw an error, but rather it&rsquo;s acceptable to &lsquo;munge&rsquo; the value to
something that is more acceptable without alerting the user.</p>

<h2>Important type considerations</h2>

<p>You could write half a book just on how types work (and, again, check out the book
referenced above which DOES just that), but there are a couple of final considerations
that will prove helpful when developing your type.</p>

<h3>Defaulting values</h3>

<p>The <code>defaultto</code> method provides a default value should the user not provide one for
your property/parameter. It&rsquo;s a pretty simple construct, but it&rsquo;s important to
remember when you write spec tests for your type (which you ARE doing, right?) that
there will ALWAYS be values for properties/parameters that utilize <code>defaultto</code>. Here&rsquo;s a quick example:</p>

<figure class='code'><figcaption><span>Defaultto example </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">newparam</span><span class="p">(</span><span class="ss">:enable_lacp</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">defaultto</span> <span class="ss">:true</span>
</span><span class='line'>  <span class="n">newvalues</span><span class="p">(</span><span class="ss">:true</span><span class="p">,</span> <span class="ss">:false</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Ensurable types</h3>

<p>A resource is considered &lsquo;ensurable&rsquo; when its presence can be verified (i.e. it
exists on the system), it can be created when it doesn&rsquo;t exist and it SHOULD, and
it can be destroyed when it exists and it SHOULDN&rsquo;T. The simplest way to tell
Puppet that a resource type is ensurable is to call the <code>ensurable</code> method within
the body of the type (i.e. outside of any property/parameter declarations). Doing
this will automatically create an &lsquo;ensure&rsquo; property that accepts values of &lsquo;absent&rsquo;
and &lsquo;present&rsquo; that are automatically wired to the &lsquo;exists?&rsquo;, &lsquo;create&rsquo; and &lsquo;destroy&rsquo;
methods of the provider (something I&rsquo;ll write about in the next post). Optionally,
you can choose to pass a block to the <code>ensurable</code> method and define acceptable
property values as well as the methods of the provider that are to be called. That
would look something like this:</p>

<figure class='code'><figcaption><span>lib/puppet/type/package.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ensurable</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">newvalue</span><span class="p">(</span><span class="ss">:present</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span><span class="o">.</span><span class="n">install</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newvalue</span><span class="p">(</span><span class="ss">:absent</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span><span class="o">.</span><span class="n">uninstall</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newvalue</span><span class="p">(</span><span class="ss">:purged</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span><span class="o">.</span><span class="n">purge</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">newvalue</span><span class="p">(</span><span class="ss">:held</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span><span class="o">.</span><span class="n">hold</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This means that instead of calling the <code>create</code> method to create a new resource that
SHOULD exist (but doesn&rsquo;t), Puppet is going to call the <code>install</code> method. Conversely,
it will call the <code>uninstall</code> method to destroy a resource based on this type. The
ensure property will also accept values of &lsquo;purged&rsquo; and &lsquo;held&rsquo; which will be wired up
to the <code>purge</code> and <code>hold</code> methods respectively.</p>

<h3>Namevars are unique little snowflakes</h3>

<p>Puppet has a <a href="http://docs.puppetlabs.com/puppet/2.7/reference/lang_resources.html#namenamevar">concept known as the &lsquo;namevar&rsquo; for a resource.</a>
If you&rsquo;re hazy about the concept check out the documentation, but basically it&rsquo;s the parameter
that describes the form of uniqueness for a resource type on the system. For the package resource
type, the &lsquo;name&rsquo; parameter is the namevar because the way you tell one package from another is
its name. For the file resource, it&rsquo;s the &lsquo;path&rsquo; parameter, because you can differentiate unique
files from each other according to their path (and not necessarily their filename, since filenames
don&rsquo;t have to be unique on systems).</p>

<p>When designing a type, it&rsquo;s important to consider WHICH parameter will be the namevar (i.e. how
can you tell unique resources from one another). To make a parameter the namevar, you simply
set the <code>:namevar</code> attribute to <code>:true</code> like below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">newparam</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:namevar</span> <span class="o">=&gt;</span> <span class="ss">:true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Type declaration attributes here...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Handling array values</h3>

<p>Nearly every property/parameter value that is declared for a resource is &lsquo;stringified&rsquo;, or
cast to a string. Sometimes, however, it&rsquo;s necessary to accept an array of elements as the
value for a property/parameter. To do this, you have to explicitly tell Puppet that you&rsquo;ll
be passing an array by setting the <code>:array_matching</code> attribute to <code>:all</code> (if you don&rsquo;t set
this attribute, it defaults to <code>:first</code>, which means that if you pass an array as a value
for a property/parameter, Puppet will only accept the FIRST element in that array).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">newproperty</span><span class="p">(</span><span class="ss">:domains</span><span class="p">,</span> <span class="ss">:array_matching</span> <span class="o">=&gt;</span> <span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Type declaration attributes here... </span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you set <code>:array_matching</code> to <code>:all</code>, EVERY value passed for that parameter/property will
be cast to an array (which means if you pass a value of &lsquo;foo&rsquo;, you&rsquo;ll get an array with a
single element &ndash; the string of &lsquo;foo&rsquo;).</p>

<h3>Documenting your property/parameter</h3>

<p>It&rsquo;s a best-practice to document the purpose of your property or parameter declaration, and
this can be done by passing a string to the <code>desc</code> method within the body of the property/parameter
declaration.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">newproperty</span><span class="p">(</span><span class="ss">:domains</span><span class="p">,</span> <span class="ss">:array_matching</span> <span class="o">=&gt;</span> <span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Domains which should bypass the proxy&quot;</span>
</span><span class='line'><span class="c1"># Type declaration attributes here...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Synchronization tricks</h3>

<p>Puppet uses a method called <code>insync?</code> to determine whether a property value is synchronized (i.e.
if Puppet needs to change its value, or it&rsquo;s set appropriately). You usually have no need to change
the behavior of this method since most of the properties you create for a type will have string
values (and the <code>==</code> operator does a good job of checking string equality). For structured data
types like arrays and hashes, however, that can be a bit trickier. Arrays, for example, are
ordered construct &ndash; they have a definitive idea of what the first element and the last element
of the array are. Sometimes you WANT to ensure that values are in a very specific order, and
sometimes you don&rsquo;t necessarily care about the ORDER that values for a property are set &ndash; you
just want to make sure that all of them are set.</p>

<p>If the latter cases sounds like what you need, then you&rsquo;ll need to override the behavior of the
<code>insync?</code> method. Take a look at the below example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">newproperty</span><span class="p">(</span><span class="ss">:domains</span><span class="p">,</span> <span class="ss">:array_matching</span> <span class="o">=&gt;</span> <span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Domains which should bypass the proxy&quot;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">insync?</span><span class="p">(</span><span class="n">is</span><span class="p">)</span>
</span><span class='line'>    <span class="n">is</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">should</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, I&rsquo;ve overridden the <code>insync?</code> method to first sort the &lsquo;is&rsquo; value (or, the value that
was discovered by Puppet on the target node) and compare it with the sorted &lsquo;should&rsquo; value (or,
the value that was specified in the Puppet manifest when the catalog was compiled by the Puppet
master). You can do WHATEVER you want in here as long as <code>insync?</code> returns either a true or a
false value.  If <code>insync?</code> returns true, then Puppet determines that everything is in sync and
no changes are necessary, whereas if it returns false then Puppet will trigger a change.</p>

<h2>And this was the EASY part!</h2>

<p>Wow this went longer than I expected&hellip; and types are usually the &lsquo;easier&rsquo; bit
since you&rsquo;re only describing the format to be used by the Puppet admin in
manifests. There are some hacky type tricks that I&rsquo;ve not yet covered (i.e.
features, &lsquo;inheritance&rsquo;, and other meta-bullshit), but those will be saved for
a final &lsquo;dirty tips and tricks&rsquo; post.  In the next section, I&rsquo;ll touch on
providers (which is where all interaction with the system takes place), so
stay tuned for more brain-dumping-goodness&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[From the Archive: Using Crankd]]></title>
    <link href="http://garylarizza.com/blog/2013/07/10/from-the-archive-using-crankd/"/>
    <updated>2013-07-10T09:51:00-07:00</updated>
    <id>http://garylarizza.com/blog/2013/07/10/from-the-archive-using-crankd</id>
    <content type="html"><![CDATA[<p>Supporting laptops in a managed environment is tricky (and doubly so if you allow them to be taken off your corporate network).  While you can be reasonably assured that your desktops will remain on and connected during the workday, it&rsquo;s not uncommon for laptops to go to sleep, change wireless access points, and even change between an Ethernet or AirPort connection several times during the day.  It&rsquo;s important to have a tool that can &ldquo;tweak&rdquo; certain settings in response to these changes.</p>

<p>This is where crankd comes in.</p>

<p>Crankd is a cool utility that&rsquo;s part of the Pymacadmin (<a href="http://code.google.com/p/pymacadmin/">http://code.google.com/p/pymacadmin/</a>) suite of tools co-authored by Chris Adams and Nigel Kersten.  Specifically crankd is a Python daemon that lets you trigger shell scripts, or execute Python methods, based upon state changes in SystemConfiguration, NSWorkspace and FSEvents.</p>

<h2>Use Cases</h2>

<p>It&rsquo;s easier to see how crankd can help you with a couple of scenarios:</p>

<ol>
<li><p>Your laptops, like all of the other machines in your organization, are bound to your corporate LDAP servers.  When they&rsquo;re on network, they will query the LDAP servers for things like authentication information.  Unless your corporate LDAP directory is accessible outside your corporate network, your laptops may exhibit the &ldquo;spinning wheel of death&rdquo; when they attempt to contact a suddenly-unreachable LDAP directory at the neighborhood Starbucks.  A solution to this is to remove the LDAP servers from your Search (and Contacts) path whenever the laptop is taken off-network and add the LDAP servers when you come back on-network.</p></li>
<li><p>Perhaps you&rsquo;re using Puppet, Munki, Chef, StarDeploy, Filewave, Absolute Manage, Casper, or any other configuration management system that needs to contact a centralized server for configuration information. Usually these tools will have your machine contact their servers once an hour or so, but this can be a problem if the machine is constantly sleeping and waking.  Plus if you take your machine off-network, you don&rsquo;t want it trying to contact a server that might not be reachable from the outside world. It would be nice to have your laptop &ldquo;phone home&rdquo; when it establishes a network connection on your corporate network, and skip this step when the laptop is taken outside your organization.</p></li>
<li><p>OS X allows you to set a preferred order for your network connections, but it would be nice to disable the AirPort when your laptop establishes an Ethernet connection.</p></li>
<li><p>Finally, maybe you have the need to perform an action whenever your laptop sleeps (or wakes), changes a network connection, mounts a volume, or runs a specific Application (whether it&rsquo;s located in the Applications directory or anywhere else on your machine).</p></li>
</ol>


<p>All of these situations can be made trivial through the help of crankd.</p>

<h2>How do I get it working?</h2>

<p>Crankd is a daemon, so it&rsquo;s running in the background while you work.  It uses an XML plist file that tells it which scripts (or which Python methods) to execute in response to specific state changes (like a network connection going up or down or a volume being mounted).  Since it&rsquo;s a small Python library, the files aren&rsquo;t huge and the entire finished installation is around 100 Kb (or larger with your custom code/scripts).  Lets download crankd and experiment with its settings:</p>

<ol>
<li><p><strong>Download the Pymacadmin source.</strong>  You can do this through Google Code or Github &ndash; I&rsquo;ll demonstrate the Github method.  Navigate to <a href="http://github.com/acdha/pymacadmin,">http://github.com/acdha/pymacadmin,</a> click the Downloads button, and download either the .tar.gz or the .zip version of the source code.  Drag it to your desktop and then double-click on the file to expand it.  It should open a folder named &ldquo;acdha-pymacadmin-<combination of 7 numbers and letters>&rdquo;</p></li>
<li><p><strong>Install crankd</strong>  Upon opening the pymacadmin folder, you should see a series of folders, readme files, and an &ldquo;install-crankd.sh&rdquo; installation script.  Let&rsquo;s open Terminal.app and navigate to the pymacadmin folder that we expanded on our desktop (you can type &ldquo;cd&rdquo; into Terminal.app and then drag and drop the folder into the Terminal window.  Hit the Return button on your keyboard to change to the directory.).  The install-crankd.sh script is executable, so run it by typing &ldquo;sudo ./install-crankd.sh&rdquo; into the Terminal window and hitting Return.  Enter your password when it prompts you</p></li>
<li><p><strong>Setup a plist file for crankd</strong>  If you&rsquo;ve never worked with crankd before, it&rsquo;s best to let it setup a configuration plist for you.  If you don&rsquo;t specify a configuration plist with the &ldquo;&mdash;config&rdquo; argument, or you don&rsquo;t have a com.googlecode.pymacadmin.crankd.plist file in your /Users/<username>/Library/Preferences folder, crankd will automatically create a sample plist for you.  Let&rsquo;s do that by typing &ldquo;/usr/local/sbin/crankd.py&rdquo; into Terminal and hitting the Return button.  Take a look at the sample configuration plist file:</p></li>
</ol>


<p>  &lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;UTF-8&rdquo;?>
  &lt;!DOCTYPE plist PUBLIC &ldquo;&ndash;//Apple Computer//DTD PLIST 1.0//EN&rdquo; &ldquo;<a href="http://www.apple.com/DTDs/PropertyList-1.0.dtd">http://www.apple.com/DTDs/PropertyList-1.0.dtd</a>&rdquo;>
  <plist version="1.0">
  <dict></p>

<pre><code>&lt;key&gt;NSWorkspace&lt;/key&gt;
&lt;dict&gt;
  &lt;key&gt;NSWorkspaceDidMountNotification&lt;/key&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;string&gt;/bin/echo "A new volume was mounted!"&lt;/string&gt;
  &lt;/dict&gt;
  &lt;key&gt;NSWorkspaceDidWakeNotification&lt;/key&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;string&gt;/bin/echo "The system woke from sleep!"&lt;/string&gt;
  &lt;/dict&gt;
  &lt;key&gt;NSWorkspaceWillSleepNotification&lt;/key&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;string&gt;/bin/echo "The system is about to go to sleep!"&lt;/string&gt;
  &lt;/dict&gt;
&lt;/dict&gt;
&lt;key&gt;SystemConfiguration&lt;/key&gt;
&lt;dict&gt;
  &lt;key&gt;State:/Network/Global/IPv4&lt;/key&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;string&gt;/bin/echo "Global IPv4 config changed"&lt;/string&gt;
  &lt;/dict&gt;
&lt;/dict&gt;
</code></pre>

<p>  </dict>
  </plist></p>

<p>This XML file has two main keys &ndash; one for NSWorkspace events (such as mounted volumes and sleeping/waking your laptop), and one for SystemConfiguration events (such as network state changes).  Followed by a key for the specific event that we&rsquo;re monitoring, a key specifying whether we&rsquo;ll be executing a command or a Python method in response to this event, and a string (or an array of strings, as we&rsquo;ll see later) specifying the actual command that&rsquo;s to be executed.  For all of the events in the sample plist, we&rsquo;re going to be echoing a message to the console.</p>

<ol>
<li><strong>Start crankd</strong>  Once crankd has been installed and your configuration plist file is setup, you&rsquo;re ready to let crankd monitor for state changes. Let&rsquo;s start crankd with the sample plist that was created in the previous step by executing the following command in Terminal &ldquo;/usr/local/sbin/crankd.py &mdash;config=/Users/<username>/Library/Preferences/com.googlecode.pymacadmin.crankd.plist&rdquo;  Remember to substitute your username for <username> in that command (if you don&rsquo;t know your username, you can type &ldquo;whoami&rdquo; into Terminal and hit the Return button).  If everything was executed correctly, you should see the following lines displayed in Terminal:</li>
</ol>


<p>  Module directory /Users/<username>/Library/Application Support/crankd does not exist: Python handlers will need to use absolute pathnames
  INFO: Loading configuration from /Users/<username>/Library/Preferences/com.googlecode.pymacadmin.crankd.plist
  INFO: Listening for these NSWorkspace notifications: NSWorkspaceWillSleepNotification, NSWorkspaceDidWakeNotification, NSWorkspaceDidMountNotification
  INFO: Listening for these SystemConfiguration events: State:/Network/Global/IPv4</p>

<p>It might look like Terminal isn&rsquo;t doing anything, but in all actuality crankd is listening for changes.  You can make crankd come to life by either connecting to (or disconnecting from) an AirPort network, sleeping/waking your machine, or mounting a volume (by inserting a USB memory stick, for example).  Performing any of these actions will cause crankd to echo messages to your Terminal window.  Here&rsquo;s the message I received when I disconnected from an AirPort network:</p>

<p>  INFO: SystemConfiguration: State:/Network/Global/IPv4: executing /bin/echo &ldquo;Global IPv4 config changed&rdquo;
  Global IPv4 config changed</p>

<p>To quit this sample configuration of crankd, simply hold down the control button on your keyboard and press the C key.  Congratulations, crankd is now up and running!</p>

<h2>A more complex example</h2>

<p>Let&rsquo;s look at one of our previous situations</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet + Github = Laptop <3]]></title>
    <link href="http://garylarizza.com/blog/2013/02/15/puppet-plus-github-equals-laptop-love/"/>
    <updated>2013-02-15T00:00:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/02/15/puppet-plus-github-equals-laptop-love</id>
    <content type="html"><![CDATA[<p>Everybody wants to be special (I blame our moms). The price of special, when
it comes to IT, is time. Consider how long you&rsquo;ve spent on just your damn
PROMPT and you&rsquo;ll realize why automation gives any good sysadmin a case of
the giggles. Like the cobbler&rsquo;s kids, though, your laptop and development
environment are always the last to be visited by the automation gnomes.</p>

<p>Until now.</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/YlKXRdSAZhY "></iframe></div>


<p><a href="http://www.youtube.com/watch?v=YlKXRdSAZhY">Will Farrington gave a great talk at Puppetconf 2012</a>
about managing an army of developer laptops using Puppet + some Github love
that left more than a couple of people asking for his code. That request
has unfortunately been denied.</p>

<p>Until now.</p>

<h2>Boxen, and hand-tune no more</h2>

<p><a href="http://boxen.github.com">Enter Boxen</a> (nÃ©e &lsquo;The Setup&rsquo;), a full-fledged open source project from
the guys at Github that melds Puppet with your Github credentials to create a
framework for automating everything from applications, to dotfiles, and even
printers and emacs extensions (that last bit&rsquo;s a lie &ndash; no one should be using
emacs).</p>

<p>How does it work? Think &lsquo;Masterless Puppet&rsquo; (or, just a bunch of Puppet modules
that are enforced by running <code>puppet apply</code> on your local machine). Boxen not
only includes the framework ITSELF, but is a project on Github that hosts
over 75 individual modules for managing things like rbenv, homebrew, git, mysql,
postgres, riak, redis, npm, erlang, dropbox, skype, minecraft, heroku,
1password, iterm2, and much more. Odds are there&rsquo;s a module for many of the
common things you setup on your laptop. And what about things like dotfiles
that are intrinsically personal? You can create your own repository and manage
them like you would any other file/directory/symlink on the file system. The
goal is to model every little piece of your laptop that makes it &lsquo;unique&rsquo; from
everyone else until you have your entire environment managed and the hardware
becomes&hellip;well&hellip;disposable. How many times have you shied away from doing an
upgrade because some component of your laptop required you to spend countless
hours tinkering with it? If you&rsquo;ve done the time, you should do something to
make sure that you NEVER have to repeat that process manually ever again.</p>

<p>Boxen is also very self-contained. Packages and binaries that come out of
Homebrew are installed into <code>/opt/boxen/homebrew/bin</code>, frameworks like Ruby and
Node are installed into <code>/opt/boxen/{rbenv,nvm}</code>, and individual versions of
those frameworks are kept separate from your system version of those
frameworks.  These details are important when you consider that you could purge
the whole setup without having to rip out components scattered around your
system.</p>

<p>You may be reading this and thinking &ldquo;There&rsquo;s no way in hell I can use this to
manage every laptop in my organization!&rdquo;, and you&rsquo;re right. The POINT of Boxen
is that it&rsquo;s a tool written by developers for developers to automate THEIR
systems. The goal of developing is to have as little friction between the
process of writing code and deploying that code into production. A tool like
Boxen allows you to more quickly GET to the state where your laptop is ready
for you to start developing. If you want a tool to completely manage and lock
down all the laptops on your system, look to using <a href="http://www.puppetlabs.com">Puppet</a>
in agent/master mode or to a tool like <a href="https://code.google.com/p/munki/">Munki</a>
to manage all packages on your system. If you&rsquo;re interested in giving your
developers/users the freedom to manage their OWN &lsquo;boxes&rsquo; because they know best
what works for them, then Boxen is your tool.</p>

<p>There IS one catch &ndash; it&rsquo;s targeted to OS X (10.8 to be exact).</p>

<h2>Diary of an elitist</h2>

<p>I was fortunate to have early-access to Boxen in order to kick its Ruby tyres.
As someone who&rsquo;s managed Macs with Puppet before (all the way down to the
desktop/laptop level), I was embarrassed to admit that I had NOTHING about
my laptop automated. <a href="http://twitter.com/wfarr">Will</a> unlocked the project and basically said &ldquo;Have
fun, break shit, fix it, and file pull requests&rdquo; and away I went. To commit
completely to the project, I did what any sane person would do.</p>

<p>I reformatted my laptop and started entirely from scratch.</p>

<p>(Let&rsquo;s be clear here &ndash; you don&rsquo;t have to do that. Initially Will reported
problems getting Boxen running in VMs, but I never ran into an issue. I ran
Boxen in VMware Fusion 5 a number of times to make sure the changes I made
were going to do the right thing on a fresh install. I&rsquo;d recommend going down
THAT road if you&rsquo;re hesitant of immediately throwing this on your pretty
snowflake of a laptop.)</p>

<p>Installing Boxen was pretty easy &ndash; the only prerequisite was downloading
the <a href="http://developer.apple.com/library/ios/#documentation/DeveloperTools/Conceptual/WhatsNewXcode/Articles/xcode_4_3.html">XCode Command-Line Tools</a>
(which included git), pulling down the Boxen repo, and running <code>script/boxen</code>.
It was stupid simple. What you GOT, by default, was:</p>

<ul>
<li>Homebrew</li>
<li>Git</li>
<li>Hub</li>
<li>DNSMasq w/ .dev resolver for localhost</li>
<li>NVM</li>
<li>RBenv</li>
<li>Full Disk Encryption requirement</li>
<li>NodeJS 0.4</li>
<li>NodeJS 0.6</li>
<li>NodeJS 0.8</li>
<li>Ruby 1.8.7</li>
<li>Ruby 1.9.2</li>
<li>Ruby 1.9.3</li>
<li>Ack</li>
<li>Findutils</li>
<li>GNU-Tar</li>
</ul>


<p>Remember, this is all tunable and you don&rsquo;t need to pull down ALL of these
packages, but, since it was new, I decided to install everything and sort
it out later.  Yes, the initial setup took a good number of minutes, but
think about everything that&rsquo;s being installed. In the end, I had a full Ruby
development environment with rbenv, multiple versions of Ruby, and a laptop
that could be customized without much work at all.</p>

<h2>Which end do I blow in?</h2>

<p>The readme on <a href="http://boxen.github.com">the project page for Boxen</a> describes how to clone the
project into <code>/opt/boxen/repo</code>, so that&rsquo;s the directory we&rsquo;ll be working with.
To see what will be enforced on your machine, check out <code>manifests/site.pp</code> to
see something that looks like this:</p>

<figure class='code'><figcaption><span>manifests/site.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">require</span> <span class="nc">boxen::environment</span>
</span><span class='line'><span class="kn">require</span> <span class="nc">homebrew::repo</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Exec</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">group</span>       <span class="p">=&gt;</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">logoutput</span>   <span class="p">=&gt;</span> <span class="ss">on_failure</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">user</span>        <span class="p">=&gt;</span> <span class="nv">$luser</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">path</span> <span class="p">=&gt;</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">${boxen::config::home}</span><span class="s2">/rbenv/shims&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">${boxen::config::home}</span><span class="s2">/homebrew/bin&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;/usr/bin&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;/bin&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;/usr/sbin&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;/sbin&#39;</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">environment</span> <span class="p">=&gt;</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;HOMEBREW_CACHE=</span><span class="si">${homebrew::cachedir}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;HOME=/Users/</span><span class="si">${::luser}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">File</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">group</span> <span class="p">=&gt;</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">owner</span> <span class="p">=&gt;</span> <span class="nv">$luser</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Package</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">homebrew</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">require</span>  <span class="p">=&gt;</span> <span class="nc">Class</span><span class="p">[</span><span class="s1">&#39;homebrew&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Repository</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">git</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">extra</span>    <span class="p">=&gt;</span> <span class="p">[</span>
</span><span class='line'>    <span class="s1">&#39;--recurse-submodules&#39;</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">require</span>  <span class="p">=&gt;</span> <span class="nc">Class</span><span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Service</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">ghlaunchd</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is largely scaffolding setting up the Boxen environment and resource
defaults. If you&rsquo;re familiar with Puppet, this should be recognizable to you,
but for everyone else, let&rsquo;s dissect one of the resource defaults:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">File</span> <span class="p">{</span>
</span><span class='line'>  <span class="nt">group</span> <span class="p">=&gt;</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">owner</span> <span class="p">=&gt;</span> <span class="nv">$luser</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This block basically means that any file you declare with Puppet should default
to having its owner set as your username and its group set to &lsquo;staff&rsquo; (which is
standard in OS X). You can override this explicitly with a file declaration by
providing the owner or group attribute, but if you omit it then it&rsquo;s going to
default to these values.</p>

<p>The rest of the defaults are customized for Boxen&rsquo;s preferences (i.e. homebrew
will be used to install all packages unless you specify otherwise, exec
resources will log all output on failure, service resources will use githubs&rsquo;s
customized service provider, and etc&hellip;).  Now let&rsquo;s look below:</p>

<figure class='code'><figcaption><span>manifests/site.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="s">default</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  # core modules, needed for most things</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">dnsmasq</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">git</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">hub</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">nginx</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">nvm</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # fail if FDE is not enabled</span>
</span><span class='line'>  <span class="kr">if</span> <span class="nv">$::root_encrypted</span> <span class="o">==</span> <span class="ss">false</span> <span class="p">{</span>
</span><span class='line'>    <span class="nf">fail</span><span class="p">(</span><span class="s1">&#39;Please enable full disk encryption and try again&#39;</span><span class="p">)</span>
</span><span class='line'>  }<span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # node versions</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">nodejs::0-4</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">nodejs::0-6</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">nodejs::0-8</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # default ruby versions</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">ruby::1-8-7</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">ruby::1-9-2</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">ruby::1-9-3</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # common, useful packages</span>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>      <span class="s1">&#39;ack&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;findutils&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;gnu-tar&#39;</span>
</span><span class='line'>    <span class="p">]:</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;</span><span class="si">${boxen::config::srcdir}</span><span class="s2">/our-boxen&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span> <span class="p">=&gt;</span> <span class="nv">$boxen::config::repodir</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>These are the things that Boxen has chosen to enforce &lsquo;out of the box&rsquo;. Knowing
that Boxen was designed so that developers could customize their &lsquo;boxes&rsquo;
THEMSELVES, it makes sense that there&rsquo;s not much that&rsquo;s being enforced on
everyone. In fact, the most significant thing being &lsquo;thrust&rsquo; upon you is the
fact that the machine must have full disk encryption enabled (which is a
good idea anyways).</p>

<p>If you want to pare down what Boxen gives you by default, you can choose to
comment out lines providing, for example, nvm and nodejs versions (if you don&rsquo;t
use node.js in your environment). I&rsquo;m a Ruby developer, so all the Ruby builds
(and rbenv) are very helpful to me, but you could also remove those if you were
so inclined. The point is that this file contains the &lsquo;knobs&rsquo; to dial your base
Boxen setup up or down.</p>

<h2>Customizing (or, my dotfiles are better than yours)</h2>

<p>The whole point of Boxen is to customize your laptop and keep its customization
automated. To do this, we&rsquo;re going to need to make some Puppet class files.</p>

<p><strong> CAUTION: PUPPET AHEAD </strong></p>

<p>If you&rsquo;ve not had experience with Puppet before, <a href="http://docs.puppetlabs.com/learning/">I can&rsquo;t recommend the learning
Puppet series enough</a>. In the vein of &ldquo;Puppet now, learn later&rdquo;,
I&rsquo;m going to give you Puppet code that works for ME and only explain the trickier
bits.</p>

<p>Boxen has some &lsquo;magic&rsquo; code that&rsquo;s going to automatically look for a class
called <code>people::&lt;github username&gt;</code>, and so I&rsquo;m going to create a file in
<code>modules/people/manifests</code> called <code>glarizza.pp</code>.  This file will contain Puppet
code specific to MY laptop(s).  Here&rsquo;s a snippit of that file:</p>

<figure class='code'><figcaption><span>modules/people/manifests/glarizza.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">people::glarizza</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">notify</span> <span class="p">{</span> <span class="s1">&#39;class people::glarizza declared&#39;</span><span class="p">:</span> <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Changes the default shell to the zsh version we get from Homebrew</span>
</span><span class='line'><span class="c-Singleline">  # Uses the osx_chsh type out of boxen/puppet-osx</span>
</span><span class='line'>  <span class="nc">osx_chsh</span> <span class="p">{</span> <span class="nv">$::luser</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">shell</span>   <span class="p">=&gt;</span> <span class="s1">&#39;/opt/boxen/homebrew/bin/zsh&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">&#39;zsh&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file_line</span> <span class="p">{</span> <span class="s1">&#39;add zsh to /etc/shells&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">path</span>    <span class="p">=&gt;</span> <span class="s1">&#39;/etc/shells&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">line</span>    <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${boxen::config::homebrewdir}</span><span class="s2">/bin/zsh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">&#39;zsh&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  ##################################</span>
</span><span class='line'><span class="c-Singleline">  ## Facter, Puppet, and Envpuppet##</span>
</span><span class='line'><span class="c-Singleline">  ##################################</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">repository</span> <span class="p">{</span> <span class="s2">&quot;</span><span class="si">${::boxen_srcdir}</span><span class="s2">/puppet&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">source</span> <span class="p">=&gt;</span> <span class="s1">&#39;puppetlabs/puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">repository</span> <span class="p">{</span> <span class="s2">&quot;</span><span class="si">${::boxen_srcdir}</span><span class="s2">/facter&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">source</span> <span class="p">=&gt;</span> <span class="s1">&#39;puppetlabs/facter&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s1">&#39;/bin/envpuppet&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">mode</span>    <span class="p">=&gt;</span> <span class="s1">&#39;0755&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span>  <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${::boxen_srcdir}</span><span class="s2">/puppet/ext/envpuppet&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${::boxen_srcdir}</span><span class="s2">/puppet&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The notify resource is only to prove that when you run Boxen that this class
is being declared &ndash; it only displays a message to the console when you run
the <code>boxen</code> binary.</p>

<p>The <code>osx_chsh</code> resource is a custom defined type that Github has created to
ensure a line shows up in <code>/etc/shells</code> as an acceptable shell. Because
Boxen installs zsh from homebrew into <code>/opt/boxen/homebrew</code>, we need to ensure
that <code>/etc/shells</code> is correct. Note the syntax of <code>$boxen::config::homebrewdir</code>
which refers to a variable called <code>$homebrewdir</code> in the <code>boxen::config</code> class.</p>

<p>Next, I&rsquo;ve setup a couple of resources to make sure the <code>puppet</code> and <code>facter</code>
repositories are installed on my system. Github has also developed a lightweight
<code>repository</code> resource that will simply ensure that a repo is cloned at a location
on disk. <code>$::boxen_srcdir</code> is one of the <a href="http://docs.puppetlabs.com/guides/custom_facts.html">custom Facter facts</a> that
Boxen provides in <code>shared/boxen/lib/facter/boxen.rb</code> in the Boxen repository.</p>

<p>The file resource sets up a symlink from <code>/bin/envpuppet</code> to
<code>/Users/glarizza/src/puppet/ext/envpuppet</code> on my system. The attributes should
be pretty self-explanatory, but the newest attribute of <code>require</code> says that the
<code>repository</code> resource must come BEFORE this file resource is declared. This is
a demonstration of <a href="http://docs.puppetlabs.com/learning/ordering.html">Puppet&rsquo;s ordering metaparameters</a> that are described
in the <a href="http://docs.puppetlabs.com/learning/">Learning Puppet</a> series.</p>

<p>Since we briefly touched on <code>$::boxen_srcdir</code>, what are some other custom facts
that come out of <code>shared/boxen/lib/facter/boxen.rb</code>?</p>

<figure class='code'><figcaption><span>shared/boxen/lib/facter/boxen.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;json&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;boxen/config&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">config</span>   <span class="o">=</span> <span class="ss">Boxen</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">load</span>
</span><span class='line'><span class="n">facts</span>    <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="n">factsdir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="n">config</span><span class="o">.</span><span class="n">homedir</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;facts&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;github_login&quot;</span><span class="o">]</span>   <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">login</span>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;github_email&quot;</span><span class="o">]</span>   <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;github_name&quot;</span><span class="o">]</span>    <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;boxen_home&quot;</span><span class="o">]</span>     <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">homedir</span>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;boxen_srcdir&quot;</span><span class="o">]</span>   <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">srcdir</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:reponame</span>
</span><span class='line'>  <span class="n">facts</span><span class="o">[</span><span class="s2">&quot;boxen_reponame&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">reponame</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">facts</span><span class="o">[</span><span class="s2">&quot;luser&quot;</span><span class="o">]</span>          <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">config</span><span class="o">.</span><span class="n">homedir</span><span class="si">}</span><span class="s2">/config/facts/*.json&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="n">facts</span><span class="o">.</span><span class="n">merge!</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span> <span class="n">file</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">facts</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span> <span class="n">setcode</span> <span class="p">{</span> <span class="n">v</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file will also give you <code>$::luser</code>, which will evaluate out to your system
username, and <code>$::github_name</code>, which is equivalent to your Github username
(note that this is what Boxen uses to find your class file in
<code>modules/people/manifests</code>). If you&rsquo;re looking for all the other values set by
these custom facts, check out <code>config/boxen/defaults.json</code> after you run Boxen.</p>

<h2>Using modules out of the Boxen namespace</h2>

<p>Not only is Boxen its own project, but it&rsquo;s a <a href="http://github.com/boxen">separate organization on Github
that hosts a number of Puppet modules</a>. Some of these modules are
pretty simple (a single resource to install a package), but the point is that
they&rsquo;ve been provided FOR you &ndash; so use, fork, and improve them (but most of
all, submit pull requests). The way you use them with Boxen may not be readily
clear, so let&rsquo;s walk through that with a simple module for installing Google
Chrome.</p>

<ol>
<li>Add the module to your Puppetfile</li>
<li>Classify the module in your Puppet setup</li>
<li>Run Boxen</li>
</ol>


<h4>Add the module to your Puppetfile</h4>

<p>Boxen uses a tool called <a href="https://github.com/rodjek/librarian-puppet">librarian-puppet</a> to source and install Puppet
modules from Github. Librarian-puppet uses the <code>Puppetfile</code> file in the root of
the Boxen repo to install modules.  Let&rsquo;s look at a couple of lines in that
file:</p>

<figure class='code'><figcaption><span>Puppetfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;boxen&quot;</span><span class="p">,</span>    <span class="s2">&quot;0.1.8&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-boxen&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;dnsmasq&quot;</span><span class="p">,</span>  <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-dnsmasq&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>      <span class="s2">&quot;0.0.3&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-git&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;hub&quot;</span><span class="p">,</span>      <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-hub&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;homebrew&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.17&quot;</span><span class="p">,</span> <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-homebrew&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;inifile&quot;</span><span class="p">,</span>  <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-inifile&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;nginx&quot;</span><span class="p">,</span>    <span class="s2">&quot;0.0.2&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-nginx&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;nodejs&quot;</span><span class="p">,</span>   <span class="s2">&quot;0.0.2&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-nodejs&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;nvm&quot;</span><span class="p">,</span>      <span class="s2">&quot;0.0.5&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-nvm&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;ruby&quot;</span><span class="p">,</span>     <span class="s2">&quot;0.4.0&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-ruby&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;stdlib&quot;</span><span class="p">,</span>   <span class="s2">&quot;3.0.0&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;puppetlabs/puppetlabs-stdlib&quot;</span>
</span><span class='line'><span class="n">mod</span> <span class="s2">&quot;sudo&quot;</span><span class="p">,</span>     <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>  <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-sudo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This evaluates out to the following syntax:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;</span></code></pre></td></tr></table></div></figure>


<p>The <strong>HARDEST</strong> thing about this file is finding the version number of modules
on Github (HINT: it&rsquo;s a tag). Once you&rsquo;re given that information, it&rsquo;s easy to
pull up a module on Github, look at its tags, and then fill out the file. Let&rsquo;s
do that with a line for the Chrome module:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;chrome&quot;</span><span class="p">,</span>     <span class="s2">&quot;0.0.2&quot;</span><span class="p">,</span>   <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;boxen/puppet-chrome&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Classify the module in your Puppet setup</h4>

<p>In the previous section, we created <code>modules/people/manifests/&lt;github
username&gt;.pp</code>.  We COULD continue to fill this file with a ton of resources,
but I tend to like to separate out resources into separate subclasses. <a href="http://docs.puppetlabs.com/learning/modules1.html#manifests-namespacing-and-autoloading">Puppet
has module naming conventions to ensure that it can FIND your
subclasses</a>, so I recommend browsing that guide before randomly
naming files (<strong>HINT:</strong> Filenames ARE important and DO matter here). I want to
create a <code>people::glarizza::applications</code> subclass, so I need to do the
following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>## YES, make sure to replace YOUR USERNAME for 'glarizza'
</span><span class='line'>$ cd /opt/boxen/repo
</span><span class='line'>$ mkdir -p modules/people/manifests/glarizza
</span><span class='line'>$ vim modules/people/manifests/glarizza/applications.pp</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s totally fine that there&rsquo;s a <code>glarizza</code> directory aside the <code>glarizza.pp</code>
file &ndash; this is intentional and desired. Puppet&rsquo;s not going to automatically
declare anything in the <code>people::glarizza::applications</code> class until we TELL it
to, so let&rsquo;s open <code>modules/people/manifests/glarizza.pp</code> and add the following
line at the top:</p>

<figure class='code'><figcaption><span>modules/people/manifests/glarizza.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">people::glarizza::applications</span>
</span></code></pre></td></tr></table></div></figure>


<p>That tells Puppet to find the <code>people::glarizza::applications</code> class and make
sure it &lsquo;does&rsquo; everything in that file. Now, let&rsquo;s create the
<code>people::glarizza::applications</code> class:</p>

<figure class='code'><figcaption><span>modules/people/manifests/glarizza/applications.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">people::glarizza::applications</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">chrome</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Yep, all it takes is one line to include the module we will get from Boxen.
Because of the way Boxen works, it will consult the Puppetfile FIRST, pull down
any modules that are in the Puppetfile but NOT on the system, drop them into
place so Puppet can find them, and then run Puppet normally.</p>

<h4>Run Boxen</h4>

<p>Once you have Boxen setup, you can just run <code>boxen</code> from the command line to
have it enforce your configuration. By default, if there are any errors, it
will log them as Github Issues on your fork of the main Boxen repository (this
can be disabled with <code>boxen --no-issue</code>). As you&rsquo;re just getting started,
don&rsquo;t worry about the errors. The good news is that once you fix things and
perform a successful Boxen run, it will automatically close all open issues.
If everything went well, you should now have Google Chrome in your
<code>/Applications</code> directory!</p>

<h2>Â¡MÃ¡s Puppet!</h2>

<p>You&rsquo;ll find as you start customizing all the things that you&rsquo;re usually
managing one of the following resources:</p>

<ol>
<li>Packages</li>
<li>Files</li>
<li>Repositories</li>
<li>Plist files</li>
</ol>


<p>We&rsquo;ve covered managing a repository and a file, but let&rsquo;s look at a couple of
the other popular resources:</p>

<h3>Packages are annoying</h3>

<p>I would be willing to bet that most of the things you end up managing will be
packages. Using Puppet with Boxen, you have the ability to install four
different kinds of packages:</p>

<ol>
<li>Applications inside a DMG</li>
<li>Installer packages inside a DMG</li>
<li>Homebrew Packages</li>
<li>Applications inside a .zip file</li>
</ol>


<p>Here&rsquo;s an example of every type of package installer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline">  # Application in a DMG</span>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;Gephi&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>   <span class="p">=&gt;</span> <span class="ss">installed</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">source</span>   <span class="p">=&gt;</span> <span class="s1">&#39;https://launchpadlibrarian.net/98903476/gephi-0.8.1-beta.dmg&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">appdmg</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Installer in a DMG</span>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;Virtualbox&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">installed</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">source</span> <span class="p">=&gt;</span> <span class="s1">&#39;http://download.virtualbox.org/virtualbox/4.1.22/VirtualBox-4.1.23-80870-OSX.dmg&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">pkgdmg</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Homebrew Package</span>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;tmux&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">installed</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Application in a .zip</span>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;Github for Mac&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>   <span class="p">=&gt;</span> <span class="ss">installed</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">source</span>   <span class="p">=&gt;</span> <span class="s1">&#39;https://github-central.s3.amazonaws.com/mac%2FGitHub%20for%20Mac%2069.zip&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">provider</span> <span class="p">=&gt;</span> <span class="ss">compressed_app</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the only thing that changes among these resources is the <code>provider</code>
attribute. Remember from before that Boxen sets the default package provider to
be &lsquo;homebrew&rsquo;, so for &lsquo;tmux&rsquo; I omitted the provider attribute to utilize the
default. Also, the <code>ensure</code> attribute is defaulted to &lsquo;installed&rsquo;, so
technically I could remove it&hellip;but I tend to prefer to use it for people who
will be reading my code later.</p>

<p>There&rsquo;s no provider for .pkg files. Why? Well, packages on OS X are
either bundles or flat-packages. Bundles LOOK like individual files, but they&rsquo;re
actually folders that contain everything necessary to expand and install the
package. Flat packages are just that &ndash; an actual file that ends in .pkg that
can be expanded to install whatever you want. Bundle packages are pretty
common, but they&rsquo;re also hard for curl to download them (being that it&rsquo;s just
a folder full of files) &ndash; this is why most installer packages you encounter on
OS X are going to be enclosed in a .dmg Disk Image.</p>

<p>So which provider will you use? Well, if your file ends in .dmg then you&rsquo;re
going to be using either the <code>pkgdmg</code> or <code>appdmg</code> provider. How do you know
which to use? Expand the .dmg file and look inside it. If it contains an
application ending in .app that simply needs dragged into the <code>/Applications</code>
folder on disk, then chose the <code>appdmg</code> provider (that&rsquo;s essentially all it
does &ndash; expand the .dmg file and ditto the .app file into <code>/Applications</code>).
If the disk image contains a .pkg package installer, then you&rsquo;ll chose the
<code>pkgdmg</code> provider (which expands the .dmg file and uses <code>installer</code> to install
the contents of the .pkg file silently in the background). If your file is a
.zip file containing an Application (.app file), then you can use Github&rsquo;s
custom <code>compressed_app</code> provider that will unzip the file and ditto the app
into <code>/Applications</code>. Finally, if you want to install a package from Homebrew,
then the <code>homebrew</code> provider is pretty self-explanatory here.</p>

<p>(NOTE: There is ONE more package provider I haven&rsquo;t covered here &ndash; the <code>macports</code>
provider. It requires <a href="http://www.macports.org">Macports</a> to be installed on your
system, and will use it to install a package. Macports vs. Homebrew arguments
notwithstanding, if you&rsquo;re into Macports then there&rsquo;s a provider for you.)</p>

<h3>Plists: because why NOT XML :\</h3>

<p>Apple falls somewhere between &ldquo;the registry&rdquo; and &ldquo;config files&rdquo; on the timeline
of tweaking system settings. Most settings are locked up in plist files that
can be managed by hand or with <code>plistbuddy</code> or <code>defaults</code>. A couple of people
have saved their customizations in with their dotfiles (<a href="https://github.com/holman/dotfiles/blob/master/osx/set-defaults.sh">Zach Holman has an example here</a>),
but Puppet is a great way for managing individual keys in your plist files.
<a href="http://github.com/glarizza/puppet-property_list_key">I&rsquo;ve written a module that will manage any number of keys in a plist
file</a>.  You can modify your <code>Puppetfile</code> to
make sure Boxen picks up my module by adding the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="s2">&quot;property_list_key&quot;</span><span class="p">,</span>  <span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>   <span class="ss">:github_tarball</span> <span class="o">=&gt;</span> <span class="s2">&quot;glarizza/puppet-property_list_key&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, you&rsquo;ll need to add resources to your classes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline">  # Disable Gatekeeper so you can install any package you want</span>
</span><span class='line'>  <span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;Disable Gatekeeper&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">path</span>   <span class="p">=&gt;</span> <span class="s1">&#39;/var/db/SystemPolicy-prefs.plist&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">key</span>    <span class="p">=&gt;</span> <span class="s1">&#39;enabled&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value</span>  <span class="p">=&gt;</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$my_homedir</span> <span class="o">=</span> <span class="s2">&quot;/Users/</span><span class="si">${::luser}</span><span class="s2">&quot;</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # NOTE: Dock prefs only take effect when you restart the dock</span>
</span><span class='line'>  <span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;Hide the dock&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/Library/Preferences/com.apple.dock.plist&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;autohide&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">notify</span>     <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s1">&#39;Restart the Dock&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;Align the Dock Left&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/Library/Preferences/com.apple.dock.plist&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;orientation&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">notify</span>     <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s1">&#39;Restart the Dock&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;Lower Right Hotcorner - Screen Saver&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/Library/Preferences/com.apple.dock.plist&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;wvous-br-corner&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="m">10</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">notify</span>     <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s1">&#39;Restart the Dock&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;Lower Right Hotcorner - Screen Saver - modifier&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/Library/Preferences/com.apple.dock.plist&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;wvous-br-modifier&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">notify</span>     <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s1">&#39;Restart the Dock&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">exec</span> <span class="p">{</span> <span class="s1">&#39;Restart the Dock&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">command</span>     <span class="p">=&gt;</span> <span class="s1">&#39;/usr/bin/killall -HUP Dock&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">refreshonly</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s1">&#39;Dock Plist&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">file</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="p">[</span>
</span><span class='line'>                 <span class="nc">Property_list_key</span><span class="p">[</span><span class="s1">&#39;Lower Right Hotcorner - Screen Saver - modifier&#39;</span><span class="p">],</span>
</span><span class='line'>                 <span class="nc">Property_list_key</span><span class="p">[</span><span class="s1">&#39;Hide the dock&#39;</span><span class="p">],</span>
</span><span class='line'>                 <span class="nc">Property_list_key</span><span class="p">[</span><span class="s1">&#39;Align the Dock Left&#39;</span><span class="p">],</span>
</span><span class='line'>                 <span class="nc">Property_list_key</span><span class="p">[</span><span class="s1">&#39;Lower Right Hotcorner - Screen Saver&#39;</span><span class="p">],</span>
</span><span class='line'>                 <span class="nc">Property_list_key</span><span class="p">[</span><span class="s1">&#39;Lower Right Hotcorner - Screen Saver - modifier&#39;</span><span class="p">],</span>
</span><span class='line'>               <span class="p">],</span>
</span><span class='line'>    <span class="nt">path</span>    <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/Library/Preferences/com.apple.dock.plist&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">mode</span>    <span class="p">=&gt;</span> <span class="s1">&#39;0600&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">notify</span>     <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s1">&#39;Restart the Dock&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The important attributes are:</p>

<ol>
<li><code>path</code>: The path to the plist file on disk</li>
<li><code>key</code>: The individual KEY in the plist file you want to manage</li>
<li><code>value</code>: The value that the key should have in the plist file</li>
<li><code>value_type</code>: The datatype the value should be (defaults to <code>string</code>, but
could also be <code>array</code>, <code>hash</code>, <code>boolean</code>, or <code>integer</code>)</li>
</ol>


<p>You MUST pass a path, key, and value or Puppet will throw an error.</p>

<p>The first resource above sets Gatekeeper in 10.8 and allows you to install
packages from the web that HAVEN&rsquo;T been signed (in 10.8, Apple won&rsquo;t allow you
to install unsigned packages or anything outside of the App Store without
enabling this setting).</p>

<p>All of the other resources relate to making changes to the Dock. Because of the
way the Dock is managed, you must <code>HUP</code> its process when making changes to your
dock plist before they take effect. Also, the dock plist has to be owned by
you or else the changes won&rsquo;t take effect. Every dock plist resource has
a <code>notify</code> metaparameter which means &ldquo;any time this resource changes, run this
exec resource&rdquo;. That exec resource is a simple command that <code>HUP</code>s the dock
process.  It will ONLY be run if a resource notifies it &ndash; so if no changes are
made in a Puppet run then the command won&rsquo;t fire. Finally, the file resource to
manage the dock plist ensures that permissions are set (and notifies the exec
in case it needs to CHANGE permissions).</p>

<p>Again, this is purely dealing with Puppet &ndash; but plists are a major part of OS
X and you&rsquo;ll be dealing with them regularly!</p>

<h3>But seriously, dotfiles</h3>

<p>I know I&rsquo;ve joked about it a couple of times, but getting your dotfiles into
their correct location is a quick win. The secret is to lock them all up in
a repository, and then symlink them where you need them. Let&rsquo;s look at that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline">  # My dotfile repository</span>
</span><span class='line'>  <span class="nc">repository</span> <span class="p">{</span> <span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">source</span> <span class="p">=&gt;</span> <span class="s1">&#39;glarizza/dotfiles&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;</span><span class="si">${my_homedir}</span><span class="s2">/.tmux.conf&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">mode</span>    <span class="p">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span>  <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles/tmux.conf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;/Users/</span><span class="si">${my_username}</span><span class="s2">/.zshrc&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">mode</span>    <span class="p">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span>  <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles/zshrc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;/Users/</span><span class="si">${my_username}</span><span class="s2">/.vimrc&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">mode</span>   <span class="p">=&gt;</span> <span class="s1">&#39;0644&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles/vimrc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/dotfiles&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Yes, oh-my-zsh. Judge me.</span>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;/Users/</span><span class="si">${my_username}</span><span class="s2">/.oh-my-zsh&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">link</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">target</span>  <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/oh-my-zsh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Repository</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${my_sourcedir}</span><span class="s2">/oh-my-zsh&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s worth mentioning that Puppet does not do things procedurally. Just because
the dotfiles repository is listed before every symlink DOES NOT mean that Puppet
will evaluate and declare it first. You&rsquo;ll need to specify order here, and that&rsquo;s
what the <code>require</code> metaparameter does.</p>

<p>Based on what I&rsquo;ve already shown you, this code block should be very simple to
follow. Because I&rsquo;m using symlinks, the dotfiles should always be current.
Because the dotfiles are under revision control, updating them all is as simple
as making commits and updating your repository. If you&rsquo;ve ever had to migrate
these files to a new VM/machine, then you know how full of win this block of
code is.</p>

<h2>Don&rsquo;t sweat petty (or pet sweaty)</h2>

<p>When I show sysadmins/developers automation like this, they usually want to
apply it to the HARDEST part of their day-job IMMEDIATELY. That&rsquo;s a somewhat
rational reaction, but it&rsquo;s not going to give you the results you want. The
cool thing ABOUT Boxen and Puppet is that it&rsquo;s going to remove those little
annoyances in your day that slowly sap your time. START by tackling those
small annoyances to remove them and build your confidence (like the dotfiles
example above). Yeah, you&rsquo;ll only save a couple of minutes a day, but it
grows exponentially. Also, when you solve a problem during the course of your
day, MANAGE it with Boxen by putting it in your Puppet class (then, test it
out on a VM or another machine to make sure it does what you expect).</p>

<p>Don&rsquo;t worry that you&rsquo;re not saving the world with a massive Puppet class &ndash;
sometimes the secret to happiness is opening iTerm on a new machine and
seeing your finely-crafted prompt shining in its cornflower-blue glory.</p>

<h2>Now show me some cool stuff</h2>

<p>So that&rsquo;s a quick tour of the basics of Boxen and the kinds of things you can
do from the start.  I&rsquo;m really excited for everyone to get their hands on Boxen
and do more cool stuff with Puppet. I&rsquo;ve done a bunch of work with Puppet for
OS X, and that&rsquo;s enough to know that there&rsquo;s still PLENTY that can be
improved in the codebase.  A giant THANK YOU to <a href="http://twitter.com/jbarnette">John Barnette</a>, <a href="http://twitter.com/wfarr">Will Farrington</a>,
and the entire Github Boxen team for all their work on this
tool (and letting me tinker with it before it hit the general public)! Feel
free to comment below, email me (gary at puppetlabs), or <a href="http://twitter.com/glarizza">yell at me on Twitter</a>
for more information!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Repeatable Puppet Development With Vagrant]]></title>
    <link href="http://garylarizza.com/blog/2013/02/01/repeatable-puppet-development-with-vagrant/"/>
    <updated>2013-02-01T00:00:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/02/01/repeatable-puppet-development-with-vagrant</id>
    <content type="html"><![CDATA[<p>I miss testing code in production. In smaller organizations, &lsquo;testing&rsquo; and
&lsquo;development&rsquo; can sometimes consist of making changes directly on a server,
walking to an active machine, and hoping things work. Once you were done, you
MIGHT document what changes you made, but more often than not you kept that
information in your head and referred to it later.</p>

<p>I lied &ndash; that is everything that sucks about manual configuration of machines.</p>

<p>The best way to get out of this rut is to get addicted to automating first the
menial tasks on your machines, and then work your way up from there. We STILL
have the problem, though, of doing this in production &ndash; that&rsquo;s what this post
is meant to address.</p>

<p>What we want is the ability to spin up a couple of test nodes for the purpose
of testing our automation workflow BEFORE it gets committed and applied to our
production nodes. This post details using <a href="http://www.vagrantup.com">Vagrant</a> and
<a href="http://www.puppetlabs.com">Puppet</a> to both establish a clean test environment and also test
automation changes BEFORE applying them to your production environment.</p>

<p><a href="http://www.puppetlabs.com">Puppet</a> is a Configuration Management tool that automates all the
annoying aspects of manual configuration out of your infrastructure. The bulk
of its usage is beyond the scope of THIS post, however we&rsquo;re going to be using
it as the means to describe the changes we want to make on our systems.</p>

<p><a href="http://www.vagrantup.com">Vagrant</a> is a magical project that uses minimal VM templates (boxes)
to spin up clean virtualized environments on your workstation for the purpose
of testing changes. Currently, it only supports a Virtualbox backend, but its
creator, <a href="http://twitter.com/mitchellh">Mitchell Hashimoto</a>, has <a href="http://vimeo.com/58059557">teased a preview of upcoming VMware</a>
integration that SHOULD be coming any day now. In this post, Vagrant will be
the means by which we spin up new VMs for development purposes</p>

<h2>Getting setup</h2>

<p>The only moving piece you need installed on your system is <a href="http://www.vagrantup.com">Vagrant</a>.
Fortunately, Mitchell <a href="http://downloads.vagrantup.com">provides native package installers</a> on his website for
downloading Vagrant. If you&rsquo;ve never used Vagrant before, and you AREN&rsquo;T a Ruby
developer who maintains multiple Ruby versions on your system, then you&rsquo;ll want
to opt for the native package installer since it&rsquo;s the easiest method to get
Vagrant installed (and, on Macs, Vagrant embeds its own Ruby AND Rubygems
binaries in the Package bundle&hellip;which is kind of cool).</p>

<p>IF, however, you are developing in Ruby and you use <a href="https://rvm.io/">RVM</a> or <a href="https://github.com/sstephenson/rbenv/">Rbenv</a>
to maintain multiple copies of Ruby on your system, then you&rsquo;ll want to favor
installing Vagrant via Rubygems a la:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install vagrant --no-ri --no-rdoc
</span></code></pre></td></tr></table></div></figure>


<p>If you have no idea how to use RVM or Rbenv &ndash; stick with the <a href="http://downloads.vagrantup.com">native installers</a> :)</p>

<p>Puppet does NOT need to be on your workstation since we&rsquo;re only going to be using it on the VMs that
Vagrant spins up &ndash; so don&rsquo;t worry about Puppet yet.</p>

<h2>My kingdom for a box</h2>

<p>Vagrant uses box files as templates from which to spin up a new virtual machine
for development purposes. <a href="http://vagrantbox.es">There are sites that host boxes available for download</a>,
OR, you could use <a href="https://github.com/jedi4ever/veewee">an awesome project called Veewee</a> to build your own.
Again, building your box file is outside the scope of this article, so just
make sure you download a box with an OS that&rsquo;s to your liking.  This box DOES
NOT need to have Puppet preinstalled &ndash; in fact, it&rsquo;s probably better that it
doesn&rsquo;t (because the version will probably be old, and we&rsquo;re going to work
around this anyways). I&rsquo;m going to choose a CentOS 6.3 box that the SE team at
Puppet Labs uses for demos, but, again, it&rsquo;s up to you.</p>

<h2>Vagrantfile, assemble!</h2>

<p>Now that we&rsquo;ve got the pieces we need, let&rsquo;s start stitching together
a repeatable workflow. To do that, we&rsquo;ll need to create a directory for this
project and a <code>Vagrantfile</code> to direct Vagrant on how it should setup your VM.
I&rsquo;m going to use <code>~/src/vagrant_projects</code> for the purpose of this demo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p ~/src/vagrant_projects
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/vagrant_projects
</span><span class='line'><span class="nv">$ </span>vim Vagrantfile
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a look at a sample Vagrantfile that I use to get Puppet installed on
a box:</p>

<figure class='code'><figcaption><span>Vagrantfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Vagrant</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span>       <span class="o">=</span> <span class="s2">&quot;centos-6.3-x86_64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span>   <span class="o">=</span> <span class="s2">&quot;https://saleseng.s3.amazonaws.com/boxfiles/CentOS-6.3-x86_64-minimal.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;development.puppetlabs.vm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="s2">&quot;192.168.33.10&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">forward_port</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8084</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:shell</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos_6_x.sh&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Stepping through this file line-by-line, the first two <code>config.vm</code> lines
establish the box we want to use for our development VM as well as the URL to
the box file where it can be downloaded (in the event that it does not exist on
our system). Because, initially, this box will NOT be known to Vagrant, it will
attempt to reach out to that address and download it (note that the URL to THIS
PARTICULAR BOX is subject to change &ndash; please find a box file that works for you
and substitute its URL in the <code>config.vm.box_url</code> config setting).  The next
three lines define the machine&rsquo;s hostname, the network type, and the IP address
for this VM. In this case, I&rsquo;m using a host-only network and giving it an IP
address on a made-up 192.168.33.0/24 subnet (feel free to use your own
private IP range as long as it doesn&rsquo;t conflict with anything). The next line
is forwarding port 80 on the VM to port 8084 on my local laptop &ndash; this allows
you to test out web services by simply navigating to <a href="http://localhost:8084">http://localhost:8084</a>
from your web browser.  I&rsquo;ll save explaining the last line for the next
section.</p>

<p><strong>NOTE</strong>: For more documentation on these settings, <a href="http://docs.vagrantup.com/v1/docs/vagrantfile.html">visit Vagrant&rsquo;s documentation site</a>
as it&rsquo;s quite good</p>

<h2>Getting Puppet on your VM</h2>

<p>The final line in the sample Vagrantfile runs what&rsquo;s called the &lsquo;Shell
Provisioner&rsquo; for Vagrant. Essentially, it runs a shell script on the VM once
it&rsquo;s been booted and configured. What does this shell script do?</p>

<figure class='code'><figcaption><span>centos_6_x.sh</span><a href='https://github.com/hashicorp/puppet-bootstrap/blob/master/centos_6_x.sh'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="c"># This bootstraps Puppet on CentOS 6.x</span>
</span><span class='line'><span class="c"># It has been tested on CentOS 6.3 64bit</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="nv">REPO_URL</span><span class="o">=</span><span class="s2">&quot;http://yum.puppetlabs.com/el/6/products/i386/puppetlabs-release-6-6.noarch.rpm&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$EUID&quot;</span> -ne <span class="s2">&quot;0&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;This script must be run as root.&quot;</span> &gt;&amp;2
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if </span>which puppet &gt; /dev/null 2&gt;&amp;1; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Puppet is already installed&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>0
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Install puppet labs repo</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Configuring PuppetLabs repo...&quot;</span>
</span><span class='line'><span class="nv">repo_path</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
</span><span class='line'>wget --output-document<span class="o">=</span><span class="k">${</span><span class="nv">repo_path</span><span class="k">}</span> <span class="k">${</span><span class="nv">REPO_URL</span><span class="k">}</span> 2&gt;/dev/null
</span><span class='line'>rpm -i <span class="k">${</span><span class="nv">repo_path</span><span class="k">}</span> &gt;/dev/null
</span><span class='line'>
</span><span class='line'><span class="c"># Install Puppet...</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Installing puppet&quot;</span>
</span><span class='line'>yum install -y puppet &gt; /dev/null
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Puppet installed!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, it sets up the Puppet Labs el6 repository containing the
current packages for Puppet/Facter/Hiera/PuppetDB/etc and installs the most
recent version of Puppet and Facter that are in the repository. This will
ensure that you have the most recent version of Puppet on your VM, and you
don&rsquo;t need to worry about creating a new box every time Puppet releases a new
version.</p>

<p>This code <a href="https://github.com/hashicorp/puppet-bootstrap/blob/master/centos_6_x.sh">came from Mitchell&rsquo;s puppet-bootstrap repo</a> where he
maintains a list of scripts that will bootstrap Puppet onto many of the common
operating systems out there. This code was current as of the initial posting
date of this blog, but make sure to check that repo for any updates.  If you&rsquo;re
maintaining your OWN provisioning script, consider filing pull requests against
Mitchell&rsquo;s repo so we can ALL benefit from good code and don&rsquo;t have to keep
creating &lsquo;another wheel&rsquo; just to provision Puppet on VMs!</p>

<h2>Spin up your VM</h2>

<p>Once you&rsquo;ve created a <code>Vagrantfile</code> in a directory, the next logical thing to
do is to test out Vagrant and fire up your VM. Let&rsquo;s first check the status of
the vm:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant status
</span><span class='line'>
</span><span class='line'>Current VM states:
</span><span class='line'>
</span><span class='line'>default                  not created
</span><span class='line'>
</span><span class='line'>The environment has not yet been created. Run <span class="sb">`</span>vagrant up<span class="sb">`</span> to
</span><span class='line'>create the environment.
</span></code></pre></td></tr></table></div></figure>


<p>As expected, this VM has yet to be created, so let&rsquo;s do that by doing a <code>vagrant up</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant up
</span><span class='line'>
</span><span class='line'>[default] Box centos-6.3-x86_64 was not found. Fetching box from specified
</span><span class='line'>URL...
</span><span class='line'>[vagrant] Downloading with Vagrant::Downloaders::HTTP...
</span><span class='line'>[vagrant] Downloading box:
</span><span class='line'>https://saleseng.s3.amazonaws.com/boxfiles/CentOS-6.3-x86_64-minimal.box
</span><span class='line'>[vagrant] Extracting box...
</span><span class='line'>[vagrant] Verifying box...
</span><span class='line'>[vagrant] Cleaning up downloaded box...
</span><span class='line'>[default] Importing base box 'centos-6.3-x86_64'...
</span><span class='line'>[default] The guest additions on this VM do not match the install version of
</span><span class='line'>VirtualBox! This may cause things such as forwarded ports, shared
</span><span class='line'>folders, and more to not work properly. If any of those things fail on
</span><span class='line'>this machine, please update the guest additions and repackage the
</span><span class='line'>box.
</span><span class='line'>
</span><span class='line'>Guest Additions Version: 4.1.18
</span><span class='line'>VirtualBox Version: 4.1.23
</span><span class='line'>[default] Matching MAC address for NAT networking...
</span><span class='line'>[default] Clearing any previously set forwarded ports...
</span><span class='line'>[default] Forwarding ports...
</span><span class='line'>[default] -- 22 => 2222 (adapter 1)
</span><span class='line'>[default] -- 80 => 8084 (adapter 1)
</span><span class='line'>[default] Creating shared folders metadata...
</span><span class='line'>[default] Clearing any previously set network interfaces...
</span><span class='line'>[default] Preparing network interfaces based on configuration...
</span><span class='line'>[default] Booting VM...
</span><span class='line'>[default] Waiting for VM to boot. This can take a few minutes.
</span><span class='line'>[default] VM booted and ready for use!
</span><span class='line'>[default] Configuring and enabling network interfaces...
</span><span class='line'>[default] Setting host name...
</span><span class='line'>[default] Mounting shared folders...
</span><span class='line'>[default] -- v-root: /vagrant
</span><span class='line'>[default] Running provisioner: Vagrant::Provisioners::Shell...
</span><span class='line'>Configuring PuppetLabs repo...
</span><span class='line'>warning: 
</span><span class='line'>/tmp/tmp.FvW0K7FJWU: Header V4 RSA/SHA1 Signature, key ID 4bd6ec30: NOKEY
</span><span class='line'>Installing puppet
</span><span class='line'>warning: 
</span><span class='line'>rpmts_HdrFromFdno: Header V4 RSA/SHA1 Signature, key ID 4bd6ec30: NOKEY
</span><span class='line'>Importing GPG key 0x4BD6EC30:
</span><span class='line'> Userid : Puppet Labs Release Key (Puppet Labs Release Key) &lt;info@puppetlabs.com>
</span><span class='line'> Package: puppetlabs-release-6-6.noarch (installed)
</span><span class='line'> From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-puppetlabs
</span><span class='line'>Warning: RPMDB altered outside of yum.
</span><span class='line'>Puppet installed!</span></code></pre></td></tr></table></div></figure>


<p>Vagrant first noticed that we did not have the CentOS box on our machine, so it
downloaded, extracted, and verified the box before importing it and creating
our custom VM. Next, it configured the VM&rsquo;s network settings according to our
Vagrantfile, and finally it provisioned the box using the script we passed in
the Vagrantfile.</p>

<p>We&rsquo;ve now got a VM running and Puppet is installed. Let&rsquo;s ssh to our VM
and check the Puppet Version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant ssh
</span><span class='line'>
</span><span class='line'>Last login: Tue Jul 10 22:56:01 2012 from 10.0.2.2
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>puppet --version
</span><span class='line'>3.0.2
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>hostname
</span><span class='line'>development.puppetlabs.vm
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
</span><span class='line'><span class="nb">logout</span>
</span><span class='line'>Connection to 127.0.0.1 closed.
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>vagrant destroy -f
</span><span class='line'><span class="o">[</span>default<span class="o">]</span> Forcing shutdown of VM...
</span><span class='line'><span class="o">[</span>default<span class="o">]</span> Destroying VM and associated drives...
</span></code></pre></td></tr></table></div></figure>


<p>Cool &ndash; so we demonstrated that we could ssh into the VM, check the Puppet
version, check the hostname to ensure that Vagrant had set it correctly, exit
out, and then we finally destroyed the VM with <code>vagrant destroy -f</code>.  The next
step is to actually configure Puppet to DO something with this VM&hellip;</p>

<h2>Using Puppet to setup your node</h2>

<p>The act of GETTING a clean VM is all well and good (and is probably magic
enough for most people out there), but the purpose of this post is to
demonstrate a workflow for testing out Puppet code changes. In the previous
step we showed how to get Puppet installed, but we&rsquo;ve yet to demonstrate how
to use Vagrant&rsquo;s built-in <a href="http://docs.vagrantup.com/v1/docs/provisioners/puppet.html">Puppet provisioner</a> to configure your VM. Let&rsquo;s use
the example of a developer wanting to spin up a LAMP stack. To manually
configure that would require installing a number of packages, editing a number
of config files, and then making sure services were installed (among other
things). We&rsquo;re going to use some of the Puppet modules from the <a href="http://forge.puppetlabs.com">Puppet
Forge</a> to tackle these tasks and make Vagrant automatically configure
our VM.</p>

<h2>Scaffolding Puppet</h2>

<p>We need a way to pass our Puppet code to the VM Vagrant creates. Fortunately,
Vagrant has a way to define <a href="http://docs.vagrantup.com/v1/docs/config/vm/share_folder.html">Shared Folders</a> that can be shared from your
workstation and mounted on your VM at a particular mount point. Let&rsquo;s modify
our Vagrantfile to account for this shared folder:</p>

<figure class='code'><figcaption><span>Vagrantfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Vagrant</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span>       <span class="o">=</span> <span class="s2">&quot;centos-6.3-x86_64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span>   <span class="o">=</span> <span class="s2">&quot;https://saleseng.s3.amazonaws.com/boxfiles/CentOS-6.3-x86_64-minimal.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;development.puppetlabs.vm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="s2">&quot;192.168.33.10&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">forward_port</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8084</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:shell</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos_6_x.sh&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Puppet Shared Folder</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span> <span class="s2">&quot;puppet_mount&quot;</span><span class="p">,</span> <span class="s2">&quot;/puppet&quot;</span><span class="p">,</span> <span class="s2">&quot;puppet&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The syntax for the <code>config.vm.share_folder</code> line is that the first argument is
a logical name for the shared folder mapping, the second argument is the path
IN THE VM where this folder will be mounted (so, a folder called &lsquo;puppet&rsquo; in
the root of the filesystem), and the last argument is the path to the folder ON
YOUR WORKSTATION that will be mounted in the VM (it can be a full or relative
path &ndash; which is what we&rsquo;ve done here). This folder hasn&rsquo;t been created yet, so
let&rsquo;s create it (and a couple of subfolders):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/vagrant_projects
</span><span class='line'><span class="nv">$ </span>mkdir -p puppet/<span class="o">{</span>manifests,modules<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This command will create the <code>puppet</code> directory in the same directory that
contains our Vagrantfile, and then two subdirectories, <code>manifests</code> and
<code>modules</code>, that will be used by the Puppet provisioner later. Now that we&rsquo;ve
told Vagrant to create our shared folder, and we&rsquo;ve created the folder
structure, let&rsquo;s bring up the VM with <code>vagrant up</code> again, ssh into the VM with
<code>vagrant ssh</code>, and then check to see that the folder has been mounted.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant up
</span><span class='line'>
</span><span class='line'>&lt;output suppressed - see above <span class="k">for </span>example output&gt;
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>vagrant ssh
</span><span class='line'>
</span><span class='line'>Last login: Tue Jul 10 22:56:01 2012 from 10.0.2.2
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>ls /puppet
</span><span class='line'>manifests  modules
</span></code></pre></td></tr></table></div></figure>


<p>Great! We&rsquo;ve setup a shared folder. To further test it out, you can try
dropping a file in the puppet directory or one of its subdirectories &ndash; it
should immediately show up on the VM without having to recreate the VM (because
it&rsquo;s a shared folder). There are pros and cons with this workflow &ndash; the main
pro is that changes you make on your workstation will immediately be reflected
in the VM, and the main con is that you can&rsquo;t symlink folders INSIDE
the shared folder on your workstation because of the nature of symlinks.</p>

<h2>Installing the necessary Puppet Modules</h2>

<p>Since we&rsquo;ve already spun up a new VM and ssh&rsquo;d into it, let&rsquo;s use our VM to
download modules we&rsquo;re going to need to setup our LAMP stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>puppet module install puppetlabs/apache --target-dir /puppet/modules/
</span><span class='line'>Notice: Preparing to install into /puppet/modules ...
</span><span class='line'>Notice: Downloading from https://forge.puppetlabs.com ...
</span><span class='line'>Notice: Installing -- <span class="k">do </span>not interrupt ...
</span><span class='line'>/puppet/modules
</span><span class='line'>â””â”€â”¬ puppetlabs-apache <span class="o">(</span>v0.5.0-rc1<span class="o">)</span>
</span><span class='line'>  â”œâ”€â”€ puppetlabs-firewall <span class="o">(</span>v0.0.4<span class="o">)</span>
</span><span class='line'>  â””â”€â”€ puppetlabs-stdlib <span class="o">(</span>v3.2.0<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>puppet module install puppetlabs/mysql --target-dir /puppet/modules/
</span><span class='line'>Notice: Preparing to install into /puppet/modules ...
</span><span class='line'>Notice: Downloading from https://forge.puppetlabs.com ...
</span><span class='line'>Notice: Installing -- <span class="k">do </span>not interrupt ...
</span><span class='line'>/puppet/modules
</span><span class='line'>â””â”€â”€ puppetlabs-mysql <span class="o">(</span>v0.6.1<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>vagrant@development ~<span class="o">]</span><span class="nv">$ </span>ls /puppet/modules/
</span><span class='line'>apache  concat  firewall  mysql  stdlib
</span></code></pre></td></tr></table></div></figure>


<p>The <code>puppet</code> binary has a module subcommand that will connect to the <a href="http://forge.puppetlabs.com">Puppet Forge</a>
to download Puppet modules and their dependencies. The commands we used will
install Puppet Labs&#8217; <code>apache</code> and <code>mysql</code> modules (and their dependencies).
We&rsquo;re also passing the <code>--target-dir</code> argument that will tell the <code>puppet
module</code> subcommand to install the module into our shared directory (instead of
Puppet&rsquo;s default module path).</p>

<p>I&rsquo;m choosing to use <code>puppet module</code> to install these modules, but there are
a multitude of other methods you can use (from downloading the modules directly
out of <a href="http://github.com">Github</a> to using a tool like <a href="https://github.com/rodjek/librarian-puppet">librarian-puppet</a>). The point is
that we need to ultimately get the modules into the <code>modules</code> directory
in our shared <code>puppet</code> folder &ndash; however you want to do that works for me :)</p>

<p>Once the modules are in <code>puppet/modules</code>, we&rsquo;re good. You only ever need to do
this step ONCE. Because this folder is a shared folder, you can now <code>vagrant
up</code> and <code>vagrant destroy</code> to your heart&rsquo;s content &ndash; Vagrant will not remove the
content in our shared folder when a VM is destroyed. Remember, too, that any
changes made to those modules from either the VM or on your Workstation will be
IMMEDIATELY available to both.</p>

<p>Since we&rsquo;re now done with the VM for now, let&rsquo;s destroy it with <code>vagrant destroy</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant destroy</span></code></pre></td></tr></table></div></figure>


<h2>Classifying your development VM</h2>

<p>The modules we installed are a framework that we will use to configure the
node. The act of directing the actions that Puppet should take on a particular
node is called <a href="http://docs.puppetlabs.com/puppet/3/reference/lang_summary.html#resources-classes-and-nodes">&lsquo;Classification&rsquo;</a>. Puppet uses a file called <a href="http://docs.puppetlabs.com/learning/agent_master_basic.html#sitepp">site.pp</a>
to map Puppet code with the corresponding &lsquo;node&rsquo; (or, in our case, our VM) that
should receive it. Let&rsquo;s create a site.pp file and open it for editing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/src/vagrant_projects
</span><span class='line'>$ vim puppet/manifests/site.pp</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create a site.pp that will setup the LAMP stack on our
<code>development.puppetlabs.vm</code> that we create with Vagrant:</p>

<figure class='code'><figcaption><span>~/src/vagrant_projects/manifests/site.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="s1">&#39;development.puppetlabs.vm&#39;</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">  # Configure mysql</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;mysql::server&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">config_hash</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;root_password&#39;</span> <span class="p">=&gt;</span> <span class="s1">&#39;8ZcJZFHsvo7fINZcAvi0&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">mysql::php</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Configure apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">apache::mod::php</span>
</span><span class='line'>  <span class="nc">apache::vhost</span> <span class="p">{</span> <span class="nv">$::fqdn</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">port</span>    <span class="p">=&gt;</span> <span class="s1">&#39;80&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">docroot</span> <span class="p">=&gt;</span> <span class="s1">&#39;/var/www/test&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">File</span><span class="p">[</span><span class="s1">&#39;/var/www/test&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  # Configure Docroot and index.html</span>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="p">[</span><span class="s1">&#39;/var/www&#39;</span><span class="p">,</span> <span class="s1">&#39;/var/www/test&#39;</span><span class="p">]:</span>
</span><span class='line'>    <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">directory</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">file</span> <span class="p">{</span> <span class="s1">&#39;/var/www/test/index.php&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="ss">file</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">content</span> <span class="p">=&gt;</span> <span class="s1">&#39;&lt;?php echo \&#39;</span><span class="err">&lt;</span><span class="ss">p</span><span class="err">&gt;</span><span class="ss">Hello</span> <span class="ss">World</span><span class="err">&lt;/</span><span class="ss">p</span><span class="err">&gt;\</span><span class="s1">&#39;; ?&gt; &#39;</span><span class="err">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c-Singleline"># Realize the Firewall Rule</span>
</span><span class='line'>  <span class="ss">Firewall</span> <span class="err">&lt;||&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, the point of this post is not about writing Puppet code but more about
testing the Puppet code you write. The above node declaration will setup MySQL
with a root password of &lsquo;puppet&rsquo;, setup Apache and a VHost for
<code>development.puppetlabs.vm</code> with a docroot out of <code>/var/www/test</code>, setup an
<code>index.php</code> file for Apache, and setup a Firewall rule to allow access through
to port 80 on our VM.</p>

<h2>Setting up the Puppet provisioner for Vagrant</h2>

<p>We&rsquo;re going to have to modify our <code>Vagrantfile</code> one more time to tell Vagrant
to use the <a href="http://docs.vagrantup.com/v1/docs/provisioners/puppet.html">Puppet provisioner</a> to execute our Puppet code and setup our VM:</p>

<figure class='code'><figcaption><span>Vagrantfile</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Vagrant</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span>       <span class="o">=</span> <span class="s2">&quot;centos-6.3-x86_64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span>   <span class="o">=</span> <span class="s2">&quot;https://saleseng.s3.amazonaws.com/boxfiles/CentOS-6.3-x86_64-minimal.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;development.puppetlabs.vm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="s2">&quot;192.168.33.10&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">forward_port</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8084</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:shell</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos_6_x.sh&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Puppet Shared Folder</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span> <span class="s2">&quot;puppet_mount&quot;</span><span class="p">,</span> <span class="s2">&quot;/puppet&quot;</span><span class="p">,</span> <span class="s2">&quot;puppet&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Puppet Provisioner setup</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span> <span class="k">do</span> <span class="o">|</span><span class="n">puppet</span><span class="o">|</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">manifests_path</span> <span class="o">=</span> <span class="s2">&quot;puppet/manifests&quot;</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">module_path</span>    <span class="o">=</span> <span class="s2">&quot;puppet/modules&quot;</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">manifest_file</span>  <span class="o">=</span> <span class="s2">&quot;site.pp&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the block for the Puppet provisioner that sets up the manifest path (i.e. where
to find <code>site.pp</code>), the module path (i.e. where to find our Puppet modules),
and the name of our manifest file (i.e. <code>site.pp</code>). Again, <a href="http://docs.vagrantup.com/v1/docs/provisioners/puppet.html">this is all documented</a>
on the <a href="http://www.vagrantup.com">Vagrant</a> documentation page should you need to use it for
reference.</p>

<p>This bumps the number of provisioners in our <code>Vagrantfile</code> to two, but which
one goes first? Vagrant will iterate through the <code>Vagrantfile</code> procedurally, so
the Shell provisioner will always get checked first and then the Puppet
provisioner will get checked second.  This allows us to be certain that Puppet
will always be installed before attempting to use the Puppet provisioner. You
could continue to add as many provisioning blocks as you like &ndash; Vagrant will
iterate through them procedurally as it encounters them.</p>

<h2>Give the entire workflow a try</h2>

<p>Now that we have our Vagrantfile finalized, our Puppet directory structure
setup, our Puppet modules installed, and our <code>site.pp</code> file set to classify our
new VM, let&rsquo;s actually let Vagrant do what it does best and setup our VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant up</span></code></pre></td></tr></table></div></figure>


<p>You should see Vagrant use the Shell provisioner to install Puppet, hand off to
the Puppet provisioner, and then use Puppet to setup a LAMP stack on our VM.
After everything completes, try visiting <a href="http://localhost:8084">http://localhost:8084</a>
in your web browser and see if you get a shiny &ldquo;Hello World&rdquo; staring back at
you.  If you do &ndash; Awesome!  If you don&rsquo;t, check the error messages to determine
if there are typos in the Puppet code or if something went wrong in the <code>Vagrantfile</code>.</p>

<h2>Where do you take it from here?</h2>

<p>The first thing to do is to take the Vagrantfile you&rsquo;ve created and put it
under revision control so you can track the changes you make. I personally have
a couple of workflows up on <a href="http://github.com">Github</a> that I use as templates when I&rsquo;m
testing out something new. You&rsquo;ll probably find that your Vagrantfile won&rsquo;t
change much &ndash; just the modules you use for testing.</p>

<p>Now that you understand the pattern, you can expand it to fit your workflow.
Single-vm projects are great when you&rsquo;re testing a specific component, but
the next logical step is to test out multi-tiered components/applications.  In these instances,
<a href="http://docs.vagrantup.com/v1/docs/multivm.html">Vagrant has the ability to spin up multiple VMs from a single Vagrantfile</a>.
That workflow saves a TON of time and lets you create your own private network
of VMs for the purpose of simulating changes.  That&rsquo;s a post for another time,
though&hellip;</p>

<h2>Get involved</h2>

<p>Stay tuned to the <a href="http://www.vagrantup.com">Vagrant website</a> for updates on the VMware
provisioner.  Stability with Virtualbox has notoriously been an issue, but, as
of this posting, things have been relatively rock-solid for me (using
Virtualbox version 4.1.23 on OS X).</p>

<p>If you want to keep up-to-date on all things Vagrant, follow <a href="http://twitter.com/mitchellh">Mitchell</a> on
Twitter, check out <code>#vagrant</code> on Freenode, join <a href="http://groups.google.com/group/vagrant-up">the Vagrant list</a>, and
check out Google for what other folks have done!</p>

<p>A GIANT thank you to <a href="http://twitter.com/mitchellh">Mitchell Hashimoto</a> for all the work he&rsquo;s done on
Vagrant &ndash; I can&rsquo;t count the number of hours it&rsquo;s saved me personally (let ALONE
everyone at <a href="http://www.puppetlabs.com">Puppet Labs</a>!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Veewee to Build OS X VMs]]></title>
    <link href="http://garylarizza.com/blog/2013/01/20/using-veewee-to-build-os-x-vms/"/>
    <updated>2013-01-20T19:36:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/01/20/using-veewee-to-build-os-x-vms</id>
    <content type="html"><![CDATA[<p>I hate <a href="http://github.com/timsutton">Tim Sutton</a> in the same way I hate <a href="http://ihatestevensinger.com/">Steven Singer</a>. I hate Tim
because he actually IMPLEMENTS some of the things on my list of &lsquo;shit to tinker
with when you get some free time&rsquo; instead of just TALKING about them. He and
<a href="https://twitter.com/bruienne">Pepijn Bruienne</a> have been working on some code for <a href="http://github.com/jedi4ever/veewee">Veewee</a> that
will allow you to automate the creation of OS X VMs in VMware Fusion. For those
who are interested, you can <a href="https://github.com/jedi4ever/veewee/issues/481">check out the pull request containing this code</a>
and comment/help them out. For everyone else, read on and entertain the idea&hellip;</p>

<h2>Prerequisites:</h2>

<ol>
<li>OS X</li>
<li>VMware Fusion</li>
<li>Git</li>
<li>Ruby 1.9.3 and rbenv</li>
<li>Mountain Lion (10.8) installer application</li>
</ol>


<h4>OS X</h4>

<p>This walkthrough assumes that you&rsquo;re running OS X on your development
workstation. That&rsquo;s what I use, and it&rsquo;s the workflow I know.</p>

<h4>VMware Fusion</h4>

<p>If you&rsquo;ve used <a href="http://github.com/jedi4ever/veewee">Veewee</a> before, odds are good that you MIGHT have used
it to build baseboxes for <a href="http://www.vagrantup.com/">Vagrant</a> and/or Virtualbox. Veewee
+ Vagrant is a post for ANOTHER time, but in short it&rsquo;s an awesome workflow for
testing automation like <a href="http://www.puppetlabs.com">Puppet</a> on Linux or
Windows. When I originally tried using Veewee to build OS X VMs, I had
absentmindedly tried to do this using Virtualbox&hellip;which isn&rsquo;t supported. As
such, VMware Fusion is the only virtualization platform (as of this posting
date) that is supported with this method. I&rsquo;m using VMware Fusion 5 pro, but
YMMV.</p>

<h4>Git</h4>

<p>Because the code that supports OS X only exists in Tim&rsquo;s fork of Veewee (as of
this posting date), we&rsquo;re going to have to install/use Veewee from source. That
introduces a bit more complexity, but hold my hand &ndash; we&rsquo;ll get through this
together. Git comes with the XCode Command Line Tools or can be <a href="http://git-scm.com/download/mac">installed with native packages</a>.</p>

<h4>Ruby 1.9.3 and rbenv</h4>

<p>Veewee uses the <code>gssapi</code> gem which requires Ruby 1.9.1 or higher. The problem,
though, is that the version of Ruby that comes with OS X is 1.8.7. There are
typically two camps when it comes to getting a development version of Ruby on
OS X: <a href="http://octopress.org/docs/setup/rbenv/">rbenv</a> or <a href="http://octopress.org/docs/setup/rvm/">RVM</a>. I recommend <a href="http://octopress.org/docs/setup/rbenv/">rbenv</a> because it
doesn&rsquo;t screw with your path and it&rsquo;s a bit more lightweight, so that&rsquo;s the
path I&rsquo;m going to take in this writeup. <a href="http://octopress.org/docs/setup/rbenv/">Octopress has instructions</a>
for getting <a href="http://octopress.org/docs/setup/rbenv/">rbenv</a> on your machine &ndash; so make sure to check those out
for this step. The instructions describe using rbenv to install Ruby version
1.9.3 &ndash; and that&rsquo;s the version we&rsquo;ll use here.</p>

<h4>Mountain Lion installer application</h4>

<p>This workflow supports creating a VM for Mountain Lion (10.8), but it SHOULD
also work for Lion (10.7). The final piece of our whole puzzle is the installer
application from the App Store. Get that application somehow and drop it in the
<code>/Applications</code> directory (that&rsquo;s where the App store puts it by default). We
REALLY only need a single disk image from the installer, and we&rsquo;ll get that
next.</p>

<h2>Some assembly required&hellip;</h2>

<p>Now that you have all the pieces, let&rsquo;s tie this FrankenVM up with some code
and ugly bash, shall we? Splendid.</p>

<h4>Copy out the installation disk image</h4>

<p>In the last step, we downloaded the <code>Install OS X Mountain Lion.app</code> file from
the App Store to <code>/Applications</code>, but we&rsquo;ll want to extract the main
installation disk image somewhere where we can work with it. I&rsquo;m going to make
a copy on the Desktop so we don&rsquo;t screw up the main installer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cp /Applications/Install<span class="se">\ </span>OS<span class="se">\ </span>X<span class="se">\ </span>Mountain<span class="se">\ </span>Lion.app/Contents/SharedSupport/InstallESD.dmg ~/Desktop
</span></code></pre></td></tr></table></div></figure>


<p>Beautiful. This should take a minute as it&rsquo;s a sizeable file, but in the end
you&rsquo;ll have the installation disk image on your Desktop. For now this is fine,
but we&rsquo;ll be revisiting it later&hellip;</p>

<h4>Clone Tim&rsquo;s fork of Veewee</h4>

<p>As if the writing of this blog post, the code you need is ONLY in Tim&rsquo;s fork,
so let&rsquo;s pull that down to somewhere where we can work with it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">## I prefer to work with code out of a &#39;src&#39; directory in my home directory</span>
</span><span class='line'><span class="nv">$ </span>mkdir ~/src
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>git clone http://github.com/timsutton/veewee
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/veewee
</span></code></pre></td></tr></table></div></figure>


<h4>Install Gems for veewee</h4>

<p>We now have the Veewee source in <code>~/src/veewee</code>, but we need to ensure all the
Rubygems necessary to make Veewee work have been installed. We&rsquo;re going to do
this with <a href="http://gembundler.com/">Bundler</a>. Let&rsquo;s switch to Ruby 1.9.3 and get Bundler
installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/veewee
</span><span class='line'><span class="nv">$ </span>rbenv <span class="nb">local </span>1.9.3
</span><span class='line'><span class="nv">$ </span>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<p>Next, let&rsquo;s use <a href="http://gembundler.com/">bundler</a> to install the rest of the gems we need to
use Veewee:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle install
</span></code></pre></td></tr></table></div></figure>


<p>Once that command completes, Bundler will have installed all the necessary gems
for Veewee and we can move on.</p>

<h4>Define your new VM</h4>

<p>Veewee has templates for most operatingsystems that can be used to spin up
a &lsquo;vanilla&rsquo; VM. Tim&rsquo;s code provides a template called &lsquo;OSX-10.8.2&rsquo; containing
the necessary scaffolding for building a vanilla 10.8.2 VM. Let&rsquo;s create a new
VM project based on this template called &lsquo;osx-vm&rsquo; with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/veewee
</span><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>veewee fusion define <span class="s1">&#39;osx-vm&#39;</span> <span class="s1">&#39;OSX-10.8.2&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will create <code>definitions/osx-vm</code> inside the Veewee directory with the
template code from <code>templates/OSX-10.8.2</code>. We&rsquo;re almost ready to let Veewee
create our VM, but we need an installation &lsquo;ISO&rsquo; first&hellip;</p>

<h4>Prepare an &lsquo;ISO&rsquo; for OS X</h4>

<p>The <code>prepare_veewee_iso.sh</code> script in Veewee&rsquo;s <code>templates/OSX-10.8.2/prepare_veewee_iso</code>
directory provides awesome detail as to why we can&rsquo;t use the vanilla InstallESD.dmg
file to install 10.8 in our new VM. Feel free to open that file and read
through the detail, or <a href="https://github.com/timsutton/veewee/blob/feature/osx-guest/templates/OSX-10.8.2/prepare_veewee_iso/prepare_veewee_iso.sh">check out the details online</a> for more
information. Let&rsquo;s use that script and prepare an installation &lsquo;ISO&rsquo; for our
new VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/veewee
</span><span class='line'><span class="nv">$ </span>mkdir iso
</span><span class='line'><span class="nv">$ </span>sudo templates/OSX-10.8.2/prepare_veewee_iso/prepare_veewee_iso.sh ~/Desktop/InstallESD.dmg iso/
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll need to be root to do this, but the script should handle everything
necessary to prepare the ISO and drop it into the <code>iso</code> directory we created.</p>

<h4>Define any additional post-installation tasks</h4>

<p>Veewee supports post-installation tasks through the <code>postinstall.sh</code> script in
the <code>definitions/osx-vm</code> folder. By default, this script will install
VMware tools, setup Vagrant keys, download the XCode Command Line Tools, and
install Puppet via Rubygems. Because this is all outlined in the <code>postinstall.sh</code>
script, you&rsquo;re free to modify this code or add your own steps. Here&rsquo;s the
current <code>postinstall.sh</code> script as of this posting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>date &gt; /etc/vagrant_box_build_time
</span><span class='line'><span class="nv">OSX_VERS</span><span class="o">=</span><span class="k">$(</span>sw_vers -productVersion | awk -F <span class="s2">&quot;.&quot;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span><span class='line'><span class="c"># Install VMware tools if we were built with VMware</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -e .vmfusion_version <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">TMPMOUNT</span><span class="o">=</span><span class="sb">`</span>/usr/bin/mktemp -d /tmp/vmware-tools.XXXX<span class="sb">`</span>
</span><span class='line'>  hdiutil attach darwin.iso -mountpoint <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'>  installer -pkg <span class="s2">&quot;$TMPMOUNT/Install VMware Tools.app/Contents/Resources/VMware Tools.pkg&quot;</span> -target /
</span><span class='line'>  <span class="c"># This usually fails</span>
</span><span class='line'>  hdiutil detach <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'>  rm -rf <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Installing vagrant keys</span>
</span><span class='line'>mkdir /Users/vagrant/.ssh
</span><span class='line'>chmod 700 /Users/vagrant/.ssh
</span><span class='line'>curl -k <span class="s1">&#39;https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub&#39;</span> &gt; /Users/vagrant/.ssh/authorized_keys
</span><span class='line'>chmod 600 /Users/vagrant/.ssh/authorized_keys
</span><span class='line'>chown -R vagrant /Users/vagrant/.ssh
</span><span class='line'>
</span><span class='line'><span class="c"># Get Xcode CLI tools for Lion (at least to build Chef)</span>
</span><span class='line'><span class="c"># https://devimages.apple.com.edgekey.net/downloads/xcode/simulators/index-3905972D-B609-49CE-8D06-51ADC78E07BC.dvtdownloadableindex</span>
</span><span class='line'><span class="nv">TOOLS</span><span class="o">=</span>clitools.dmg
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OSX_VERS&quot;</span> -eq 7 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">DMGURL</span><span class="o">=</span>http://devimages.apple.com/downloads/xcode/command_line_tools_for_xcode_os_x_lion_november_2012.dmg
</span><span class='line'><span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OSX_VERS&quot;</span> -eq 8 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">DMGURL</span><span class="o">=</span>http://devimages.apple.com/downloads/xcode/command_line_tools_for_xcode_os_x_mountain_lion_november_2012.dmg
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>curl <span class="s2">&quot;$DMGURL&quot;</span> -o <span class="s2">&quot;$TOOLS&quot;</span>
</span><span class='line'><span class="nv">TMPMOUNT</span><span class="o">=</span><span class="sb">`</span>/usr/bin/mktemp -d /tmp/clitools.XXXX<span class="sb">`</span>
</span><span class='line'>hdiutil attach <span class="s2">&quot;$TOOLS&quot;</span> -mountpoint <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'>installer -pkg <span class="s2">&quot;$(find $TMPMOUNT -name &#39;*.mpkg&#39;)&quot;</span> -target /
</span><span class='line'>hdiutil detach <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'>rm -rf <span class="s2">&quot;$TMPMOUNT&quot;</span>
</span><span class='line'>rm <span class="s2">&quot;$TOOLS&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get gems - we should really be installing rvm instead, since we can&#39;t even compile Chef or have a Ruby dev environment..</span>
</span><span class='line'>gem update --system
</span><span class='line'>gem install puppet --no-ri --no-rdoc
</span><span class='line'><span class="c"># gem install chef --no-ri --no-rdoc</span>
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Build the VM</h4>

<p>Everything we&rsquo;ve done has all been for this step. With the ISO built, the VM
defined, and all necessary Gems installed, we can finally BUILD the vm with the
following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~/src/veewee
</span><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>veewee fusion build osx-vm
</span></code></pre></td></tr></table></div></figure>


<p>This process takes the longest &ndash; you should see VMware Fusion fire up, a new VM
get created, and follow the process of OS X being installed into the VM. When
it completes, your VM will have been created. Just like most Vagrant workflows,
the resultant vm will have a <code>vagrant</code> user whose password is also <code>vagrant</code>.
Feel free to login and ensure that everything looks good.</p>

<h2>Now what?</h2>

<p>At this point, I would snapshot the VM before making any changes. Because
Virtualbox isn&rsquo;t yet supported with Veewee for building OS X VMs (and Vagrant
doesn&rsquo;t currently include VMware Fusion support for its workflow), this VM
isn&rsquo;t going to fit into a Vagrant workflow&hellip;yet. What you have, though, is
a vanilla OS X VM that can be built on-demand (or reverted to a snapshot) to
test whatever configuration changes you need to make (all 11.36 Gb worth of
it).</p>

<p>As you would expect, this is all pretty experimental for the moment. If you&rsquo;re
a Ruby developer who needs an OS X VM for testing purposes but have never
managed OS X and it&rsquo;s &lsquo;quirky&rsquo; imaging process, this workflow is for you. For
everyone else, it&rsquo;s probably an academic proof-of-concept that&rsquo;s more
interesting from the point of view of &ldquo;Look what you can do&rdquo; versus &ldquo;Let&rsquo;s make
this my primary testing workflow.&rdquo;</p>

<p>Credit goes to <a href="https://twitter.com/patrickdebois">Patrick Dubois</a> for creating and managing the Veewee
project, and to <a href="http://github.com/timsutton">Tim Sutton</a> and <a href="https://twitter.com/bruienne">Pepijn Bruienne</a> &ndash; like I mentioned
before &ndash; for the work they&rsquo;ve done on this. You can speak with them directly in
the ##osx-server chatroom on Freenode, or by checking them out on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Managing a Blog Is Insane; Octopress FTW!]]></title>
    <link href="http://garylarizza.com/blog/2013/01/17/managing-a-blog-is-insane/"/>
    <updated>2013-01-17T00:00:00-08:00</updated>
    <id>http://garylarizza.com/blog/2013/01/17/managing-a-blog-is-insane</id>
    <content type="html"><![CDATA[<p>Masochists are everywhere. Managing a system by hand appeals to a certain subset
of the population, but I joined <a href="http://www.puppetlabs.com">Puppet Labs</a> because
I was a fan of automating the shit out of menial tasks. I have no burning desire
to handcraft an artisanal blog made out of organic bits. I tried web development
at one point in my life and learned an important lesson:</p>

<p>I am not a web developer</p>

<p>What I DO want is to have a platform to share information and code I&rsquo;ve
accumulated along the way that:</p>

<ol>
<li>Doesn&rsquo;t look like hell</li>
<li>Doesn&rsquo;t take forever to update</li>
<li>Doesn&rsquo;t require me being online to write a post</li>
<li>Allows me to post code that&rsquo;s syntactically highlighted and easy to copy/paste</li>
<li>Accepts <a href="http://daringfireball.net/projects/markdown/">Markdown</a></li>
<li>Fits into my DVCS workflow</li>
<li>Is free &ndash; because screw paying for A BLOG</li>
</ol>


<h2>Seriously, is this too much to ask?</h2>

<p>Originally I waded the waters of <a href="http://glarizza.posterous.com">Posterous</a> but
found that not only did it have awkward <a href="http://daringfireball.net/projects/markdown/">Markdown</a> syntax, but staging of
blog posts was cumbersome.  Also, while there WAS <a href="http://gist.github.com">gist</a> integration,
the code you posted looked like crap. That sucks because most of what I post has
code attached.</p>

<p>Others have sold their soul for Wordpress/Drupal/Bumblefuck CMS (whether hosted
or unhosted platforms), but it still felt like too much process and not enough
action for my taste.</p>

<h2>Github to the rescue&hellip;again</h2>

<p>The answer, it turns out, was right in front of my face the whole time.
<a href="http://pages.github.com/">Github Pages</a> has always been available to host web content or <a href="https://github.com/mojombo/jekyll">Jekyll
sites</a> &ndash; I&rsquo;m just late to the damn party.</p>

<p><a href="http://glarizza.github.com/images/blog_blog/left.png"><img class="left" src="http://garylarizza.com/images/blog_blog/left.png" width="300" height="300"></a></p>

<p>Hosting static web content was out; like I said before, I don&rsquo;t really want to
&lsquo;manage&rsquo; this thing. Jekyll, however, intrigued me. Jekyll is essentially
a static site generator that allows you to throw Markdown at it and get static
content in the end. There are even <a href="http://jekyllbootstrap.com/">Jekyll
bootstrap</a> projects aimed at making it (even more)
stupid simple. I tried plain vanilla Jekyll and realized that I didn&rsquo;t really
want/need that level of control (again, I&rsquo;m not into web development).
I pulled down Jekyll Bootstrap, but this time it felt a little TOO
&lsquo;template-y&rsquo;. Next, I pulled down an awesome Jekyll template called <a href="https://github.com/holman/left">Left by
Zach Holman</a> (seen, conveniently, in the
picture on the left).  I REALLY liked the look of Left, but was stuck with
Jekyll&rsquo;s code formatting that was&hellip;less than ideal. Jekyll is pluggable (and
people have made plugins to fix this sort of thing), but I still
didn&rsquo;t have enough experience at that time
to be able to deal with the plugins in an intelligent manner.</p>

<h2>Octopress = Jekyll + Plugins + &lt;3</h2>

<p>During my plugin party, I discovered <a href="http://octopress.org">Octopress</a>, which
basically had EVERYTHING I wanted wrapped with a templated bow. I loved the way
it rendered code, it supported things like <a href="http://github.github.com/github-flavored-markdown/)">fenced code blocks</a> , and it
seemed REALLY simple to update and deploy code.  The thing I DIDN&rsquo;T like was
that NEARLY EVERY DAMN OCTOPRESS SITE LOOKS EXACTLY THE SAME! I know I said
that I&rsquo;m not a web developer and didn&rsquo;t want to tweak styles a great bit, but
damn &ndash; couldn&rsquo;t I get a BIT of differentiation? That can be done, but you&rsquo;re
still editing styles (so some CSS is necessary &ndash; but not much). After
evaluating all three options, I opted for Octopress.</p>

<h2>Documentation? Who knew!?</h2>

<p>Octopress.org has <a href="http://octopress.org/docs/setup/">GREAT documentation</a> for
getting setup with an Octopress blog. They even have documentation for setting
up Ruby 1.9.3 on rbenv or RVM (I recommend rbenv for reasons beyond this blog),
so make sure to check it out if you&rsquo;re unfamiliar with either. To not reinvent
that documented wheel, make sure to check out that site to get Octopress setup
(I recommend cloning all repositories to somewhere in your home directory
like ~/src or ~/repos, but other than that their docs are solid). Normally
I post the dirty technical details, but the point of this post is to outline
WHY I made the decision I did and WHY it works for ME.</p>

<h2>Pretty code is pretty</h2>

<p>I&rsquo;m not gonna lie &ndash; syntactical highlighting with the <a href="http://ethanschoonover.com/solarized">Solarized</a>
theme was pretty sexy. Let&rsquo;s look at some Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value_type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:boolean</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/(true|false)/i</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Valid boolean values are &#39;true&#39; or &#39;false&#39;, you specified &#39;</span><span class="si">#{</span><span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
</span><span class='line'>      <span class="n">plist</span> <span class="o">=</span> <span class="n">read_plist_file</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">plist</span> <span class="o">=</span> <span class="ss">OSX</span><span class="p">:</span><span class="ss">:NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value_type</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:integer</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:boolean</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/false/i</span>
</span><span class='line'>        <span class="n">plist_value</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">plist_value</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:hash</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plist</span><span class="o">[</span><span class="n">resource</span><span class="o">[</span><span class="ss">:key</span><span class="o">]]</span> <span class="o">=</span> <span class="n">plist_value</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">write_plist_file</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about some Puppet code?</p>

<figure class='code'><figcaption><span>Plist Management </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span> <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>    <span class="p">=&gt;</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>  <span class="p">=&gt;</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="ss">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;hashtest&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;hashtest&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;key&#39;</span> <span class="p">=&gt;</span> <span class="s1">&#39;value&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;hash&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doesn&rsquo;t that look awesome? What if you have a <a href="http://gist.github.com">gist</a>? You can embed those too
(and they&rsquo;re also linkable):</p>

<div><script src='https://gist.github.com/3218523.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>Want to know how much code it took to do that?  About this much:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="o">%</span> <span class="n">gist</span> <span class="mi">3218523</span> <span class="o">%</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For a blog with a ton of code, something like this is pretty damn important.</p>

<h2>Markdown formatting</h2>

<p><a href="http://daringfireball.net/projects/markdown/">Markdown</a> is becoming more prolific as a lightweight way to format
text. If you&rsquo;ve used Github to comment on code, then you&rsquo;ve probably used
markdown syntax at some point in your life. You&rsquo;ll notice the recurring goal of
being quick and precise, and markdown really &lsquo;does it for me&rsquo;.</p>

<h2>Workflow++</h2>

<p>It&rsquo;s really liberating to write a blog post in (insert favorite text editor).
Travelling as often as I do, I&rsquo;m usually jotting down notes in vi because I&rsquo;m
in a plane or somewhere without internet access. Octopress not only lets you
write offline, but it will let you generate and preview your site locally
while being offline. That&rsquo;s totally handy.  My workflow typically looks like
this:</p>

<ul>
<li><strong>Generate a post</strong></li>
</ul>


<p>To start a new post, you can create a new file by hand, or use the
provided Rakefile to scaffold it out for you (NOTE: to see all commands
available to the Rakefile, you can run <code>rake -T</code>). Here&rsquo;s how to scaffold
with rake:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="s1">&#39;new_post[&quot;Title of my post&quot;]&#39;</span>
</span><span class='line'><span class="err">$</span> <span class="n">vi</span> <span class="n">source</span><span class="o">/</span><span class="n">_posts</span><span class="o">/</span><span class="mi">2013</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">17</span><span class="o">-</span><span class="n">title</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">post</span><span class="o">.</span><span class="n">markdown</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Edit the post file</strong></li>
<li><strong>Generate the site content</strong></li>
</ul>


<p>Remember that Octopress/Jekyll generates static content to be uploaded to
your host. With every change, you&rsquo;ll need to re-generate the content. Yeah,
that kinda sucks, but that action has been abstracted away in the Rakefile
with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="n">generate</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Display and view the site</strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="n">preview</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following command will serve up your page over Webrick in the terminal,
just navigate to <a href="http://localhost:4000">http://localhost:4000</a> in your browser to see a local copy of
how your site will look once deployed. Once you&rsquo;re done, just do a Control+c
from your terminal to cancel the process.</p>

<ul>
<li><strong>Edit/generate/preview until done</strong></li>
<li><strong>Commit your code and deploy</strong></li>
</ul>


<p>Because everything is a series of flat-files, you can use git to keep it all
under version control. Did you make a mistake? Revert to a previous commit.
Deploying to your blog is similarly easy, as you&rsquo;ll see in the next steps</p>

<h2>Be a unique snowflake</h2>

<p>I <a href="http://blog.bigdinosaur.org/changing-octopresss-header/">used this article</a> to help
change the color scheme of my blog, and <a href="https://github.com/imathis/octopress/wiki/Octopress-Sites">checked out a list of other Octopress sites</a>
to steal a couple of other tweaks. That&rsquo;s all I needed for customization, but
if you need more knobs they&rsquo;re there for you to twist.</p>

<h2>Hosted by your pals at Github</h2>

<p><a href="http://pages.github.com/">Github Pages</a> is a free service for any Github user (again free to join) and
is an EXCELLENT FIT for an Octopress blog. As you would expect, Octopress
has <a href="http://octopress.org/docs/deploying/github/">great documentation for enabling deployment to Github Pages</a>.
If you have your own custom domain, you can STILL use Github Pages
(hint, the instructions are on that page too).</p>

<h2>Fuck it. Ship it.</h2>

<p>The act of updating a blog has GOT to be frictionless. Is this simple enough
for you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep. That&rsquo;s all it takes to deploy code to your blog once you&rsquo;ve setup Github
Pages. Forget about logging in, wading through a GUI, cutting/pasting content,
FTPing things up to a host, and any of that crap. I&rsquo;ve done that. &lsquo;That&rsquo; sucks.</p>

<h2>Write your own damn blog</h2>

<p>You now have no excuse to NOT share all the cool things you&rsquo;re doing. Seriously,
if you can EDIT A TEXT FILE then you can &lsquo;maintain&rsquo; a blog.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JAMF NetSUS Appliance]]></title>
    <link href="http://garylarizza.com/blog/2012/02/06/jamf-netsus-appliance/"/>
    <updated>2012-02-06T11:22:00-08:00</updated>
    <id>http://garylarizza.com/blog/2012/02/06/jamf-netsus-appliance</id>
    <content type="html"><![CDATA[<h2>JAMF&rsquo;s NetSUS Appliance &ndash; Netboot in a Box</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">Today, JAMF released a new appliance VM</a> based on Ubuntu 10.04 LTS (Lucid) that, for once, provides an &lsquo;out of the box&rsquo; implementation of Netboot and Software Update Service WITHOUT requiring OS X hardware (based on <a href="http://github.com/wdas/reposado">Reposado</a>) and <a href="http://twitpic.com/8glygw">other open-source technologies.</a></p>

<p>For those people who are relatively new to Linux, I thought I&rsquo;d provide an easy walkthrough of how to get started using this VM on your Laptop.  I&rsquo;m going to demo this using VMware Fusion instead of VirtualBox mainly because I prefer how Fusion handles Networking.  I&rsquo;ve used many VMs, and Fusion always tends to be much more solid and stable for me.  If you don&rsquo;t have Fusion or don&rsquo;t WANT to use Fusion, feel free to use VirtualBox.</p>

<h2>Download and Convert the OVA File</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">The appliance can be downloaded directly from JAMF</a> and comes as a VirtualBox OVA file.  <a href="http://derflounder.wordpress.com/2012/02/06/converting-jamfs-netbootsus-appliance-to-vmware/">Rich Trouton has provided a great walkthrough</a> on converting the OVA file to a VMX file, so I&rsquo;ll link you to that post (since he did it so well).</p>

<h2>Start up the VM</h2>

<p>Once you have your VMX file, you can open it up with Fusion and import it into your Virtual Machine Library.  There is one change we&rsquo;ll want to make, so click on the VM and open its Settings panel (this is different from Fusion 3.0 and 4.0 &ndash; I&rsquo;ll be describing the 4.0 method).  In the Settings panel, you&rsquo;ll want to select the Network Adapter icon and make sure the radio button next to &ldquo;Share the Mac&rsquo;s network connection (NAT)&rdquo; is selected.  This will create a local IP address so we can contact it directly from our Laptop.  Once you&rsquo;ve done that, start the VM and get to the login screen (you&rsquo;ll need to click the Ok button through the message about logging into the NetSUS instance).  Feel free to login with the username &lsquo;shelluser&rsquo; and the password &lsquo;shelluser&rsquo;.  You should see a Message of the Day splash with one of the sections being &ldquo;IP address for eth0:&rdquo;.  Note the IP address, we&rsquo;ll need it in the next section (if you don&rsquo;t see this, just run <code>ifconfig</code> from the command line and look for the IP address for the eth0 adapter &ndash; it should be in the format of 192.168.x.x).</p>

<h2>Prepare to Break Free!</h2>

<p>It really sucks to work with VMs from WITHIN the VM window for various reasons (lack of Copy/Paste, loss of mouse, etcâ€¦), so we&rsquo;re going to setup a host entry on your local laptop so we can SSH into the VM as we need.  I&rsquo;m going to give my VM a hostname of &lsquo;netsus.puppetlabs.vm&rsquo; but you can name it whatever you want.  Let&rsquo;s first edit the /etc/hosts file on your laptop (NOT within the VM, this is ON your laptop) by running the following from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/hosts</span></code></pre></td></tr></table></div></figure>


<p>Feel free to use pico/nano to edit /etc/hosts in case you don&rsquo;t have any experience with vim.  We want to add the following line in the /etc/hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.217.154 netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE</strong> SUBSTITUTE 192.168.217.154 WITH THE IP ADDRESS YOU GOT FROM THE PREVIOUS STEP!  That&rsquo;s the IP address that was assigned on MY laptop, and it will definitely be different from the IP address you got on YOUR computer.  Also, you don&rsquo;t HAVE to use &lsquo;netsus.puppetlabs.vm&rsquo; &ndash; you can assign it any name you want.  Save and close /etc/hosts and then let&rsquo;s test connectivity from the command line by doing a ping:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ping 192.168.217.154</span></code></pre></td></tr></table></div></figure>


<p>As long as we have connection, we&rsquo;re fine (remember, substitute your IP Address for mine).  If you DON&rsquo;T have connectivity, make sure your VM is running and review your /etc/hosts file to make sure the changes were saved (also, check the IP address on your VM again).</p>

<h2>Snapshot Time</h2>

<p>The beauty of Fusion is that you can take snapshots and revert to them should you mess things up.  Let&rsquo;s take a snapshot now in case we screw things up in the following steps.  I&rsquo;m using VMware Fusion 4.0, so I take a snapshot by clicking on the VM window, clicking on the Virtual Machine menu at the top, and then down to Snapshots.  From there, you can click the &lsquo;Take Snapshot&rsquo; button and let it do its thing.  When it&rsquo;s done, hit the close button and return to the VM</p>

<h2>Enable SSH and Login</h2>

<p>By default, the VM doesn&rsquo;t have the SSHD process running, so we can&rsquo;t yet SSH in from our laptop.  Enable this by doing the following from within the VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install openssh-server</span></code></pre></td></tr></table></div></figure>


<p>Hit &ldquo;Y&rdquo; when it asks if it should download and install.  When it completes, switch back to your LAPTOP (i.e. NOT inside the VM), open up Terminal, and do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh shelluser@netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Type yes to add the SSH key to your known_hosts file and use the password &lsquo;shelluser&rsquo; to login.  Tada! Now you can work directly from Terminal and enable copy/pasting directly from your Terminal window.  You can always type <code>exit</code> to close the ssh connection when you&rsquo;re done.</p>

<h2>Install Puppet</h2>

<p>So, it wouldn&rsquo;t be one of my write-ups if I DIDN&rsquo;T get Puppet installed.  Actually, if you&rsquo;ve only managed Macs, then you might not have seen the benefit of Puppet before.  Now that we&rsquo;re on Linux, you&rsquo;ll definitely see the benefit of Puppet (especially if you&rsquo;re not familiar with the service/package manipulation commands).  Puppet can help abstract that for you, so we&rsquo;re going to enable it.</p>

<p>The version of Puppet that&rsquo;s in the main package repository is quite old (0.25 as opposed to the current 2.7.10 version we support).  Let&rsquo;s add Puppet Labs&#8217; Apt Repository to the list of repositories queried so we can get a recent version of Puppet.  Do that by opening up the /etc/apt/sources.list file for editing with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/apt/sources.list</span></code></pre></td></tr></table></div></figure>


<p>If it prompts you for your password, go ahead and enter it.  Also, if you&rsquo;re not familiar with vi or vim, I&rsquo;ll try and help you with the basics.  Arrow down to the line JUST above the line that begins with &ldquo;deb <a href="http://">http://</a>&rdquo; and press the i button on your keyboard to insert the following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://apt.puppetlabs.com/ubuntu lucid main
</span><span class='line'>deb-src http://apt.puppetlabs.com/ubuntu lucid main</span></code></pre></td></tr></table></div></figure>


<p>When you&rsquo;re done, hit the escape key and press ZZ (hold shift and hit Z twice, you want two capital-Z&rsquo;s) to save and close the file.  This will add Puppet Labs&#8217; repository to the list of repos queried.</p>

<p>Next, we&rsquo;ll need to add Puppet Labs&#8217; GPG key to the system so we can validate the packages that are downloaded.  From the terminal, execute the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>The first time you run it, it will bother you about needing to create the keyserver file and won&rsquo;t run correctly.  Let&rsquo;s execute it correctly to receive the key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>Great, we should have the key, now we want to load it.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg -a --export 4BD6EC30 | sudo apt-key add -</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&rsquo;s update apt so that it knows about the repository.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get update</span></code></pre></td></tr></table></div></figure>


<p>When it finishes running, you can finally install Puppet with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install puppet</span></code></pre></td></tr></table></div></figure>


<p>Type &ldquo;Y&rdquo; when it asks you if it should download and install all the dependencies.  That&rsquo;s it!  Puppet should be installed!  Run the following to see what version we&rsquo;ve installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet --version</span></code></pre></td></tr></table></div></figure>


<p>As of this writing, 2.7.10 is the current version.  As long as you don&rsquo;t have version 0.25 you should be good!</p>

<h2>Snapshots away</h2>

<p>It would be wise to take another snapshot at this point.  Don&rsquo;t worry, I&rsquo;ll wait.</p>

<h2>Inspect the System</h2>

<p>Puppet lets us see what&rsquo;s been installed on the VM.  Take a look at all the packages on the system by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource package</span></code></pre></td></tr></table></div></figure>


<p>Type your password when prompted and Puppet will return you with a list of all packages on the system and the versions that are running.  Similarly, you can see what services are running with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource service</span></code></pre></td></tr></table></div></figure>


<p>Notice that sshd is running and other services like netatalk (that enables AFP on Linux) should also be running.  Sweet.  We&rsquo;ll come back to Puppet later.</p>

<h2>Login to the Web GUI</h2>

<p>If your VM is running, you should be able to open a web browser on your Laptop and navigate to the following address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Note the httpS as we&rsquo;ll need to use SSL to get into the Web GUI.  When it asks if you want to accept the self-signed cert, make sure to choose Yes.  You can login with the user &lsquo;webadmin&rsquo; and the password &lsquo;webadmin&rsquo;</p>

<p>Once you&rsquo;re logged in, <a href="https://s3.amazonaws.com/jamfsoftware-content/downloads/NetBootSUS+Appliance_v1.0.pdf">feel free to read through JAMF&rsquo;s instructions for enabling their services.</a>  They do a much better job than I about walking you through that.</p>

<h2>Access to the Raw Files</h2>

<p>Back in the Terminal window, you can access all the PHP/Shell magic that comprises the Web GUI in the /var/www/webadmin directory.  You can poke around through all the files (and use sudo to open some of the key bits) at your leisure.</p>

<p>Note that /etc/dhcpd.conf is the main configuration file for the DHCPD service and it&rsquo;s got some special bits to accommodate Apple Hardware.</p>

<p>Also, /var/appliance has some magic (and the /var/appliance/configurefornetboot script has some sed statements for fixing a stock dhcpd.conf file and enabling those Apple Hardware bits).</p>

<h2>More Later?</h2>

<p>That&rsquo;s it for now &ndash; I just wanted to get something online to show people how to setup and poke around in the VM.  Later I can show you how to manipulate and manage the VM with Puppet, which is pretty fun.  Your VM should get you started and let you play around locally, but if you want to test out Netboot and the like then you&rsquo;ll need an externally-accessible IP address (as apposed to the 192.168.x.x IP, which is only accessible from your Laptop).  You can change the settings in VMware Fusion to enable that (like we did in step 2).</p>

<p>Hope this helped you out!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Git for Mac Sysadmins]]></title>
    <link href="http://garylarizza.com/blog/2012/01/24/using-git-for-mac-sysadmins/"/>
    <updated>2012-01-24T15:25:00-08:00</updated>
    <id>http://garylarizza.com/blog/2012/01/24/using-git-for-mac-sysadmins</id>
    <content type="html"><![CDATA[<p>As a former Mac Sysadmin, I frequently felt like I had one toe in the world in which Linux Sysadmins frequently found themselves, but was surrounded by a culture of GUI-Clickery that either feared, scorned, or flat-out avoided tools that were command-line based (or, as many will point out, used the GUI (Graphic User Interface) tools because &lsquo;they worked&rsquo; and that was all they needed).  This sucked because Linux Sysadmins have some tools that, as a current colleague would say, &lsquo;are kind-of awesome.&rsquo;</p>

<p>One of those tools is Git, which is a Distributed Version Control System (or, DVCS).  Git, in a TOTAL nutshell, is a tool that allows you to create multiple &lsquo;what-if scenarios&rsquo; with very little cost and the ability to save yourself from&hellip;well, yourself.</p>

<h2>Yes &ndash; You&rsquo;re Going to Use the Command Line</h2>

<p>Like I mentioned before, the GUI is ingrained in the culture of the Mac.  It wasn&rsquo;t until OS X that Mac Sysadmins finally had a proper command-line (which I will refer to as the CLI, which is short for Command Line Interface.  If you&rsquo;re not familiar with that terminology, I&rsquo;m speaking about the interface you get when you run /Applications/Utilities/Terminal.app), so we&rsquo;re a bit &lsquo;new&rsquo; to the whole idea.  I can help you if you fear or avoid the CLI; there&rsquo;s always room for learning and I&rsquo;ll try to hold your hand as much as possible.  For those that downright refuse to use the CLI&hellip;well, I&rsquo;m sorry?</p>

<h2>What IS Git?</h2>

<p>Git is relatively new in the DVCS world (being initially released in 2005).  Developers have been using DVCS for MANY years with tools like CVS, Subversion, Git, Mercurial, and others.  For a team of developers who ALL need to make contributions to a SINGLE project or code base, it&rsquo;s vital that they have a way to modify a file without breaking something that someone else is doing.  That&rsquo;s what DVCS tools do &ndash; allow you to take something as large as a code base like OS X 10.7 (or something as small as a directory with a couple of files) and make changes without affecting everyone else who&rsquo;s working on the SAME code base (or files in the directory).</p>

<p>So why am I choosing to talk about Git instead of, say, Subversion?  That&rsquo;s easy: lightweight branching and merging.  Git allows you to easily create a &lsquo;topic branch&rsquo; (or, using the metaphor above, a &lsquo;what-if scenario&rsquo;), make changes, and see if your changes are favorable or if they downright stink. If your changes are desirable, you can then &lsquo;merge&rsquo; your topic branch back in with your master branch (or, the original state the files were in when you created the topic branch in the first place).  If the changes don&rsquo;t work well, you can just delete the topic branch and &lsquo;no-harm, no-foul&rsquo;; your original files remain unchanged and in the pristine condition that they existed when you first created the topic branch.  True, Subversion could do the same thing, but Git allows MANY people to do the same thing and then EASILY merge in EVERYONE&rsquo;S changes without having to fight Subversion (just trust me on this if you&rsquo;ve never used Subversion).</p>

<p>And why am I choosing to talk about Git instead of Mercurial?  Easy &ndash; Git is what I learned :)  As I understand it Mercurial functions similarly, and I truly don&rsquo;t have the experience with Mercurial to tell you the differences.  I&rsquo;m talking about Git because Git is what I use and Git is what my company uses.</p>

<h2>So what does this have to do with me as a Mac Sysadmin?</h2>

<p>Good question.  Mac Sysadmins are more frequently finding themselves having to use the CLI to tune their clients and servers.  Also, many Mac Sysadmins are finding that certain CLI tools are working better for their teams (in terms of simplicity, responsibility, and visibility).  As they dip their toes into this CLI world, they&rsquo;re finding that they want the same features they had in the GUI: the ability to do a &lsquo;save-as&rsquo;, to create &lsquo;versions&rsquo;, and to have the ability to have a rollback function similar to Time Machine.  Git gives you this through the CLI (or, yes, even through the GUI as I will mention later in the article).</p>

<p>If you&rsquo;re ready to take that step then follow me&hellip;</p>

<h2>A note on Git and Github</h2>

<p>You might have heard of <a href="http://www.github.com">Github</a>.  Github is a free (they have a free tier and plenty of subscription tiers of service) service that allows you to &lsquo;push&rsquo; your git repositories up to them for storage in &lsquo;the cloud&rsquo;.  Github is basically centralized-storage for your git repositories and is NOT NECESSARY for you to use git as a tool.  In reality, you CAN use Github or setup something like Gitolite on a local server in your environment to get most of the benefits of Github without having to push your repositories to Github&rsquo;s servers.</p>

<p>The bottom line: Github and git (the tool) are two different things.  Github didn&rsquo;t create git, and git doesn&rsquo;t need Github to work properly.  Keep that in mind as you read through.</p>

<h2>Installing Git</h2>

<p>Git can be installed in a variety of ways.  First and foremost, you can download the latest package from <a href="http://code.google.com/p/git-osx-installer/">Git&rsquo;s Googlecode Page</a>.  You can also choose to install git through Macports or Homebrew as long as you have them installed (both of which require the Developer Tools&hellip;but so does The Luggage, the tool we&rsquo;ll be using later).  Simply download the package from <a href="http://code.google.com/p/git-osx-installer/">Git&rsquo;s Googlecode Page</a>, install it, and you should be good to go!</p>

<p>If you&rsquo;re using Macports, make sure the Developer Tools are installed, Macports is installed, and then do the following from the command line (<strong>PLEASE NOTE: The dollar sign is a prompt &ndash; you SHOULDN&rsquo;T type it.  Lines BEGINNING with a dollar sign, or a prompt, should be typed by you.  Lines that DON&rsquo;T begin with a prompt represent the output you receive from typing the command.  If you don&rsquo;t see a line that DOESN&rsquo;T begin with a prompt, then I&rsquo;m not listing the output.  Got it?  Good!</strong>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo port install git-core</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re using Homebrew, make sure the Developer Tools are installed, Homebrew is installed, and then do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo brew install git</span></code></pre></td></tr></table></div></figure>


<p>To check to see where and what version of git is installed, execute the following commands :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ which git
</span><span class='line'>$ git --version</span></code></pre></td></tr></table></div></figure>


<p>You should receive the path to where git is installed after you run the first command, and you should receive the version of git that&rsquo;s currently installed on your system.  Any version of Git greater-than or equal to 1.7 is probably ideal, though most of the commands we&rsquo;ll be using will probably work just fine with previous versions.</p>

<h2>Your first Git repo</h2>

<p>I find it&rsquo;s easier to understand Git if I describe an actual scenario instead of talking in terms of &lsquo;git can do&hellip;&rsquo;.  I&rsquo;m going to talk about using git with <a href="http://github.com/unixorn/luggage">The Luggage</a>.  <a href="http://glarizza.posterous.com/an-intro-to-using-the-luggage-for-packaging">I&rsquo;ve written about The Luggage in several articles on this site</a>, so feel free to familiarize yourself with it if you haven&rsquo;t used the tool before.  As a quick review, The Luggage is a tool that lets you create plain text Makefiles that can be used to build packages to install files, deploy scripts, and basically distribute &lsquo;things&rsquo; to the users in your organization.  Auditing HOW a package is made can be incredibly difficult for a team of sysadmins, but The Luggage helps you with this by using plain text Makefiles.  Git will give you the ability to track WHO made changes, WHEN they were made, and ROLLBACK the changes if you notice something undesirable happening.  Git and The Luggage are a perfect combo if you&rsquo;re a sysadmin.</p>

<p>Incidentally, The Luggage exists as a Github repository, so we have to CLONE it (or download it) from Github first before we can start playing with it.  I recommend creating a directory in your home directory (/Users/-username-) and cloning your repositories there &ndash; that way you retain ownership of the files and can work on them at will.  I put all my git repositories in ~/src, but if you&rsquo;re using something like Mobile Home Directories or even Network Home Directories, then you&rsquo;ll want to make sure that you&rsquo;re not syncing these directories back to some central location and burning up your quota in some fashion.  Let&rsquo;s create our repositories directory and clone The Luggage source code with these steps:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/src
</span><span class='line'>$ cd ~/src
</span><span class='line'>$ git clone git://github.com/unixorn/luggage.git</span></code></pre></td></tr></table></div></figure>


<p>Doing this will create the ~/src directory where we&rsquo;re putting all our repositories and download The Luggage source code to ~/src/luggage.  As you might be able to infer, git clone will clone an existing git repository from its location on another server (we call that the remote location, or just remote for short) down to a local directory.  This is usually how many sysadmins first encounter git &ndash; by needing to download something from Github or a remote server.  Let&rsquo;s look and see what git knows about this repo by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git remote -v
</span><span class='line'>origin  git://github.com/unixorn/luggage.git (fetch)
</span><span class='line'>origin  git://github.com/unixorn/luggage.git (push)</span></code></pre></td></tr></table></div></figure>


<p>This command will list all the remote repositories that we&rsquo;re tracking.  By default, you will get a remote by the name of &lsquo;origin&rsquo; that lists the location where you originally cloned the repository (in our case, this is Github).</p>

<p>Why is it listed twice?  Well, with git, you can pull down, or fetch, changes from a remote repository as well as push up changes from your LOCAL repository to the remote repository.  Frequently these paths will be the same, but in our case these links are to the READ-ONLY version of this repository, so trying to push changes will always fail because we don&rsquo;t have access.  We&rsquo;ll talk later about how you can push up changes, but for now let&rsquo;s create our OWN repository instead of working with someone ELSE&rsquo;S.</p>

<h2>Creating your OWN git repo</h2>

<p>The Luggage has a directory called Examples, but it&rsquo;s absent of any actual examples.  We want to create our own directory where we can store our Luggage Examples.  For the purposes of this demo, I&rsquo;m going to create a directory called luggage_examples that will contain our&hellip;well&hellip; Luggage examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/src
</span><span class='line'>$ mkdir luggage_examples</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a directory, we need to make sure that git is tracking our changes so that we can create those &lsquo;what if&rsquo; scenarios and save our work.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/src/luggage_examples
</span><span class='line'>$ git init
</span><span class='line'>Initialized empty Git repository in /Users/gary/src/luggage_examples/.git/</span></code></pre></td></tr></table></div></figure>


<p>Git created a new empty repository at ~/src/luggage_examples and created a .git directory inside luggage_examples.  This .git directory is where git stores all its dynamic data that&rsquo;s pertinent to your repository, so MAKE SURE not to delete it or modify any files in there (without knowing what you&rsquo;re doing).</p>

<p>That&rsquo;s it!  We&rsquo;ve created a repository!  Now let&rsquo;s actually see how git works locally on your machine.</p>

<h2>Working with Files</h2>

<p>As I mentioned before, you don&rsquo;t NEED Github to use git.  Git functions as a mechanism to &lsquo;version&rsquo; your files so you can rollback to a previous version or create our &lsquo;what-if&rsquo; scenarios and then accept (merge) or deny (destroy) them depending on our needs.  You can easily create a git repository on your local computer ONLY, but of course you lose the ability to restore your work if your hard drive malfunctions.  This is what Github gives us, and we&rsquo;ll look at that functionality later.</p>

<p>The example I&rsquo;m going to use is based on the previous blog post I wrote on <a href="http://glarizza.posterous.com/using-googles-crankd-application-tracking-cod">Using the Google Mac Sysops Crankd Code</a>  Let&rsquo;s create a directory for this example and create a starter Makefile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/src/luggage_examples/crankd_google
</span><span class='line'>$ cd ~/src/luggage_examples/crankd_google
</span><span class='line'>$ vim Makefile</span></code></pre></td></tr></table></div></figure>


<p>I use vi or vim to edit files from the Terminal.  Feel free to use any text editor you like (nano, emacs, Textmate, TextWrangler, etc&hellip;), but CREATE a file called &lsquo;Makefile&rsquo; (note the capital M) and put it in ~/src/luggage_examples/crankd_google.  Here&rsquo;s what I&rsquo;ll put into this file:</p>

<figure class='code'><figcaption><span>Crankd Luggage Example </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    # Title:       Crankd-Google Example</span>
</span><span class='line'><span class="c">    # Author:      Gary Larizza</span>
</span><span class='line'><span class="c">    # Description: Something so Marnin doesn&#39;t kill me w/ postinstalls :)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">    include /Users/gary/src/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>Crankd-Google
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.googlecode
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span>pack-crankd
</span></code></pre></td></tr></table></div></figure>


<p>Great, so we have our skeleton of a file!  The file is saved in our folder, but we haven&rsquo;t actually told git to track the file (and so git is AWARE that the file EXISTS, but it isn&rsquo;t tracking its changes&hellip;yet).  This is a good time to explain the three states in which files can exist in a git repository.</p>

<h2>The Three Stages of Files: Working Tree, Index, and Repository</h2>

<p>Git has three &lsquo;locations&rsquo; by which a file can exist (even though it technically exists, in our case, in ~/src/luggage_examples/crankd_google).  These three locations are called the working tree, the index, and the repository</p>

<h2>The Working Tree</h2>

<p>When you put a file in a directory that&rsquo;s being managed by git, but you haven&rsquo;t told git to track the files changes, then this file is said to be in the working tree.  Our file we just created, Makefile, exists in the working tree currently.  Git knows that the file EXISTS, but it hasn&rsquo;t saved the file&rsquo;s &lsquo;state&rsquo; so we can rollback the file if need be.</p>

<h2>The Index</h2>

<p>The index is also known as the cache or the staging area, and it&rsquo;s a place to put files before you&rsquo;re ready to make a &lsquo;commit&rsquo; (which is something of a &lsquo;milestone&rsquo; or a version).  A commit is a representation of a point in time in the history of your git repository.  Think of it as a snapshot of your repository &ndash; &lsquo;this is how our files looked at this specific time&rsquo;.  With commits, you can always rollback to a specific &lsquo;commit&rsquo; (or even advance to a future commit if you had rolled-back to an earlier commit).  In order to rollback to a specific version of a file, though, you need to make a commit, and in order to make a commit you need to tell git what FILES will comprise our commit.  As I mentioned, a commit is just a point in time&hellip;but it doesn&rsquo;t HAVE to be a point in time for a SINGLE file.  A commit can represent a specific point in time for a NUMBER of files all at once.  To make life easier for everyone, though, if you make a commit comprised of multiple files, then you want to make sure that the changes to the multiple files all represent a single functional change (for example, say we wanted to change a file that existed in our crankd_google folder that was being copied into a package, but we ALSO had to change the Makefile to change WHERE this file was to be put in the final package.  These two changes are related and comprise a single functional change, so you would want to make a commit with the changes to both files at once.).</p>

<p>Our Makefile exists in the working tree currently, but we want to put it in the index because we&rsquo;re ready to make a commit (no, our Makefile functionally doesn&rsquo;t DO anything yet, but we want to make a commit so we can rollback to this point in time should we mess up anything).  Understand that the locations of the &lsquo;working tree&rsquo; and &lsquo;index&rsquo; are relative to git ONLY.  Yes, this file lives in ~/src/luggage_examples, and it will CONTINUE to exist in that directory (as far as the OS X filesystem is concerned), but to git it currently exists in the working tree.  How do we know that the file is in the working tree and NOT in the index?  Use the git status command to show you that info:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git status
</span><span class='line'>
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Untracked files:
</span><span class='line'>#   (use "git add ..." to include in what will be committed)
</span><span class='line'>#
</span><span class='line'># Makefile
</span><span class='line'>nothing added to commit but untracked files present (use "git add" to track)</span></code></pre></td></tr></table></div></figure>


<p>Anything listed under &lsquo;Untracked files:&rsquo; is in the working tree.  You can add a file to the index by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add Makefile
</span><span class='line'>$ git status
</span><span class='line'>
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Changes to be committed:
</span><span class='line'>#   (use "git rm --cached ..." to unstage)
</span><span class='line'>#
</span><span class='line'># new file:   Makefile
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Great, the file is in the index!  Notice that the file is listed under &lsquo;Changes to be committed:&rsquo; meaning that it&rsquo;s in the index but NOT YET committed (or, &lsquo;in the repository&rsquo;).</p>

<h2>The Repository</h2>

<p>The Repository is where your files exist once they&rsquo;ve been made part of a commit.  As I mentioned before, files must be committed before we can roll back their states (and their states can only be rolled back to individual commits).  You can never rollback a file&rsquo;s state UNLESS it&rsquo;s tied to a commit.  If you made a commit to a file last week and haven&rsquo;t made another since, but wanted to revert a file to how it existed three days ago, you would be out of luck.  Git ONLY rolls back to specific commits (this is why it&rsquo;s important to make frequent commits).  Before we make a commit, however, we need to make sure to identify ourself to git (if you haven&rsquo;t previously set this up).  The user.email and user.name settings are the most important settings as they will be used to trace back what code you committed.  If you&rsquo;re not sure of how git is setup, use the following command to list the git config settings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git config -l
</span><span class='line'>user.name=Gary Larizza
</span><span class='line'>user.email=gary@puppetlabs.com</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Should the user.name and user.email settings NOT be configured, you can configure them with the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git config user.name 'Your name'
</span><span class='line'>$ git config user.email your@email.com</span></code></pre></td></tr></table></div></figure>


<p>Now that you&rsquo;ve been identified (so we can lay the blame on you in the future), let&rsquo;s actually commit some code.  The <strong>git commit</strong> command allows git to commit all staged files to the repository in one fell swoop.</p>

<p>Every commit has three things: the list of files and CONTENT of the files that should be committed, a SHA1 hash value representing the commit itself (essentially, a unique identifier for the commit so it can be tracked), and the commit message describing the what and why of the commit.</p>

<p><strong>Creating a commit message seems insignificant but should NOT be taken lightly.</strong>  Great commit messages usually consist of a title line containing no more than 60 characters followed by a paragraph describing the changes.  Because many people may potentially need to trace your code and commits, it&rsquo;s important to list how your code functioned previously, the reasoning behind the change, and what specifically was changed.  Don&rsquo;t skimp with your commit messages!  Always assume that the next person to maintain your code owns many dangerous weapons and knows where you sleep, so do that person a favor and be as kind to them (in the form of great commit messages) as possible!</p>

<p>Let&rsquo;s begin the process of making a commit by issuing the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git commit</span></code></pre></td></tr></table></div></figure>


<p>Executing <strong>git commit</strong> will drop you into the default text editor (which is vim by default &ndash; you can change this by running <strong>git config core.editor /path/to/your/editor</strong> before doing git commit) and show the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Please enter the commit message for your changes. Lines starting
</span><span class='line'># with '#' will be ignored, and an empty message aborts the commit.
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Changes to be committed:
</span><span class='line'>#   (use "git rm --cached ..." to unstage)
</span><span class='line'>#
</span><span class='line'># new file:   Makefile
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Note that everything that begins with a hash ( # ) is solely for YOUR benefit and will be stripped out of the commit message, so don&rsquo;t worry about it being included.  Here&rsquo;s an example of a commit message I would use in this instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Initial commit for crankd_google code
</span><span class='line'>
</span><span class='line'>Previously we didn't have an example for creating a package of the 
</span><span class='line'>Google Mac Sysops code.  This commit adds the shell for the Makefile and
</span><span class='line'>includes the luggage.make file in ~/src/luggage.</span></code></pre></td></tr></table></div></figure>


<p>Great!  When you save and close your editor, you should see something that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[master (root-commit) f423ac6] Initial commit for crankd_google code
</span><span class='line'> 1 files changed, 9 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 Makefile</span></code></pre></td></tr></table></div></figure>


<p>This tells us that we made a commit on the master branch with a SHA1 hash ID beginning in f423ac6 being attributed to this commit.  In most cases, the first 7 digits of the hash are all you need for uniqueness when you refer to this commit, and that&rsquo;s usually all that git will provide you in THIS instance.  YOUR SHA1 hash won&rsquo;t match the hash provided above (hence a unique ID), so don&rsquo;t panic if it doesn&rsquo;t match up for you.  And that&rsquo;s it!  We&rsquo;ve done it!  Now what?</p>

<h2>Examining your Work</h2>

<p>Git tracks the ENTIRE history of a repository, and thus will track any and every commit made.  To display this history, run the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git log
</span><span class='line'>commit f423ac6e9548d93f53b15d1154723c5abcd69738
</span><span class='line'>Author: Gary Larizza 
</span><span class='line'>Date:   Sun Jan 22 23:27:31 2012 -0500
</span><span class='line'>
</span><span class='line'>    Initial commit for crankd_google code
</span><span class='line'>
</span><span class='line'>    Previously we didn't have an example for creating a package of the
</span><span class='line'>    Google Mac Sysops code.  This commit adds the shell for the Makefile and
</span><span class='line'>    includes the luggage.make file in ~/src/luggage.</span></code></pre></td></tr></table></div></figure>


<p>By default, git log will show ALL information about ALL of your commits (including the full commit message).  There&rsquo;s a LARGE number of arguments that git log will accept that allows you to format the output for ANY purpose.  One of the common lists of arguments that I like to employ is the following (long) command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git log --pretty=format:'%C(yellow)%h%C(reset) %s %C(cyan)%cr%C(reset) %C(blue)%an%C(reset) %C(green)%d%C(reset)' --graph --date-order
</span><span class='line'>* f423ac6 Initial commit for crankd_google code 10 minutes ago Gary Larizza  (HEAD, master)</span></code></pre></td></tr></table></div></figure>


<p>This format both colorizes the output for readability and also shows a nice graph of commits as you do things like branching and merging.  Here&rsquo;s an example of this command (with line length chopped for brevity) being run on a repository with many commits:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* 72a2fe0 (#5445) Create /var/lib/puppet in OS X Package 26 hours ago Gary Larizza  (HEAD, gary/bug/2.7.x/5445_crea
</span><span class='line'>*   c6667c5 Merge pull request #324 from glarizza/bug/2.7.x/2273_launchd_dashw 12 days ago Daniel Pittman  (origin/
</span><span class='line'>|\  
</span><span class='line'>* \   bc6c642 Merge pull request #318 from glarizza/bug/2.7.x/11202_apple_rake 12 days ago Michael Stahnke 
</span><span class='line'>|\ \  
</span><span class='line'>| * | 6c14a28 Build a Rake task for building Apple Packages 12 days ago Gary Larizza  (gary/bug/2.7.x/11202_apple_r
</span><span class='line'>* | |   5ec5657 Merge pull request #127 from adrienthebo/ticket/2.7.x/8341-prevent_duplicate_loading_of_facts 12 da
</span><span class='line'>|\ \ \  
</span><span class='line'>* \ \ \   450da6a Merge pull request #92 from duritong/tickets/2.7.x/1886 12 days ago Daniel Pittman 
</span><span class='line'>|\ \ \ \  
</span><span class='line'>| | | | * d5bef5e (#2773) Use launchctl load -w in launchd provider 12 days ago Gary Larizza  (gary/bug/2.7.x/2273_
</span><span class='line'>* | | | |   1cb2b6a Merge branch 'ticket/2.7.x/11714-envpuppet' into 2.7.x 12 days ago Josh Cooper 
</span><span class='line'>|\ \ \ \ \  
</span><span class='line'>| |_|_|_|/  
</span><span class='line'>|/| | | |   
</span><span class='line'>| * | | | 5accc69 (#11714) Use **%~dp0** to resolve bat file's install directory 12 days ago Josh Cooper 
</span><span class='line'>* | | | |   fe79537 Merge pull request #323 from glarizza/bug/2.7.x/fix_launchd_spec 12 days ago Jeff McCune 
</span><span class='line'>|\ \ \ \ \  
</span><span class='line'>| * | | | | c865a80 Clean up launchd spec tests 12 days ago Gary Larizza  (gary/bug/2.7.x/fix_launchd_spec, bug/2.7
</span><span class='line'>|/ / / / /</span></code></pre></td></tr></table></div></figure>


<p>As you can see, git log is powerful and handy to list out what&rsquo;s happened to your repository.  You&rsquo;ll also notice that it lists WHO made the changes, which is handy if you have MANY people contributing to the same code base.</p>

<h2>That&rsquo;s it for now</h2>

<p>Hey , what gives?! We haven&rsquo;t really DONE anything!  Git has a tremendous amount of power, and it&rsquo;s important to know WHAT&rsquo;S happening before I can progress and show you the power of git.  This article is ALREADY quite long, so I&rsquo;ve broken it up for &lsquo;easier&rsquo; reading.  Rest assured, in parts 2 and beyond we will modify files, create topic branches, merge topic branches, use Github (for backup AND to allow others to contribute to your project), and much more.  Stay tuned for the following article(s) and as always, put any questions in the comments or email me directly!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using the Google Macops Crankd and Facter Code]]></title>
    <link href="http://garylarizza.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code/"/>
    <updated>2011-12-31T00:00:00-08:00</updated>
    <id>http://garylarizza.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code</id>
    <content type="html"><![CDATA[<p>On December 21st, the MacOps team at Google released a Googlecode repository containing a couple of scripts that they use for managing Macs.  The scripts provided interface with <a href="http://code.google.com/p/pymacadmin/">crankd (available in the Pymacadmin code suite)</a> and <a href="http://puppetlabs.com/puppet/related-projects/facter/">Facter</a>, which are a couple of tools with which you MIGHT not be familiar.</p>

<p>I saw a couple of questions on the ##osx-server IRC channel about how these scripts work, and I decided to do a quick writeup on how you would implement the scripts in your environment.  This is meant to be a walkthrough to getting their scripts up-and-running, but please READ EVERYTHING FIRST before implementing.</p>

<h2>Prepare Crankd:</h2>

<p>Crankd is a vital part of the Google MacOps puzzle.  Crankd essentially executes Python code in response to System/Network events on your system.  I have MUCH MORE information on crankd <a href="http://glarizza.posterous.com/using-crankd-to-react-to-network-events">in a guide I posted a while back</a>, but I&rsquo;m going to give you the &lsquo;quick version&rsquo; for those looking to get started quickly:</p>

<ul>
<li>Clone or download the Pymacadmin Github repo.  If you have git installed you can accomplish that by doing the following from the command line:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/acdha/pymacadmin.git</span></code></pre></td></tr></table></div></figure>


<p>If you DON&rsquo;T have git on your machine just visit <a href="https://github.com/acdha/pymacadmin">https://github.com/acdha/pymacadmin</a>, click on the Downloads tab, and download the .tar.gz or .zip version of the repo.  Next, double-click on the resultant file to expand it into a folder.</p>

<ul>
<li>Change to the pymacadmin folder and run the install-crankd.sh script which will install crankd.py into /usr/local/sbin and create /Library/Application Support/crankd  Once you&rsquo;ve changed to the pymacadmin source directory, run the following from the command line:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo ./install-crankd.sh</span></code></pre></td></tr></table></div></figure>


<h2>OR&hellip;</h2>

<p>If you already have a Puppet environment configured, I&rsquo;ve written a <a href="http://github.com/glarizza/puppetlabs-crankd">module that will install crankd for you.</a> The upside is that this module should work out of the box, but the downside is that I&rsquo;ve copied the source to the module&rsquo;s files/ directory.  Since Pymacadmin hasn&rsquo;t been changed since 2009, though, this shouldn&rsquo;t pose a big issue.  Simply copy this module to your modulepath and declare it with the following line in your node declarations:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">crankd</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Download the Google-macops source code</h2>

<p>You can download the source by using subversion with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>svn checkout http://google-macops.googlecode.com/svn/trunk/ google-macops-read-only</span></code></pre></td></tr></table></div></figure>


<p>This will create a folder called &lsquo;google-macops-read-only&rsquo; in the current directory.</p>

<h2>Copy the Python crankd files</h2>

<p>Change to the directory where you downloaded the Google-macops source code and you will notice two folders: crankd and facter.  Change to the crankd directory and copy all of the python files to /Library/Application Support/crankd with the following command from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo cp *.py /Library/Application\ Support/crankd/</span></code></pre></td></tr></table></div></figure>


<p>This copies two files into /Library/Application Support/crankd: ApplicationUsage.py and NSWorkspaceHandler.py.  The ApplicationUsage.py file contains most of the magic.  In a nutshell, it will create a SQLite database file called /var/db/application_usage.sqlite containing information on applications that are launched and quit (we will inspect this information later), and it will update the database any time an application is (you guessed it) launched or quit.  Crankd provides the mechanism by which the code is run any time an application is launched/quit and these Python files actually update the database with the pertinent information.</p>

<h2>Copy the provided crankd plist to /Library/Preferences</h2>

<p>Changing to the crankd directory in the google-macops-read-only directory you should find a file called &lsquo;com.googlecode.pymacadmin.crankd.plist&rsquo; which is a sample plist for utilizing Google&rsquo;s code that tracks application usage via crankd.  It&rsquo;s up to you to merge these Python methods into your existing crankd setup, or utilize the plist they&rsquo;ve provided.  The plist essentially says that any time an application is LAUNCHED, you should call the &lsquo;OnApplicationLaunch&rsquo; method in the NSWorkspaceHandler class, and any time an application is QUIT, you should call the &lsquo;OnApplicationQuit&rsquo; method in the NSWorkspaceHandler class.  Let&rsquo;s accept these conditions and copy their plist into /Library/Preferences (assuming that we don&rsquo;t have an existing crankd setup) with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp com.googlecode.pymacadmin.crankd.plist /Library/Preferences</span></code></pre></td></tr></table></div></figure>


<h2>Test out crankd from the command line</h2>

<p>With crankd.py installed, the Python methods copied to /Library/Application Support/crankd, and the com.googlecode.pymacadmin.crankd.plist plist copied to /Library/Preferences, we can finally test out the code to see how it works.  Start crankd with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /usr/local/sbin/crankd.py --config=/Library/Preferences/com.googlecode.pymacadmin.crankd.plist</span></code></pre></td></tr></table></div></figure>


<p>After entering your password, you should see the following in your terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Loading configuration from /Library/Preferences/com.googlecode.pymacadmin.crankd.plist
</span><span class='line'>INFO: Listening for these NSWorkspace notifications:  NSWorkspaceWillLaunchApplicationNotification, NSWorkspaceDidTerminateApplicationNotification</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s launch a couple of applications and see how we track their usage through the sqlite database.  Do this by starting Safari and TextEdit, and then closing them (note that you MUST start them fresh &ndash; if they&rsquo;re already opened make sure to close them, then open them, and THEN close them again).  You should see something that looks like the following in the terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Application Launched: bundle_id: com.apple.Safari version: 6534.52.7 path: /Applications/Safari.app
</span><span class='line'>INFO: Application Launched: bundle_id: com.apple.TextEdit version: 264 path: /Applications/TextEdit.app
</span><span class='line'>INFO: Application Quit: bundle_id: com.apple.TextEdit version: 264 path: /Applications/TextEdit.app
</span><span class='line'>INFO: Application Quit: bundle_id: com.apple.Safari version: 6534.52.7 path: /Applications/Safari.app</span></code></pre></td></tr></table></div></figure>


<p>Finally, you can quit crankd from the terminal by holding the control button down and pressing the &lsquo;c&rsquo; key on your keyboard.</p>

<h2>Inspect the application_usage.sqlite database</h2>

<p>If you&rsquo;re proficient in SQL, feel free to browse through the contents of the database.  To keep things simple, let&rsquo;s download an app called <a href="http://sourceforge.net/projects/sqlitebrowser/files/latest/download">SQLite Database Browser</a> from the following link.  Launch SQLite Database Browser, go to File &ndash;&gt; Open Database, hold the Shift and Command buttons down on your keyboard and then press the &lsquo;g&rsquo; button to bring up the &lsquo;Go to the folder:&rsquo; dialog box, type in /var/db/application_usage.sqlite in the box and press return, and then finally click the open button to open the database.  If you click the &lsquo;Browse Data&rsquo; tab near the top of the window, you should be able to see the raw data in the database.  It should list the last time (in epoch time), bundle id, version, path, and number of times that the application has been launched (note that you can use an <a href="http://www.onlineconversion.com/unix_time.htm">online utility</a> to convert from epoch time to regular time).</p>

<h2>Inspect the Facter fact</h2>

<p><a href="http://puppetlabs.com/puppet/related-projects/facter/">If you&rsquo;re not familiar with Facter</a>, you should click on the link and check it out.  Facter is an awesome binary designed to gather information about your system and report it back in the form of a &lsquo;fact&rsquo;, which is essentially a key =&gt; value pair (for example, the &lsquo;operatingsystem&rsquo; fact will return a value of &lsquo;Darwin&rsquo; on Macs running OS X or &lsquo;RedHat&rsquo; on machines running RedHat Linux).  Google has provided a custom Facter fact that will report a fact NAME that corresponds with an application you&rsquo;ve launched on your system (such as &lsquo;app_lastrun_com.apple.safari&rsquo; or &lsquo;app_lastrun_com.apple.textedit&rsquo;) and a VALUE with the epoch time or the last time that application was run.  The output will ultimately look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app_lastrun_com.apple.safari =&gt; 1325203354
</span><span class='line'>app_lastrun_com.apple.textedit =&gt; 1325203357</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> This Facter fact requires the SQLite database that is created by the crankd code from above, so make sure you&rsquo;ve followed the previous steps or you might have problems getting fact values.</p>

<p>We&rsquo;ll need to install Facter.  <a href="http://downloads.puppetlabs.com/mac">You can download a copy of Facter from Puppet Labs directly</a>.  Simply download the DMG, expand it, and run the package installer inside.</p>

<p>To test out the fact, we will need the full path to the folder containing the google-macops code we downloaded in step two above.  I downloaded the source to a path of /Users/gary/Desktop/google-macops-read-only and so that&rsquo;s the path I&rsquo;m going to use in the next step.</p>

<p>Facter is designed to work with <a href="http://puppetlabs.com/puppet/puppet-enterprise/">Puppet</a>, but you can also run it independently.  Facter is ALSO designed to be plug-able with custom facts, and that&rsquo;s what Google has shipped us.  In order to TEST these custom facts, we need to set the RUBYLIB environment variable (as Facter will look for a custom facts inside a &lsquo;facter&rsquo; directory that&rsquo;s located inside the path returned by the RUBYLIB environment variable).  RUBYLIB should be set to the path of the downloaded google-macops source, so in my case I would run the following from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RUBYLIB</span><span class="o">=</span>/Users/gary/Desktop/google-macops-read-only
</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong>  make sure RUBYLIB is in capital letters.  If you downloaded the google-macops source to a different path, substitute your path for &lsquo;/Users/gary/Desktop/google-macops-read-only&rsquo;.</p>

<p>Next, we need to make sure we have the &lsquo;sqlite3&rsquo; ruby library installed on our system as the custom fact requires this library for correct operation.  One way to install sqlite3 is by using Rubygems with the following command from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo gem install sqlite3</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> If you have troubles using Rubygems to install sqlite3, you can either build it from source (which is beyond the scope of this article), or you can use Macports (if you have it installed) to install it with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo port install sqlite3</span></code></pre></td></tr></table></div></figure>


<p>The last step is to actually run Facter to test out the fact.  You may have a problem TESTING this fact if you installed sqlite3 via Rubygems &ndash; the reason is because the custom fact doesn&rsquo;t actually load Rubygems before it tries to load sqlite3 (this isn&rsquo;t a problem if you use the fact with Puppet as Puppet loads Rubygems.  It&rsquo;s ALSO not a problem if you&rsquo;re running version 1.9 or greater of ruby, as you no longer need to load Rubygems BEFORE trying to include a ruby library with ruby 1.9 or greater).  To remedy this problem, let&rsquo;s add a single line to the custom fact.  Notice the line that says the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sqlite3&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This line is where the custom fact loads the sqlite3 library.  Now, the line BEFORE this line we need to add a single line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This line will load Rubygems so that it knows where to access the sqlite3 library.  Note that this line is unnecessary if you use this custom fact with Puppet as, like I mentioned before, Puppet already loads Rubygems.  For the purpose of our testing, though, we will need this line.</p>

<p>Finally, let&rsquo;s test the fact by running Facter from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>facter</span></code></pre></td></tr></table></div></figure>


<p>You SHOULD get a list of ALL your Facter facts, but up at the top you should have a couple of facts that begin with &lsquo;app_lastrun_&rsquo; and then end with the bundle_id of the application that was launched.  These are the custom facts that have been created.</p>

<p>You&rsquo;ll note that the time reported is in epoch time.  If you&rsquo;d prefer a date/time string that&rsquo;s more legible, you&rsquo;ll need to modify the apps.rb file in the facter directory.  Line 39 in the file (or, line 40 if you added the require &lsquo;rubygems&rsquo; line previously) should say &lsquo;appdate&rsquo; but change it to say the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">appdate</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running facter again (like above) will give you a more legible date:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app_lastrun_com.apple.safari =&gt; Thu Dec 29 19:02:34 -0500 2011
</span><span class='line'>app_lastrun_com.apple.textedit =&gt; Thu Dec 29 19:02:37 -0500 2011</span></code></pre></td></tr></table></div></figure>


<h2>???</h2>

<h2>Profit!</h2>

<p>Now that you know how the code works, you&rsquo;re free to modify, extend, and improve it as you see fit!  The one thing that&rsquo;s missing here is a LaunchDaemon that keeps crankd running in the background.  Since you&rsquo;re maintaining your environment, I&rsquo;ll leave that up to you (though I walk you through this step in <a href="http://glarizza.posterous.com/using-crankd-to-react-to-network-events">&lsquo;Step 5.  A LaunchDaemon to keep crankd running&rsquo; in my previous crankd writeup</a>).  Feel free to check out my other writeups on Facter, Puppet, and Crankd to see how I used to manage hundreds of Macs in an educational environment!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Run Stages With Puppet]]></title>
    <link href="http://garylarizza.com/blog/2011/03/11/using-run-stages-with-puppet/"/>
    <updated>2011-03-11T11:34:00-08:00</updated>
    <id>http://garylarizza.com/blog/2011/03/11/using-run-stages-with-puppet</id>
    <content type="html"><![CDATA[<p>As of version 2.6, Puppet introduced a feature called &ldquo;Run Stages&rdquo; that will allow you to better control the order that Puppet configures your system.  The problem with Run Stages (as of right now) is that there&rsquo;s not that much good Documentation out there.  Hopefully this document helps someone else out there who wants to setup Run Stages in their own environment.</p>

<h2>A NOTE ON SYNTAX!!!</h2>

<p>One of THE MOST DIFFICULT concepts to understand for puppet newbies is that these two things are identical:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">foo</span>
</span><span class='line'><span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of these lines INVOKE the &lsquo;foo&rsquo; class for use on a particular node.  The problem is that the second method (the parameterized class method) looks nearly IDENTICAL to the method you would use to DECLARE the foo class in foo.pp.  The only difference is that the class name is now INSIDE the curly braces (versus being OUTSIDE the braces when you DECLARE the class in your foo.pp file).  It is VERY important that you distinguish the difference between DECLARING a class and using a parameterized class to INCLUDE the class in your site.pp file.  I will point this out later too&hellip;</p>

<h2>A Linux Example &ndash; Repositories</h2>

<p>I would bet that the resource with the most &ldquo;require&rdquo; and &ldquo;before&rdquo; dependencies in the Linux world (Well, in the RHEL world anyways) would be the yumrepo.  I&rsquo;m sure most of us have many declared yumrepo resources in our manifests that each have their own tangled web of dependencies.  My goal was to create a &ldquo;repo&rdquo; class that would have all of my repositories and use a Run Stage to ensure that my repo class was installed prior to any other package installs.  Let&rsquo;s look at some code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::repo</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">yumrepo</span> <span class="p">{</span> <span class="s1">&#39;huronrepo&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">descr</span>    <span class="p">=&gt;</span> <span class="s1">&#39;Huron Repository&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">enabled</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">gpgcheck</span> <span class="p">=&gt;</span>  <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">baseurl</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;http://10.13.0.6/huronrepo&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This is my repo subclass based on my general base class.  I have a single repository, but could easily have another 5 or 10 as need arises (I&rsquo;m keeping things simple for demo purposes).  Let&rsquo;s look at another class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::centos</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">general::repo</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;mcollective&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">name</span>    <span class="p">=&gt;</span> <span class="s2">&quot;mcollective&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">&#39;stomp&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s a centos subclass off of the general base class.  We&rsquo;re including our repo class and declaring a single package that requires our &ldquo;huronrepo&rdquo; yumrepo.  If we only needed to install a single package, we could use the &ldquo;require&rdquo; parameter; but if you assume that we will eventually need to install MULTIPLE packages, then this logic doesn&rsquo;t scale. Just to keep things consistent, here&rsquo;s my general base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">case</span> <span class="nv">$::operatingsystem</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;CentOS&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="kn">include</span> <span class="nc">general::centos</span> <span class="err">}</span>
</span><span class='line'>    <span class="err">&#39;Darwin&#39;</span><span class="nc">:</span> <span class="p">{</span> <span class="ss">include</span> <span class="ss">general</span><span class="p">::</span><span class="ss">osx</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>You can see that we include the general::centos class as long as Puppet is running on a CentOS box.  There&rsquo;s one final piece to this puzzle &ndash; it&rsquo;s the actual declaration and assignment of the Run Stages.  I&rsquo;m doing this in my site.pp file.  Here&rsquo;s a snippit of what&rsquo;s in my site.pp file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline"># /etc/puppet/manifests/site.pp</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Exec</span> <span class="p">{</span> <span class="ss">path</span> <span class="err">=&amp;</span><span class="ss">gt</span><span class="err">;</span> <span class="s2">&quot;/usr/bin:/usr/sbin:/bin:/sbin&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Run Stages</span>
</span><span class='line'><span class="ss">stage</span> <span class="p">{</span> <span class="s1">&#39;pre&#39;</span><span class="err">:</span>
</span><span class='line'>  <span class="ss">before</span> <span class="p">=&gt;</span> <span class="nc">Stage</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Node Declaration</span>
</span><span class='line'><span class="ss">node</span> <span class="s1">&#39;server.whomever.com&#39;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">class</span> <span class="p">{</span> <span class="s1">&#39;general::repos&#39;</span><span class="err">:</span>
</span><span class='line'>    <span class="ss">stage</span> <span class="p">=&gt;</span> <span class="s1">&#39;pre&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s where we&rsquo;ve declared a &ldquo;pre&rdquo; stage that needs to run before the &ldquo;main&rdquo; stage.  We don&rsquo;t have to declare the &ldquo;main&rdquo; stage because Puppet uses that stage by default.  Next, we&rsquo;re including the general::repos class inside our &lsquo;server.whomever.com&rsquo; node declaration and assigning it to the &ldquo;pre&rdquo; stage (which means that everything in that class will get configured prior to our &ldquo;main&rdquo; stage).  Remember that you can declare as many stages as you need and chain them all to setup the order that you want, but that can become very unmanageable very quickly.  I find it ideal to setup a &lsquo;pre&rsquo; stage for repo setup, and then setting up dependencies within class files.</p>

<h2>The World is Your Stage</h2>

<p>This might not be the &ldquo;best&rdquo; way to use Run Stages, but it works for me.  Hopefully this little writeup cements the concept for you too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting Started With the Luggage]]></title>
    <link href="http://garylarizza.com/blog/2010/12/21/getting-started-with-the-luggage/"/>
    <updated>2010-12-21T09:47:00-08:00</updated>
    <id>http://garylarizza.com/blog/2010/12/21/getting-started-with-the-luggage</id>
    <content type="html"><![CDATA[<p>With the current movement in the Mac Community toward modular imaging strategies, there&rsquo;s a spike in the need for properly formed package installers. Apple&rsquo;s package format is well documented for its benefits and flaws and there are a string of applications that will help you create your perfect package (from Apple&rsquo;s Packagemaker to the many third-party applications).  While all the various package creation applications will ultimately create a desirable package in the end, very few of them have the triple-threat of easy code-review, replication, and portability.  This is where The Luggage comes in.</p>

<p><a href="http://github.com/unixorn/luggage">The Luggage</a> is a packaging system based on GNU&rsquo;s make command that is found on most every *nix-based operating system (OS X included).  Joe Block, the author, open-sourced the project based on an internal Google tool for creating packages with Makefiles.  By using Makefiles, every member of your team can quickly glance at the file and see exactly what is being inserted into a package.  Changes can be made and committed quickly, errors can be squashed without tearing apart .pkg files, and you can reproduce packages quickly and efficiently without wading through many GUI windows.</p>

<h2>Why do I need to Package?</h2>

<p>Many vendors already ship properly formatted package installers for their software &ndash; and for that we thank them.  There are still a couple of major software vendors that choose to use unique third-party package &ldquo;wrappers&rdquo; to install their software.  While this is fine if you only ever need to install that software on one machine, it makes software deployment&hellip;difficult.  Because of this, systems administrators need to re-package this software into a proper package installer that will deploy and install silently.</p>

<p>If you&rsquo;re a fan of open-source software, you will find that many projects do not offer their software in Apple-friendly packages.  The Luggage will help you wrap their source files into a package format that can be distributed to your machines.</p>

<p>Finally, you may have a whole bevy of scripts that you use for configuration/customization of your clients.  These scripts can easily be deployed via ARD or wrapped into a payload-free package with a single postinstall script.  The Luggage will help you keep track of all your scripts and package them for distribution.</p>

<p>As I&rsquo;ve said before, there are other third-party applications out there that will create a package to your needs.  Many will use snapshotting (or fseventsd monitoring) to create a package based on what&rsquo;s changed on your system.  While this is lightning fast (in most cases), you will need to redo this whole process if something needs to be changed in the resultant package.</p>

<h2>How do we use The Luggage?</h2>

<p>As we said before, The Luggage is just a giant Makefile.  Make has its own unique language, so you need to obey its syntax and formatting standards.  I&rsquo;ve linked to the <a href="http://www.gnu.org/software/make/manual/make.html">GNU make manual here</a> so you can get a quick overview of how it works (WARNING, it&rsquo;s quite large), but this guide will cover all the basics you need to know to get started.</p>

<p>Note that while it is <strong>NOT NECESSARY TO COMPLETELY UNDERSTAND MAKE TO BEGIN USING THE LUGGAGE</strong>, it will help you out tremendously as you start to create complicated packages if you DO understand make&rsquo;s nuances. This article may be long, but that&rsquo;s only to make sure that the reader understands what is going on in the background.</p>

<h2>The luggage.make File</h2>

<p>The base of everything you will do with The Luggage is a file called luggage.make.  It is by no means definitive, and you&rsquo;re encouraged to add to it should you encounter a situation where a recipe doesn&rsquo;t exist for a directory into which you want to install files (Don&rsquo;t worry, we&rsquo;ll get into this later), but it does serve as the basis for all packages you&rsquo;re going to be creating.</p>

<p>At the top of the file are all the variable declarations.  Anything that begins with SOMETHING=somethingelse is setting a variable that we will encounter later.  Many of these variables (such as PACKAGEMAKER, WORK_D, CP, INSTALL, and so on) are paths to various commands that we will need in our rules (setting absolute paths to common commands saves typing later and helps us avoid errors with things like PATH environment variables).  Dereferencing these variables in a Makefile is done with a syntax that looks like this &ndash;> ${CP} (this outputs the value of the CP variable, which is actually <strong>/bin/cp</strong>).  Note that you DO NOT use quotes when you set a variable (i.e. if you want to set the path to CP you do it with CP=/bin/cp and NOT by doing CP=&ldquo;/bin/cp&rdquo;) &ndash; if you DO use quotes, they will be included in the value of that variable (which will cause you all kinds of problems).</p>

<p>Next, we have the target stanzas.  A target (or a rule &ndash; I will use the word rule throughout the article) is setup to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        <span class="k">do</span>-something: l_usr_bin
</span><span class='line'>        @-echo <span class="s2">&quot;Commands are entered here&quot;</span>
</span><span class='line'>        @-echo <span class="s2">&quot;Everything below our rule is executed&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, the <strong>target</strong>, or <strong>rule</strong>, is called <strong>do-something</strong> and has dependencies based on ANOTHER rule that&rsquo;s called <strong>l_usr_bin</strong>.  Below this line is called our <strong>recipe</strong>, and right now there are two echo commands.  If the above code was in a blank text file called Makefile we could execute the two echo commands by running the following command from the command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    make <span class="k">do</span>-something
</span></code></pre></td></tr></table></div></figure>


<p>This would in turn echo the two lines of text below the do-something rule (This is not totally true &ndash; since we haven&rsquo;t defined a rule for l_usr_bin it would probably error out, but I&rsquo;ve kept that dependency in the above example to show you how a rule works.).  Looking specifically at luggage.make, the target stanzas define the behavior for The Luggage&rsquo;s various behaviors (make pkg, make dmg, make zip, and so on).  Note that since many of these rules have dependencies on OTHER rules, a simple command of <strong>make pkg</strong> will trigger.</p>

<p>Next, you will encounter the Target directory rules.  This is the part of the luggage.make file that you may need to edit.  Joe has done a great job of defining the most popular directories into which you will install files/applications/etc. but it would be impossible for him to define EVERY location that you could possibly need.  Here is the structure of creating a Directory Rule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        l_etc_puppet: l_etc
</span><span class='line'>        @sudo mkdir -p <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chown -R root:wheel <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span></code></pre></td></tr></table></div></figure>


<p>This rule will create an /etc/puppet directory in Luggage&rsquo;s working directory (The variable WORK_D will be used frequently &ndash; it&rsquo;s the temporary directory that The Luggage creates to simulate the target volume onto which it&rsquo;s installing files.  Everything following ${WORK_D} will be the <strong>EXACT PATH</strong> into which files will be installed on the machine that runs your package.)  These Directory Rules become very important when we create custom Makefiles because they serve as dependencies which create the directories in The Luggage&rsquo;s Working Directory. In a nutshell, if you&rsquo;re installing files into a directory with The Luggage, you need to have a Directory Rule that creates this directory first.  Bottom Line: if you don&rsquo;t FIND a Directory Rule for a directory where you will be installing files, then you&rsquo;ll need to create one.</p>

<p>Finally are the File Packaging Rules.  These are handy shortcut rules that will keep your makefiles very short and readable.  In a nutshell, Joe has defined some of the most common directories to which files are installed and created one-line commands that will install specific files into those directories.  For example, say you were creating a custom Makefile in a directory that also had a launchd plist called <strong>com.foo.bar.plist</strong> in it.  If ALL you needed to do was create a package that installed that launchd plist into the /Library/LaunchDaemons directory you could setup your Makefile like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>install_foo_launchd_plist
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.foo
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>pack-Library-LaunchDaemons-com.foo.bar.plist
</span></code></pre></td></tr></table></div></figure>


<p>The PAYLOAD variable tells The Luggage which rules to execute.  In this case, it&rsquo;s executing the File Packaging Rule for launchd plists (pack-Library-LaunchDaemons-%) that creates the ${WORK_D}/Library/LaunchDaemons directory, installs the com.foo.bar.plist file into it, sets the correct permissions, and then executes the Packagemaker command line tool to create your package installer. Congratulations, you created a package in 5 lines of code!</p>

<h2>Preparing for using The Luggage</h2>

<p>The Luggage is fairly self contained, but it DOES use Apple&rsquo;s Packagemaker command line tool &ndash; and the way to install THAT is to download and install the Developer Tools for your computer&rsquo;s OS version (There are different Developer Tools packages for 10.6, 10.5, and so on).  The Developer Tools can be downloaded from <a href="http://developer.apple.com">Apple&rsquo;s Developer Site</a>, but you must create a (free) developer account first.  If you&rsquo;re a Mac sysadmin, you should already have all of this.</p>

<p>Once the Developer Tools have been installed you will then need to install The Luggage.  You can use The Luggage to create an installer package for The Luggage (Weird, yes) by first <a href="http://github.com/unixorn/luggage">downloading the source code from Github.</a>  Just click on the big Downloads button in the upper right corner of the screen and download a zip version of the files.  From there, double-click on the downloaded zip file to open it, open up Terminal and change to the folder that was created which contains The Luggage&rsquo;s source code, and execute the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo make pkg
</span></code></pre></td></tr></table></div></figure>


<p>This will create an installer package which can be run.  This package installs The Luggage into the /usr/local/share/luggage directory (Don&rsquo;t believe me? Check the Makefile for your self!).  You&rsquo;re now ready to use The Luggage!</p>

<p>Before we get into the package creation examples, we need to talk about directory structure and version control systems (svn, hg, git, etc&hellip;).  When you create new packages with The Luggage, it&rsquo;s necessary to create a new Makefile in a new directory.  I like to use the /usr/local/share/luggage/examples directory to create my packages.  The easiest way to begin a new package is to copy a directory that contains a working Makefile and simply tailor it to your needs.  Unless your job is SOLELY packaging (or you&rsquo;re a unix graybeard), you&rsquo;re NOT going to remember all the syntax and nuances of make.  Don&rsquo;t re-create the wheel &ndash; just copy and edit.</p>

<p>Next, you&rsquo;re going to want to backup your files and/or have a versioning system.  Version control systems (like Subversion, Mercurial, Git, and the like) are becoming increasingly popular <a href="http://www.agileweboperations.com/the-state-of-devops">with the current DevOps movement</a>, so it might be a good idea to start playing with one NOW while you&rsquo;re learning a new skill!  If you&rsquo;re TOTALLY new to this concept, <a href="http://help.github.com/mac-git-installation/">I recommend using git</a>, but it&rsquo;s entirely up to you.  <a href="http://github.com/huronschools/luggage">I maintain a git repository of my Luggage fork</a> that&rsquo;s open to anyone to review and borrow.  If you decide to use something like Git, well then GOOD ON YA, MAN!  If not, make sure you have a backup of your Makefiles.  They&rsquo;re small files; make two backups :)</p>

<h2>Package Creation Examples</h2>

<p>Now that we&rsquo;ve described how make works, how luggage.make works, given a quick example of how to create a package in 5 lines, and had the installation/backup talk let&rsquo;s walk you through some basic package creation examples. We&rsquo;ll create packages that install an application, create a package that installs printers and executes a postinstall script, create a package that installs source code in many directories, and finally create a complex Makefile that uses variables and bash commands.</p>

<h2>An Application Package</h2>

<p>The most common packages will simply install an application file into the /Applications folder on your computer.  Since .app files are actually bundles (a directory that contains subdirectories of executable code), we will need to use tar to wrap these bundles into a single file.  From there we can have The Luggage untar the application into the correct folder. <a href="https://github.com/unixorn/luggage/blob/master/examples/firefox/Makefile">Joe&rsquo;s Firefox example</a> does this, but he also has an added step of curling the tarred/bzipped application from a web server.  I&rsquo;m going to skip that step (for now) so you understand how the basic process works, but it&rsquo;s a best practice to use the curl method so you can keep your applications up-to-date on your fileserver without having to copy the new files to your luggage directory every time.</p>

<p>Let&rsquo;s first create the /usr/local/share/luggage/examples/calculator directory and then make a copy of /Applications/Calculator.app into the /usr/local/share/luggage/examples/calculator directory.  Next, lets open Terminal and change to our /usr/local/share/luggage/examples/calculator directory.  Finally, run the following command to tar.bz2 our Calculator.app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    tar cvfj Calculator.app.tar.bz2 Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>If you did it correctly, it should create the Calculator.app.tar.bz2 file that we need for The Luggage.  Make sure this file is in the SAME directory (and level &ndash; so don&rsquo;t create subfolders) as the Makefile we&rsquo;re going to create.  You can actually delete the Calculator.app copy that we created &ndash; we won&rsquo;t need it.  From there, our Makefile is simple &ndash; it should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>Calculator_Install
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.yourdomain
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>unbz2-applications-Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it!  The PAYLOAD variable is the magic variable here &ndash; it contains the rule(s) that are to be executed in creating our package.  The unbz2-applications-% File Packaging Rule is defined in our luggage.make file (which we&rsquo;ve included at the top of our Makefile), so we don&rsquo;t NEED anything else in our Makefile.  <strong>MAKE SURE</strong> that the capitalization and spelling of Calculator.app in &ldquo;unbz2-applications-Calculator.app&rdquo; and your &ldquo;Calculator.app.tar.bz2&rdquo; files are IDENTICAL or this package will NOT be created (make relies on this).</p>

<h2>UPDATED: An easier Application Package</h2>

<p>Joe has actually created a Ruby script that will perform all of the actions outlined in the previous example for you.  It&rsquo;s called app2luggage.rb and it can save you a few steps if you know how to use it.  Let&rsquo;s take a look and see what we need to use it.</p>

<p>The first thing you will need to do is install the trollop rubygem as that&rsquo;s what app2luggage.rb uses to parse its options.  You can do this with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo gem install trollop
</span></code></pre></td></tr></table></div></figure>


<p>Next, make sure the app2luggage.rb script exists in your /usr/local/share/luggage directory.  Finally, let&rsquo;s run the command with the following arguments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo /usr/local/share/luggage/app2luggage.rb -a /Applications/Calculator.app -i /usr/local/share/luggage/examples/Calculator_Application/ -l /usr/local/share/luggage/luggage.make -r com.huronhs -p Calculator_Application
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s what each argument means:</p>

<ol>
<li>-a is the path to the Application we want to tar up and install with The Luggage &ndash; we&rsquo;re using the path to Calculator.app for now</li>
<li>-i is the path to the folder that app2luggage.rb will create that contains our Makefile and tarred up application.  This folder SHOULD NOT EXIST or app2luggage.rb will exit (so as not to overwrite your data).</li>
<li>-l is the path to our luggage.make file</li>
<li>-r is the reverse domain for our organization</li>
<li>-p is the package id for the Makefile</li>
</ol>


<p>There are other arguments available, simply run app2luggage.rb with the &mdash;help argument to see them all.  Once app2luggage.rb runs successfully, it will create the directory you specified in the -i argument and populate it with a Makefile and the tarred up application.  The only thing left to do is to make your pkg, zip, or dmg.</p>

<h2>Installing a printer with a preinstall script</h2>

<p>One of the most popular solutions I offer with using The Luggage is to create a package that will install a printer and then install a pre-configured PPD file that sets all the initial settings for the printer.  I do this with Puppet currently, and I know it&rsquo;s popular in Munki too.  You can also optionally install a specific driver (if the drivers for your printer aren&rsquo;t already on your machines).  For those people who like to skip ahead, <a href="https://github.com/huronschools/luggage/tree/master/examples/hhs_printers/Printserver%20Managed/Office_9050">I have this example on my luggage repo</a>.</p>

<p>This Makefile demonstrates the use of a preinstall/preflight script (which isn&rsquo;t actually installed into the payload of the package).  The Luggage has a special packaging rule for this called pack-script-% that works so long as the name of your script corresponds exactly with what you write in the PAYLOAD variable.  This file also demonstrates the use of multiple rules in the PAYLOAD variable by using the \ character.  While this isn&rsquo;t difficult to understand, it is a necessary syntax.</p>

<p><a href="https://github.com/huronschools/luggage/blob/master/examples/hhs_printers/Printserver%20Managed/Office_9050/preflight">My preflight script is right here</a> for those who are interested.  It&rsquo;s copied into the directory we create that contains our makefile and I name it preflight.  Note that it contains variables that need to be changed (all of which are at the top of the script) before you deploy this package.</p>

<p>Next, we need to get a .ppd file that contains all the configuration data for our printer.  The easiest way to do this is to install your printer on a demo machine using the EXACT SAME SETTINGS that will be configured in your script (protip: actually RUN the script on your computer first), configure it how you want (number of trays, memory settings, type of finisher, etc&hellip;), and then open the /etc/cups/ppd directory on your model computer.  Inside should be a .ppd file for your printer containing all the settings you&rsquo;ve just configured.  Copy this .ppd file into the folder that contains your Makefile and preflight script.  Mine (in this example) will be called psm_HHS_Office_9050.ppd</p>

<p>Now, let&rsquo;s look at our Makefile:</p>

<figure class='code'><figcaption><span>Managed Printer Makefile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>HHS_Main_Office_9050_Managed_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-hp-ppd <span class="se">\</span>
</span><span class='line'>        pack-script-preflight
</span><span class='line'>
</span><span class='line'>    pack-hp-ppd: l_etc_cups_ppd
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./psm_HHS_Office_9050.ppd <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chmod 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chown root:_lp <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The first thing you should notice is that our PAYLOAD variable starts with a \ and has three lines.  The \ signifies that the contents of our variable spans multiple lines.  In reality, the value of PAYLOAD is actually &ldquo;pack-hp-ppd pack-script-preflight&rdquo; but it&rsquo;s formatted so it&rsquo;s easier to read.  Next, notice that the pack-script-preflight rule contains the word &ldquo;preflight&rdquo; after pack-script-.  This means that our script must be named preflight (EXACTLY &ndash; case is sensitive here).  Finally, we&rsquo;ve also specified a pack-hp-ppd rule.  Since luggage.make DOES NOT define this rule, we&rsquo;ve defined it in our Makefile.</p>

<p>The pack-hp-ppd rule has a dependency on the l_etc_cups_ppd rule.  This rule IS defined in luggage.make (well, it is for me &ndash; I can&rsquo;t remember if I created it or not.  If it isn&rsquo;t there for you, then you&rsquo;ll need to create it using the other folder creation rules as a guide) &ndash; and it creates the /etc/cups/ppd folder structure that we need in our package.  Lets look at the three lines which are called our <strong>recipe</strong>*:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="err">@sudo</span> <span class="err">${CP}</span> <span class="err">./psm_HHS_Office_9050.ppd</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="err">@sudo</span> <span class="err">chmod</span> <span class="err">644</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="nf">@sudo chown root</span><span class="o">:</span><span class="m">_lp ${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line references the CP variable (if you remember &ndash; its value is /bin/cp) to copy the psm_HHS_Office_9050.ppd file from the directory that contains our Makefile into Luggage&rsquo;s working directory/etc/cups/ppd.  The second line sets its mode to 644 (to match the mode for all .ppd files in that directory), and the third line sets the owner to root and the group to _lp (note that this group is ONLY available in 10.5 and 10.6 machines &ndash; so you&rsquo;ll need another package for 10.4 clients or below).</p>

<p>That&rsquo;s it!  The resultant package will run the preflight script and then install the correct .ppd file after the script is run.  This package will successfully install and configure your printer in one fell swoop.</p>

<h2>Installing files into multiple directories</h2>

<p>So far our Makefiles have been pretty easy.  In fact, most of them have been a couple of lines.  Lets look at a package that installs files into multiple locations.  There&rsquo;s a cool open source tool called <a href="http://github.com/ripienaar/angelia">Angelia that was created by R.I Pienaar</a>.  I use it to send alerts to my iPhone and to also process Nagios Alerts.  The problem is that it&rsquo;s only packaged for Linux machines.  Since I manage Mac machines, I thought I&rsquo;d lend R.I. a hand and create a package installer for it.  <a href="https://github.com/huronschools/luggage/tree/master/examples/angelia">This package is also on my luggage repo</a> if you want to work ahead.  Let&rsquo;s look at the Makefile:</p>

<figure class='code'><figcaption><span>Angelia Recipe </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Angelia Package Creation:</span>
</span><span class='line'>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>Angelia_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-angelia-etc <span class="se">\</span>
</span><span class='line'>        pack-angelia-binaries <span class="se">\</span>
</span><span class='line'>        pack-angelia-lib <span class="se">\</span>
</span><span class='line'>        pack-angelia-spool <span class="se">\</span>
</span><span class='line'>        pack-angelia-log <span class="se">\</span>
</span><span class='line'>        pack-angelia-launchd
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    pack-angelia-launchd: l_Library_LaunchDaemons
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> net.devco.angelia.plist <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>      @sudo chmod -R 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>
</span><span class='line'>    pack-angelia-binaries: l_usr_sbin
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-send
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-spoold.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-spoold
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-nagios-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-nagios-send
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin
</span><span class='line'>
</span><span class='line'>    pack-angelia-lib: l_Library_Ruby_Site_1_8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./angelia <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>
</span><span class='line'>    pack-angelia-etc: l_etc_angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./templates <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.cfg <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./COPYING <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./README.markdown <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>
</span><span class='line'>    pack-angelia-log: l_var_log_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>    pack-angelia-spool: l_var_spool_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s definitely longer, but I don&rsquo;t think it&rsquo;s any more complex than the examples we&rsquo;ve seen before.  The PAYLOAD variable spans multiple lines using the \ character and I&rsquo;ve defined all the custom rules.  All of the rules depend on <a href="https://github.com/huronschools/luggage/blob/master/luggage.make">folder rules in my luggage.make file</a> (which were created if they didn&rsquo;t exist before), and the recipes inside those rules are extremely simple to navigate (mainly copying files and changing permissions).  Creating a script that makes this package would be QUITE A BIT longer than this Makefile, and the Makefile itself took less than 3 minutes to create.  The only caveat is that we need to make sure all the files/directories we&rsquo;re copying into Luggage&rsquo;s WORK_D directory are in the folder that contains the Makefile.  Because of this, anytime Angelia is updated I will need to copy over new files.</p>

<p>It would be much easier to create a Makefile that downloaded the current version of all of these files before it copied them into our package&hellip;</p>

<h2>Creating a more complex Makefile</h2>

<p>The basis of this example was my thought that it would be MUCH easier for me to have a Makefile that downloaded the newest versions of the files that I need before it copies them into the package.  Make supports this through its support of shell commands and variables &ndash; it only requires you to code it up.  Let&rsquo;s look at a package I created for Marionette-Collective.</p>

<p><a href="http://github.com/puppetlabs/marionette-collective">Marionette-Collective is awesome software</a> (also created by R.I Pienaar and now owned by Puppet Labs) that allows you to communicate with multiple nodes at once.  They DID have a script that created their packages, but I wanted to create a Makefile that would create a package of ANY version of their software.  Let&rsquo;s look at the Makefile first and I&rsquo;ll break it down:</p>

<figure class='code'><figcaption><span>MCollective Recipe </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Example:  A dynamic installer for Marionette-Collective</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Author:  Gary Larizza</span>
</span><span class='line'><span class="c">    #  Created: 12/17/2010</span>
</span><span class='line'><span class="c">    #  Last Modified: 12/18/2010</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Description:  This Makefile will download the version of MCollective specified</span>
</span><span class='line'><span class="c">    #    in the PACKAGE_VERSION variable from the Puppet Labs website, untar it,</span>
</span><span class='line'><span class="c">    #    and then install the source files into their Mac-specific locations.  </span>
</span><span class='line'><span class="c">    #    The MAJOR and MINOR versions must be specified for the Info.plist file</span>
</span><span class='line'><span class="c">    #    that Packagemaker requires, but I use awk on the PACKAGE_VERSION to </span>
</span><span class='line'><span class="c">    #    get these.  See inline comments.</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">    # Luggage Variables:</span>
</span><span class='line'><span class="c">    #    If the TYPE variable isn&#39;t specified via the CLI, we will install everything</span>
</span><span class='line'><span class="c">    #    into the resultant package</span>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Full
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.puppetlabs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>        pack-mc-libexec <span class="se">\</span>
</span><span class='line'>        pack-mc-binaries <span class="se">\</span>
</span><span class='line'>        pack-mc-lib <span class="se">\</span>
</span><span class='line'>        pack-mc-config <span class="se">\</span>
</span><span class='line'>        pack-mc-config-server <span class="se">\</span>
</span><span class='line'>        pack-mc-config-client <span class="se">\</span>
</span><span class='line'>        pack-mc-launchd <span class="se">\</span>
</span><span class='line'>        pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>        pack-mc-preflight-all
</span><span class='line'>
</span><span class='line'><span class="c">    # Variable Declarations:  </span>
</span><span class='line'><span class="c">    #    Any variable can be set from the command line by doing this:</span>
</span><span class='line'><span class="c">    #    &quot;make pkg PACKAGE_VERSION=1.0.0&quot;</span>
</span><span class='line'>    <span class="nv">PACKAGE_VERSION</span><span class="o">=</span>1.0.0
</span><span class='line'>    <span class="nv">PACKAGE_MAJOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$1}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">PACKAGE_MINOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$2$$3}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">MCFILE</span><span class="o">=</span>mcollective-<span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="nv">MCURL</span><span class="o">=</span>http://puppetlabs.com/downloads/mcollective/<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # Package Creation Limiters:</span>
</span><span class='line'><span class="c">    #    These if-statements will check for one of three values for the TYPE variable:</span>
</span><span class='line'><span class="c">    #    &quot;COMMON, CLIENT, or BASE&quot;  If either of these values are present (CASE SENSITIVE)</span>
</span><span class='line'><span class="c">    #    the PAYLOAD variable will be changed to limit what is installed into the package.</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # COMMON Package:</span>
</span><span class='line'><span class="c">    #    This package includes the Ruby libraries and MCollective plugins with nothing else.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},COMMON)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-libexec <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-common
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Common
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # CLIENT Package:</span>
</span><span class='line'><span class="c">    #    This package includes the MCollective Binaries and the configuration file for</span>
</span><span class='line'><span class="c">    #    MCollective&#39;s client binaries.  </span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},CLIENT)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-binaries <span class="se">\</span>
</span><span class='line'>          pack-mc-config-client <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-client
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Client
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # BASE Package:</span>
</span><span class='line'><span class="c">    #    This package includes the mcollectived daemon, Ruby Libraries, a launchd plist</span>
</span><span class='line'><span class="c">    #    to call mcollectived, and the configuration files for the MCollective server.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},BASE)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-config-server <span class="se">\</span>
</span><span class='line'>          pack-mc-launchd <span class="se">\</span>
</span><span class='line'>          pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-base
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Base
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will curl the selected version of MCollective and untar it into the directory</span>
</span><span class='line'><span class="c">    #    in which the Makefile resides.</span>
</span><span class='line'>    unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>:
</span><span class='line'>      curl <span class="k">${</span><span class="nv">MCURL</span><span class="k">}</span> -o <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">TAR</span><span class="k">}</span> xzf <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will install MCollective&#39;s plugin files to /usr/libexec/mcollective</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
