<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Shit Gary Says]]></title>
  <link href="http://glarizza.github.com/atom.xml" rel="self"/>
  <link href="http://glarizza.github.com/"/>
  <updated>2013-01-17T19:58:29-08:00</updated>
  <id>http://glarizza.github.com/</id>
  <author>
    <name><![CDATA[Gary larizza]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Managing a blog is insane; Octopress FTW!]]></title>
    <link href="http://glarizza.github.com/blog/2013/01/17/managing-a-blog-is-insane/"/>
    <updated>2013-01-17T00:00:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2013/01/17/managing-a-blog-is-insane</id>
    <content type="html"><![CDATA[<p>Masochists are everywhere. Managing a system by hand appeals to a certain subset
of the population, but I joined <a href="http://www.puppetlabs.com">Puppet Labs</a> because
I was a fan of automating the shit out of menial tasks. I have no burning desire
to handcraft an artisanal blog made out of organic bits. I tried web development
at one point in my life and learned an important lesson:</p>

<p>I am not a web developer</p>

<p>What I DO want is to have a platform to share information and code I&#8217;ve
accumulated along the way that:</p>

<ol>
<li>Doesn&#8217;t look like hell</li>
<li>Doesn&#8217;t take forever to update</li>
<li>Doesn&#8217;t require me being online to write a post</li>
<li>Allows me to post code that&#8217;s syntactically highlighted and easy to copy/paste</li>
<li>Accepts <a href="http://daringfireball.net/projects/markdown/">Markdown</a></li>
<li>Fits into my DVCS workflow</li>
<li>Is free - because screw paying for A BLOG</li>
</ol>


<h2>Seriously, is this too much to ask?</h2>

<p>Originally I waded the waters of <a href="http://glarizza.posterous.com">Posterous</a> but
found that not only did it have awkward <a href="http://daringfireball.net/projects/markdown/">Markdown</a> syntax, but staging of
blog posts was cumbersome.  Also, while there WAS <a href="http://gist.github.com">gist</a> integration,
the code you posted looked like crap. That sucks because most of what I post has
code attached.</p>

<p>Others have sold their soul for Wordpress/Drupal/Bumblefuck CMS (whether hosted
or unhosted platforms), but it still felt like too much process and not enough
action for my taste.</p>

<h2>Github to the rescue&#8230;again</h2>

<p>The answer, it turns out, was right in front of my face the whole time.
<a href="http://pages.github.com/">Github Pages</a> has always been available to host web content or <a href="https://github.com/mojombo/jekyll">Jekyll
sites</a> - I&#8217;m just late to the damn party.</p>

<p><a href="http://glarizza.github.com/images/blog_blog/left.png"><img class="left" src="http://glarizza.github.com/images/blog_blog/left.png" width="300" height="300"></a></p>

<p>Hosting static web content was out; like I said before, I don&#8217;t really want to
&#8216;manage&#8217; this thing. Jekyll, however, intrigued me. Jekyll is essentially
a static site generator that allows you to throw Markdown at it and get static
content in the end. There are even <a href="http://jekyllbootstrap.com/">Jekyll
bootstrap</a> projects aimed at making it (even more)
stupid simple. I tried plain vanilla Jekyll and realized that I didn&#8217;t really
want/need that level of control (again, I&#8217;m not into web development).
I pulled down Jekyll Bootstrap, but this time it felt a little TOO
&#8216;template-y&#8217;. Next, I pulled down an awesome Jekyll template called <a href="https://github.com/holman/left">Left by
Zach Holman</a> (seen, conveniently, in the
picture on the left).  I REALLY liked the look of Left, but was stuck with
Jekyll&#8217;s code formatting that was&#8230;less than ideal. Jekyll is pluggable (and
people have made plugins to fix this sort of thing), but I still
didn&#8217;t have enough experience at that time
to be able to deal with the plugins in an intelligent manner.</p>

<h2>Octopress = Jekyll + Plugins + &lt;3</h2>

<p>During my plugin party, I discovered <a href="http://octopress.org">Octopress</a>, which
basically had EVERYTHING I wanted wrapped with a templated bow. I loved the way
it rendered code, it supported things like <a href="http://github.github.com/github-flavored-markdown/)">fenced code blocks</a> , and it
seemed REALLY simple to update and deploy code.  The thing I DIDN&#8217;T like was
that NEARLY EVERY DAMN OCTOPRESS SITE LOOKS EXACTLY THE SAME! I know I said
that I&#8217;m not a web developer and didn&#8217;t want to tweak styles a great bit, but
damn - couldn&#8217;t I get a BIT of differentiation? That can be done, but you&#8217;re
still editing styles (so some CSS is necessary - but not much). After
evaluating all three options, I opted for Octopress.</p>

<h2>Documentation? Who knew!?</h2>

<p>Octopress.org has <a href="http://octopress.org/docs/setup/">GREAT documentation</a> for
getting setup with an Octopress blog. They even have documentation for setting
up Ruby 1.9.3 on rbenv or RVM (I recommend rbenv for reasons beyond this blog),
so make sure to check it out if you&#8217;re unfamiliar with either. To not reinvent
that documented wheel, make sure to check out that site to get Octopress setup
(I recommend cloning all repositories to somewhere in your home directory
like ~/src or ~/repos, but other than that their docs are solid). Normally
I post the dirty technical details, but the point of this post is to outline
WHY I made the decision I did and WHY it works for ME.</p>

<h2>Pretty code is pretty</h2>

<p>I&#8217;m not gonna lie - syntactical highlighting with the <a href="http://ethanschoonover.com/solarized">Solarized</a>
theme was pretty sexy. Let&#8217;s look at some Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value_type</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:boolean</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/(true|false)/i</span>
</span><span class='line'>        <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Valid boolean values are &#39;true&#39; or &#39;false&#39;, you specified &#39;</span><span class="si">#{</span><span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
</span><span class='line'>      <span class="n">plist</span> <span class="o">=</span> <span class="n">read_plist_file</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">plist</span> <span class="o">=</span> <span class="ss">OSX</span><span class="p">:</span><span class="ss">:NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value_type</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:integer</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:boolean</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/false/i</span>
</span><span class='line'>        <span class="n">plist_value</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">plist_value</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:hash</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">].</span><span class="n">first</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">plist_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">plist</span><span class="o">[</span><span class="n">resource</span><span class="o">[</span><span class="ss">:key</span><span class="o">]]</span> <span class="o">=</span> <span class="n">plist_value</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">write_plist_file</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">resource</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about some Puppet code?</p>

<figure class='code'><figcaption><span>Plist Management  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span> <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>    <span class="p">=&gt;</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>  <span class="p">=&gt;</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="ss">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">property_list_key</span> <span class="p">{</span> <span class="s1">&#39;hashtest&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">ensure</span>     <span class="p">=&gt;</span> <span class="ss">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">path</span>       <span class="p">=&gt;</span> <span class="s1">&#39;/tmp/com.puppetlabs.puppet&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">key</span>        <span class="p">=&gt;</span> <span class="s1">&#39;hashtest&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">value</span>      <span class="p">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;key&#39;</span> <span class="p">=&gt;</span> <span class="s1">&#39;value&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nt">value_type</span> <span class="p">=&gt;</span> <span class="s1">&#39;hash&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doesn&#8217;t that look awesome? What if you have a <a href="http://gist.github.com">gist</a>? You can embed those too
(and they&#8217;re also linkable):</p>

<div><script src='https://gist.github.com/3218523.js'></script>
<noscript><pre><code>require 'puppet'
require 'puppet/face'
arguments = { 'image'   =&gt; 'ami-30fe7300', 
              'keyname' =&gt; 'Your_Key', 
              'type'    =&gt; 't1.micro',
              'region'  =&gt; 'us-west-2' }
list_args = { 'region' =&gt; 'us-west-2' }
install_args = { 'login'             =&gt; 'ec2-user',
                 'keyfile'           =&gt; 'Your_Key.pem',
                 'install_script'    =&gt; 'puppet-enterprise-http',
                 'installer_payload' =&gt; 'http://pm.puppetlabs.com/puppet-enterprise/2.0/puppet-enterprise-2.0-el-6-x86_64.tar.gz',
                 'installer_answers' =&gt; '/Users/gary/Desktop/Writeups/pe-answers-agent.txt' }


# Create an Instance
ec2_ip = Puppet::Face[:node_aws, :current].create(arguments)

# List instances
instances = Puppet::Face[:node_aws, :current].list(list_args)

# Install Puppet
install_node = Puppet::Face[:node, :current].install(ec2_ip, install_args)  

# Terminate an instance
Puppet::Face[:node_aws, :current].terminate(ec2_ip, list_args)</code></pre></noscript></div>


<p>Want to know how much code it took to do that?  About this much:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="o">%</span> <span class="n">gist</span> <span class="mi">3218523</span> <span class="o">%</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For a blog with a ton of code, something like this is pretty damn important.</p>

<h2>Markdown formatting</h2>

<p><a href="http://daringfireball.net/projects/markdown/">Markdown</a> is becoming more prolific as a lightweight way to format
text. If you&#8217;ve used Github to comment on code, then you&#8217;ve probably used
markdown syntax at some point in your life. You&#8217;ll notice the recurring goal of
being quick and precise, and markdown really &#8216;does it for me&#8217;.</p>

<h2>Workflow++</h2>

<p>It&#8217;s really liberating to write a blog post in (insert favorite text editor).
Travelling as often as I do, I&#8217;m usually jotting down notes in vi because I&#8217;m
in a plane or somewhere without internet access. Octopress not only lets you
write offline, but it will let you generate and preview your site locally
while being offline. That&#8217;s totally handy.  My workflow typically looks like
this:</p>

<ul>
<li><strong>Generate a post</strong></li>
</ul>


<p>To start a new post, you can create a new file by hand, or use the
provided Rakefile to scaffold it out for you (NOTE: to see all commands
available to the Rakefile, you can run <code>rake -T</code>). Here&#8217;s how to scaffold
with rake:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="s1">&#39;new_post[&quot;Title of my post&quot;]&#39;</span>
</span><span class='line'><span class="err">$</span> <span class="n">vi</span> <span class="n">source</span><span class="o">/</span><span class="n">_posts</span><span class="o">/</span><span class="mi">2013</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">17</span><span class="o">-</span><span class="n">title</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">post</span><span class="o">.</span><span class="n">markdown</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Edit the post file</strong></li>
<li><strong>Generate the site content</strong></li>
</ul>


<p>Remember that Octopress/Jekyll generates static content to be uploaded to
your host. With every change, you&#8217;ll need to re-generate the content. Yeah,
that kinda sucks, but that action has been abstracted away in the Rakefile
with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="n">generate</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>Display and view the site</strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rake</span> <span class="n">preview</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following command will serve up your page over Webrick in the terminal,
just navigate to <a href="http://localhost:4000">http://localhost:4000</a> in your browser to see a local copy of
how your site will look once deployed. Once you&#8217;re done, just do a Control+c
from your terminal to cancel the process.</p>

<ul>
<li><strong>Edit/generate/preview until done</strong></li>
<li><strong>Commit your code and deploy</strong></li>
</ul>


<p>Because everything is a series of flat-files, you can use git to keep it all
under version control. Did you make a mistake? Revert to a previous commit.
Deploying to your blog is similarly easy, as you&#8217;ll see in the next steps</p>

<h2>Be a unique snowflake</h2>

<p>I <a href="http://blog.bigdinosaur.org/changing-octopresss-header/">used this article</a> to help
change the color scheme of my blog, and <a href="https://github.com/imathis/octopress/wiki/Octopress-Sites">checked out a list of other Octopress sites</a>
to steal a couple of other tweaks. That&#8217;s all I needed for customization, but
if you need more knobs they&#8217;re there for you to twist.</p>

<h2>Hosted by your pals at Github</h2>

<p><a href="http://pages.github.com/">Github Pages</a> is a free service for any Github user (again free to join) and
is an EXCELLENT FIT for an Octopress blog. As you would expect, Octopress
has <a href="http://octopress.org/docs/deploying/github/">great documentation for enabling deployment to Github Pages</a>.
If you have your own custom domain, you can STILL use Github Pages
(hint, the instructions are on that page too).</p>

<h2>Fuck it. Ship it.</h2>

<p>The act of updating a blog has GOT to be frictionless. Is this simple enough
for you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep. That&#8217;s all it takes to deploy code to your blog once you&#8217;ve setup Github
Pages. Forget about logging in, wading through a GUI, cutting/pasting content,
FTPing things up to a host, and any of that crap. I&#8217;ve done that. &#8216;That&#8217; sucks.</p>

<h2>Write your own damn blog</h2>

<p>You now have no excuse to NOT share all the cool things you&#8217;re doing. Seriously,
if you can EDIT A TEXT FILE then you can &#8216;maintain&#8217; a blog.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JAMF NetSUS Appliance]]></title>
    <link href="http://glarizza.github.com/blog/2012/02/06/jamf-netsus-appliance/"/>
    <updated>2012-02-06T11:22:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2012/02/06/jamf-netsus-appliance</id>
    <content type="html"><![CDATA[<h2>JAMF&#8217;s NetSUS Appliance - Netboot in a Box</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">Today, JAMF released a new appliance VM</a> based on Ubuntu 10.04 LTS (Lucid) that, for once, provides an &#8216;out of the box&#8217; implementation of Netboot and Software Update Service WITHOUT requiring OS X hardware (based on <a href="http://github.com/wdas/reposado">Reposado</a>) and <a href="http://twitpic.com/8glygw">other open-source technologies.</a></p>

<p>For those people who are relatively new to Linux, I thought I&#8217;d provide an easy walkthrough of how to get started using this VM on your Laptop.  I&#8217;m going to demo this using VMware Fusion instead of VirtualBox mainly because I prefer how Fusion handles Networking.  I&#8217;ve used many VMs, and Fusion always tends to be much more solid and stable for me.  If you don&#8217;t have Fusion or don&#8217;t WANT to use Fusion, feel free to use VirtualBox.</p>

<h2>Download and Convert the OVA File</h2>

<p><a href="https://jamfnation.jamfsoftware.com/viewProduct.html?id=180">The appliance can be downloaded directly from JAMF</a> and comes as a VirtualBox OVA file.  <a href="http://derflounder.wordpress.com/2012/02/06/converting-jamfs-netbootsus-appliance-to-vmware/">Rich Trouton has provided a great walkthrough</a> on converting the OVA file to a VMX file, so I&#8217;ll link you to that post (since he did it so well).</p>

<h2>Start up the VM</h2>

<p>Once you have your VMX file, you can open it up with Fusion and import it into your Virtual Machine Library.  There is one change we&#8217;ll want to make, so click on the VM and open its Settings panel (this is different from Fusion 3.0 and 4.0 - I&#8217;ll be describing the 4.0 method).  In the Settings panel, you&#8217;ll want to select the Network Adapter icon and make sure the radio button next to &#8220;Share the Mac&#8217;s network connection (NAT)&#8221; is selected.  This will create a local IP address so we can contact it directly from our Laptop.  Once you&#8217;ve done that, start the VM and get to the login screen (you&#8217;ll need to click the Ok button through the message about logging into the NetSUS instance).  Feel free to login with the username &#8216;shelluser&#8217; and the password &#8216;shelluser&#8217;.  You should see a Message of the Day splash with one of the sections being &#8220;IP address for eth0:&#8221;.  Note the IP address, we&#8217;ll need it in the next section (if you don&#8217;t see this, just run <code>ifconfig</code> from the command line and look for the IP address for the eth0 adapter - it should be in the format of 192.168.x.x).</p>

<h2>Prepare to Break Free!</h2>

<p>It really sucks to work with VMs from WITHIN the VM window for various reasons (lack of Copy/Paste, loss of mouse, etcâ€¦), so we&#8217;re going to setup a host entry on your local laptop so we can SSH into the VM as we need.  I&#8217;m going to give my VM a hostname of &#8216;netsus.puppetlabs.vm&#8217; but you can name it whatever you want.  Let&#8217;s first edit the /etc/hosts file on your laptop (NOT within the VM, this is ON your laptop) by running the following from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/hosts</span></code></pre></td></tr></table></div></figure>


<p>Feel free to use pico/nano to edit /etc/hosts in case you don&#8217;t have any experience with vim.  We want to add the following line in the /etc/hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.217.154 netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE</strong> SUBSTITUTE 192.168.217.154 WITH THE IP ADDRESS YOU GOT FROM THE PREVIOUS STEP!  That&#8217;s the IP address that was assigned on MY laptop, and it will definitely be different from the IP address you got on YOUR computer.  Also, you don&#8217;t HAVE to use &#8216;netsus.puppetlabs.vm&#8217; - you can assign it any name you want.  Save and close /etc/hosts and then let&#8217;s test connectivity from the command line by doing a ping:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ping 192.168.217.154</span></code></pre></td></tr></table></div></figure>


<p>As long as we have connection, we&#8217;re fine (remember, substitute your IP Address for mine).  If you DON&#8217;T have connectivity, make sure your VM is running and review your /etc/hosts file to make sure the changes were saved (also, check the IP address on your VM again).</p>

<h2>Snapshot Time</h2>

<p>The beauty of Fusion is that you can take snapshots and revert to them should you mess things up.  Let&#8217;s take a snapshot now in case we screw things up in the following steps.  I&#8217;m using VMware Fusion 4.0, so I take a snapshot by clicking on the VM window, clicking on the Virtual Machine menu at the top, and then down to Snapshots.  From there, you can click the &#8216;Take Snapshot&#8217; button and let it do its thing.  When it&#8217;s done, hit the close button and return to the VM</p>

<h2>Enable SSH and Login</h2>

<p>By default, the VM doesn&#8217;t have the SSHD process running, so we can&#8217;t yet SSH in from our laptop.  Enable this by doing the following from within the VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install openssh-server</span></code></pre></td></tr></table></div></figure>


<p>Hit &#8220;Y&#8221; when it asks if it should download and install.  When it completes, switch back to your LAPTOP (i.e. NOT inside the VM), open up Terminal, and do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh shelluser@netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Type yes to add the SSH key to your known_hosts file and use the password &#8216;shelluser&#8217; to login.  Tada! Now you can work directly from Terminal and enable copy/pasting directly from your Terminal window.  You can always type <code>exit</code> to close the ssh connection when you&#8217;re done.</p>

<h2>Install Puppet</h2>

<p>So, it wouldn&#8217;t be one of my write-ups if I DIDN&#8217;T get Puppet installed.  Actually, if you&#8217;ve only managed Macs, then you might not have seen the benefit of Puppet before.  Now that we&#8217;re on Linux, you&#8217;ll definitely see the benefit of Puppet (especially if you&#8217;re not familiar with the service/package manipulation commands).  Puppet can help abstract that for you, so we&#8217;re going to enable it.</p>

<p>The version of Puppet that&#8217;s in the main package repository is quite old (0.25 as opposed to the current 2.7.10 version we support).  Let&#8217;s add Puppet Labs&#8217; Apt Repository to the list of repositories queried so we can get a recent version of Puppet.  Do that by opening up the /etc/apt/sources.list file for editing with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo vim /etc/apt/sources.list</span></code></pre></td></tr></table></div></figure>


<p>If it prompts you for your password, go ahead and enter it.  Also, if you&#8217;re not familiar with vi or vim, I&#8217;ll try and help you with the basics.  Arrow down to the line JUST above the line that begins with &#8220;deb http://&#8221; and press the i button on your keyboard to insert the following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://apt.puppetlabs.com/ubuntu lucid main
</span><span class='line'>deb-src http://apt.puppetlabs.com/ubuntu lucid main</span></code></pre></td></tr></table></div></figure>


<p>When you&#8217;re done, hit the escape key and press ZZ (hold shift and hit Z twice, you want two capital-Z&#8217;s) to save and close the file.  This will add Puppet Labs&#8217; repository to the list of repos queried.</p>

<p>Next, we&#8217;ll need to add Puppet Labs&#8217; GPG key to the system so we can validate the packages that are downloaded.  From the terminal, execute the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>The first time you run it, it will bother you about needing to create the keyserver file and won&#8217;t run correctly.  Let&#8217;s execute it correctly to receive the key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> gpg --recv-key 4BD6EC30</span></code></pre></td></tr></table></div></figure>


<p>Great, we should have the key, now we want to load it.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpg -a --export 4BD6EC30 | sudo apt-key add -</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s update apt so that it knows about the repository.  Do that with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get update</span></code></pre></td></tr></table></div></figure>


<p>When it finishes running, you can finally install Puppet with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install puppet</span></code></pre></td></tr></table></div></figure>


<p>Type &#8220;Y&#8221; when it asks you if it should download and install all the dependencies.  That&#8217;s it!  Puppet should be installed!  Run the following to see what version we&#8217;ve installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet --version</span></code></pre></td></tr></table></div></figure>


<p>As of this writing, 2.7.10 is the current version.  As long as you don&#8217;t have version 0.25 you should be good!</p>

<h2>Snapshots away</h2>

<p>It would be wise to take another snapshot at this point.  Don&#8217;t worry, I&#8217;ll wait.</p>

<h2>Inspect the System</h2>

<p>Puppet lets us see what&#8217;s been installed on the VM.  Take a look at all the packages on the system by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource package</span></code></pre></td></tr></table></div></figure>


<p>Type your password when prompted and Puppet will return you with a list of all packages on the system and the versions that are running.  Similarly, you can see what services are running with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo puppet resource service</span></code></pre></td></tr></table></div></figure>


<p>Notice that sshd is running and other services like netatalk (that enables AFP on Linux) should also be running.  Sweet.  We&#8217;ll come back to Puppet later.</p>

<h2>Login to the Web GUI</h2>

<p>If your VM is running, you should be able to open a web browser on your Laptop and navigate to the following address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://netsus.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>Note the httpS as we&#8217;ll need to use SSL to get into the Web GUI.  When it asks if you want to accept the self-signed cert, make sure to choose Yes.  You can login with the user &#8216;webadmin&#8217; and the password &#8216;webadmin&#8217;</p>

<p>Once you&#8217;re logged in, <a href="https://s3.amazonaws.com/jamfsoftware-content/downloads/NetBootSUS+Appliance_v1.0.pdf">feel free to read through JAMF&#8217;s instructions for enabling their services.</a>  They do a much better job than I about walking you through that.</p>

<h2>Access to the Raw Files</h2>

<p>Back in the Terminal window, you can access all the PHP/Shell magic that comprises the Web GUI in the /var/www/webadmin directory.  You can poke around through all the files (and use sudo to open some of the key bits) at your leisure.</p>

<p>Note that /etc/dhcpd.conf is the main configuration file for the DHCPD service and it&#8217;s got some special bits to accommodate Apple Hardware.</p>

<p>Also, /var/appliance has some magic (and the /var/appliance/configurefornetboot script has some sed statements for fixing a stock dhcpd.conf file and enabling those Apple Hardware bits).</p>

<h2>More Later?</h2>

<p>That&#8217;s it for now - I just wanted to get something online to show people how to setup and poke around in the VM.  Later I can show you how to manipulate and manage the VM with Puppet, which is pretty fun.  Your VM should get you started and let you play around locally, but if you want to test out Netboot and the like then you&#8217;ll need an externally-accessible IP address (as apposed to the 192.168.x.x IP, which is only accessible from your Laptop).  You can change the settings in VMware Fusion to enable that (like we did in step 2).</p>

<p>Hope this helped you out!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Git for Mac Sysadmins]]></title>
    <link href="http://glarizza.github.com/blog/2012/01/24/using-git-for-mac-sysadmins/"/>
    <updated>2012-01-24T15:25:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2012/01/24/using-git-for-mac-sysadmins</id>
    <content type="html"><![CDATA[<p>As a former Mac Sysadmin, I frequently felt like I had one toe in the world in which Linux Sysadmins frequently found themselves, but was surrounded by a culture of GUI-Clickery that either feared, scorned, or flat-out avoided tools that were command-line based (or, as many will point out, used the GUI (Graphic User Interface) tools because &#8216;they worked&#8217; and that was all they needed).  This sucked because Linux Sysadmins have some tools that, as a current colleague would say, &#8216;are kind-of awesome.&#8217;</p>

<p>One of those tools is Git, which is a Distributed Version Control System (or, DVCS).  Git, in a TOTAL nutshell, is a tool that allows you to create multiple &#8216;what-if scenarios&#8217; with very little cost and the ability to save yourself from&#8230;well, yourself.</p>

<h2>Yes - You&#8217;re Going to Use the Command Line</h2>

<p>Like I mentioned before, the GUI is ingrained in the culture of the Mac.  It wasn&#8217;t until OS X that Mac Sysadmins finally had a proper command-line (which I will refer to as the CLI, which is short for Command Line Interface.  If you&#8217;re not familiar with that terminology, I&#8217;m speaking about the interface you get when you run /Applications/Utilities/Terminal.app), so we&#8217;re a bit &#8216;new&#8217; to the whole idea.  I can help you if you fear or avoid the CLI; there&#8217;s always room for learning and I&#8217;ll try to hold your hand as much as possible.  For those that downright refuse to use the CLI&#8230;well, I&#8217;m sorry?</p>

<h2>What IS Git?</h2>

<p>Git is relatively new in the DVCS world (being initially released in 2005).  Developers have been using DVCS for MANY years with tools like CVS, Subversion, Git, Mercurial, and others.  For a team of developers who ALL need to make contributions to a SINGLE project or code base, it&#8217;s vital that they have a way to modify a file without breaking something that someone else is doing.  That&#8217;s what DVCS tools do - allow you to take something as large as a code base like OS X 10.7 (or something as small as a directory with a couple of files) and make changes without affecting everyone else who&#8217;s working on the SAME code base (or files in the directory).</p>

<p>So why am I choosing to talk about Git instead of, say, Subversion?  That&#8217;s easy: lightweight branching and merging.  Git allows you to easily create a &#8216;topic branch&#8217; (or, using the metaphor above, a &#8216;what-if scenario&#8217;), make changes, and see if your changes are favorable or if they downright stink. If your changes are desirable, you can then &#8216;merge&#8217; your topic branch back in with your master branch (or, the original state the files were in when you created the topic branch in the first place).  If the changes don&#8217;t work well, you can just delete the topic branch and &#8216;no-harm, no-foul&#8217;; your original files remain unchanged and in the pristine condition that they existed when you first created the topic branch.  True, Subversion could do the same thing, but Git allows MANY people to do the same thing and then EASILY merge in EVERYONE&#8217;S changes without having to fight Subversion (just trust me on this if you&#8217;ve never used Subversion).</p>

<p>And why am I choosing to talk about Git instead of Mercurial?  Easy - Git is what I learned :)  As I understand it Mercurial functions similarly, and I truly don&#8217;t have the experience with Mercurial to tell you the differences.  I&#8217;m talking about Git because Git is what I use and Git is what my company uses.</p>

<h2>So what does this have to do with me as a Mac Sysadmin?</h2>

<p>Good question.  Mac Sysadmins are more frequently finding themselves having to use the CLI to tune their clients and servers.  Also, many Mac Sysadmins are finding that certain CLI tools are working better for their teams (in terms of simplicity, responsibility, and visibility).  As they dip their toes into this CLI world, they&#8217;re finding that they want the same features they had in the GUI: the ability to do a &#8216;save-as&#8217;, to create &#8216;versions&#8217;, and to have the ability to have a rollback function similar to Time Machine.  Git gives you this through the CLI (or, yes, even through the GUI as I will mention later in the article).</p>

<p>If you&#8217;re ready to take that step then follow me&hellip;</p>

<h2>A note on Git and Github</h2>

<p>You might have heard of <a href="http://www.github.com">Github</a>.  Github is a free (they have a free tier and plenty of subscription tiers of service) service that allows you to &#8216;push&#8217; your git repositories up to them for storage in &#8216;the cloud&#8217;.  Github is basically centralized-storage for your git repositories and is NOT NECESSARY for you to use git as a tool.  In reality, you CAN use Github or setup something like Gitolite on a local server in your environment to get most of the benefits of Github without having to push your repositories to Github&#8217;s servers.</p>

<p>The bottom line: Github and git (the tool) are two different things.  Github didn&#8217;t create git, and git doesn&#8217;t need Github to work properly.  Keep that in mind as you read through.</p>

<h2>Installing Git</h2>

<p>Git can be installed in a variety of ways.  First and foremost, you can download the latest package from <a href="http://code.google.com/p/git-osx-installer/">Git&#8217;s Googlecode Page</a>.  You can also choose to install git through Macports or Homebrew as long as you have them installed (both of which require the Developer Tools&#8230;but so does The Luggage, the tool we&#8217;ll be using later).  Simply download the package from <a href="http://code.google.com/p/git-osx-installer/">Git&#8217;s Googlecode Page</a>, install it, and you should be good to go!</p>

<p>If you&#8217;re using Macports, make sure the Developer Tools are installed, Macports is installed, and then do the following from the command line (<strong>PLEASE NOTE: The dollar sign is a prompt - you SHOULDN&#8217;T type it.  Lines BEGINNING with a dollar sign, or a prompt, should be typed by you.  Lines that DON&#8217;T begin with a prompt represent the output you receive from typing the command.  If you don&#8217;t see a line that DOESN&#8217;T begin with a prompt, then I&#8217;m not listing the output.  Got it?  Good!</strong>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo port install git-core</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re using Homebrew, make sure the Developer Tools are installed, Homebrew is installed, and then do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo brew install git</span></code></pre></td></tr></table></div></figure>


<p>To check to see where and what version of git is installed, execute the following commands :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ which git
</span><span class='line'>$ git --version</span></code></pre></td></tr></table></div></figure>


<p>You should receive the path to where git is installed after you run the first command, and you should receive the version of git that&#8217;s currently installed on your system.  Any version of Git greater-than or equal to 1.7 is probably ideal, though most of the commands we&#8217;ll be using will probably work just fine with previous versions.</p>

<h2>Your first Git repo</h2>

<p>I find it&#8217;s easier to understand Git if I describe an actual scenario instead of talking in terms of &#8216;git can do&#8230;&#8217;.  I&#8217;m going to talk about using git with <a href="http://github.com/unixorn/luggage">The Luggage</a>.  <a href="http://glarizza.posterous.com/an-intro-to-using-the-luggage-for-packaging">I&#8217;ve written about The Luggage in several articles on this site</a>, so feel free to familiarize yourself with it if you haven&#8217;t used the tool before.  As a quick review, The Luggage is a tool that lets you create plain text Makefiles that can be used to build packages to install files, deploy scripts, and basically distribute &#8216;things&#8217; to the users in your organization.  Auditing HOW a package is made can be incredibly difficult for a team of sysadmins, but The Luggage helps you with this by using plain text Makefiles.  Git will give you the ability to track WHO made changes, WHEN they were made, and ROLLBACK the changes if you notice something undesirable happening.  Git and The Luggage are a perfect combo if you&#8217;re a sysadmin.</p>

<p>Incidentally, The Luggage exists as a Github repository, so we have to CLONE it (or download it) from Github first before we can start playing with it.  I recommend creating a directory in your home directory (/Users/-username-) and cloning your repositories there - that way you retain ownership of the files and can work on them at will.  I put all my git repositories in ~/src, but if you&#8217;re using something like Mobile Home Directories or even Network Home Directories, then you&#8217;ll want to make sure that you&#8217;re not syncing these directories back to some central location and burning up your quota in some fashion.  Let&#8217;s create our repositories directory and clone The Luggage source code with these steps:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/src
</span><span class='line'>$ cd ~/src
</span><span class='line'>$ git clone git://github.com/unixorn/luggage.git</span></code></pre></td></tr></table></div></figure>


<p>Doing this will create the ~/src directory where we&#8217;re putting all our repositories and download The Luggage source code to ~/src/luggage.  As you might be able to infer, git clone will clone an existing git repository from its location on another server (we call that the remote location, or just remote for short) down to a local directory.  This is usually how many sysadmins first encounter git - by needing to download something from Github or a remote server.  Let&#8217;s look and see what git knows about this repo by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git remote -v
</span><span class='line'>origin  git://github.com/unixorn/luggage.git (fetch)
</span><span class='line'>origin  git://github.com/unixorn/luggage.git (push)</span></code></pre></td></tr></table></div></figure>


<p>This command will list all the remote repositories that we&#8217;re tracking.  By default, you will get a remote by the name of &#8216;origin&#8217; that lists the location where you originally cloned the repository (in our case, this is Github).</p>

<p>Why is it listed twice?  Well, with git, you can pull down, or fetch, changes from a remote repository as well as push up changes from your LOCAL repository to the remote repository.  Frequently these paths will be the same, but in our case these links are to the READ-ONLY version of this repository, so trying to push changes will always fail because we don&#8217;t have access.  We&#8217;ll talk later about how you can push up changes, but for now let&#8217;s create our OWN repository instead of working with someone ELSE&#8217;S.</p>

<h2>Creating your OWN git repo</h2>

<p>The Luggage has a directory called Examples, but it&#8217;s absent of any actual examples.  We want to create our own directory where we can store our Luggage Examples.  For the purposes of this demo, I&#8217;m going to create a directory called luggage_examples that will contain our&#8230;well&#8230; Luggage examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/src
</span><span class='line'>$ mkdir luggage_examples</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a directory, we need to make sure that git is tracking our changes so that we can create those &#8216;what if&#8217; scenarios and save our work.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/src/luggage_examples
</span><span class='line'>$ git init
</span><span class='line'>Initialized empty Git repository in /Users/gary/src/luggage_examples/.git/</span></code></pre></td></tr></table></div></figure>


<p>Git created a new empty repository at ~/src/luggage_examples and created a .git directory inside luggage_examples.  This .git directory is where git stores all its dynamic data that&#8217;s pertinent to your repository, so MAKE SURE not to delete it or modify any files in there (without knowing what you&#8217;re doing).</p>

<p>That&#8217;s it!  We&#8217;ve created a repository!  Now let&#8217;s actually see how git works locally on your machine.</p>

<h2>Working with Files</h2>

<p>As I mentioned before, you don&#8217;t NEED Github to use git.  Git functions as a mechanism to &#8216;version&#8217; your files so you can rollback to a previous version or create our &#8216;what-if&#8217; scenarios and then accept (merge) or deny (destroy) them depending on our needs.  You can easily create a git repository on your local computer ONLY, but of course you lose the ability to restore your work if your hard drive malfunctions.  This is what Github gives us, and we&#8217;ll look at that functionality later.</p>

<p>The example I&#8217;m going to use is based on the previous blog post I wrote on <a href="http://glarizza.posterous.com/using-googles-crankd-application-tracking-cod">Using the Google Mac Sysops Crankd Code</a>  Let&#8217;s create a directory for this example and create a starter Makefile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/src/luggage_examples/crankd_google
</span><span class='line'>$ cd ~/src/luggage_examples/crankd_google
</span><span class='line'>$ vim Makefile</span></code></pre></td></tr></table></div></figure>


<p>I use vi or vim to edit files from the Terminal.  Feel free to use any text editor you like (nano, emacs, Textmate, TextWrangler, etc&#8230;), but CREATE a file called &#8216;Makefile&#8217; (note the capital M) and put it in ~/src/luggage_examples/crankd_google.  Here&#8217;s what I&#8217;ll put into this file:</p>

<figure class='code'><figcaption><span>Crankd Luggage Example  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    # Title:       Crankd-Google Example</span>
</span><span class='line'><span class="c">    # Author:      Gary Larizza</span>
</span><span class='line'><span class="c">    # Description: Something so Marnin doesn&#39;t kill me w/ postinstalls :)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">    include /Users/gary/src/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>Crankd-Google
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.googlecode
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span>pack-crankd
</span></code></pre></td></tr></table></div></figure>


<p>Great, so we have our skeleton of a file!  The file is saved in our folder, but we haven&#8217;t actually told git to track the file (and so git is AWARE that the file EXISTS, but it isn&#8217;t tracking its changes&#8230;yet).  This is a good time to explain the three states in which files can exist in a git repository.</p>

<h2>The Three Stages of Files: Working Tree, Index, and Repository</h2>

<p>Git has three &#8216;locations&#8217; by which a file can exist (even though it technically exists, in our case, in ~/src/luggage_examples/crankd_google).  These three locations are called the working tree, the index, and the repository</p>

<h2>The Working Tree</h2>

<p>When you put a file in a directory that&#8217;s being managed by git, but you haven&#8217;t told git to track the files changes, then this file is said to be in the working tree.  Our file we just created, Makefile, exists in the working tree currently.  Git knows that the file EXISTS, but it hasn&#8217;t saved the file&#8217;s &#8216;state&#8217; so we can rollback the file if need be.</p>

<h2>The Index</h2>

<p>The index is also known as the cache or the staging area, and it&#8217;s a place to put files before you&#8217;re ready to make a &#8216;commit&#8217; (which is something of a &#8216;milestone&#8217; or a version).  A commit is a representation of a point in time in the history of your git repository.  Think of it as a snapshot of your repository - &#8216;this is how our files looked at this specific time&#8217;.  With commits, you can always rollback to a specific &#8216;commit&#8217; (or even advance to a future commit if you had rolled-back to an earlier commit).  In order to rollback to a specific version of a file, though, you need to make a commit, and in order to make a commit you need to tell git what FILES will comprise our commit.  As I mentioned, a commit is just a point in time&#8230;but it doesn&#8217;t HAVE to be a point in time for a SINGLE file.  A commit can represent a specific point in time for a NUMBER of files all at once.  To make life easier for everyone, though, if you make a commit comprised of multiple files, then you want to make sure that the changes to the multiple files all represent a single functional change (for example, say we wanted to change a file that existed in our crankd_google folder that was being copied into a package, but we ALSO had to change the Makefile to change WHERE this file was to be put in the final package.  These two changes are related and comprise a single functional change, so you would want to make a commit with the changes to both files at once.).</p>

<p>Our Makefile exists in the working tree currently, but we want to put it in the index because we&#8217;re ready to make a commit (no, our Makefile functionally doesn&#8217;t DO anything yet, but we want to make a commit so we can rollback to this point in time should we mess up anything).  Understand that the locations of the &#8216;working tree&#8217; and &#8216;index&#8217; are relative to git ONLY.  Yes, this file lives in ~/src/luggage_examples, and it will CONTINUE to exist in that directory (as far as the OS X filesystem is concerned), but to git it currently exists in the working tree.  How do we know that the file is in the working tree and NOT in the index?  Use the git status command to show you that info:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git status
</span><span class='line'>
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Untracked files:
</span><span class='line'>#   (use "git add ..." to include in what will be committed)
</span><span class='line'>#
</span><span class='line'># Makefile
</span><span class='line'>nothing added to commit but untracked files present (use "git add" to track)</span></code></pre></td></tr></table></div></figure>


<p>Anything listed under &#8216;Untracked files:&#8217; is in the working tree.  You can add a file to the index by doing the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add Makefile
</span><span class='line'>$ git status
</span><span class='line'>
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Changes to be committed:
</span><span class='line'>#   (use "git rm --cached ..." to unstage)
</span><span class='line'>#
</span><span class='line'># new file:   Makefile
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Great, the file is in the index!  Notice that the file is listed under &#8216;Changes to be committed:&#8217; meaning that it&#8217;s in the index but NOT YET committed (or, &#8216;in the repository&#8217;).</p>

<h2>The Repository</h2>

<p>The Repository is where your files exist once they&#8217;ve been made part of a commit.  As I mentioned before, files must be committed before we can roll back their states (and their states can only be rolled back to individual commits).  You can never rollback a file&#8217;s state UNLESS it&#8217;s tied to a commit.  If you made a commit to a file last week and haven&#8217;t made another since, but wanted to revert a file to how it existed three days ago, you would be out of luck.  Git ONLY rolls back to specific commits (this is why it&#8217;s important to make frequent commits).  Before we make a commit, however, we need to make sure to identify ourself to git (if you haven&#8217;t previously set this up).  The user.email and user.name settings are the most important settings as they will be used to trace back what code you committed.  If you&#8217;re not sure of how git is setup, use the following command to list the git config settings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git config -l
</span><span class='line'>user.name=Gary Larizza
</span><span class='line'>user.email=gary@puppetlabs.com</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Should the user.name and user.email settings NOT be configured, you can configure them with the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git config user.name 'Your name'
</span><span class='line'>$ git config user.email your@email.com</span></code></pre></td></tr></table></div></figure>


<p>Now that you&#8217;ve been identified (so we can lay the blame on you in the future), let&#8217;s actually commit some code.  The <strong>git commit</strong> command allows git to commit all staged files to the repository in one fell swoop.</p>

<p>Every commit has three things: the list of files and CONTENT of the files that should be committed, a SHA1 hash value representing the commit itself (essentially, a unique identifier for the commit so it can be tracked), and the commit message describing the what and why of the commit.</p>

<p><strong>Creating a commit message seems insignificant but should NOT be taken lightly.</strong>  Great commit messages usually consist of a title line containing no more than 60 characters followed by a paragraph describing the changes.  Because many people may potentially need to trace your code and commits, it&#8217;s important to list how your code functioned previously, the reasoning behind the change, and what specifically was changed.  Don&#8217;t skimp with your commit messages!  Always assume that the next person to maintain your code owns many dangerous weapons and knows where you sleep, so do that person a favor and be as kind to them (in the form of great commit messages) as possible!</p>

<p>Let&#8217;s begin the process of making a commit by issuing the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git commit</span></code></pre></td></tr></table></div></figure>


<p>Executing <strong>git commit</strong> will drop you into the default text editor (which is vim by default - you can change this by running <strong>git config core.editor /path/to/your/editor</strong> before doing git commit) and show the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Please enter the commit message for your changes. Lines starting
</span><span class='line'># with '#' will be ignored, and an empty message aborts the commit.
</span><span class='line'># On branch master
</span><span class='line'>#
</span><span class='line'># Initial commit
</span><span class='line'>#
</span><span class='line'># Changes to be committed:
</span><span class='line'>#   (use "git rm --cached ..." to unstage)
</span><span class='line'>#
</span><span class='line'># new file:   Makefile
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<p>Note that everything that begins with a hash ( # ) is solely for YOUR benefit and will be stripped out of the commit message, so don&#8217;t worry about it being included.  Here&#8217;s an example of a commit message I would use in this instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Initial commit for crankd_google code
</span><span class='line'>
</span><span class='line'>Previously we didn't have an example for creating a package of the 
</span><span class='line'>Google Mac Sysops code.  This commit adds the shell for the Makefile and
</span><span class='line'>includes the luggage.make file in ~/src/luggage.</span></code></pre></td></tr></table></div></figure>


<p>Great!  When you save and close your editor, you should see something that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[master (root-commit) f423ac6] Initial commit for crankd_google code
</span><span class='line'> 1 files changed, 9 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 Makefile</span></code></pre></td></tr></table></div></figure>


<p>This tells us that we made a commit on the master branch with a SHA1 hash ID beginning in f423ac6 being attributed to this commit.  In most cases, the first 7 digits of the hash are all you need for uniqueness when you refer to this commit, and that&#8217;s usually all that git will provide you in THIS instance.  YOUR SHA1 hash won&#8217;t match the hash provided above (hence a unique ID), so don&#8217;t panic if it doesn&#8217;t match up for you.  And that&#8217;s it!  We&#8217;ve done it!  Now what?</p>

<h2>Examining your Work</h2>

<p>Git tracks the ENTIRE history of a repository, and thus will track any and every commit made.  To display this history, run the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git log
</span><span class='line'>commit f423ac6e9548d93f53b15d1154723c5abcd69738
</span><span class='line'>Author: Gary Larizza 
</span><span class='line'>Date:   Sun Jan 22 23:27:31 2012 -0500
</span><span class='line'>
</span><span class='line'>    Initial commit for crankd_google code
</span><span class='line'>
</span><span class='line'>    Previously we didn't have an example for creating a package of the
</span><span class='line'>    Google Mac Sysops code.  This commit adds the shell for the Makefile and
</span><span class='line'>    includes the luggage.make file in ~/src/luggage.</span></code></pre></td></tr></table></div></figure>


<p>By default, git log will show ALL information about ALL of your commits (including the full commit message).  There&#8217;s a LARGE number of arguments that git log will accept that allows you to format the output for ANY purpose.  One of the common lists of arguments that I like to employ is the following (long) command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git log --pretty=format:'%C(yellow)%h%C(reset) %s %C(cyan)%cr%C(reset) %C(blue)%an%C(reset) %C(green)%d%C(reset)' --graph --date-order
</span><span class='line'>* f423ac6 Initial commit for crankd_google code 10 minutes ago Gary Larizza  (HEAD, master)</span></code></pre></td></tr></table></div></figure>


<p>This format both colorizes the output for readability and also shows a nice graph of commits as you do things like branching and merging.  Here&#8217;s an example of this command (with line length chopped for brevity) being run on a repository with many commits:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* 72a2fe0 (#5445) Create /var/lib/puppet in OS X Package 26 hours ago Gary Larizza  (HEAD, gary/bug/2.7.x/5445_crea
</span><span class='line'>*   c6667c5 Merge pull request #324 from glarizza/bug/2.7.x/2273_launchd_dashw 12 days ago Daniel Pittman  (origin/
</span><span class='line'>|\  
</span><span class='line'>* \   bc6c642 Merge pull request #318 from glarizza/bug/2.7.x/11202_apple_rake 12 days ago Michael Stahnke 
</span><span class='line'>|\ \  
</span><span class='line'>| * | 6c14a28 Build a Rake task for building Apple Packages 12 days ago Gary Larizza  (gary/bug/2.7.x/11202_apple_r
</span><span class='line'>* | |   5ec5657 Merge pull request #127 from adrienthebo/ticket/2.7.x/8341-prevent_duplicate_loading_of_facts 12 da
</span><span class='line'>|\ \ \  
</span><span class='line'>* \ \ \   450da6a Merge pull request #92 from duritong/tickets/2.7.x/1886 12 days ago Daniel Pittman 
</span><span class='line'>|\ \ \ \  
</span><span class='line'>| | | | * d5bef5e (#2773) Use launchctl load -w in launchd provider 12 days ago Gary Larizza  (gary/bug/2.7.x/2273_
</span><span class='line'>* | | | |   1cb2b6a Merge branch 'ticket/2.7.x/11714-envpuppet' into 2.7.x 12 days ago Josh Cooper 
</span><span class='line'>|\ \ \ \ \  
</span><span class='line'>| |_|_|_|/  
</span><span class='line'>|/| | | |   
</span><span class='line'>| * | | | 5accc69 (#11714) Use **%~dp0** to resolve bat file's install directory 12 days ago Josh Cooper 
</span><span class='line'>* | | | |   fe79537 Merge pull request #323 from glarizza/bug/2.7.x/fix_launchd_spec 12 days ago Jeff McCune 
</span><span class='line'>|\ \ \ \ \  
</span><span class='line'>| * | | | | c865a80 Clean up launchd spec tests 12 days ago Gary Larizza  (gary/bug/2.7.x/fix_launchd_spec, bug/2.7
</span><span class='line'>|/ / / / /</span></code></pre></td></tr></table></div></figure>


<p>As you can see, git log is powerful and handy to list out what&#8217;s happened to your repository.  You&#8217;ll also notice that it lists WHO made the changes, which is handy if you have MANY people contributing to the same code base.</p>

<h2>That&#8217;s it for now</h2>

<p>Hey , what gives?! We haven&#8217;t really DONE anything!  Git has a tremendous amount of power, and it&#8217;s important to know WHAT&#8217;S happening before I can progress and show you the power of git.  This article is ALREADY quite long, so I&#8217;ve broken it up for &#8216;easier&#8217; reading.  Rest assured, in parts 2 and beyond we will modify files, create topic branches, merge topic branches, use Github (for backup AND to allow others to contribute to your project), and much more.  Stay tuned for the following article(s) and as always, put any questions in the comments or email me directly!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using the Google Macops Crankd and Facter Code]]></title>
    <link href="http://glarizza.github.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code/"/>
    <updated>2011-12-31T00:00:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code</id>
    <content type="html"><![CDATA[<p>On December 21st, the MacOps team at Google released a Googlecode repository containing a couple of scripts that they use for managing Macs.  The scripts provided interface with <a href="http://code.google.com/p/pymacadmin/">crankd (available in the Pymacadmin code suite)</a> and <a href="http://puppetlabs.com/puppet/related-projects/facter/">Facter</a>, which are a couple of tools with which you MIGHT not be familiar.</p>

<p>I saw a couple of questions on the ##osx-server IRC channel about how these scripts work, and I decided to do a quick writeup on how you would implement the scripts in your environment.  This is meant to be a walkthrough to getting their scripts up-and-running, but please READ EVERYTHING FIRST before implementing.</p>

<h2>Prepare Crankd:</h2>

<p>Crankd is a vital part of the Google MacOps puzzle.  Crankd essentially executes Python code in response to System/Network events on your system.  I have MUCH MORE information on crankd <a href="http://glarizza.posterous.com/using-crankd-to-react-to-network-events">in a guide I posted a while back</a>, but I&#8217;m going to give you the &#8216;quick version&#8217; for those looking to get started quickly:</p>

<ul>
<li>Clone or download the Pymacadmin Github repo.  If you have git installed you can accomplish that by doing the following from the command line:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/acdha/pymacadmin.git</span></code></pre></td></tr></table></div></figure>


<p>If you DON&#8217;T have git on your machine just visit <a href="https://github.com/acdha/pymacadmin">https://github.com/acdha/pymacadmin</a>, click on the Downloads tab, and download the .tar.gz or .zip version of the repo.  Next, double-click on the resultant file to expand it into a folder.</p>

<ul>
<li>Change to the pymacadmin folder and run the install-crankd.sh script which will install crankd.py into /usr/local/sbin and create /Library/Application Support/crankd  Once you&#8217;ve changed to the pymacadmin source directory, run the following from the command line:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo ./install-crankd.sh</span></code></pre></td></tr></table></div></figure>


<h2>OR&#8230;</h2>

<p>If you already have a Puppet environment configured, I&#8217;ve written a <a href="http://github.com/glarizza/puppetlabs-crankd">module that will install crankd for you.</a> The upside is that this module should work out of the box, but the downside is that I&#8217;ve copied the source to the module&#8217;s files/ directory.  Since Pymacadmin hasn&#8217;t been changed since 2009, though, this shouldn&#8217;t pose a big issue.  Simply copy this module to your modulepath and declare it with the following line in your node declarations:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">crankd</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Download the Google-macops source code</h2>

<p>You can download the source by using subversion with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>svn checkout http://google-macops.googlecode.com/svn/trunk/ google-macops-read-only</span></code></pre></td></tr></table></div></figure>


<p>This will create a folder called &#8216;google-macops-read-only&#8217; in the current directory.</p>

<h2>Copy the Python crankd files</h2>

<p>Change to the directory where you downloaded the Google-macops source code and you will notice two folders: crankd and facter.  Change to the crankd directory and copy all of the python files to /Library/Application Support/crankd with the following command from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo cp *.py /Library/Application\ Support/crankd/</span></code></pre></td></tr></table></div></figure>


<p>This copies two files into /Library/Application Support/crankd: ApplicationUsage.py and NSWorkspaceHandler.py.  The ApplicationUsage.py file contains most of the magic.  In a nutshell, it will create a SQLite database file called /var/db/application_usage.sqlite containing information on applications that are launched and quit (we will inspect this information later), and it will update the database any time an application is (you guessed it) launched or quit.  Crankd provides the mechanism by which the code is run any time an application is launched/quit and these Python files actually update the database with the pertinent information.</p>

<h2>Copy the provided crankd plist to /Library/Preferences</h2>

<p>Changing to the crankd directory in the google-macops-read-only directory you should find a file called &#8216;com.googlecode.pymacadmin.crankd.plist&#8217; which is a sample plist for utilizing Google&#8217;s code that tracks application usage via crankd.  It&#8217;s up to you to merge these Python methods into your existing crankd setup, or utilize the plist they&#8217;ve provided.  The plist essentially says that any time an application is LAUNCHED, you should call the &#8216;OnApplicationLaunch&#8217; method in the NSWorkspaceHandler class, and any time an application is QUIT, you should call the &#8216;OnApplicationQuit&#8217; method in the NSWorkspaceHandler class.  Let&#8217;s accept these conditions and copy their plist into /Library/Preferences (assuming that we don&#8217;t have an existing crankd setup) with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp com.googlecode.pymacadmin.crankd.plist /Library/Preferences</span></code></pre></td></tr></table></div></figure>


<h2>Test out crankd from the command line</h2>

<p>With crankd.py installed, the Python methods copied to /Library/Application Support/crankd, and the com.googlecode.pymacadmin.crankd.plist plist copied to /Library/Preferences, we can finally test out the code to see how it works.  Start crankd with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo /usr/local/sbin/crankd.py --config=/Library/Preferences/com.googlecode.pymacadmin.crankd.plist</span></code></pre></td></tr></table></div></figure>


<p>After entering your password, you should see the following in your terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Loading configuration from /Library/Preferences/com.googlecode.pymacadmin.crankd.plist
</span><span class='line'>INFO: Listening for these NSWorkspace notifications:  NSWorkspaceWillLaunchApplicationNotification, NSWorkspaceDidTerminateApplicationNotification</span></code></pre></td></tr></table></div></figure>


<p>Now, let&#8217;s launch a couple of applications and see how we track their usage through the sqlite database.  Do this by starting Safari and TextEdit, and then closing them (note that you MUST start them fresh - if they&#8217;re already opened make sure to close them, then open them, and THEN close them again).  You should see something that looks like the following in the terminal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Application Launched: bundle_id: com.apple.Safari version: 6534.52.7 path: /Applications/Safari.app
</span><span class='line'>INFO: Application Launched: bundle_id: com.apple.TextEdit version: 264 path: /Applications/TextEdit.app
</span><span class='line'>INFO: Application Quit: bundle_id: com.apple.TextEdit version: 264 path: /Applications/TextEdit.app
</span><span class='line'>INFO: Application Quit: bundle_id: com.apple.Safari version: 6534.52.7 path: /Applications/Safari.app</span></code></pre></td></tr></table></div></figure>


<p>Finally, you can quit crankd from the terminal by holding the control button down and pressing the &#8216;c&#8217; key on your keyboard.</p>

<h2>Inspect the application_usage.sqlite database</h2>

<p>If you&#8217;re proficient in SQL, feel free to browse through the contents of the database.  To keep things simple, let&#8217;s download an app called <a href="http://sourceforge.net/projects/sqlitebrowser/files/latest/download">SQLite Database Browser</a> from the following link.  Launch SQLite Database Browser, go to File -&gt; Open Database, hold the Shift and Command buttons down on your keyboard and then press the &#8216;g&#8217; button to bring up the &#8216;Go to the folder:&#8217; dialog box, type in /var/db/application_usage.sqlite in the box and press return, and then finally click the open button to open the database.  If you click the &#8216;Browse Data&#8217; tab near the top of the window, you should be able to see the raw data in the database.  It should list the last time (in epoch time), bundle id, version, path, and number of times that the application has been launched (note that you can use an <a href="http://www.onlineconversion.com/unix_time.htm">online utility</a> to convert from epoch time to regular time).</p>

<h2>Inspect the Facter fact</h2>

<p><a href="http://puppetlabs.com/puppet/related-projects/facter/">If you&#8217;re not familiar with Facter</a>, you should click on the link and check it out.  Facter is an awesome binary designed to gather information about your system and report it back in the form of a &#8216;fact&#8217;, which is essentially a key =&gt; value pair (for example, the &#8216;operatingsystem&#8217; fact will return a value of &#8216;Darwin&#8217; on Macs running OS X or &#8216;RedHat&#8217; on machines running RedHat Linux).  Google has provided a custom Facter fact that will report a fact NAME that corresponds with an application you&#8217;ve launched on your system (such as &#8216;app_lastrun_com.apple.safari&#8217; or &#8216;app_lastrun_com.apple.textedit&#8217;) and a VALUE with the epoch time or the last time that application was run.  The output will ultimately look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app_lastrun_com.apple.safari =&gt; 1325203354
</span><span class='line'>app_lastrun_com.apple.textedit =&gt; 1325203357</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> This Facter fact requires the SQLite database that is created by the crankd code from above, so make sure you&#8217;ve followed the previous steps or you might have problems getting fact values.</p>

<p>We&#8217;ll need to install Facter.  <a href="http://downloads.puppetlabs.com/mac">You can download a copy of Facter from Puppet Labs directly</a>.  Simply download the DMG, expand it, and run the package installer inside.</p>

<p>To test out the fact, we will need the full path to the folder containing the google-macops code we downloaded in step two above.  I downloaded the source to a path of /Users/gary/Desktop/google-macops-read-only and so that&#8217;s the path I&#8217;m going to use in the next step.</p>

<p>Facter is designed to work with <a href="http://puppetlabs.com/puppet/puppet-enterprise/">Puppet</a>, but you can also run it independently.  Facter is ALSO designed to be plug-able with custom facts, and that&#8217;s what Google has shipped us.  In order to TEST these custom facts, we need to set the RUBYLIB environment variable (as Facter will look for a custom facts inside a &#8216;facter&#8217; directory that&#8217;s located inside the path returned by the RUBYLIB environment variable).  RUBYLIB should be set to the path of the downloaded google-macops source, so in my case I would run the following from the command line:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RUBYLIB</span><span class="o">=</span>/Users/gary/Desktop/google-macops-read-only
</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong>  make sure RUBYLIB is in capital letters.  If you downloaded the google-macops source to a different path, substitute your path for &#8216;/Users/gary/Desktop/google-macops-read-only&#8217;.</p>

<p>Next, we need to make sure we have the &#8216;sqlite3&#8217; ruby library installed on our system as the custom fact requires this library for correct operation.  One way to install sqlite3 is by using Rubygems with the following command from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo gem install sqlite3</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:</strong> If you have troubles using Rubygems to install sqlite3, you can either build it from source (which is beyond the scope of this article), or you can use Macports (if you have it installed) to install it with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo port install sqlite3</span></code></pre></td></tr></table></div></figure>


<p>The last step is to actually run Facter to test out the fact.  You may have a problem TESTING this fact if you installed sqlite3 via Rubygems - the reason is because the custom fact doesn&#8217;t actually load Rubygems before it tries to load sqlite3 (this isn&#8217;t a problem if you use the fact with Puppet as Puppet loads Rubygems.  It&#8217;s ALSO not a problem if you&#8217;re running version 1.9 or greater of ruby, as you no longer need to load Rubygems BEFORE trying to include a ruby library with ruby 1.9 or greater).  To remedy this problem, let&#8217;s add a single line to the custom fact.  Notice the line that says the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sqlite3&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This line is where the custom fact loads the sqlite3 library.  Now, the line BEFORE this line we need to add a single line:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This line will load Rubygems so that it knows where to access the sqlite3 library.  Note that this line is unnecessary if you use this custom fact with Puppet as, like I mentioned before, Puppet already loads Rubygems.  For the purpose of our testing, though, we will need this line.</p>

<p>Finally, let&#8217;s test the fact by running Facter from the command line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>facter</span></code></pre></td></tr></table></div></figure>


<p>You SHOULD get a list of ALL your Facter facts, but up at the top you should have a couple of facts that begin with &#8216;app_lastrun_&#8217; and then end with the bundle_id of the application that was launched.  These are the custom facts that have been created.</p>

<p>You&#8217;ll note that the time reported is in epoch time.  If you&#8217;d prefer a date/time string that&#8217;s more legible, you&#8217;ll need to modify the apps.rb file in the facter directory.  Line 39 in the file (or, line 40 if you added the require &#8216;rubygems&#8217; line previously) should say &#8216;appdate&#8217; but change it to say the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">appdate</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running facter again (like above) will give you a more legible date:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app_lastrun_com.apple.safari =&gt; Thu Dec 29 19:02:34 -0500 2011
</span><span class='line'>app_lastrun_com.apple.textedit =&gt; Thu Dec 29 19:02:37 -0500 2011</span></code></pre></td></tr></table></div></figure>


<h2>???</h2>

<h2>Profit!</h2>

<p>Now that you know how the code works, you&#8217;re free to modify, extend, and improve it as you see fit!  The one thing that&#8217;s missing here is a LaunchDaemon that keeps crankd running in the background.  Since you&#8217;re maintaining your environment, I&#8217;ll leave that up to you (though I walk you through this step in <a href="http://glarizza.posterous.com/using-crankd-to-react-to-network-events">&#8216;Step 5.  A LaunchDaemon to keep crankd running&#8217; in my previous crankd writeup</a>).  Feel free to check out my other writeups on Facter, Puppet, and Crankd to see how I used to manage hundreds of Macs in an educational environment!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Run Stages with Puppet]]></title>
    <link href="http://glarizza.github.com/blog/2011/03/11/using-run-stages-with-puppet/"/>
    <updated>2011-03-11T11:34:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2011/03/11/using-run-stages-with-puppet</id>
    <content type="html"><![CDATA[<p>As of version 2.6, Puppet introduced a feature called &#8220;Run Stages&#8221; that will allow you to better control the order that Puppet configures your system.  The problem with Run Stages (as of right now) is that there&#8217;s not that much good Documentation out there.  Hopefully this document helps someone else out there who wants to setup Run Stages in their own environment.</p>

<h2>A NOTE ON SYNTAX!!!</h2>

<p>One of THE MOST DIFFICULT concepts to understand for puppet newbies is that these two things are identical:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kn">include</span> <span class="nc">foo</span>
</span><span class='line'><span class="nc">class</span> <span class="p">{</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of these lines INVOKE the &#8216;foo&#8217; class for use on a particular node.  The problem is that the second method (the parameterized class method) looks nearly IDENTICAL to the method you would use to DECLARE the foo class in foo.pp.  The only difference is that the class name is now INSIDE the curly braces (versus being OUTSIDE the braces when you DECLARE the class in your foo.pp file).  It is VERY important that you distinguish the difference between DECLARING a class and using a parameterized class to INCLUDE the class in your site.pp file.  I will point this out later too&#8230;</p>

<h2>A Linux Example - Repositories</h2>

<p>I would bet that the resource with the most &#8220;require&#8221; and &#8220;before&#8221; dependencies in the Linux world (Well, in the RHEL world anyways) would be the yumrepo.  I&#8217;m sure most of us have many declared yumrepo resources in our manifests that each have their own tangled web of dependencies.  My goal was to create a &#8220;repo&#8221; class that would have all of my repositories and use a Run Stage to ensure that my repo class was installed prior to any other package installs.  Let&#8217;s look at some code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::repo</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">yumrepo</span> <span class="p">{</span> <span class="s1">&#39;huronrepo&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">descr</span>    <span class="p">=&gt;</span> <span class="s1">&#39;Huron Repository&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">enabled</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">gpgcheck</span> <span class="p">=&gt;</span>  <span class="s1">&#39;0&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">baseurl</span>  <span class="p">=&gt;</span>  <span class="s1">&#39;http://10.13.0.6/huronrepo&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This is my repo subclass based on my general base class.  I have a single repository, but could easily have another 5 or 10 as need arises (I&#8217;m keeping things simple for demo purposes).  Let&#8217;s look at another class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general::centos</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">include</span> <span class="nc">general::repo</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">package</span> <span class="p">{</span> <span class="s1">&#39;mcollective&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">name</span>    <span class="p">=&gt;</span> <span class="s2">&quot;mcollective&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">ensure</span>  <span class="p">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Package</span><span class="p">[</span><span class="s1">&#39;stomp&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s a centos subclass off of the general base class.  We&#8217;re including our repo class and declaring a single package that requires our &#8220;huronrepo&#8221; yumrepo.  If we only needed to install a single package, we could use the &#8220;require&#8221; parameter; but if you assume that we will eventually need to install MULTIPLE packages, then this logic doesn&#8217;t scale. Just to keep things consistent, here&#8217;s my general base class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">class</span> <span class="nc">general</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">case</span> <span class="nv">$::operatingsystem</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;CentOS&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="kn">include</span> <span class="nc">general::centos</span> <span class="err">}</span>
</span><span class='line'>    <span class="err">&#39;Darwin&#39;</span><span class="nc">:</span> <span class="p">{</span> <span class="ss">include</span> <span class="ss">general</span><span class="p">::</span><span class="ss">osx</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>You can see that we include the general::centos class as long as Puppet is running on a CentOS box.  There&#8217;s one final piece to this puzzle - it&#8217;s the actual declaration and assignment of the Run Stages.  I&#8217;m doing this in my site.pp file.  Here&#8217;s a snippit of what&#8217;s in my site.pp file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline"># /etc/puppet/manifests/site.pp</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Exec</span> <span class="p">{</span> <span class="ss">path</span> <span class="err">=&amp;</span><span class="ss">gt</span><span class="err">;</span> <span class="s2">&quot;/usr/bin:/usr/sbin:/bin:/sbin&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Run Stages</span>
</span><span class='line'><span class="ss">stage</span> <span class="p">{</span> <span class="s1">&#39;pre&#39;</span><span class="err">:</span>
</span><span class='line'>  <span class="ss">before</span> <span class="p">=&gt;</span> <span class="nc">Stage</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># Node Declaration</span>
</span><span class='line'><span class="ss">node</span> <span class="s1">&#39;server.whomever.com&#39;</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">class</span> <span class="p">{</span> <span class="s1">&#39;general::repos&#39;</span><span class="err">:</span>
</span><span class='line'>    <span class="ss">stage</span> <span class="p">=&gt;</span> <span class="s1">&#39;pre&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s where we&#8217;ve declared a &#8220;pre&#8221; stage that needs to run before the &#8220;main&#8221; stage.  We don&#8217;t have to declare the &#8220;main&#8221; stage because Puppet uses that stage by default.  Next, we&#8217;re including the general::repos class inside our &#8216;server.whomever.com&#8217; node declaration and assigning it to the &#8220;pre&#8221; stage (which means that everything in that class will get configured prior to our &#8220;main&#8221; stage).  Remember that you can declare as many stages as you need and chain them all to setup the order that you want, but that can become very unmanageable very quickly.  I find it ideal to setup a &#8216;pre&#8217; stage for repo setup, and then setting up dependencies within class files.</p>

<h2>The World is Your Stage</h2>

<p>This might not be the &#8220;best&#8221; way to use Run Stages, but it works for me.  Hopefully this little writeup cements the concept for you too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting Started with The Luggage]]></title>
    <link href="http://glarizza.github.com/blog/2010/12/21/getting-started-with-the-luggage/"/>
    <updated>2010-12-21T09:47:00-08:00</updated>
    <id>http://glarizza.github.com/blog/2010/12/21/getting-started-with-the-luggage</id>
    <content type="html"><![CDATA[<p>With the current movement in the Mac Community toward modular imaging strategies, there&#8217;s a spike in the need for properly formed package installers. Apple&#8217;s package format is well documented for its benefits and flaws and there are a string of applications that will help you create your perfect package (from Apple&#8217;s Packagemaker to the many third-party applications).  While all the various package creation applications will ultimately create a desirable package in the end, very few of them have the triple-threat of easy code-review, replication, and portability.  This is where The Luggage comes in.</p>

<p><a href="http://github.com/unixorn/luggage">The Luggage</a> is a packaging system based on GNU&#8217;s make command that is found on most every *nix-based operating system (OS X included).  Joe Block, the author, open-sourced the project based on an internal Google tool for creating packages with Makefiles.  By using Makefiles, every member of your team can quickly glance at the file and see exactly what is being inserted into a package.  Changes can be made and committed quickly, errors can be squashed without tearing apart .pkg files, and you can reproduce packages quickly and efficiently without wading through many GUI windows.</p>

<h2>Why do I need to Package?</h2>

<p>Many vendors already ship properly formatted package installers for their software - and for that we thank them.  There are still a couple of major software vendors that choose to use unique third-party package &#8220;wrappers&#8221; to install their software.  While this is fine if you only ever need to install that software on one machine, it makes software deployment&#8230;difficult.  Because of this, systems administrators need to re-package this software into a proper package installer that will deploy and install silently.</p>

<p>If you&#8217;re a fan of open-source software, you will find that many projects do not offer their software in Apple-friendly packages.  The Luggage will help you wrap their source files into a package format that can be distributed to your machines.</p>

<p>Finally, you may have a whole bevy of scripts that you use for configuration/customization of your clients.  These scripts can easily be deployed via ARD or wrapped into a payload-free package with a single postinstall script.  The Luggage will help you keep track of all your scripts and package them for distribution.</p>

<p>As I&#8217;ve said before, there are other third-party applications out there that will create a package to your needs.  Many will use snapshotting (or fseventsd monitoring) to create a package based on what&#8217;s changed on your system.  While this is lightning fast (in most cases), you will need to redo this whole process if something needs to be changed in the resultant package.</p>

<h2>How do we use The Luggage?</h2>

<p>As we said before, The Luggage is just a giant Makefile.  Make has its own unique language, so you need to obey its syntax and formatting standards.  I&#8217;ve linked to the <a href="http://www.gnu.org/software/make/manual/make.html">GNU make manual here</a> so you can get a quick overview of how it works (WARNING, it&#8217;s quite large), but this guide will cover all the basics you need to know to get started.</p>

<p>Note that while it is <strong>NOT NECESSARY TO COMPLETELY UNDERSTAND MAKE TO BEGIN USING THE LUGGAGE</strong>, it will help you out tremendously as you start to create complicated packages if you DO understand make&#8217;s nuances. This article may be long, but that&#8217;s only to make sure that the reader understands what is going on in the background.</p>

<h2>The luggage.make File</h2>

<p>The base of everything you will do with The Luggage is a file called luggage.make.  It is by no means definitive, and you&#8217;re encouraged to add to it should you encounter a situation where a recipe doesn&#8217;t exist for a directory into which you want to install files (Don&#8217;t worry, we&#8217;ll get into this later), but it does serve as the basis for all packages you&#8217;re going to be creating.</p>

<p>At the top of the file are all the variable declarations.  Anything that begins with SOMETHING=somethingelse is setting a variable that we will encounter later.  Many of these variables (such as PACKAGEMAKER, WORK_D, CP, INSTALL, and so on) are paths to various commands that we will need in our rules (setting absolute paths to common commands saves typing later and helps us avoid errors with things like PATH environment variables).  Dereferencing these variables in a Makefile is done with a syntax that looks like this -> ${CP} (this outputs the value of the CP variable, which is actually <strong>/bin/cp</strong>).  Note that you DO NOT use quotes when you set a variable (i.e. if you want to set the path to CP you do it with CP=/bin/cp and NOT by doing CP=&#8221;/bin/cp&#8221;) - if you DO use quotes, they will be included in the value of that variable (which will cause you all kinds of problems).</p>

<p>Next, we have the target stanzas.  A target (or a rule - I will use the word rule throughout the article) is setup to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        o-something: l_usr_bin
</span><span class='line'>        @-echo <span class="s2">&quot;Commands are entered here&quot;</span>
</span><span class='line'>        @-echo <span class="s2">&quot;Everything below our rule is executed&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, the <strong>target</strong>, or <strong>rule</strong>, is called <strong>do-something</strong> and has dependencies based on ANOTHER rule that&#8217;s called <strong>l_usr_bin</strong>.  Below this line is called our <strong>recipe</strong>, and right now there are two echo commands.  If the above code was in a blank text file called Makefile we could execute the two echo commands by running the following command from the command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    make <span class="k">do</span>-something
</span></code></pre></td></tr></table></div></figure>


<p>This would in turn echo the two lines of text below the do-something rule (This is not totally true - since we haven&#8217;t defined a rule for l_usr_bin it would probably error out, but I&#8217;ve kept that dependency in the above example to show you how a rule works.).  Looking specifically at luggage.make, the target stanzas define the behavior for The Luggage&#8217;s various behaviors (make pkg, make dmg, make zip, and so on).  Note that since many of these rules have dependencies on OTHER rules, a simple command of <strong>make pkg</strong> will trigger.</p>

<p>Next, you will encounter the Target directory rules.  This is the part of the luggage.make file that you may need to edit.  Joe has done a great job of defining the most popular directories into which you will install files/applications/etc. but it would be impossible for him to define EVERY location that you could possibly need.  Here is the structure of creating a Directory Rule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'>        l_etc_puppet: l_etc
</span><span class='line'>        @sudo mkdir -p <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chown -R root:wheel <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span><span class='line'>        @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/puppet
</span></code></pre></td></tr></table></div></figure>


<p>This rule will create an /etc/puppet directory in Luggage&#8217;s working directory (The variable WORK_D will be used frequently - it&#8217;s the temporary directory that The Luggage creates to simulate the target volume onto which it&#8217;s installing files.  Everything following ${WORK_D} will be the <strong>EXACT PATH</strong> into which files will be installed on the machine that runs your package.)  These Directory Rules become very important when we create custom Makefiles because they serve as dependencies which create the directories in The Luggage&#8217;s Working Directory. In a nutshell, if you&#8217;re installing files into a directory with The Luggage, you need to have a Directory Rule that creates this directory first.  Bottom Line: if you don&#8217;t FIND a Directory Rule for a directory where you will be installing files, then you&#8217;ll need to create one.</p>

<p>Finally are the File Packaging Rules.  These are handy shortcut rules that will keep your makefiles very short and readable.  In a nutshell, Joe has defined some of the most common directories to which files are installed and created one-line commands that will install specific files into those directories.  For example, say you were creating a custom Makefile in a directory that also had a launchd plist called <strong>com.foo.bar.plist</strong> in it.  If ALL you needed to do was create a package that installed that launchd plist into the /Library/LaunchDaemons directory you could setup your Makefile like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>install_foo_launchd_plist
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.foo
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>pack-Library-LaunchDaemons-com.foo.bar.plist
</span></code></pre></td></tr></table></div></figure>


<p>The PAYLOAD variable tells The Luggage which rules to execute.  In this case, it&#8217;s executing the File Packaging Rule for launchd plists (pack-Library-LaunchDaemons-%) that creates the ${WORK_D}/Library/LaunchDaemons directory, installs the com.foo.bar.plist file into it, sets the correct permissions, and then executes the Packagemaker command line tool to create your package installer. Congratulations, you created a package in 5 lines of code!</p>

<h2>Preparing for using The Luggage</h2>

<p>The Luggage is fairly self contained, but it DOES use Apple&#8217;s Packagemaker command line tool - and the way to install THAT is to download and install the Developer Tools for your computer&#8217;s OS version (There are different Developer Tools packages for 10.6, 10.5, and so on).  The Developer Tools can be downloaded from <a href="http://developer.apple.com">Apple&#8217;s Developer Site</a>, but you must create a (free) developer account first.  If you&#8217;re a Mac sysadmin, you should already have all of this.</p>

<p>Once the Developer Tools have been installed you will then need to install The Luggage.  You can use The Luggage to create an installer package for The Luggage (Weird, yes) by first <a href="http://github.com/unixorn/luggage">downloading the source code from Github.</a>  Just click on the big Downloads button in the upper right corner of the screen and download a zip version of the files.  From there, double-click on the downloaded zip file to open it, open up Terminal and change to the folder that was created which contains The Luggage&#8217;s source code, and execute the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo make pkg
</span></code></pre></td></tr></table></div></figure>


<p>This will create an installer package which can be run.  This package installs The Luggage into the /usr/local/share/luggage directory (Don&#8217;t believe me? Check the Makefile for your self!).  You&#8217;re now ready to use The Luggage!</p>

<p>Before we get into the package creation examples, we need to talk about directory structure and version control systems (svn, hg, git, etc&#8230;).  When you create new packages with The Luggage, it&#8217;s necessary to create a new Makefile in a new directory.  I like to use the /usr/local/share/luggage/examples directory to create my packages.  The easiest way to begin a new package is to copy a directory that contains a working Makefile and simply tailor it to your needs.  Unless your job is SOLELY packaging (or you&#8217;re a unix graybeard), you&#8217;re NOT going to remember all the syntax and nuances of make.  Don&#8217;t re-create the wheel - just copy and edit.</p>

<p>Next, you&#8217;re going to want to backup your files and/or have a versioning system.  Version control systems (like Subversion, Mercurial, Git, and the like) are becoming increasingly popular <a href="http://www.agileweboperations.com/the-state-of-devops">with the current DevOps movement</a>, so it might be a good idea to start playing with one NOW while you&#8217;re learning a new skill!  If you&#8217;re TOTALLY new to this concept, <a href="http://help.github.com/mac-git-installation/">I recommend using git</a>, but it&#8217;s entirely up to you.  <a href="http://github.com/huronschools/luggage">I maintain a git repository of my Luggage fork</a> that&#8217;s open to anyone to review and borrow.  If you decide to use something like Git, well then GOOD ON YA, MAN!  If not, make sure you have a backup of your Makefiles.  They&#8217;re small files; make two backups :)</p>

<h2>Package Creation Examples</h2>

<p>Now that we&#8217;ve described how make works, how luggage.make works, given a quick example of how to create a package in 5 lines, and had the installation/backup talk let&#8217;s walk you through some basic package creation examples. We&#8217;ll create packages that install an application, create a package that installs printers and executes a postinstall script, create a package that installs source code in many directories, and finally create a complex Makefile that uses variables and bash commands.</p>

<h2>An Application Package</h2>

<p>The most common packages will simply install an application file into the /Applications folder on your computer.  Since .app files are actually bundles (a directory that contains subdirectories of executable code), we will need to use tar to wrap these bundles into a single file.  From there we can have The Luggage untar the application into the correct folder. <a href="https://github.com/unixorn/luggage/blob/master/examples/firefox/Makefile">Joe&#8217;s Firefox example</a> does this, but he also has an added step of curling the tarred/bzipped application from a web server.  I&#8217;m going to skip that step (for now) so you understand how the basic process works, but it&#8217;s a best practice to use the curl method so you can keep your applications up-to-date on your fileserver without having to copy the new files to your luggage directory every time.</p>

<p>Let&#8217;s first create the /usr/local/share/luggage/examples/calculator directory and then make a copy of /Applications/Calculator.app into the /usr/local/share/luggage/examples/calculator directory.  Next, lets open Terminal and change to our /usr/local/share/luggage/examples/calculator directory.  Finally, run the following command to tar.bz2 our Calculator.app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    tar cvfj Calculator.app.tar.bz2 Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>If you did it correctly, it should create the Calculator.app.tar.bz2 file that we need for The Luggage.  Make sure this file is in the SAME directory (and level - so don&#8217;t create subfolders) as the Makefile we&#8217;re going to create.  You can actually delete the Calculator.app copy that we created - we won&#8217;t need it.  From there, our Makefile is simple - it should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TITLE</span><span class="o">=</span>Calculator_Install
</span><span class='line'><span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.yourdomain
</span><span class='line'><span class="nv">PAYLOAD</span><span class="o">=</span>unbz2-applications-Calculator.app
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it!  The PAYLOAD variable is the magic variable here - it contains the rule(s) that are to be executed in creating our package.  The unbz2-applications-% File Packaging Rule is defined in our luggage.make file (which we&#8217;ve included at the top of our Makefile), so we don&#8217;t NEED anything else in our Makefile.  <strong>MAKE SURE</strong> that the capitalization and spelling of Calculator.app in &#8220;unbz2-applications-Calculator.app&#8221; and your &#8220;Calculator.app.tar.bz2&#8221; files are IDENTICAL or this package will NOT be created (make relies on this).</p>

<h2>UPDATED: An easier Application Package</h2>

<p>Joe has actually created a Ruby script that will perform all of the actions outlined in the previous example for you.  It&#8217;s called app2luggage.rb and it can save you a few steps if you know how to use it.  Let&#8217;s take a look and see what we need to use it.</p>

<p>The first thing you will need to do is install the trollop rubygem as that&#8217;s what app2luggage.rb uses to parse its options.  You can do this with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo gem install trollop
</span></code></pre></td></tr></table></div></figure>


<p>Next, make sure the app2luggage.rb script exists in your /usr/local/share/luggage directory.  Finally, let&#8217;s run the command with the following arguments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>    sudo /usr/local/share/luggage/app2luggage.rb -a /Applications/Calculator.app -i /usr/local/share/luggage/examples/Calculator_Application/ -l /usr/local/share/luggage/luggage.make -r com.huronhs -p Calculator_Application
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s what each argument means:</p>

<ol>
<li>-a is the path to the Application we want to tar up and install with The Luggage - we&#8217;re using the path to Calculator.app for now</li>
<li>-i is the path to the folder that app2luggage.rb will create that contains our Makefile and tarred up application.  This folder SHOULD NOT EXIST or app2luggage.rb will exit (so as not to overwrite your data).</li>
<li>-l is the path to our luggage.make file</li>
<li>-r is the reverse domain for our organization</li>
<li>-p is the package id for the Makefile</li>
</ol>


<p>There are other arguments available, simply run app2luggage.rb with the &#8211;help argument to see them all.  Once app2luggage.rb runs successfully, it will create the directory you specified in the -i argument and populate it with a Makefile and the tarred up application.  The only thing left to do is to make your pkg, zip, or dmg.</p>

<h2>Installing a printer with a preinstall script</h2>

<p>One of the most popular solutions I offer with using The Luggage is to create a package that will install a printer and then install a pre-configured PPD file that sets all the initial settings for the printer.  I do this with Puppet currently, and I know it&#8217;s popular in Munki too.  You can also optionally install a specific driver (if the drivers for your printer aren&#8217;t already on your machines).  For those people who like to skip ahead, <a href="https://github.com/huronschools/luggage/tree/master/examples/hhs_printers/Printserver%20Managed/Office_9050">I have this example on my luggage repo</a>.</p>

<p>This Makefile demonstrates the use of a preinstall/preflight script (which isn&#8217;t actually installed into the payload of the package).  The Luggage has a special packaging rule for this called pack-script-% that works so long as the name of your script corresponds exactly with what you write in the PAYLOAD variable.  This file also demonstrates the use of multiple rules in the PAYLOAD variable by using the \ character.  While this isn&#8217;t difficult to understand, it is a necessary syntax.</p>

<p><a href="https://github.com/huronschools/luggage/blob/master/examples/hhs_printers/Printserver%20Managed/Office_9050/preflight">My preflight script is right here</a> for those who are interested.  It&#8217;s copied into the directory we create that contains our makefile and I name it preflight.  Note that it contains variables that need to be changed (all of which are at the top of the script) before you deploy this package.</p>

<p>Next, we need to get a .ppd file that contains all the configuration data for our printer.  The easiest way to do this is to install your printer on a demo machine using the EXACT SAME SETTINGS that will be configured in your script (protip: actually RUN the script on your computer first), configure it how you want (number of trays, memory settings, type of finisher, etc&#8230;), and then open the /etc/cups/ppd directory on your model computer.  Inside should be a .ppd file for your printer containing all the settings you&#8217;ve just configured.  Copy this .ppd file into the folder that contains your Makefile and preflight script.  Mine (in this example) will be called psm_HHS_Office_9050.ppd</p>

<p>Now, let&#8217;s look at our Makefile:</p>

<figure class='code'><figcaption><span>Managed Printer Makefile  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>HHS_Main_Office_9050_Managed_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-hp-ppd <span class="se">\</span>
</span><span class='line'>        pack-script-preflight
</span><span class='line'>
</span><span class='line'>    pack-hp-ppd: l_etc_cups_ppd
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./psm_HHS_Office_9050.ppd <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chmod 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>      @sudo chown root:_lp <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/cups/ppd/psm_HHS_Office_9050.ppd
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The first thing you should notice is that our PAYLOAD variable starts with a \ and has three lines.  The \ signifies that the contents of our variable spans multiple lines.  In reality, the value of PAYLOAD is actually &#8220;pack-hp-ppd pack-script-preflight&#8221; but it&#8217;s formatted so it&#8217;s easier to read.  Next, notice that the pack-script-preflight rule contains the word &#8220;preflight&#8221; after pack-script-.  This means that our script must be named preflight (EXACTLY - case is sensitive here).  Finally, we&#8217;ve also specified a pack-hp-ppd rule.  Since luggage.make DOES NOT define this rule, we&#8217;ve defined it in our Makefile.</p>

<p>The pack-hp-ppd rule has a dependency on the l_etc_cups_ppd rule.  This rule IS defined in luggage.make (well, it is for me - I can&#8217;t remember if I created it or not.  If it isn&#8217;t there for you, then you&#8217;ll need to create it using the other folder creation rules as a guide) - and it creates the /etc/cups/ppd folder structure that we need in our package.  Lets look at the three lines which are called our <strong>recipe</strong>*:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="err">@sudo</span> <span class="err">${CP}</span> <span class="err">./psm_HHS_Office_9050.ppd</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="err">@sudo</span> <span class="err">chmod</span> <span class="err">644</span> <span class="err">${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span><span class='line'><span class="nf">@sudo chown root</span><span class="o">:</span><span class="m">_lp ${WORK_D}/etc/cups/ppd/psm_HHS_Office_9050.ppd</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line references the CP variable (if you remember - its value is /bin/cp) to copy the psm_HHS_Office_9050.ppd file from the directory that contains our Makefile into Luggage&#8217;s working directory/etc/cups/ppd.  The second line sets its mode to 644 (to match the mode for all .ppd files in that directory), and the third line sets the owner to root and the group to _lp (note that this group is ONLY available in 10.5 and 10.6 machines - so you&#8217;ll need another package for 10.4 clients or below).</p>

<p>That&#8217;s it!  The resultant package will run the preflight script and then install the correct .ppd file after the script is run.  This package will successfully install and configure your printer in one fell swoop.</p>

<h2>Installing files into multiple directories</h2>

<p>So far our Makefiles have been pretty easy.  In fact, most of them have been a couple of lines.  Lets look at a package that installs files into multiple locations.  There&#8217;s a cool open source tool called <a href="http://github.com/ripienaar/angelia">Angelia that was created by R.I Pienaar</a>.  I use it to send alerts to my iPhone and to also process Nagios Alerts.  The problem is that it&#8217;s only packaged for Linux machines.  Since I manage Mac machines, I thought I&#8217;d lend R.I. a hand and create a package installer for it.  <a href="https://github.com/huronschools/luggage/tree/master/examples/angelia">This package is also on my luggage repo</a> if you want to work ahead.  Let&#8217;s look at the Makefile:</p>

<figure class='code'><figcaption><span>Angelia Recipe  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Angelia Package Creation:</span>
</span><span class='line'>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>Angelia_Installer
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.huronhs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        pack-angelia-etc <span class="se">\</span>
</span><span class='line'>        pack-angelia-binaries <span class="se">\</span>
</span><span class='line'>        pack-angelia-lib <span class="se">\</span>
</span><span class='line'>        pack-angelia-spool <span class="se">\</span>
</span><span class='line'>        pack-angelia-log <span class="se">\</span>
</span><span class='line'>        pack-angelia-launchd
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    pack-angelia-launchd: l_Library_LaunchDaemons
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> net.devco.angelia.plist <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>      @sudo chmod -R 644 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/LaunchDaemons
</span><span class='line'>
</span><span class='line'>    pack-angelia-binaries: l_usr_sbin
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-send
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-spoold.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-spoold
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia-nagios-send.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin/angelia-nagios-send
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/usr/sbin
</span><span class='line'>
</span><span class='line'>    pack-angelia-lib: l_Library_Ruby_Site_1_8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./angelia <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.rb <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/Library/Ruby/Site/1.8
</span><span class='line'>
</span><span class='line'>    pack-angelia-etc: l_etc_angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> -R ./templates <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./angelia.cfg <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./COPYING <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">CP</span><span class="k">}</span> ./README.markdown <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>      @sudo chmod -R 755 <span class="k">${</span><span class="nv">WORK_D</span><span class="k">}</span>/etc/angelia
</span><span class='line'>
</span><span class='line'>    pack-angelia-log: l_var_log_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>    pack-angelia-spool: l_var_spool_angelia
</span><span class='line'>      @sudo touch .create
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s definitely longer, but I don&#8217;t think it&#8217;s any more complex than the examples we&#8217;ve seen before.  The PAYLOAD variable spans multiple lines using the \ character and I&#8217;ve defined all the custom rules.  All of the rules depend on <a href="https://github.com/huronschools/luggage/blob/master/luggage.make">folder rules in my luggage.make file</a> (which were created if they didn&#8217;t exist before), and the recipes inside those rules are extremely simple to navigate (mainly copying files and changing permissions).  Creating a script that makes this package would be QUITE A BIT longer than this Makefile, and the Makefile itself took less than 3 minutes to create.  The only caveat is that we need to make sure all the files/directories we&#8217;re copying into Luggage&#8217;s WORK_D directory are in the folder that contains the Makefile.  Because of this, anytime Angelia is updated I will need to copy over new files.</p>

<p>It would be much easier to create a Makefile that downloaded the current version of all of these files before it copied them into our package&#8230;</p>

<h2>Creating a more complex Makefile</h2>

<p>The basis of this example was my thought that it would be MUCH easier for me to have a Makefile that downloaded the newest versions of the files that I need before it copies them into the package.  Make supports this through its support of shell commands and variables - it only requires you to code it up.  Let&#8217;s look at a package I created for Marionette-Collective.</p>

<p><a href="http://github.com/puppetlabs/marionette-collective">Marionette-Collective is awesome software</a> (also created by R.I Pienaar and now owned by Puppet Labs) that allows you to communicate with multiple nodes at once.  They DID have a script that created their packages, but I wanted to create a Makefile that would create a package of ANY version of their software.  Let&#8217;s look at the Makefile first and I&#8217;ll break it down:</p>

<figure class='code'><figcaption><span>MCollective Recipe  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c">    #  Example:  A dynamic installer for Marionette-Collective</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Author:  Gary Larizza</span>
</span><span class='line'><span class="c">    #  Created: 12/17/2010</span>
</span><span class='line'><span class="c">    #  Last Modified: 12/18/2010</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="c">    #  Description:  This Makefile will download the version of MCollective specified</span>
</span><span class='line'><span class="c">    #    in the PACKAGE_VERSION variable from the Puppet Labs website, untar it,</span>
</span><span class='line'><span class="c">    #    and then install the source files into their Mac-specific locations.  </span>
</span><span class='line'><span class="c">    #    The MAJOR and MINOR versions must be specified for the Info.plist file</span>
</span><span class='line'><span class="c">    #    that Packagemaker requires, but I use awk on the PACKAGE_VERSION to </span>
</span><span class='line'><span class="c">    #    get these.  See inline comments.</span>
</span><span class='line'><span class="c">    #</span>
</span><span class='line'><span class="cp">    include /usr/local/share/luggage/luggage.make</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">    # Luggage Variables:</span>
</span><span class='line'><span class="c">    #    If the TYPE variable isn&#39;t specified via the CLI, we will install everything</span>
</span><span class='line'><span class="c">    #    into the resultant package</span>
</span><span class='line'>    <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Full
</span><span class='line'>    <span class="nv">REVERSE_DOMAIN</span><span class="o">=</span>com.puppetlabs
</span><span class='line'>    <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>        unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>        pack-mc-libexec <span class="se">\</span>
</span><span class='line'>        pack-mc-binaries <span class="se">\</span>
</span><span class='line'>        pack-mc-lib <span class="se">\</span>
</span><span class='line'>        pack-mc-config <span class="se">\</span>
</span><span class='line'>        pack-mc-config-server <span class="se">\</span>
</span><span class='line'>        pack-mc-config-client <span class="se">\</span>
</span><span class='line'>        pack-mc-launchd <span class="se">\</span>
</span><span class='line'>        pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>        pack-mc-preflight-all
</span><span class='line'>
</span><span class='line'><span class="c">    # Variable Declarations:  </span>
</span><span class='line'><span class="c">    #    Any variable can be set from the command line by doing this:</span>
</span><span class='line'><span class="c">    #    &quot;make pkg PACKAGE_VERSION=1.0.0&quot;</span>
</span><span class='line'>    <span class="nv">PACKAGE_VERSION</span><span class="o">=</span>1.0.0
</span><span class='line'>    <span class="nv">PACKAGE_MAJOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$1}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">PACKAGE_MINOR_VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span> | awk -F <span class="s1">&#39;.&#39;</span> <span class="s1">&#39;{print $$2$$3}&#39;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nv">MCFILE</span><span class="o">=</span>mcollective-<span class="k">${</span><span class="nv">PACKAGE_VERSION</span><span class="k">}</span>
</span><span class='line'>    <span class="nv">MCURL</span><span class="o">=</span>http://puppetlabs.com/downloads/mcollective/<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # Package Creation Limiters:</span>
</span><span class='line'><span class="c">    #    These if-statements will check for one of three values for the TYPE variable:</span>
</span><span class='line'><span class="c">    #    &quot;COMMON, CLIENT, or BASE&quot;  If either of these values are present (CASE SENSITIVE)</span>
</span><span class='line'><span class="c">    #    the PAYLOAD variable will be changed to limit what is installed into the package.</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # COMMON Package:</span>
</span><span class='line'><span class="c">    #    This package includes the Ruby libraries and MCollective plugins with nothing else.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},COMMON)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-libexec <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-common
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Common
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # CLIENT Package:</span>
</span><span class='line'><span class="c">    #    This package includes the MCollective Binaries and the configuration file for</span>
</span><span class='line'><span class="c">    #    MCollective&#39;s client binaries.  </span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},CLIENT)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-binaries <span class="se">\</span>
</span><span class='line'>          pack-mc-config-client <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-client
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Client
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # BASE Package:</span>
</span><span class='line'><span class="c">    #    This package includes the mcollectived daemon, Ruby Libraries, a launchd plist</span>
</span><span class='line'><span class="c">    #    to call mcollectived, and the configuration files for the MCollective server.</span>
</span><span class='line'><span class="cp">    ifeq (${TYPE},BASE)</span>
</span><span class='line'>      <span class="nv">PAYLOAD</span><span class="o">=</span><span class="se">\</span>
</span><span class='line'>          unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span> <span class="se">\</span>
</span><span class='line'>          pack-mc-config <span class="se">\</span>
</span><span class='line'>          pack-mc-config-server <span class="se">\</span>
</span><span class='line'>          pack-mc-launchd <span class="se">\</span>
</span><span class='line'>          pack-mc-mcollectived <span class="se">\</span>
</span><span class='line'>          pack-mc-lib <span class="se">\</span>
</span><span class='line'>          pack-mc-preflight-base
</span><span class='line'>      <span class="nv">TITLE</span><span class="o">=</span>MCollective_Installer_Base
</span><span class='line'><span class="cp">    endif</span>
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will curl the selected version of MCollective and untar it into the directory</span>
</span><span class='line'><span class="c">    #    in which the Makefile resides.</span>
</span><span class='line'>    unpack-mc-<span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>:
</span><span class='line'>      curl <span class="k">${</span><span class="nv">MCURL</span><span class="k">}</span> -o <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>      @sudo <span class="k">${</span><span class="nv">TAR</span><span class="k">}</span> xzf <span class="k">${</span><span class="nv">MCFILE</span><span class="k">}</span>.tgz
</span><span class='line'>
</span><span class='line'><span class="c">    # This rule will install MCollective&#39;s plugin files to /usr/libexec/mcollective</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
